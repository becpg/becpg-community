<?xml version="1.0" encoding="UTF-8"?>

<process-definition xmlns="urn:jbpm.org:jpdl-3.1" name="bcpgwf:productValidationWF">

    <swimlane name="initiator" />

    <start-state name="start">
        <task name="bcpgwf:initiateProductValidationTask" swimlane="initiator" />
        <transition name="" to="review" >
        	<action class="org.alfresco.repo.workflow.jbpm.AlfrescoJavaScript">
           <script>
              if (bcpgwf_notifyAssignee)
              {             
              		for each (user in people.getMembers(people.getGroup('GROUP_ProductReviewer'), false)){
              		
              			var mail = actions.create("mail");
		              	mail.parameters.to = user.properties.email;
	                 	mail.parameters.subject = "beCPG Validation : " + bpm_workflowDescription;
	                 	mail.parameters.from = initiator.properties.email;
			 			mail.parameters.template = search.xpathSearch("/app:company_home/app:dictionary/app:email_templates/app:workflow/cm:product-validation-notify-task-email.ftl")[0];
	                 	mail.parameters.text = "Vous êtes assigné à une validation de produit.";
	                 	mail.execute(bpm_package);
	                 	
	                 	if (logger.isLoggingEnabled()) {
                     	logger.log("\nEmail send to " + user.properties['cm:firstName'] + " " + user.properties['cm:lastName']);
                    	} 
              		}                 
              }
           </script>
         </action>
        </transition>
    </start-state>

    <swimlane name="reviewer">
        <assignment class="org.alfresco.repo.workflow.jbpm.AlfrescoAssignment">
            <pooledactors>#{people.getGroup('GROUP_ProductReviewer')}</pooledactors>
        </assignment>    
    </swimlane>

    <task-node name="review">
        <task name="bcpgwf:doProductValidationTask" swimlane="reviewer">
            <event type="task-create">
                <script>
                   if (bpm_workflowDueDate != void) taskInstance.dueDate = bpm_workflowDueDate;
                   if (bpm_workflowPriority != void) taskInstance.priority = bpm_workflowPriority;
                </script>
            </event>
            <event type="task-end">
               <action class="org.alfresco.repo.workflow.jbpm.AlfrescoJavaScript">
                  <script>
                     <variable name="bpm_assignee" access="write"/>
                     <expression>
                        if (taskInstance.actorId != null)
                           people.getPerson(taskInstance.actorId);
                        else
                           person;
                     </expression>
                  </script>
               </action>
            </event>
        </task>
        <transition name="approve" to="approved" >
        	<action class="fr.becpg.repo.workflow.jbpm.productvalidation.ApproveActionHandler">
			</action>
			<action class="org.alfresco.repo.workflow.jbpm.AlfrescoJavaScript">
           <script>
              if (bcpgwf_notifyMe)
              {             
                 var mail = actions.create("mail");
                 mail.parameters.to = initiator.properties.email;
                 mail.parameters.subject = "beCPG Validation Produit : " + bpm_workflowDescription;
                 mail.parameters.from = bpm_assignee.properties.email;
		 		 mail.parameters.template = search.xpathSearch("/app:company_home/app:dictionary/app:email_templates/app:workflow/cm:product-validation-approved-task-email.ftl")[0];
                 mail.parameters.text = "Le processus de validation est terminé. La demande a été acceptée.";
                 mail.execute(bpm_package);
              }
           </script>
         </action>
        </transition>
        <transition name="reject" to="rejected" >
        	<action class="org.alfresco.repo.workflow.jbpm.AlfrescoJavaScript">
           <script>
              if (bcpgwf_notifyMe)
              {             
                 var mail = actions.create("mail");
                 mail.parameters.to = initiator.properties.email;
                 mail.parameters.subject = "beCPG Validation Produit : " + bpm_workflowDescription;
                 mail.parameters.from = bpm_assignee.properties.email;
		 		 mail.parameters.template = search.xpathSearch("/app:company_home/app:dictionary/app:email_templates/app:workflow/cm:product-validation-rejected-task-email.ftl")[0];
                 mail.parameters.text = "Le processus de validation est terminé. La demande a été refusée.";
                 mail.execute(bpm_package);
              }
           </script>
         </action>
        </transition>
    </task-node>

    <task-node name="rejected">
        <task name="bcpgwf:rejectProductTask" swimlane="initiator" />
        <transition name="" to="end" />
    </task-node>

    <task-node name="approved">
        <task name="bcpgwf:approveProductTask" swimlane="initiator" />
        <transition name="" to="end" />
    </task-node>

    <end-state name="end" />

</process-definition>
