(function(){var d=YAHOO.Bubbling,m=Alfresco.util.encodeHTML;var t=Alfresco.util.generateDomId(null,"task");var b=Alfresco.util.generateDomId(null,"submitTask");var o=Alfresco.util.generateDomId(null,"showDetails");var r=Alfresco.util.generateDomId(null,"comment");var u=Alfresco.util.generateDomId(null,"commentProject");beCPG.component.ProjectCommons={};beCPG.component.ProjectCommons.prototype={cache:[],taskEventClass:t,taskSubmitEventClass:b,commentEventClass:r,commentProjectEventClass:u,showDetailsEventClass:o,onActionShowTask:function e(z){var A=this;var B=function y(E,F){Alfresco.util.populateHTML([F.id+"-dialogTitle",A.msg("label.edit-row.title")])};var v=z.replace("node-","").split("|");var w=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?entityNodeRef={entityNodeRef}&itemKind={itemKind}&itemId={itemId}&mode={mode}&submitType={submitType}&showCancelButton=true&popup=true",{itemKind:"node",itemId:v[0],mode:"edit",submitType:"json",entityNodeRef:v[1]!="#access_forbidden"?v[1]:""});var C=new Alfresco.module.SimpleDialog(this.id+"-editCharacts-"+Alfresco.util.generateDomId());C.setOptions({width:"34em",templateUrl:w,actionUrl:null,destroyOnHide:true,zIndex:10,doBeforeDialogShow:{fn:B,scope:this},onSuccess:{fn:function D(E){d.fire(A.scopeId+"dataItemUpdated",{nodeRef:v[1],callback:function(F){Alfresco.util.PopupManager.displayMessage({text:A.msg("message.details.success")})}})},scope:this},onFailure:{fn:function x(E){Alfresco.util.PopupManager.displayMessage({text:A.msg("message.details.failure")})},scope:this}}).show()},onActionCommentTask:function e(x){var v=x.replace("node-","").split("|"),y=v[1]!="#access_forbidden"?v[1]:"";var w=Alfresco.constants.URL_SERVICECONTEXT+"modules/comments/list?nodeRef="+v[0]+"&activityType=task&entityNodeRef="+y;this._showPanel(w,this.id+"_comments",v[1])},onActionSubmitTask:function n(w){var v=w.replace("node-","").split("|"),y=v[0]!="#access_forbidden"?v[0]:"",x=this;Alfresco.util.PopupManager.displayPrompt({title:x.msg("message.confirm.submit-task.title"),text:x.msg("message.confirm.submit-task.description"),buttons:[{text:x.msg("button.submit"),handler:function(){Alfresco.util.Ajax.jsonRequest({url:Alfresco.constants.PROXY_URI+"/becpg/project/complete/task?nodeRef="+y,method:"POST",successCallback:{fn:function(z){Alfresco.util.PopupManager.displayMessage({text:x.msg("message.submit-task.success")});YAHOO.Bubbling.fire(x.scopeId+"dataItemUpdated",{nodeRef:y})},scope:x}});this.destroy()}},{text:x.msg("button.cancel"),handler:function(){this.destroy()},isDefault:true}]})},onActionCommentProject:function e(w){var x=w.replace("node-","");x=(x!="#access_forbidden"?x:"");var v=Alfresco.constants.URL_SERVICECONTEXT+"modules/comments/list?nodeRef="+x+"&activityType=project&entityNodeRef="+x;this._showPanel(v,this.id+"_comments",x)},onActionShowProjectDetails:function a(w){var v=Alfresco.constants.URL_SERVICECONTEXT+"modules/project-details/project-details?nodeRef="+w.nodeRef;this._showPanel(v,this.id+"_projectDetails",w.nodeRef)},onActionShowProjectFolder:function h(v){var w=beCPG.util.entityDocumentsURL(v.siteId,v.path,v.itemData.prop_cm_name.displayValue);window.location.href=w},getOverdueClass:function g(A,v){var w=0,x=A.itemData.prop_pjt_projectOverdue,z=this.extractDates(A),y=v!=null?"-"+v:"";if(x.value!=null&&z.start!=null&&z.due!=null){w=100*(x.value/(z.due.getTime()-z.start.getTime()))*24*60*60*1000}if(w>45){return"overdue-45plus"+y}if(w>30){return"overdue-30to45"+y}if(w>15){return"overdue-15to29"+y}if(w>0){return"overdue-0to14"+y}return"overdue-negative"+y},extractDates:function(w,B,y){var v=null,A=null,x=null;if(y){v=w.itemData["prop_pjt_tlStart"].value;A=w.itemData["prop_pjt_tlEnd"].value;A=A!=null?this.resetDate(Alfresco.util.fromISO8601(A)):null;v=v!=null?this.resetDate(Alfresco.util.fromISO8601(v)):this.resetDate(B);if(A==null){var z=w.itemData["prop_pjt_tlDuration"].value;if(z==null){if(w.itemData["prop_pjt_tlIsMilestone"]!=null&&w.itemData["prop_pjt_tlIsMilestone"].value){z=1}else{z=0}}A=new Date(v.getTime()+z*24*60*60*1000)}return{start:v,end:A}}v=w.itemData.prop_pjt_projectStartDate.value;A=w.itemData.prop_pjt_projectCompletionDate.value;x=w.itemData.prop_pjt_projectDueDate.value;v=v!=null?this.resetDate(Alfresco.util.fromISO8601(v)):new Date();A=A!=null?this.resetDate(Alfresco.util.fromISO8601(A)):null;x=x!=null?this.resetDate(Alfresco.util.fromISO8601(x)):this.computeDueDate(v,w);return{start:v,end:A,due:x}},computeDueDate:function(v,y){var C=y.itemData.dt_pjt_taskList;var A=v,x=v;for(j in C){var w=C[j];var D=w.nodeRef;var E=this.cache[D];if(!E){for(var F in w.itemData["assoc_pjt_tlPrevTasks"]){var B=w.itemData["assoc_pjt_tlPrevTasks"][F].value;if(this.cache[B]!=null&&this.cache[B].end!=null&&this.cache[B].end.getTime()>x.getTime()){x=this.cache[B].end}}E=this.extractDates(w,x,true);this.cache[D]=E}A=E.end}return A},resetDate:function k(v){if(v==null){return new Date()}v.setHours(0);v.setMinutes(0);v.setSeconds(0);return v},getTaskTitle:function l(v,E,G,H){var F=null,z="";if(v.itemData["assoc_pjt_subProjectRef"]!=null&&v.itemData["assoc_pjt_subProjectRef"].length>0){F=v.itemData["assoc_pjt_subProjectRef"][0];z=" sub-project"}var w=(F==null&&v.itemData["prop_pjt_tlIsGroup"]!=null&&v.itemData["prop_pjt_tlIsGroup"].value)?" task-group":"";var C="";if(G){var y=this.getTaskColor(v);C='<span class="task-legend" style="background-color:#'+y+'"></span>'}var A=C+'<span class="task-status task-status-'+v.itemData["prop_pjt_tlState"].value+w+z+'">',x="";var D=v.itemData["prop_pjt_tlTaskName"].displayValue;if(v.permissions.userAccess.edit&&w==""){if(H&&D.length>H){A+='<span class="node-'+(F!=null?F.value:v.nodeRef)+"|"+E+' text-tooltip se" data-tooltip="'+beCPG.util.encodeAttr(D)+'"><a href="" class="theme-color-1 '+t+'" title="'+this.msg("link.title.task-edit")+'" >'+Alfresco.util.encodeHTML(D.substring(0,H).trim())+"...</span>"}else{A+='<span class="node-'+(F!=null?F.value:v.nodeRef)+"|"+E+'"><a href="" class="theme-color-1 '+t+'" title="'+this.msg("link.title.task-edit")+'" >'+D+"</span>"}}else{if(H&&D.length>H){A+='<span class="node-'+(F!=null?F.value:v.nodeRef)+"|"+E+' text-tooltip se" data-tooltip="'+beCPG.util.encodeAttr(D)+'"><span>'+Alfresco.util.encodeHTML(D.substring(0,H).trim())+"...</span></span>"}else{A+='<span class="node-'+(F!=null?F.value:v.nodeRef)+"|"+E+'">'+D+"</span>"}}if(v.itemData["prop_pjt_tlState"].value=="InProgress"){if(v.itemData["prop_pjt_completionPercent"]&&v.itemData["prop_pjt_completionPercent"].value!=null){x+='<span title="'+this.msg("completion.title")+'">'+v.itemData["prop_pjt_completionPercent"].displayValue+"%</span>"}}if(v.itemData["prop_pjt_tlRealDuration"]&&v.itemData["prop_pjt_tlRealDuration"].value!=null&&v.itemData["prop_pjt_tlRealDuration"].value>v.itemData["prop_pjt_tlDuration"].value){if(x.length>0){x+=" - "}x+='<span class="red" title="'+this.msg("overdue.title")+'">'+Alfresco.util.encodeHTML(v.itemData["prop_pjt_tlRealDuration"].value-v.itemData["prop_pjt_tlDuration"].value)+" "+this.msg("overdue.day")+"</span>"}if(v.permissions.userAccess.edit){A+="</a>"}if(x.length>0){A+=" ("+x+")"}if(F!=null){A+='<a  class="sub-project-link" title="'+F.displayValue+'" href="'+beCPG.util.entityURL(F.siteId,F.value,"pjt:project")+'" >';A+="&nbsp;</a>"}else{if(v.permissions.userAccess.edit&&v.itemData["prop_pjt_tlState"].value=="InProgress"){A+='<span class="node-'+v.nodeRef+"|"+E+'">';A+='<a class="submit-task '+b+'" title="'+this.msg("link.title.submit-task")+'" href="" >';A+="&nbsp;";A+="</a></span>"}}var B="node-"+v.nodeRef+"|"+E;if(F!=null){B="node-"+F.value+"|"+E}A+='<span class="'+B+'">';if(v.itemData["prop_fm_commentCount"]&&v.itemData["prop_fm_commentCount"].value){A+='<a class="task-comments active-comments '+r+'" title="'+this.msg("link.title.comment-task")+'" href="" >';A+=v.itemData["prop_fm_commentCount"].value}else{A+='<a class="task-comments '+r+'" title="'+this.msg("link.title.comment-task")+'" href="" >';A+="&nbsp;"}A+="</a></span></span>";return A},getDeliverableTitle:function s(v,z){var x='<span class="delivrable-status delivrable-status-'+v.itemData["prop_pjt_dlState"].value+'">';var y=v.itemData["assoc_pjt_dlContent"];if(y.length>0){x+='<span class="doc-file"><a title="'+this.msg("link.title.open-document")+'" href="'+beCPG.util.entityURL(y[0].siteId,y[0].value,"document")+'"><img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/filetypes/"+Alfresco.util.getFileIcon(y[0].displayValue,"cm:content",16)+'" /></a></span>'}var w=v.itemData["prop_pjt_dlUrl"]!=null?v.itemData["prop_pjt_dlUrl"].value:null;if(w!=null&&w.length>0){x+='<span class="doc-url"><a title="'+this.msg("link.title.open-link")+'" href="'+w+'"><img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/link-16.png" /></a></span>'}if(v.permissions.userAccess.edit){x+='<span class="node-'+v.nodeRef+"|"+z+'"><a class="theme-color-1 '+t+'" title="'+this.msg("link.title.deliverable-edit")+'" >'+v.itemData["prop_pjt_dlDescription"].displayValue+"</a></span>"}else{x+='<span class="node-'+v.nodeRef+"|"+z+'">'+v.itemData["prop_pjt_dlDescription"].displayValue+"</span>"}x+='<span class="node-'+v.nodeRef+"|"+z+'">';x+='<a class="task-comments '+r+'" title="'+this.msg("link.title.comment-task")+'" href="" >';if(v.itemData["prop_fm_commentCount"]&&v.itemData["prop_fm_commentCount"].value){x+=v.itemData["prop_fm_commentCount"].value}else{x+="&nbsp;"}x+="</a></span>";x+="</span>";return x},getPriorityImg:function q(v,y){if(v.itemData.prop_pjt_projectPriority){var x=v.itemData.prop_pjt_projectPriority.value,z={"1":"high","2":"medium","3":"low"},w=z[x+""];return'<img class="priority" src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/priority-"+w+'-16.png" title="'+this.msg("label.priority",this.msg("priority."+w))+'"/>'}return""},getProjectTitle:function c(y,A,F){var x=null,E=null,w=null,C="";var D=y.itemData.prop_cm_name.displayValue,v=y.itemData.prop_bcpg_code.displayValue,z="",B="";x=beCPG.util.entityURL(y.siteId,y.nodeRef,"pjt:project",null,"View-properties");E=beCPG.util.entityURL(y.siteId,y.nodeRef,"pjt:project");w=beCPG.util.entityDocumentsURL(y.siteId,y.path,D);if(y.version&&y.version!==""){C='<span class="document-version">'+y.version+"</span>"}if(A){z=y.itemData.prop_pjt_projectOverdue.displayValue!=null?m(y.itemData.prop_pjt_projectOverdue.displayValue)+"&nbsp;"+this.msg("overdue.day"):"";B+='<span class="'+this.getOverdueClass(y,F?32:null)+'" title="'+z+'">'}else{B+='<span class="project-title"><a class="folder-link" href="'+w+'" title="'+this.msg("link.title.open-folder")+'">&nbsp;</a>'}if(A){B+=this.getPriorityImg(y,F)}B+='<a class="theme-color-1" href="'+(A?x:E)+'" title="'+(A?"":this.msg("actions.entity.view-tasks"))+'">'+v+"&nbsp;-&nbsp;"+m(D)+"</a></span>"+C;return B},getProjectTitleV2:function c(w,D,F){var L=null,E=null,z="";var N=w.itemData.prop_cm_name.displayValue,v=w.itemData.prop_bcpg_code.displayValue,K="",M="",A=w.itemData.prop_pjt_projectState.value;var I=F.tooltip!=null?F.tooltip:100;var J=v+"-"+m(N);if(F.pattern!=null){J=F.pattern.replace("{cm:name}",m(N)).replace("{bcpg:code}",v)}var x="light";if(D){x="full"}if(I&&J!=null&&J.length>I){M+='<span class="project-title text-tooltip se '+x+" project-status-"+A+'" data-tooltip="'+beCPG.util.encodeAttr(J)+'" >';J=Alfresco.util.encodeHTML(J.substring(0,I).trim())+"..."}else{M+='<span class="project-title '+x+" project-status-"+A+'"  >'}M+='<a class="theme-color-1" href="'+beCPG.util.entityURL(w.siteId,w.nodeRef,"pjt:project")+'" >'+J+"</a>";M+='<span class="node-'+w.nodeRef+'">';M+='<a class="show-details '+o+'" title="'+this.msg("link.title.project-details")+'" href="" >';M+="&nbsp;";M+="</a></span>";M+='<span class="node-'+w.nodeRef+'">';if(w.itemData["prop_fm_commentCount"]&&w.itemData["prop_fm_commentCount"].value){M+='<a class="project-comments active-comments '+u+'" title="'+this.msg("link.title.comment-project")+'" href="" >';M+=w.itemData["prop_fm_commentCount"].value}else{M+='<a class="project-comments '+u+'" title="'+this.msg("link.title.comment-project")+'" href="" >';M+="&nbsp;"}M+="</a></span></span>";if(w.version&&w.version!==""){M+='<span class="document-version">'+w.version+"</span>"}if(D){var H=w.itemData.prop_cm_title;M+="<ul>";if(H!=null&&H.displayValue!=null&&H.displayValue.length>0){if(I&&H.displayValue.length>(I+10)){M+='<li><span class="project-subtitle text-tooltip se"  data-tooltip="'+beCPG.util.encodeAttr(H.displayValue)+'">'+m(H.displayValue.substring(0,(I+10)).trim())+"...</span></li>"}else{M+='<li><span class="project-subtitle">'+m(H.displayValue)+"</span></li>"}}var B=this.extractDates(w),y=B.due;var G=(B.start?Alfresco.util.formatDate(B.start,"shortDate"):scope.msg("label.none"));if(B.end!=null){y=B.end}G+=" - ";G+=(B.start?Alfresco.util.formatDate(y,"shortDate"):scope.msg("label.none"));M+="<li>";var K=w.itemData.prop_pjt_projectOverdue;if(K!=null&&K.value!=null){M+='<span class="small '+this.getOverdueClass(w,32)+'" title="'+m(K.value)+"&nbsp;"+this.msg("overdue.day")+'"></span>'}M+='<span class="project-date">'+G+"</span>";if(K!=null&&K.value!=null&&K.value>0){M+='&nbsp;<span class="project-overdue">('+m(K.value)+"&nbsp;"+this.msg("overdue.day")+")</span>"}M+="</li>";var C=w.itemData.prop_pjt_completionPercent;if(C!=null){M+="<li><progress max='100' value='"+C.value+"' >'"+m(C.value)+"&nbsp; %</progress></li>"}M+="</ul>"}return M},getTaskColor:function f(v){if(v.itemData["assoc_pjt_tlTaskLegend"][0]!=null){var w=v.itemData["assoc_pjt_tlTaskLegend"][0].value;for(i in this.taskLegends){if(this.taskLegends[i].id==w){return this.taskLegends[i].color.replace("#","")}}}return"37C700"},initTaskHandlers:function p(){var D=this;var x=function A(H,G){var F=YAHOO.Bubbling.getOwnerByTagName(G[1].anchor,"span");if(F!==null){D.onActionShowTask.call(D,F.className,F)}return true};YAHOO.Bubbling.addDefaultAction(t,x);var B=function y(H,G){var F=YAHOO.Bubbling.getOwnerByTagName(G[1].anchor,"span");if(F!==null){D.onActionSubmitTask.call(D,F.className,F)}return true};YAHOO.Bubbling.addDefaultAction(b,B);var E=function A(H,G){var F=YAHOO.Bubbling.getOwnerByTagName(G[1].anchor,"span");if(F!==null){D.onActionCommentTask.call(D,F.className,F)}return true};YAHOO.Bubbling.addDefaultAction(r,E);var w=function z(H,G){var F=YAHOO.Bubbling.getOwnerByTagName(G[1].anchor,"span");if(F!==null){D.onActionCommentProject.call(D,F.className,F)}return true};YAHOO.Bubbling.addDefaultAction(u,w);var v=function C(H,G){var F=YAHOO.Bubbling.getOwnerByTagName(G[1].anchor,"span");if(F!==null){var I=F.className.replace("node-","");D.onActionShowProjectDetails.call(D,{nodeRef:I})}return true};YAHOO.Bubbling.addDefaultAction(o,v)}}})();