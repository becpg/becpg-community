var g;(function(){var h=YAHOO.util.Dom;var f=Alfresco.util.encodeHTML;beCPG.component.ProjectList=function(o,n){this.view=n;beCPG.component.ProjectList.superclass.constructor.call(this,o);YAHOO.Bubbling.on("filterChanged",this.onFilterChanged,this);YAHOO.Bubbling.on("simpleDetailedChanged",this.onSimpleDetailed,this);this.services.preferences=new Alfresco.service.Preferences();if(n=="resources"){this.setOptions({sortable:false,localSort:true,usePagination:true,configurableColumns:false,useFilter:true,itemType:"pjt:taskList",list:"projectList",sortId:"TaskResources",extraParams:"resources",formWidth:"65em"})}else{this.setOptions({sortable:false,localSort:false,usePagination:true,useFilter:true,configurableColumns:false,itemType:"pjt:project",list:"projectList",groupBy:"prop_pjt_projectHierarchy2",sortId:"ProjectList",saveFieldUrl:Alfresco.constants.PROXY_URI+"becpg/bulkedit/save",groupFormater:function(q,p){var r="";if(p.getData("itemData")["prop_pjt_projectHierarchy1"]!=null&&p.getData("itemData")["prop_pjt_projectHierarchy1"].displayValue!=null){r+=p.getData("itemData")["prop_pjt_projectHierarchy1"].displayValue}if(p.getData("itemData")["prop_pjt_projectHierarchy2"]!=null&&p.getData("itemData")["prop_pjt_projectHierarchy2"].displayValue!=null){if(r.length>0){r+=" - "}r+=p.getData("itemData")["prop_pjt_projectHierarchy2"].displayValue}return r},hiddenColumns:["prop_pjt_projectHierarchy1","prop_pjt_projectHierarchy2","prop_bcpg_code","prop_pjt_projectCompletionDate","prop_pjt_projectDueDate","prop_pjt_projectState"],formWidth:"65em"})}return this};YAHOO.extend(beCPG.component.ProjectList,beCPG.module.EntityDataGrid);YAHOO.lang.augmentProto(beCPG.component.ProjectList,beCPG.component.ProjectCommons);YAHOO.lang.augmentObject(beCPG.component.ProjectList.prototype,{view:"dataTable",taskLegends:[],onReady:function d(){this.widgets.filter=Alfresco.util.createYUIButton(this,"filters",this.onMenuFilterChanged,{type:"menu",menu:"filters-menu",lazyloadmenu:false,zindex:99});this.widgets.filter.getMenu().subscribe("beforeShow",function(){this.cfg.setProperty("zindex",99)});var o=(this.options.filter.filterId?this.options.filter.filterId+(this.options.filter.filterData?"."+this.options.filter.filterData:""):"projects.InProgress");this.widgets.filter.set("label",this.msg("filter."+o)+" "+Alfresco.constants.MENU_ARROW_SYMBOL);JSGantt.register(this);var n=Alfresco.constants.PROXY_URI+"becpg/project/info"+(this.options.siteId!=null&&this.options.siteId.length>0?"?site="+this.options.siteId:"");Alfresco.util.Ajax.request({url:n,successCallback:{fn:function(p){var t=p.json.legends;t.sort(function(v,u){if(v!=null&&v.sort!=null&&u!=null&&u.sort!=null){return v.sort-u.sort}return 0});this.options.parentNodeRef=p.json.parentNodeRef;var r="";for(var q in t){var s={id:t[q].nodeRef,label:t[q].label,color:t[q].color!=null?t[q].color.toString().replace("#",""):null,nbProjects:t[q].nbProjects};this.taskLegends.push(s);r+='<span class="task-legend" style="background-color:#'+s.color+'" ></span><span><a href='+Alfresco.util.siteURL("project-list?view="+this.view+"#filter=filterform|%7B%22prop_pjt_projectState%22%3A%22InProgress%22%2C%22prop_pjt_projectLegends%22%3A%22"+encodeURIComponent(s.id)+"%22%7D")+">"+s.label+" ("+s.nbProjects+")</a></span>&nbsp;"}h.get(this.id+"-legend").innerHTML=r;if(this.view=="gantt"){this.options.pageSize=10;this.initGantt()}if(this.view=="resources"){this.initResources()}if(this.view=="dataTable"){if(this.options.simpleView){this.options.columnFormId="datagrid-simple"}}this.initDataTable()},scope:this},failureCallback:{fn:function(){},scope:this}})},initDataTable:function k(){beCPG.component.ProjectList.superclass.onReady.call(this);this.populateDataGrid();this.initTaskHandlers()},_buildDataGridParams:function i(p){var n=this.dataRequestFields;if(this.view=="resources"){n=["pjt_tlTaskName","pjt_tlIsMilestone","pjt_tlDuration","pjt_tlResources","pjt_tlTaskLegend","pjt_tlState","pjt_completionPercent","pjt_tlStart","pjt_tlEnd","pjt_tlWorkflowInstance","fm_commentCount","pjt_project|cm_name|pjt_projectHierarchy1|pjt_projectHierarchy2|pjt_completionPercent|bcpg_code"]}var o={fields:n,page:p&&p.page?p.page:this.currentPage,extraParams:this.options.extraParams};if(this.currentSort!=null){o.sort=this.currentSort.replace("prop_","").replace("_",":")+"|"+((this.currentSortDir=="yui-dt-asc")?"true":"false")}if(this.queryExecutionId!=null){o.queryExecutionId=this.queryExecutionId}if(this.options.filter.filterId){p.filter=this.options.filter}if(p&&p.filter){o.filter={filterOwner:p.filter.filterOwner,filterId:p.filter.filterId,filterData:p.filter.filterData,filterParams:this._createFilterURLParameters(p.filter,this.options.filterParameters)}}return o},initGantt:function b(){var o=function n(){var E=this.widgets.dataTable.getRecordSet();if(E.getLength()!=0){g=new JSGantt.GanttChart("g",h.get(this.id+"-gantt"),g!=null?g.getFormat():null);g.setDateInputFormat("mediumDate");g.setDateDisplayFormat("mediumDate");g.setCaptionType("Resource");for(var H=0;H<E.getLength();H++){var J=E.getRecord(H);var G=J.getData();var F=G.nodeRef;var L='<span class="'+this.getOverdueClass(G)+'">'+this.getProjectTitle(G)+"</span>";var t=J.getData("itemData")["assoc_pjt_projectManager"].displayValue;if(t&&t!=null&&t.length>0){t='<span class="resource-title">'+t+"</span>"}var p=J.getData("itemData")["prop_pjt_completionPercent"].value;var v=this.extractDates(G);g.AddTaskItem(new JSGantt.TaskItem(F,L,v.start,v.due,"FFBC00","",0,t,p,1,0,0));var u=v.start;var K=J.getData("itemData")["dt_pjt_taskList"];for(j in K){var I=K[j];var r=I.nodeRef;var B="";for(var C in I.itemData["assoc_pjt_tlPrevTasks"]){var x=I.itemData["assoc_pjt_tlPrevTasks"][C].value;if(B.length>0){B+=","}B+=x;if(this.cache[x]!=null&&this.cache[x].end!=null&&this.cache[x].end.getTime()>u.getTime()){u=this.cache[x].end}}var q=F;if(I.itemData["prop_bcpg_parentLevel"].value!=null){q=I.itemData["prop_bcpg_parentLevel"].value}var A=!I.itemData["prop_pjt_tlIsGroup"].value?0:1;var w=I.itemData["prop_pjt_tlIsMilestone"].value;var y=I.itemData["prop_pjt_completionPercent"].value;var s=null;if(I.itemData["assoc_pjt_tlResources"].length>0){s="";for(var C in I.itemData["assoc_pjt_tlResources"]){s+='<span class="resource-title">'+I.itemData["assoc_pjt_tlResources"][C].displayValue+"</span>"}}var D=this.cache[r];if(!D){D=this.extractDates(I,u,true);this.cache[r]=D}g.AddTaskItem(new JSGantt.TaskItem(r,this.getTaskTitle(I,G.nodeRef),D.start,D.end,this.getTaskColor(I),null,w?1:0,s,y,A,q,1,B))}}g.Draw();g.DrawDependencies()}else{Alfresco.util.populateHTML([this.id+"-gantt",'<div class="yui-dt-liner">'+this.msg("message.empty")+"</div>"])}};this.cache=[];this.extraAfterDataGridUpdate.push(o)},initResources:function e(){var o=function n(){var A=this.widgets.dataTable.getRecordSet();if(A.getLength()!=0){g=new JSGantt.GanttChart("g",h.get(this.id+"-gantt"),g!=null?g.getFormat():null);g.setDateInputFormat("shortDate");g.setDateDisplayFormat("shortDate");g.setCaptionType("Resource");var q=new Date();var s=[];for(var u=0;u<A.getLength();u++){var C=A.getRecord(u);var r=C.getData();var x=r.nodeRef;var z=r.itemData["dt_pjt_project"]["itemData"]["prop_cm_name"].displayValue;var t=r.itemData["prop_pjt_tlIsMilestone"].value;var p=r.itemData["prop_pjt_completionPercent"].value;var B=r.itemData["assoc_pjt_tlResources"].length>0?r.itemData["assoc_pjt_tlResources"][0].value:null;var y=r.itemData["assoc_pjt_tlResources"].length>0?('<span class="resource-title">'+r.itemData["assoc_pjt_tlResources"][0].displayValue+"</span>"):null;if(!s[B]){g.AddTaskItem(new JSGantt.TaskItem(B,y,null,null,"FFBC00","",0,"",0,1,0,1))}s[B]=true;var w=this.cache[x];if(!w){w=this.extractDates(r,q,true);this.cache[x]=w}r.itemData["prop_pjt_tlTaskName"].displayValue=r.itemData["dt_pjt_project"]["itemData"]["prop_bcpg_code"].displayValue+" - "+r.itemData["prop_pjt_tlTaskName"].displayValue;var v=this.getTaskTitle(r,null);g.AddTaskItem(new JSGantt.TaskItem(x,v,w.start,w.end,this.getTaskColor(r),null,t?1:0,z,p,0,B,1))}g.Draw();g.DrawDependencies()}else{Alfresco.util.populateHTML([this.id+"-gantt",'<div class="yui-dt-liner">'+this.msg("message.empty")+"</div>"])}};this.cache=[];this.extraAfterDataGridUpdate.push(o)},onFilterChanged:function a(o,n){var p=this.options.filter.filterId?this.options.filter:Alfresco.util.cleanBubblingObject(n[1]);if(p.filterId=="filterform"){this.widgets.filter.set("label",f(this.msg("filter."+p.filterId))+" "+Alfresco.constants.MENU_ARROW_SYMBOL)}else{if(p.filterId=="all"||p.filterId=="my-projects"){this.widgets.filter.set("label",f(this.msg("filter."+p.filterId))+" "+Alfresco.constants.MENU_ARROW_SYMBOL)}else{if(p.filterId=="tag"){this.widgets.filter.set("label",f(this.msg("filter."+p.filterId,p.filterData))+" "+Alfresco.constants.MENU_ARROW_SYMBOL)}else{this.widgets.filter.set("label",f(this.msg("filter."+p.filterId+(p.filterData?"."+p.filterData:""),p.filterData))+" "+Alfresco.constants.MENU_ARROW_SYMBOL)}}}},onMenuFilterChanged:function l(o,n){var p=n[1];if(p){var r=p.value;var q=this;q.widgets.filter.set("label",p.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);var s={filterOwner:q.name,filterId:r.split("|")[0]};if("all"!=s.filterId&&r.split("|").length>1){s.filterData=r.split("|")[1]}this.options.filter=s;this.services.preferences.set("org.alfresco.share.project.list."+(this.options.siteId!=null?this.options.siteId:"home")+".filter",this.options.filter);YAHOO.Bubbling.fire("changeFilter",s)}},onSimpleDetailed:function c(p,o){var n=Alfresco.util.cleanBubblingObject(o[1]);if(this.view=="dataTable"){if(n.simpleView){this.options.simpleView=true;this.options.columnFormId="datagrid-simple"}else{this.options.simpleView=false;this.options.columnFormId=null}this.populateDataGrid()}},onDataItemCreated:function m(q,p){var t=p[1];if(t&&(t.nodeRef!==null)){var r=new Alfresco.util.NodeRef(t.nodeRef),o=this.options.itemUrl+r.uri+((this.options.entityNodeRef!=null&&this.options.entityNodeRef.length>0)?"?entityNodeRef="+this.options.entityNodeRef+"&":"?")+"itemType="+encodeURIComponent(this.options.itemType!=null?this.options.itemType:this.datalistMeta.itemType)+"&dataListName="+encodeURIComponent(this.datalistMeta.name!=null?this.datalistMeta.name:this.options.list);Alfresco.util.Ajax.jsonPost({url:o,dataObj:this._buildDataGridParams(),successCallback:{fn:function n(u){if(u.json&&(u.json.item!==null)){var v=u.json.item;YAHOO.Bubbling.fire("changeFilter",filter={filterOwner:"Alfresco.component.AllFilter",filterId:"projects",filterData:v.itemData["prop_pjt_projectState"].value})}},scope:this},failureCallback:{fn:function s(u){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.create.refresh.failure")})},scope:this}})}}},true)})();