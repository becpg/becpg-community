(function(){var a=YAHOO.util.Dom,F=YAHOO.util.Event,v=YAHOO.util.Selector;var s=Alfresco.util.encodeHTML;var A="org.alfresco.share.project.catalog.dashlet",E=A+".filter",G=A+".view";PREFERENCES_PROJECT__DASHLET_SIMPLEVIEW=A+".simpleView";var c=Alfresco.util.generateDomId(null,"favouriteProject"),o=Alfresco.util.generateDomId(null,"show-more-twister");beCPG.dashlet.ProjectDashlet=function p(I){return beCPG.dashlet.ProjectDashlet.superclass.constructor.call(this,I)};YAHOO.extend(beCPG.dashlet.ProjectDashlet,Alfresco.component.SimpleDocList,{searchTerm:null,currentPage:1,queryExecutionId:null,onReady:function e(){this.widgets.view=Alfresco.util.createYUIButton(this,"views",this.onViewChange,{type:"menu",menu:"views-menu",lazyloadmenu:false});this.widgets.filter=Alfresco.util.createYUIButton(this,"filters",this.onFilterChange,{type:"menu",menu:"filters-menu",lazyloadmenu:false});var I=this.options.filter;I=Alfresco.util.arrayContains(this.options.validFilters,I)?I:this.options.validFilters[0];this.widgets.filter.set("label",this.msg("filter."+I)+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.filter.value=I;var Q=this.options.view;Q=Alfresco.util.arrayContains(this.options.validViews,Q)?Q:this.options.validViews[0];this.widgets.view.set("label",this.msg("view."+Q)+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.view.value=Q;this.widgets.simpleDetailed=new YAHOO.widget.ButtonGroup(this.id+"-simpleDetailed");if(this.widgets.simpleDetailed!==null){this.widgets.simpleDetailed.check(this.options.simpleView?0:1);this.widgets.simpleDetailed.on("checkedButtonChange",this.onSimpleDetailed,this.widgets.simpleDetailed,this)}this.configureSearch();a.removeClass(v.query(".toolbar div",this.id,true),"hidden");var P=this;this.widgets.previewTooltip=new YAHOO.widget.Tooltip(this.id+"-previewTooltip",{width:"108px"});this.widgets.previewTooltip.contextTriggerEvent.subscribe(function(X,V){var W=V[0],U=P.widgets.alfrescoDataTable.getData(W.id),Y=Alfresco.constants.PROXY_URI+"api/node/"+U.nodeRef.replace(":/","")+"/content/thumbnails/doclib?c=queue&ph=true";this.cfg.setProperty("text",'<img src="'+Y+'" />')});this.widgets.metadataTooltip=new YAHOO.widget.Tooltip(this.id+"-metadataTooltip");this.widgets.metadataTooltip.contextTriggerEvent.subscribe(function(X,V){var W=V[0],U=P.widgets.alfrescoDataTable.getRecord(W.id).getData();var Y="<em>"+P.msg("label.site")+":</em> "+s(U.site.title)+"<br />";Y+="<em>"+P.msg("label.path")+":</em> "+s(U.path);this.cfg.setProperty("text",Y)});this.widgets.dataSource=new YAHOO.util.DataSource(this.getWebscriptUrl(),{connMethodPost:false,responseType:YAHOO.util.DataSource.TYPE_JSON,responseSchema:{resultsList:"items",metaFields:{startIndex:"startIndex",totalRecords:"totalRecords",queryExecutionId:"queryExecutionId"}}});var R=[{key:"thumbnail",sortable:false,formatter:this.bind(this.renderCellThumbnail),width:16},{key:"detail",sortable:false,formatter:this.bind(this.renderCellDetail)}];this.widgets.alfrescoDataTable=new YAHOO.widget.DataTable(this.id+"-documents",R,this.widgets.dataSource,{initialLoad:false,dynamicData:false,MSG_EMPTY:'<span class="wait">'+s(this.msg("message.loading"))+"</span>",MSG_ERROR:this.msg("message.error"),className:"alfresco-datatable simple-doclist",renderLoopSize:4,paginator:null});this.widgets.alfrescoDataTable.getDataTable=function(){return this};this.widgets.alfrescoDataTable.getData=function(U){return this.getRecord(U).getData()};this.widgets.paginator=new YAHOO.widget.Paginator({containers:[this.id+"-paginator"],rowsPerPage:this.options.maxItems,initialPage:1,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});var L=function M(V,U){U.currentPage=V.page;U.reloadDataTable()};this.widgets.paginator.subscribe("changeRequest",L,this);this.widgets.paginator.render();this.widgets.alfrescoDataTable.loadDataTable=function K(V){P.widgets.dataSource.connMgr.setDefaultPostHeader(Alfresco.util.Ajax.JSON);var W=V;if(!W){W=scopeParameters}P.widgets.dataSource.sendRequest("&metadata="+encodeURIComponent(YAHOO.lang.JSON.stringify(W)),{success:function U(Y,X,Z){P.widgets.alfrescoDataTable.onDataReturnReplaceRows(Y,X,Z);if(P.widgets.paginator){P.widgets.paginator.set("totalRecords",X.meta.totalRecords);P.widgets.paginator.setPage(X.meta.startIndex,true)}P.queryExecutionId=X.meta.queryExecutionId},failure:P.widgets.alfrescoDataTable.onDataReturnReplaceRows,scope:P.widgets.alfrescoDataTable,argument:{}})};var J=this.widgets.alfrescoDataTable,O=J.doBeforeLoadData;J.doBeforeLoadData=function T(U,V,W){if(V.results&&V.results.length===0){V.results.unshift({isInfo:true,title:P.msg("empty.project.title"),description:P.msg("empty.project.description")})}return O.apply(this,arguments)};J.subscribe("renderEvent",function(){this.widgets.previewTooltip.cfg.setProperty("context",this.previewTooltips)},this,true);var N=function S(W,V){var U=YAHOO.Bubbling.getOwnerByTagName(V[1].anchor,"div");if(U!==null){P.onFavourite.call(P,V[1].target.offsetParent,U)}return true};YAHOO.Bubbling.addDefaultAction(c,N);YAHOO.Bubbling.addDefaultAction(o,this.onActionShowMore);this.initTaskHandlers();this.reloadDataTable()},getWebscriptUrl:function h(){if(Alfresco.constants.SITE!==null&&Alfresco.constants.SITE.length>0){return Alfresco.constants.PROXY_URI+"becpg/entity/datalists/data/node?itemType=pjt:project&site="+Alfresco.constants.SITE+"&pageSize="+this.options.maxItems+"&dataListName=projectList&container=documentLibrary&repo=false"}return Alfresco.constants.PROXY_URI+"becpg/entity/datalists/data/node?itemType=pjt:project&pageSize="+this.options.maxItems+"&dataListName=projectList&repo=true"},getParameters:function l(){var J=this.widgets.view.value.indexOf("task")>-1,K="cm:name";if(J){if(this.widgets.filter.value=="InProgress"){K="pjt:tlEnd|true"}else{if(this.widgets.filter.value=="Planned"){K="pjt:tlStart|true"}else{K="pjt:tlEnd|false"}}}var M="fts(";if(this.widgets.filter.value!="All"){M+=" +@pjt\\:"+(J?"tl":"project")+'State:"'+this.widgets.filter.value+'"'}else{M+=" +@pjt\\:"+(J?"tl":"project")+'State:"*"'}if(this.searchTerm!==null&&this.searchTerm.length>0){M+="AND  +@"+(J?"pjt\\:tlTaskName":"cm\\:name")+":("+this.searchTerm+")"}M+=")";var I={project:["pjt_projectOverdue","pjt_projectHierarchy1","pjt_projectHierarchy2","pjt_completionPercent","bcpg_code","cm_name","pjt_taskList|pjt_tlTaskName|pjt_tlDuration|pjt_tlRealDuration|pjt_tlPrevTasks|pjt_tlState|pjt_completionPercent|pjt_tlStart|pjt_tlEnd|pjt_tlWorkflowInstance|fm_commentCount","pjt_deliverableList|pjt_dlDescription|pjt_dlContent|pjt_dlState|pjt_dlScriptExecOrder|fm_commentCount","pjt_projectManager","pjt_projectStartDate","pjt_projectCompletionDate","pjt_projectDueDate","pjt_projectState"],"project-simple":["pjt_projectOverdue","pjt_projectHierarchy1","pjt_projectHierarchy2","pjt_completionPercent","bcpg_code","cm_name","pjt_projectManager","pjt_projectStartDate","pjt_projectCompletionDate","pjt_projectDueDate","pjt_projectState"],task:["pjt_tlTaskName","pjt_tlDuration","pjt_tlRealDuration","pjt_tlResources","pjt_tlTaskLegend","pjt_tlState","pjt_completionPercent","pjt_tlStart","pjt_tlEnd","pjt_tlWorkflowInstance","fm_commentCount","pjt_project|cm_name|pjt_projectHierarchy1|pjt_projectHierarchy2|pjt_completionPercent|bcpg_code"]};var L={fields:I[J?"task":("project"+(this.options.simpleView?"-simple":""))],page:this.currentPage,sort:K,queryExecutionId:this.queryExecutionId,filter:{filterId:this.widgets.view.value,filterOwner:"Alfresco.component.AllFilter",filterData:this.widgets.filter.value,filterParams:M}};return L},onFilterChange:function b(J,I){var K=I[1];if(K){this.widgets.filter.set("label",K.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.filter.value=K.value;this.currentPage=1;this.services.preferences.set(E,this.widgets.filter.value);this._cleanSearchText();this.reloadDataTable()}},onViewChange:function H(J,I){var K=I[1];if(K){this.widgets.view.set("label",K.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.view.value=K.value;this.currentPage=1;this.services.preferences.set(G,this.widgets.view.value);this._cleanSearchText();this.reloadDataTable()}},_cleanSearchText:function B(){var I=this.getSearchText();if(I.indexOf("*")>0&&I.replace(/\*/g,"").length<3){this.searchTerm=null}else{this.searchTerm=I}},onSimpleDetailed:function y(I,J){this.options.simpleView=I.newValue.index===0;this.services.preferences.set(PREFERENCES_PROJECT__DASHLET_SIMPLEVIEW,this.options.simpleView);if(I){F.preventDefault(I)}this.reloadDataTable()},renderCellThumbnail:function z(T,W,P,J){var K=40,M=W.getData(),O="";if(M.isInfo){K=52;O='<img class="icon32" src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/help-docs-bw-32.png" />'}else{var R=this.widgets.view.value.indexOf("task")>-1;if(R){M=M.itemData.dt_pjt_project}M.jsNode={};M.jsNode.type=M.itemType;var L=M.itemData.prop_cm_name.value,V=M.site!=null?M.site.shortName:null,Q=M.itemType.substring(M.itemType.lastIndexOf(":")+1),S=new Alfresco.util.NodeRef(M.nodeRef),U=beCPG.util.entityURL(V,M.nodeRef,M.itemType);if(this.options.simpleView){var I=this.id+"-preview-"+W.getId();if(R){O='<span id="'+I+'" class="icon32"><a href="'+U+'"><img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/filetypes/"+Alfresco.util.getFileIcon(L,M.itemType)+'" alt="'+Q+'" title="'+s(L)+'" /></a></span>'}else{var N=M.itemData.prop_pjt_projectOverdue!=null?s(M.itemData.prop_pjt_projectOverdue.displayValue)+"&nbsp;"+this.msg("overdue.day"):"";O='<span class="center '+this.getOverdueClass(M,32)+'" title="'+N+'">&nbsp;</span>'}this.previewTooltips.push(I)}else{K=100;O='<span class="thumbnail"><a href="'+U+'"><img src="'+Alfresco.constants.PROXY_URI+"api/node/"+S.uri+'/content/thumbnails/doclib?c=queue&ph=true" alt="'+Q+'" title="'+s(L)+'" /></a></span>'}}P.width=K;a.setStyle(T,"width",P.width+"px");a.setStyle(T.parentNode,"width",P.width+"px");T.innerHTML=O},renderCellDetail:function g(S,U,O,J){var M=U.getData(),N="",Q="";if(M.isInfo){N+='<div class="empty"><h3>'+M.title+"</h3>";N+="<span>"+M.description+"</span></div>"}else{var P=this.widgets.view.value.indexOf("task")>-1;var I=this.extractDates(M,null,P),L=I.due;Q+=(I.start?Alfresco.util.formatDate(I.start,"longDate"):scope.msg("label.none"));if(I.end!=null){L=I.end}Q+=" - ";Q+=(I.start?Alfresco.util.formatDate(L,"longDate"):scope.msg("label.none"));if(P){if(!this.options.simpleView){N+='<h3 class="filename">';N+=this.getTaskTitle(M,M.itemData.dt_pjt_project.nodeRef,null,true);N+="</h3>"}else{N+='<h3 class="filename simple-view">'+this.getTaskTitle(M,M.itemData.dt_pjt_project.nodeRef)+"</h3>"}N+='<div class="detail">';N+='<span class="project-date">[ '+Q+" ]</span>";N+='<span class="project">';N+=this.getProjectTitle(M.itemData.dt_pjt_project);N+="</span>";if(!this.options.simpleView){N+=this.renderResourcesList(U)}N+="</div>"}else{var T=M.site!=null?M.site.shortName:null;if(this.options.simpleView){N+='<h3 class="filename simple-view">'+this.getProjectTitle(M,true,false)+"</h3>";N+='<div class="detail">';N+='<span class="project-date">[ '+Q+" ]</span>";N+='<span class="hierachy">';if(M.itemData.prop_pjt_projectHierarchy1&&M.itemData.prop_pjt_projectHierarchy1.displayValue!=null){N+=M.itemData.prop_pjt_projectHierarchy1.displayValue}if(M.itemData.prop_pjt_projectHierarchy2&&M.itemData.prop_pjt_projectHierarchy2.displayValue!=null){N+=" - "+M.itemData.prop_pjt_projectHierarchy2.displayValue}N+="</span>"}else{N+='<h3 class="filename">'+this.getProjectTitle(M,true,true)+"</h3>";N+=this.renderProjectManager(U);N+='<div class="detail">';N+='<span class="project-date">[ '+Q+" ]</span>";N+='<span class="hierachy">';if(M.itemData.prop_pjt_projectHierarchy1&&M.itemData.prop_pjt_projectHierarchy1.displayValue!=null){N+=M.itemData.prop_pjt_projectHierarchy1.displayValue}if(M.itemData.prop_pjt_projectHierarchy2&&M.itemData.prop_pjt_projectHierarchy2.displayValue!=null){N+=" - "+M.itemData.prop_pjt_projectHierarchy2.displayValue}N+="</span>";N+=this.renderTaskList(U);N+=this.renderDeliverableList(U);N+="</div>";var K=beCPG.util.entityURL(T,M.nodeRef,M.itemType),R=beCPG.util.entityDocumentsURL(T,M.path,M.itemData.prop_cm_name.value);N+='<div class="detail detail-social">';N+='<span class="item item-social">'+this.generateFavourite(this,U)+"</span>";N+='<span class="item item-social item-separator"><a class="view-documents" href="'+R+'"  title="'+this.msg("actions.entity.view-documents")+'" tabindex="0">'+this.msg("actions.entity.view-documents.short")+"</a></span>";N+='<span class="item item-social item-separator"><a class="view-characts" href="'+K+'" title="'+this.msg("actions.entity.view-tasks")+'" tabindex="0">'+this.msg("actions.entity.view-tasks.short")+"</a></span>";N+="</div>"}}}S.innerHTML=N},generateFavourite:function w(K,I){var L="favourite.document.",J="";if(I.getData("isFavourite")){J='<a class="favourite-action '+c+' enabled" title="'+K.msg(L+"remove.tip")+'" tabindex="0"></a>'}else{J='<a class="favourite-action '+c+'" title="'+K.msg(L+"add.tip")+'" tabindex="0">'+K.msg(L+"add.label")+"</a>"}return J},renderResourcesList:function x(J){var L=J.getData("itemData")["assoc_pjt_tlResources"];var I='<ul class="task-resources">';for(j in L){var K=L[j];I+="<li>";I+='<span class="avatar" title="'+K.displayValue+'">';I+=Alfresco.Share.userAvatar(K.metadata,32);I+="</span></li>"}I+="</ul>";return I},renderProjectManager:function x(J){var K=J.getData("itemData")["assoc_pjt_projectManager"];var I="";if(K&&K[0]){I+='<div class="project-manager avatar" title="'+K[0].displayValue+'">';I+=Alfresco.Share.userAvatar(K[0].metadata,16);I+="</div>"}return I},renderTaskList:function C(L){var M=L.getData("itemData")["dt_pjt_taskList"];var K='<ul class="hidden">',I=0;for(j in M){var J=M[j];if(J.itemData["prop_pjt_tlState"].value==this.widgets.filter.value){I++;K+="<li>"+this.getTaskTitle(J,L.getData().nodeRef)+"</li>"}}K+="</ul>";return'<div ><a class="alfresco-twister alfresco-twister-closed '+o+'">'+this.msg("show.tasks")+"("+I+")</a>"+K+"</div>"},renderDeliverableList:function r(N){var J=N.getData("itemData")["dt_pjt_deliverableList"],I=0;var L='<ul class="hidden">';for(j in J){var K=J[j],M=K.itemData["prop_pjt_dlScriptExecOrder"].value;if(K.itemData["prop_pjt_dlState"].value==this.widgets.filter.value&&(M==null||M.length==0||M=="None")){I++;L+="<li>"+this.getDeliverableTitle(K,N.getData().nodeRef)+"</li>"}}L+="</ul>";return'<div ><a class="alfresco-twister alfresco-twister-closed '+o+'">'+this.msg("show.deliverables")+"("+I+")</a>"+L+"</div>"},onActionShowMore:function k(K,J){var I=J[1].anchor;elPanel=a.getNextSibling(I);if(a.hasClass(I,"alfresco-twister-closed")){a.removeClass(elPanel,"hidden");a.replaceClass(I,"alfresco-twister-closed","alfresco-twister-open")}else{a.addClass(elPanel,"hidden");a.replaceClass(I,"alfresco-twister-open","alfresco-twister-closed")}},generateFavourite:function w(K,I){var L="favourite.document.",J="";if(I.getData("isFavourite")){J='<a class="favourite-action '+K.substitute(c)+' enabled" title="'+K.msg(L+"remove.tip")+'" tabindex="0"></a>'}else{J='<a class="favourite-action '+K.substitute(c)+'" title="'+K.msg(L+"add.tip")+'" tabindex="0">'+K.msg(L+"add.label")+"</a>"}return J},onFavourite:function u(M){var I=this.widgets.alfrescoDataTable.getRecord(M),K=I.getData(),L=K.nodeRef;K.isFavourite=!K.isFavourite;this.widgets.alfrescoDataTable.getDataTable().updateRow(I,K);var J={failureCallback:{fn:function N(R,O){var P=this.widgets.alfrescoDataTable.getRecord(O),Q=P.getData();Q.isFavourite=!Q.isFavourite;this.widgets.alfrescoDataTable.getDataTable().updateRow(P,Q);Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.save.failure",Q.displayName)})},scope:this,obj:M}};this.services.preferences[K.isFavourite?"add":"remove"].call(this.services.preferences,Alfresco.service.Preferences.FAVOURITE_FOLDERS,L,J)},substitute:function q(I){return YAHOO.lang.substitute(I,{site:Alfresco.constants.SITE!==null&&Alfresco.constants.SITE.length>0?"."+Alfresco.constants.SITE:""})},configureSearch:function d(){this.widgets.searchBox=a.get(this.id+"-searchText");this.defaultSearchText=this.msg("header.search.default");F.addListener(this.widgets.searchBox,"focus",this.onSearchFocus,null,this);F.addListener(this.widgets.searchBox,"blur",this.onSearchBlur,null,this);this.setDefaultSearchText();var I=this;this.widgets.searchEnterListener=new YAHOO.util.KeyListener(this.widgets.searchBox,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:I.onSearchChange,scope:this,correctScope:true},"keydown").enable();this.widgets.searchMore=new YAHOO.widget.Button(this.id+"-search_more",{type:"menu",menu:this.id+"-searchmenu_more"})},onSearchFocus:function t(){if(this.widgets.searchBox.value==this.defaultSearchText){a.removeClass(this.widgets.searchBox,"faded");this.widgets.searchBox.value=""}else{this.widgets.searchBox.select()}},onSearchBlur:function n(){var I=YAHOO.lang.trim(this.widgets.searchBox.value);if(I.length===0){YAHOO.lang.later(100,this,this.setDefaultSearchText,[])}},setDefaultSearchText:function D(){a.addClass(this.widgets.searchBox,"faded");this.widgets.searchBox.value=this.defaultSearchText},getSearchText:function i(){var I=YAHOO.lang.trim(this.widgets.searchBox.value);if(I!=this.defaultSearchText){return I}return""},onSearchChange:function f(){this.currentPage=1;this._cleanSearchText();this.reloadDataTable()},_showPanel:function m(K,L,J){var I=this;Alfresco.util.Ajax.request({url:K,dataObj:{htmlid:L},successCallback:{fn:function(M){var O=document.createElement("div");O.innerHTML=M.serverResponse.responseText;var N=a.getFirstChild(O);this.widgets.panel=Alfresco.util.createYUIPanel(N,{draggable:true,width:"50em"});this.widgets.panel.subscribe("hide",function(){I.reloadDataTable()});this.widgets.panel.show()},scope:this},failureMessage:"Could not load dialog template from '"+K+"'.",scope:this,execScripts:true})}});YAHOO.lang.augmentProto(beCPG.dashlet.ProjectDashlet,beCPG.component.ProjectCommons)})();