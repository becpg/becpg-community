(function(){var a=YAHOO.util.Dom,D=YAHOO.util.Event,t=YAHOO.util.Selector;var r=Alfresco.util.encodeHTML;var y="org.alfresco.share.project.catalog.dashlet",C=y+".filter",E=y+".view";PREFERENCES_PROJECT__DASHLET_SIMPLEVIEW=y+".simpleView";var c=Alfresco.util.generateDomId(null,"favouriteProject"),o=Alfresco.util.generateDomId(null,"show-more-twister");beCPG.dashlet.ProjectDashlet=function p(G){return beCPG.dashlet.ProjectDashlet.superclass.constructor.call(this,G)};YAHOO.extend(beCPG.dashlet.ProjectDashlet,Alfresco.component.SimpleDocList,{searchTerm:null,currentPage:1,queryExecutionId:null,onReady:function e(){this.widgets.view=Alfresco.util.createYUIButton(this,"views",this.onViewChange,{type:"menu",menu:"views-menu",lazyloadmenu:false});this.widgets.filter=Alfresco.util.createYUIButton(this,"filters",this.onFilterChange,{type:"menu",menu:"filters-menu",lazyloadmenu:false});var G=this.options.filter;G=Alfresco.util.arrayContains(this.options.validFilters,G)?G:this.options.validFilters[0];this.widgets.filter.set("label",this.msg("filter."+G)+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.filter.value=G;var O=this.options.view;O=Alfresco.util.arrayContains(this.options.validViews,O)?O:this.options.validViews[0];this.widgets.view.set("label",this.msg("view."+O)+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.view.value=O;this.widgets.simpleDetailed=new YAHOO.widget.ButtonGroup(this.id+"-simpleDetailed");if(this.widgets.simpleDetailed!==null){this.widgets.simpleDetailed.check(this.options.simpleView?0:1);this.widgets.simpleDetailed.on("checkedButtonChange",this.onSimpleDetailed,this.widgets.simpleDetailed,this)}this.configureSearch();a.removeClass(t.query(".toolbar div",this.id,true),"hidden");var N=this;this.widgets.previewTooltip=new YAHOO.widget.Tooltip(this.id+"-previewTooltip",{width:"108px"});this.widgets.previewTooltip.contextTriggerEvent.subscribe(function(V,T){var U=T[0],S=N.widgets.alfrescoDataTable.getData(U.id),W=Alfresco.constants.PROXY_URI+"api/node/"+S.nodeRef.replace(":/","")+"/content/thumbnails/doclib?c=queue&ph=true";this.cfg.setProperty("text",'<img src="'+W+'" />')});this.widgets.metadataTooltip=new YAHOO.widget.Tooltip(this.id+"-metadataTooltip");this.widgets.metadataTooltip.contextTriggerEvent.subscribe(function(V,T){var U=T[0],S=N.widgets.alfrescoDataTable.getRecord(U.id).getData();var W="<em>"+N.msg("label.site")+":</em> "+r(S.site.title)+"<br />";W+="<em>"+N.msg("label.path")+":</em> "+r(S.path);this.cfg.setProperty("text",W)});this.widgets.dataSource=new YAHOO.util.DataSource(this.getWebscriptUrl(),{connMethodPost:false,responseType:YAHOO.util.DataSource.TYPE_JSON,responseSchema:{resultsList:"items",metaFields:{startIndex:"startIndex",totalRecords:"totalRecords",queryExecutionId:"queryExecutionId"}}});var P=[{key:"thumbnail",sortable:false,formatter:this.bind(this.renderCellThumbnail),width:16},{key:"detail",sortable:false,formatter:this.bind(this.renderCellDetail)}];this.widgets.alfrescoDataTable=new YAHOO.widget.DataTable(this.id+"-documents",P,this.widgets.dataSource,{initialLoad:false,dynamicData:false,MSG_EMPTY:'<span class="wait">'+r(this.msg("message.loading"))+"</span>",MSG_ERROR:this.msg("message.error"),className:"alfresco-datatable simple-doclist",renderLoopSize:4,paginator:null});this.widgets.alfrescoDataTable.getDataTable=function(){return this};this.widgets.alfrescoDataTable.getData=function(S){return this.getRecord(S).getData()};this.widgets.paginator=new YAHOO.widget.Paginator({containers:[this.id+"-paginator"],rowsPerPage:this.options.maxItems,initialPage:1,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});var J=function K(T,S){S.currentPage=T.page;S.reloadDataTable()};this.widgets.paginator.subscribe("changeRequest",J,this);this.widgets.paginator.render();this.widgets.alfrescoDataTable.loadDataTable=function I(T){N.widgets.dataSource.connMgr.setDefaultPostHeader(Alfresco.util.Ajax.JSON);var U=T;if(!U){U=scopeParameters}N.widgets.dataSource.sendRequest("&metadata="+encodeURIComponent(YAHOO.lang.JSON.stringify(U)),{success:function S(W,V,X){N.widgets.alfrescoDataTable.onDataReturnReplaceRows(W,V,X);if(N.widgets.paginator){N.widgets.paginator.set("totalRecords",V.meta.totalRecords);N.widgets.paginator.setPage(V.meta.startIndex,true)}N.queryExecutionId=V.meta.queryExecutionId},failure:N.widgets.alfrescoDataTable.onDataReturnReplaceRows,scope:N.widgets.alfrescoDataTable,argument:{}})};var H=this.widgets.alfrescoDataTable,M=H.doBeforeLoadData;H.doBeforeLoadData=function R(S,T,U){if(T.results&&T.results.length===0){T.results.unshift({isInfo:true,title:N.msg("empty.project.title"),description:N.msg("empty.project.description")})}return M.apply(this,arguments)};H.subscribe("renderEvent",function(){this.widgets.previewTooltip.cfg.setProperty("context",this.previewTooltips)},this,true);var L=function Q(U,T){var S=YAHOO.Bubbling.getOwnerByTagName(T[1].anchor,"div");if(S!==null){N.onFavourite.call(N,T[1].target.offsetParent,S)}return true};YAHOO.Bubbling.addDefaultAction(c,L);YAHOO.Bubbling.addDefaultAction(o,this.onActionShowMore);this.initTaskHandlers();this.reloadDataTable()},getWebscriptUrl:function h(){if(Alfresco.constants.SITE!==null&&Alfresco.constants.SITE.length>0){return Alfresco.constants.PROXY_URI+"becpg/entity/datalists/data/node?itemType=pjt:project&site="+Alfresco.constants.SITE+"&pageSize="+this.options.maxItems+"&dataListName=projectList&container=documentLibrary&repo=false"}return Alfresco.constants.PROXY_URI+"becpg/entity/datalists/data/node?itemType=pjt:project&pageSize="+this.options.maxItems+"&dataListName=projectList&repo=true"},getParameters:function l(){var H=this.widgets.view.value.indexOf("task")>-1,I="cm:name";if(H){if(this.widgets.filter.value=="InProgress"){I="pjt:tlEnd|true"}else{if(this.widgets.filter.value=="Planned"){I="pjt:tlStart|true"}else{I="pjt:tlEnd|false"}}}var K="fts(";if(this.widgets.filter.value!="All"){K+=" +@pjt\\:"+(H?"tl":"project")+'State:"'+this.widgets.filter.value+'"'}else{K+=" +@pjt\\:"+(H?"tl":"project")+'State:"*"'}if(this.searchTerm!==null&&this.searchTerm.length>0){K+="AND  +@"+(H?"pjt\\:tlTaskName":"cm\\:name")+":("+this.searchTerm+")"}K+=")";var G={project:["pjt_projectOverdue","pjt_projectHierarchy1","pjt_projectHierarchy2","pjt_completionPercent","bcpg_code","cm_name","pjt_taskList|pjt_tlTaskName|pjt_tlDuration|pjt_tlRealDuration|pjt_tlPrevTasks|pjt_tlState|pjt_completionPercent|pjt_tlStart|pjt_tlEnd|pjt_tlWorkflowInstance|fm_commentCount","pjt_deliverableList|pjt_dlDescription|pjt_dlContent|pjt_dlState|pjt_dlScriptExecOrder|fm_commentCount","pjt_projectManager","pjt_projectStartDate","pjt_projectCompletionDate","pjt_projectDueDate","pjt_projectState"],"project-simple":["pjt_projectOverdue","pjt_projectHierarchy1","pjt_projectHierarchy2","pjt_completionPercent","bcpg_code","cm_name","pjt_projectManager","pjt_projectStartDate","pjt_projectCompletionDate","pjt_projectDueDate","pjt_projectState"],task:["pjt_tlTaskName","pjt_tlDuration","pjt_tlRealDuration","pjt_tlResources","pjt_tlTaskLegend","pjt_tlState","pjt_completionPercent","pjt_tlStart","pjt_tlEnd","pjt_tlWorkflowInstance","fm_commentCount","pjt_project|cm_name|pjt_projectHierarchy1|pjt_projectHierarchy2|pjt_completionPercent|bcpg_code"]};var J={fields:G[H?"task":("project"+(this.options.simpleView?"-simple":""))],page:this.currentPage,sort:I,queryExecutionId:this.queryExecutionId,filter:{filterId:this.widgets.view.value,filterOwner:"Alfresco.component.AllFilter",filterData:this.widgets.filter.value,filterParams:K}};return J},onFilterChange:function b(H,G){var I=G[1];if(I){this.widgets.filter.set("label",I.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.filter.value=I.value;this.currentPage=1;this.services.preferences.set(C,this.widgets.filter.value);this._cleanSearchText();this.reloadDataTable()}},onViewChange:function F(H,G){var I=G[1];if(I){this.widgets.view.set("label",I.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.view.value=I.value;this.currentPage=1;this.services.preferences.set(E,this.widgets.view.value);this._cleanSearchText();this.reloadDataTable()}},_cleanSearchText:function z(){var G=this.getSearchText();if(G.indexOf("*")>0&&G.replace(/\*/g,"").length<3){this.searchTerm=null}else{this.searchTerm=G}},onSimpleDetailed:function w(G,H){this.options.simpleView=G.newValue.index===0;this.services.preferences.set(PREFERENCES_PROJECT__DASHLET_SIMPLEVIEW,this.options.simpleView);if(G){D.preventDefault(G)}this.reloadDataTable()},renderCellThumbnail:function x(R,U,N,H){var I=40,K=U.getData(),M="";if(K.isInfo){I=52;M='<img class="icon32" src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/help-docs-bw-32.png" />'}else{var P=this.widgets.view.value.indexOf("task")>-1;if(P){K=K.itemData.dt_pjt_project}K.jsNode={};K.jsNode.type=K.itemType;var J=K.itemData.prop_cm_name.value,T=K.site!=null?K.site.shortName:null,O=K.itemType.substring(K.itemType.lastIndexOf(":")+1),Q=new Alfresco.util.NodeRef(K.nodeRef),S=beCPG.util.entityURL(T,K.nodeRef,K.itemType);if(this.options.simpleView){var G=this.id+"-preview-"+U.getId();if(P){M='<span id="'+G+'" class="icon32"><a href="'+S+'"><img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/filetypes/"+Alfresco.util.getFileIcon(J,K.itemType)+'" alt="'+O+'" title="'+r(J)+'" /></a></span>'}else{var L=K.itemData.prop_pjt_projectOverdue!=null?r(K.itemData.prop_pjt_projectOverdue.displayValue)+"&nbsp;"+this.msg("overdue.day"):"";M='<span class="center '+this.getOverdueClass(K,32)+'" title="'+L+'">&nbsp;</span>'}this.previewTooltips.push(G)}else{I=100;M='<span class="thumbnail"><a href="'+S+'"><img src="'+Alfresco.constants.PROXY_URI+"api/node/"+Q.uri+'/content/thumbnails/doclib?c=queue&ph=true" alt="'+O+'" title="'+r(J)+'" /></a></span>'}}N.width=I;a.setStyle(R,"width",N.width+"px");a.setStyle(R.parentNode,"width",N.width+"px");R.innerHTML=M},renderCellDetail:function g(Q,S,M,H){var K=S.getData(),L="",O="";if(K.isInfo){L+='<div class="empty"><h3>'+K.title+"</h3>";L+="<span>"+K.description+"</span></div>"}else{var N=this.widgets.view.value.indexOf("task")>-1;var G=this.extractDates(K,null,N),J=G.due;O+=(G.start?Alfresco.util.formatDate(G.start,"longDate"):scope.msg("label.none"));if(G.end!=null){J=G.end}O+=" - ";O+=(G.start?Alfresco.util.formatDate(J,"longDate"):scope.msg("label.none"));if(N){if(!this.options.simpleView){L+='<h3 class="filename">';L+=this.getTaskTitle(K,K.itemData.dt_pjt_project.nodeRef,null,true);L+="</h3>"}else{L+='<h3 class="filename simple-view">'+this.getTaskTitle(K,K.itemData.dt_pjt_project.nodeRef)+"</h3>"}L+='<div class="detail">';L+='<span class="project-date">[ '+O+" ]</span>";L+='<span class="project">';L+=this.getProjectTitle(K.itemData.dt_pjt_project);L+="</span>";if(!this.options.simpleView){L+=this.renderResourcesList(S)}L+="</div>"}else{var R=K.site!=null?K.site.shortName:null;if(this.options.simpleView){L+='<h3 class="filename simple-view">'+this.getProjectTitle(K,true,false)+"</h3>";L+='<div class="detail">';L+='<span class="project-date">[ '+O+" ]</span>";L+='<span class="hierachy">';if(K.itemData.prop_pjt_projectHierarchy1&&K.itemData.prop_pjt_projectHierarchy1.displayValue!=null){L+=K.itemData.prop_pjt_projectHierarchy1.displayValue}if(K.itemData.prop_pjt_projectHierarchy2&&K.itemData.prop_pjt_projectHierarchy2.displayValue!=null){L+=" - "+K.itemData.prop_pjt_projectHierarchy2.displayValue}L+="</span>"}else{L+='<h3 class="filename">'+this.getProjectTitle(K,true,true)+"</h3>";L+=this.renderProjectManager(S);L+='<div class="detail">';L+='<span class="project-date">[ '+O+" ]</span>";L+='<span class="hierachy">';if(K.itemData.prop_pjt_projectHierarchy1&&K.itemData.prop_pjt_projectHierarchy1.displayValue!=null){L+=K.itemData.prop_pjt_projectHierarchy1.displayValue}if(K.itemData.prop_pjt_projectHierarchy2&&K.itemData.prop_pjt_projectHierarchy2.displayValue!=null){L+=" - "+K.itemData.prop_pjt_projectHierarchy2.displayValue}L+="</span>";L+=this.renderTaskList(S);L+=this.renderDeliverableList(S);L+="</div>";var I=beCPG.util.entityURL(R,K.nodeRef,K.itemType),P=beCPG.util.entityDocumentsURL(R,K.path,K.itemData.prop_cm_name.value);L+='<div class="detail detail-social">';L+='<span class="item item-social">'+this.generateFavourite(this,S)+"</span>";L+='<span class="item item-social item-separator"><a class="view-documents" href="'+P+'"  title="'+this.msg("actions.entity.view-documents")+'" tabindex="0">'+this.msg("actions.entity.view-documents.short")+"</a></span>";L+='<span class="item item-social item-separator"><a class="view-characts" href="'+I+'" title="'+this.msg("actions.entity.view-tasks")+'" tabindex="0">'+this.msg("actions.entity.view-tasks.short")+"</a></span>";L+="</div>"}}}Q.innerHTML=L},generateFavourite:function u(I,G){var J="favourite.document.",H="";if(G.getData("isFavourite")){H='<a class="favourite-action '+c+' enabled" title="'+I.msg(J+"remove.tip")+'" tabindex="0"></a>'}else{H='<a class="favourite-action '+c+'" title="'+I.msg(J+"add.tip")+'" tabindex="0">'+I.msg(J+"add.label")+"</a>"}return H},renderResourcesList:function v(H){var J=H.getData("itemData")["assoc_pjt_tlResources"];var G='<ul class="task-resources">';for(j in J){var I=J[j];G+="<li>";G+='<span class="avatar" title="'+I.displayValue+'">';G+=Alfresco.Share.userAvatar(I.metadata,32);G+="</span></li>"}G+="</ul>";return G},renderProjectManager:function v(H){var I=H.getData("itemData")["assoc_pjt_projectManager"];var G="";if(I&&I[0]){G+='<div class="project-manager avatar" title="'+I[0].displayValue+'">';G+=Alfresco.Share.userAvatar(I[0].metadata,16);G+="</div>"}return G},renderTaskList:function A(J){var K=J.getData("itemData")["dt_pjt_taskList"];var I='<ul class="hidden">',G=0;for(j in K){var H=K[j];if(H.itemData["prop_pjt_tlState"].value==this.widgets.filter.value){G++;I+="<li>"+this.getTaskTitle(H,J.getData().nodeRef)+"</li>"}}I+="</ul>";return'<div ><a class="alfresco-twister alfresco-twister-closed '+o+'">'+this.msg("show.tasks")+"("+G+")</a>"+I+"</div>"},renderDeliverableList:function q(L){var H=L.getData("itemData")["dt_pjt_deliverableList"],G=0;var J='<ul class="hidden">';for(j in H){var I=H[j],K=I.itemData["prop_pjt_dlScriptExecOrder"].value;if(I.itemData["prop_pjt_dlState"].value==this.widgets.filter.value&&(K==null||K.length==0||K=="None")){G++;J+="<li>"+this.getDeliverableTitle(I,L.getData().nodeRef)+"</li>"}}J+="</ul>";return'<div ><a class="alfresco-twister alfresco-twister-closed '+o+'">'+this.msg("show.deliverables")+"("+G+")</a>"+J+"</div>"},onActionShowMore:function k(I,H){var G=H[1].anchor;elPanel=a.getNextSibling(G);if(a.hasClass(G,"alfresco-twister-closed")){a.removeClass(elPanel,"hidden");a.replaceClass(G,"alfresco-twister-closed","alfresco-twister-open")}else{a.addClass(elPanel,"hidden");a.replaceClass(G,"alfresco-twister-open","alfresco-twister-closed")}},configureSearch:function d(){this.widgets.searchBox=a.get(this.id+"-searchText");this.defaultSearchText=this.msg("header.search.default");D.addListener(this.widgets.searchBox,"focus",this.onSearchFocus,null,this);D.addListener(this.widgets.searchBox,"blur",this.onSearchBlur,null,this);this.setDefaultSearchText();var G=this;this.widgets.searchEnterListener=new YAHOO.util.KeyListener(this.widgets.searchBox,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:G.onSearchChange,scope:this,correctScope:true},"keydown").enable();this.widgets.searchMore=new YAHOO.widget.Button(this.id+"-search_more",{type:"menu",menu:this.id+"-searchmenu_more"})},onSearchFocus:function s(){if(this.widgets.searchBox.value==this.defaultSearchText){a.removeClass(this.widgets.searchBox,"faded");this.widgets.searchBox.value=""}else{this.widgets.searchBox.select()}},onSearchBlur:function n(){var G=YAHOO.lang.trim(this.widgets.searchBox.value);if(G.length===0){YAHOO.lang.later(100,this,this.setDefaultSearchText,[])}},setDefaultSearchText:function B(){a.addClass(this.widgets.searchBox,"faded");this.widgets.searchBox.value=this.defaultSearchText},getSearchText:function i(){var G=YAHOO.lang.trim(this.widgets.searchBox.value);if(G!=this.defaultSearchText){return G}return""},onSearchChange:function f(){this.currentPage=1;this._cleanSearchText();this.reloadDataTable()},_showPanel:function m(I,J,H){var G=this;Alfresco.util.Ajax.request({url:I,dataObj:{htmlid:J},successCallback:{fn:function(K){var M=document.createElement("div");M.innerHTML=K.serverResponse.responseText;var L=a.getFirstChild(M);this.widgets.panel=Alfresco.util.createYUIPanel(L,{draggable:true,width:"50em"});this.widgets.panel.subscribe("hide",function(){G.reloadDataTable()});this.widgets.panel.show()},scope:this},failureMessage:"Could not load dialog template from '"+I+"'.",scope:this,execScripts:true})}});YAHOO.lang.augmentProto(beCPG.dashlet.ProjectDashlet,beCPG.component.ProjectCommons)})();