(function(){var g=YAHOO.util.Dom,b=YAHOO.Bubbling,i=Alfresco.util.generateDomId(null,"task");var f=Alfresco.util.generateDomId(null,"comment");var e=Alfresco.util.generateDomId(null,"deliverableState");beCPG.component.ProjectTask=function(o){beCPG.component.ProjectTask.superclass.constructor.call(this,"beCPG.component.ProjectTask",o,["button","container"]);this.scopeId=o;b.on(this.scopeId+"dataItemUpdated",this.onDataItemUpdated,this);b.on("beforeFormRuntimeInit",this.onBeforeFormRuntimeInit,this);return this};YAHOO.extend(beCPG.component.ProjectTask,Alfresco.component.Base);YAHOO.lang.augmentProto(beCPG.component.ProjectTask,beCPG.component.ProjectCommons);YAHOO.lang.augmentObject(beCPG.component.ProjectTask.prototype,{options:{taskNodeRef:null,readOnly:false,transitionField:"prop_pjt_worflowTransition"},onReady:function m(){this.onDataItemUpdated()},onDataItemUpdated:function l(p,o){if(this.options.taskNodeRef&&this.options.taskNodeRef.length>0){Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"becpg/project/task?nodeRef="+this.options.taskNodeRef,successCallback:{fn:this.showTaskInfos,scope:this}})}},showTaskInfos:function(q){if(q.json){var p=q.json.task,w=p.deliverables,t=this;g.get(this.id+"-currentTask").innerHTML=this.getTaskTitle(p,p.entityNodeRef);g.get(this.id+"-currentTask-description").innerHTML="<span>"+p.description+"</span>";if(!p.isRefusedEnabled){var v=this.id.replace(/assoc_pjt_workflowTask\-cntrl/g,this.options.transitionField)+"-refused";YAHOO.util.Event.onAvailable(v,function(){g.addClass(v,"hidden")},this)}if(w!=null&&w.length>0){g.get(this.id+"-currentDeliverableList").innerHTML=this.getDeliverableList(w,p.entityNodeRef);g.removeClass(this.id+"-deliverableList","hidden")}if(!this.options.readOnly){var o=function r(A,z){var y=b.getOwnerByTagName(z[1].anchor,"span");if(y!==null){t.onActionShowTask.call(t,y.className,y)}return true};b.addDefaultAction(i,o);var x=function u(A,z){var y=b.getOwnerByTagName(z[1].anchor,"span");if(y!==null){t.onActionChangeDeliverableState.call(t,y.className,y)}return true};b.addDefaultAction(e,x)}var s=function r(A,z){var y=YAHOO.Bubbling.getOwnerByTagName(z[1].anchor,"span");if(y!==null){t.onActionCommentTask.call(t,y.className,y)}return true};b.addDefaultAction(f,s)}},getDeliverableList:function(o,t){var q="<ul>";o.sort(function(w,v){if(w!=null&&w.sort!=null&&v!=null&&v.sort!=null){return w.sort-v.sort}return 0});for(j in o){var r=o[j].url;if(r!=null&&r.length>0&&r.indexOf("wizard")>0&&r.indexOf("catalogId")>0){var p=YAHOO.util.History.getQueryStringParameter("nodeRef",r);var u=YAHOO.util.History.getQueryStringParameter("catalogId",r);if(p!=null&&u!=null){var s=this.id.replace(/assoc_pjt_workflowTask\-cntrl/g,this.options.transitionField)+"-validate";YAHOO.util.Event.onAvailable(s,function(){g.addClass(s,"hidden")},this);Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"becpg/entity/catalog/node/"+p.replace(":/","")+"?catalogId="+u,method:Alfresco.util.Ajax.GET,responseContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(w){var z=true;if(w.json.catalogs!=null&&w.json.catalogs!==undefined&&Object.keys(w.json.catalogs).length>0){var y=w.json.catalogs;for(var x in y){if(y[x].missingFields!==undefined&&y[x].missingFields.length>0){z=false}}}if(z){var v=YAHOO.util.Selector.query("div.delivrable-status-Refused");for(var x in v){g.removeClass(v[x],"delivrable-status-Refused");g.addClass(v[x],"delivrable-status-Completed")}YAHOO.util.Event.onAvailable(s,function(){g.removeClass(s,"hidden")},this)}},scope:this}})}}q+="<li>"+this.getDeliverableTitle(o[j],t)+"</li>"}q+="</ul>";return q},getTaskTitle:function k(o,q){var p='<span class="node-'+o.nodeRef+"|"+q+'">'+o.name+" ("+o.completionPercent+"%)";p+='<a class="task-comments '+f+(o.commentCount?" active-comments":"")+'" title="'+this.msg("link.title.comment-task")+'" href="#" >';if(o.commentCount){p+=o.commentCount}else{p+="&nbsp;"}p+="</a></span>";return p},getDeliverableTitle:function d(o,u){var q="",p=o.url;if(p!=null&&p.length>0&&p.indexOf("catalogId")>0){o.state="Refused"}q='<div class="delivrable delivrable-status-'+o.state+'">';q+='<div class="delivrable-status delivrable-status-'+o.state+'"></div>';q+='<div class="delivrable-container">';if(p!=null&&p.length>0&&p.indexOf("wizard")>0){q+='<a title="'+this.msg("form.control.project-task.link.title.open-link")+'" href="'+p+'">';q+='<span class="wizard" ><h2>';q+=this.msg("form.control.project-task.wizard");q+="</h2>"+o.name+"</span>";q+="</a>"}else{q+='<span class="node-'+o.nodeRef+"|"+o.state+'">';q+='<a class="'+e+'" title="'+this.msg("form.control.project-task.change-state")+'" href="#"><span class="delivrable-status delivrable-status-'+o.state+'">&nbsp;</span></a>';var s=o.contents;var t="";if(p!=null&&p.length>0){t=p;q+='<span class="doc-url"><a title="'+this.msg("form.control.project-task.link.title.open-link")+'" href="'+p+'"><img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/link-16.png" /></a></span>'}else{if(s.length>0){if(s[0].isContainer){t=this._getBrowseUrlForFolderPath(s[0].path,s[0].siteId,s[0].name)}else{var r=null;if(s[0].path.indexOf("/User Homes")>0||s[0].path.indexOf("/Espaces Utilisateurs")>0){r="mine"}else{if(s[0].path.indexOf("/Shared")>0||s[0].path.indexOf("/Partagé")>0){r="shared"}}t=beCPG.util.entityURL(s[0].siteId,s[0].nodeRef,"document",r)}q+='<span class="doc-file"><a title="'+this.msg("form.control.project-task.link.title.open-document")+'" href="'+t+'"><img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/filetypes/"+Alfresco.util.getFileIcon(s[0].name,s[0].isContainer?"cm:folder":"cm:content",16)+'" /></a></span>'}}if(t.length>0){q+='<a class="theme-color-1 " title="'+this.msg("form.control.project-task.link.title.open-document")+'" href="'+t+'" >'}q+=o.name;if(t.length>0){q+="</a>"}q+="</span>"}q+="</div></div>";return q},onActionChangeDeliverableState:function c(p){var q=this;var o=p.replace("node-","").split("|");Alfresco.util.Ajax.jsonPost({url:Alfresco.constants.PROXY_URI+"becpg/bulkedit/save",dataObj:{field:"prop_pjt_dlState",isMultiple:false,nodeRef:o[0],value:o[1]=="Completed"?"InProgress":"Completed"},successCallback:{fn:function(r){b.fire(q.scopeId+"dataItemUpdated")},scope:this}})},_getBrowseUrlForFolderPath:function(r,q,p){var o=null;if(q){o=Alfresco.constants.URL_PAGECONTEXT+"site/"+q+"/documentlibrary?path="+encodeURIComponent("/"+r.split("/").slice(5).join("/")+"/"+p)}else{if(r.indexOf("/User Homes")>0||r.indexOf("/Espaces Utilisateurs")>0){o=Alfresco.constants.URL_PAGECONTEXT+"context/mine/myfiles?path="+encodeURIComponent("/"+r.split("/").slice(4).join("/")+"/"+p)}else{if(r.indexOf("/Shared")>0||r.indexOf("/Partagé")>0){o=Alfresco.constants.URL_PAGECONTEXT+"context/shared/sharedfiles?path="+encodeURIComponent("/"+r.split("/").slice(2).join("/")+"/"+p)}else{o=Alfresco.constants.URL_PAGECONTEXT+"repository?path="+encodeURIComponent("/"+r.split("/").slice(2).join("/")+"/"+p)}}}return o},onBeforeFormRuntimeInit:function h(p,o){o[1].runtime.setAJAXSubmit(true,{successCallback:{fn:this.onFormSubmitSuccess,scope:this}})},onFormSubmitSuccess:function a(o){document.location.href=Alfresco.constants.URL_CONTEXT},_showPanel:function n(q,r,p){var o=this;Alfresco.util.Ajax.request({url:q,dataObj:{htmlid:r},successCallback:{fn:function(s){var u=document.createElement("div");u.innerHTML=s.serverResponse.responseText;var t=g.getFirstChild(u);this.widgets.panel=Alfresco.util.createYUIPanel(t,{draggable:true,width:"50em"});this.widgets.panel.subscribe("hide",function(){o.onDataItemUpdated()});this.widgets.panel.show()},scope:this},failureMessage:"Could not load dialog template from '"+q+"'.",scope:this,execScripts:true})}},true)})();