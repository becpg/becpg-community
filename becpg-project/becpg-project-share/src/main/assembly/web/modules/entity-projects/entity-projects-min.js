(function(){var k=YAHOO.util.Dom;var i=Alfresco.util.encodeHTML;var a=Alfresco.util.generateDomId(null,"show-more-twister");YAHOO.Bubbling.fire("registerAction",{actionName:"onActionViewAssociatedProject",fn:function d(q){Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.GET,url:Alfresco.constants.URL_SERVICECONTEXT+"modules/entity-projects/entity-projects?nodeRef="+q.nodeRef+"&htmlid="+this.id,successCallback:{fn:function(s){var t=document.createElement("div");t.innerHTML=s.serverResponse.responseText;var r=k.getFirstChild(t);this.widgets.projects=Alfresco.util.createYUIPanel(r,{draggable:true,width:"40em"});this.widgets.projects.show()},scope:this},execScripts:true})}});beCPG.component.EntityProjects=function h(q){return beCPG.component.EntityProjects.superclass.constructor.call(this,q)};YAHOO.extend(beCPG.component.EntityProjects,Alfresco.component.SimpleDocList,{queryExecutionId:null,onReady:function e(){var t=this;this.widgets.dataSource=new YAHOO.util.DataSource(this.getWebscriptUrl(),{connMethodPost:true,responseType:YAHOO.util.DataSource.TYPE_JSON,responseSchema:{resultsList:"items",metaFields:{startIndex:"startIndex",totalRecords:"totalRecords",queryExecutionId:"queryExecutionId"}}});this.widgets.dataSource.connMgr.setDefaultPostHeader(Alfresco.util.Ajax.JSON);var v=[{key:"thumbnail",sortable:false,formatter:this.bind(this.renderCellThumbnail),width:16},{key:"detail",sortable:false,formatter:this.bind(this.renderCellDetail)}];this.widgets.alfrescoDataTable=new YAHOO.widget.DataTable(this.id+"-documents",v,this.widgets.dataSource,{initialLoad:false,dynamicData:false,MSG_EMPTY:'<span class="wait">'+i(this.msg("message.loading"))+"</span>",MSG_ERROR:this.msg("message.error"),className:"alfresco-datatable simple-doclist",renderLoopSize:4,paginator:null});this.widgets.alfrescoDataTable.getDataTable=function(){return this};this.widgets.alfrescoDataTable.getData=function(w){return this.getRecord(w).getData()};this.widgets.alfrescoDataTable.loadDataTable=function r(x){t.widgets.dataSource.connMgr.setDefaultPostHeader(Alfresco.util.Ajax.JSON);var y=x;if(!y){y=scopeParameters}if(Alfresco.util.CSRFPolicy.isFilterEnabled()){t.widgets.dataSource.connMgr.initHeader(Alfresco.util.CSRFPolicy.getHeader(),Alfresco.util.CSRFPolicy.getToken(),false)}t.widgets.dataSource.sendRequest(YAHOO.lang.JSON.stringify(y),{success:function w(A,z,B){t.widgets.alfrescoDataTable.onDataReturnReplaceRows(A,z,B);if(t.widgets.paginator){t.widgets.paginator.set("totalRecords",z.meta.totalRecords);t.widgets.paginator.setPage(z.meta.startIndex,true)}t.queryExecutionId=z.meta.queryExecutionId},failure:t.widgets.alfrescoDataTable.onDataReturnReplaceRows,scope:t.widgets.alfrescoDataTable,argument:{}})};var u=this.widgets.alfrescoDataTable,s=u.doBeforeLoadData;u.doBeforeLoadData=function q(w,x,y){if(x.results&&x.results.length===0){x.results.unshift({isInfo:true,title:t.msg("empty.project.title"),description:t.msg("empty.project.description")})}return s.apply(this,arguments)};YAHOO.Bubbling.addDefaultAction(a,this.onActionShowMore);this.initTaskHandlers();this.reloadDataTable()},getWebscriptUrl:function f(){return Alfresco.constants.PROXY_URI+"becpg/entity/datalists/data/node?itemType=pjt:project&pageSize="+this.options.maxItems+"&entityNodeRef="+this.options.nodeRef+"&dataListName=projectList&repo=true"},getParameters:function m(){var q={project:["pjt_projectOverdue","pjt_projectHierarchy1","pjt_projectHierarchy2","pjt_projectPriority","pjt_completionPercent","bcpg_code","cm_name","pjt_taskList|pjt_tlTaskName|pjt_tlDuration|pjt_tlPrevTasks|pjt_tlState|pjt_completionPercent|pjt_tlStart|pjt_tlEnd|pjt_tlWorkflowInstance|fm_commentCount","pjt_deliverableList|pjt_dlDescription|pjt_dlContent|pjt_dlState|fm_commentCount","pjt_projectManager","pjt_projectStartDate","pjt_projectCompletionDate","pjt_projectDueDate","pjt_projectState"]};var r={fields:q.project,page:1,sort:"cm:name",queryExecutionId:this.queryExecutionId,filter:{filterId:"entity-projects",filterOwner:"Alfresco.component.AllFilter",filterData:"InProgress"}};return r},renderCellThumbnail:function p(y,B,v,q){var r=90,t=B.getData(),u="";if(t.isInfo){r=52;u='<img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/help-docs-bw-32.png" />'}else{t.jsNode={};t.jsNode.type=t.itemType;var s=t.itemData.prop_cm_name.value,A=t.site!=null?t.site.shortName:null,w=s.substring(s.lastIndexOf(".")),x=new Alfresco.util.NodeRef(t.nodeRef),z=beCPG.util.entityURL(A,t.nodeRef,t.itemType);u='<span class="thumbnail" ><a href="'+z+'"><img width="90%" height="90%"  src="'+Alfresco.constants.PROXY_URI+"api/node/"+x.uri+'/content/thumbnails/doclib?c=queue&ph=true" alt="'+w+'" title="'+i(s)+'" /></a></span>'}v.width=r;k.setStyle(y,"width",v.width+"px");k.setStyle(y.parentNode,"width",v.width+"px");y.innerHTML=u},renderCellDetail:function l(x,y,v,r){var t=y.getData(),u="",w="";if(t.isInfo){u+='<div class="empty"><h3>'+t.title+"</h3>";u+="<span>"+t.description+"</span></div>"}else{var q=this.extractDates(t,null,false),s=q.due;w+=(q.start?Alfresco.util.formatDate(q.start,"longDate"):scope.msg("label.none"));if(q.end!=null){s=q.end}w+=" - ";w+=(q.start?Alfresco.util.formatDate(s,"longDate"):scope.msg("label.none"));u+='<h3 class="filename">'+this.getProjectTitle(t,true,true)+"</h3>";u+=this.renderProjectManager(y);u+='<div class="detail">';u+='<span class="project-date">[ '+w+" ]</span><br/>";u+='<span class="hierachy">';if(t.itemData.prop_pjt_projectHierarchy1&&t.itemData.prop_pjt_projectHierarchy1.displayValue!=null){u+=t.itemData.prop_pjt_projectHierarchy1.displayValue}if(t.itemData.prop_pjt_projectHierarchy2&&t.itemData.prop_pjt_projectHierarchy2.displayValue!=null){u+=" - "+t.itemData.prop_pjt_projectHierarchy2.displayValue}u+="</span>";u+=this.renderTaskList(y);u+=this.renderDeliverableList(y);u+="</div>"}x.innerHTML=u},onActionShowMore:function b(s,r){var q=r[1].anchor;elPanel=k.getNextSibling(q);if(k.hasClass(q,"alfresco-twister-closed")){k.removeClass(elPanel,"hidden");k.replaceClass(q,"alfresco-twister-closed","alfresco-twister-open")}else{k.addClass(elPanel,"hidden");k.replaceClass(q,"alfresco-twister-open","alfresco-twister-closed")}},renderProjectManager:function c(r){var s=r.getData("itemData")["assoc_pjt_projectManager"];var q="";if(s&&s[0]){q+='<div class="project-manager avatar" title="'+s[0].metadata+'">';q+=Alfresco.Share.userAvatar(s[0].displayValue,32);q+="</div>"}return q},renderTaskList:function o(t){var u=t.getData("itemData")["dt_pjt_taskList"];var s='<ul class="hidden">',q=0;for(j in u){var r=u[j];q++;s+="<li>"+this.getTaskTitle(r,t.getData().nodeRef)+"</li>"}s+="</ul>";return'<div ><a class="alfresco-twister alfresco-twister-closed '+a+'">'+this.msg("show.tasks")+"("+q+")</a>"+s+"</div>"},renderDeliverableList:function g(u){var r=u.getData("itemData")["dt_pjt_deliverableList"],q=0;var t='<ul class="hidden">';for(j in r){var s=r[j];q++;t+="<li>"+this.getDeliverableTitle(s,u.getData().nodeRef)+"</li>"}t+="</ul>";return'<div ><a class="alfresco-twister alfresco-twister-closed '+a+'">'+this.msg("show.deliverables")+"("+q+")</a>"+t+"</div>"},_showPanel:function n(s,t,r){var q=this;Alfresco.util.Ajax.request({url:s,dataObj:{htmlid:t},successCallback:{fn:function(u){var w=document.createElement("div");w.innerHTML=u.serverResponse.responseText;var v=k.getFirstChild(w);this.widgets.panel=Alfresco.util.createYUIPanel(v,{draggable:true,width:"50em"});this.widgets.panel.subscribe("hide",function(){q.reloadDataTable()});this.widgets.panel.show()},scope:this},failureMessage:"Could not load dialog template from '"+s+"'.",scope:this,execScripts:true})}});YAHOO.lang.augmentProto(beCPG.component.EntityProjects,beCPG.component.ProjectCommons)})();