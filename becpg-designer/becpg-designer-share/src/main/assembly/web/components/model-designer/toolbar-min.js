(function(){var d=YAHOO.util.Dom;beCPG.component.DesignerToolbar=function(j){beCPG.component.DesignerToolbar.superclass.constructor.call(this,"beCPG.component.DesignerToolbar",j,["button","container"]);YAHOO.Bubbling.on("designerModelNodeChange",this.onDesignerModelNodeChange,this);return this};YAHOO.extend(beCPG.component.DesignerToolbar,Alfresco.component.Base);YAHOO.lang.augmentObject(beCPG.component.DesignerToolbar.prototype,{options:{},currentNode:null,readOnly:false,onReady:function h(){this.widgets.newRowButton=Alfresco.util.createYUIButton(this,"newRowButton",this.onCreateElement,{disabled:true,value:"create"});this.widgets.deleteButton=Alfresco.util.createYUIButton(this,"deleteButton",this.onDelete,{disabled:true,value:"delete"});this.widgets.publishButton=Alfresco.util.createYUIButton(this,"publishButton",this.onPublish,{disabled:true,value:"publish"});this.widgets.unPublishButton=Alfresco.util.createYUIButton(this,"unPublishButton",this.onUnPublish,{disabled:true,value:"unPublish"});this.widgets.previewButton=Alfresco.util.createYUIButton(this,"previewButton",this.onPreview,{disabled:true,value:"preview"});d.setStyle(this.id+"-body","visibility","visible")},onPublish:function c(m,n){var l=Alfresco.constants.PROXY_URI+"becpg/designer/model/publish?nodeRef="+this.tree.modelNodeRef;var k=this.tree.root.children[0].label;var j=Alfresco.util.PopupManager.displayMessage({text:this.msg("message.publishing",k),spanClass:"wait",displayTime:0});Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.POST,url:l,successCallback:{fn:function(){YAHOO.Bubbling.fire("selectedModelChanged",{nodeRef:this.tree.modelNodeRef,readOnly:this.tree.isReadOnly});Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/console/config/reload",method:Alfresco.util.Ajax.GET,responseContentType:Alfresco.util.Ajax.JSON,successMessage:this.msg("message.publish.success",k),failureMessage:this.msg("message.publish.failure",k)});j.destroy()},scope:this},failureMessage:this.msg("message.publish.failure",k),scope:this,execScripts:false})},onUnPublish:function f(m,n){var l=this;Alfresco.util.PopupManager.displayPrompt({title:l.msg("actions.unpublish"),text:l.msg("message.confirm.unpublish",l.currentNode.name),buttons:[{text:l.msg("button.unpublish"),handler:function k(){var q=Alfresco.constants.PROXY_URI+"becpg/designer/model/unpublish?nodeRef="+l.tree.modelNodeRef;var p=l.tree.root.children[0].label;var o=Alfresco.util.PopupManager.displayMessage({text:l.msg("message.unpublishing",p),spanClass:"wait",displayTime:0});Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.POST,url:q,successCallback:{fn:function(){Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/console/config/reload",method:Alfresco.util.Ajax.GET,responseContentType:Alfresco.util.Ajax.JSON,successMessage:l.msg("message.unpublish.success",p),failureMessage:l.msg("message.unpublish.failure",p)})},scope:this},failureMessage:l.msg("message.unpublish.failure",p),scope:this,execScripts:false});o.destroy();this.destroy()}},{text:this.msg("button.cancel"),handler:function j(){this.destroy()},isDefault:true}]})},onPreview:function g(p,t){var q=this;var u=function j(v,w){Alfresco.util.populateHTML([w.id+"-dialogTitle",this.msg("label.preview.title")],[w.id+"-dialogHeader",this.msg("label.preview.header")]);if(d.get(w.id+"-form-submit")){d.setStyle(w.id+"-form-submit","display","none")}if(d.get(w.id+"-form-bulkAction")){d.setStyle(w.id+"-form-bulkAction","display","none");d.setStyle(w.id+"-form-bulkAction-msg","display","none")}};var s="create",r=this.currentNode.name,n="type",l="type";if(this.currentNode.itemType=="dsg:form"){s=this.currentNode.name;r=this.currentNode.formType;if(this.currentNode.formKind!=null){l=this.currentNode.formKind}}var k=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?bulkEdit=true&formId={formId}&itemKind={itemKind}&itemId={itemId}&mode={mode}&submitType={submitType}&showCancelButton=true&showSubmitButton=true",{itemKind:l,formId:s,itemId:r,mode:"create",submitType:"json"});var o=new Alfresco.module.SimpleDialog(this.id+"-preview");o.onTemplateLoaded=function m(v){var y=document.createElement("div");y.innerHTML=v.serverResponse.responseText;var w=d.getFirstChild(y);while(w&&w.tagName.toLowerCase()!="div"){w=d.getNextSibling(w)}try{this.dialog=Alfresco.util.createYUIPanel(w,{width:this.options.width})}catch(x){Alfresco.util.PopupManager.displayMessage({text:q.msg("message.preview.failure")});if(this.options.destroyOnHide){YAHOO.Bubbling.fire("formContainerDestroyed");YAHOO.Bubbling.unsubscribe("beforeFormRuntimeInit",this.onBeforeFormRuntimeInit,this);delete this.dialog;delete this.widgets;if(this.isFormOwner){delete this.form}}return}this.dialog.hideEvent.subscribe(this.onHideEvent,null,this);if(!d.get(this.id+"-dialogTitle")){Alfresco.util.PopupManager.displayMessage({text:q.msg("message.preview.failure")})}else{if(d.get(this.id+"-form-submit")){this.isFormOwner=false;this.formsServiceDeferred.fulfil("onTemplateLoaded")}else{this.widgets.okButton=Alfresco.util.createYUIButton(this,"ok",null,{type:"submit"});this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel",this.onCancel);this.isFormOwner=true;this.form=new Alfresco.forms.Form(this.id+"-form");this.form.setSubmitElements(this.widgets.okButton);this.form.setAJAXSubmit(true,{successCallback:{fn:this.onSuccess,scope:this},failureCallback:{fn:this.onFailure,scope:this}});this.form.setSubmitAsJSON(true);this.form.setShowSubmitStateDynamically(true,false);this.form.init();this._showDialog()}}};o.setOptions({width:"850px",templateUrl:k,destroyOnHide:true,doBeforeDialogShow:{fn:u,scope:this}}).show()},onDelete:function i(){var k=this;Alfresco.util.PopupManager.displayPrompt({title:this.msg("actions.delete"),text:this.msg("message.confirm.delete",k.currentNode.name),buttons:[{text:this.msg("button.delete"),handler:function l(){this.destroy();k._onActionDeleteConfirm.call(k)}},{text:this.msg("button.cancel"),handler:function j(){this.destroy()},isDefault:true}]})},_onActionDeleteConfirm:function a(j){var l=this,k=l.currentNode.name;var m=Alfresco.constants.PROXY_URI+"slingshot/doclib/action/file/node/"+l.currentNode.nodeRef.replace("://","/");Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.DELETE,url:m,successCallback:{fn:function(){YAHOO.Bubbling.fire("elementDeleted",{nodeRef:l.currentNode.nodeRef,tree:l.tree});Alfresco.util.PopupManager.displayMessage({text:this.msg("message.delete.success",k)})},scope:this},failureMessage:this.msg("message.delete.failure",k),scope:this,execScripts:false})},onCreateElement:function b(o,r){var q=this,n=this.currentNode.itemType,j=null,k=null,m=Alfresco.constants.PROXY_URI+"becpg/designer/create/element?nodeRef="+this.currentNode.nodeRef;var t=function p(v){v.addValidation(this.id+"-createElement-assocType",function u(B,x,A,z,w,y){return B.options[B.selectedIndex].value!=="-"},null,"change");v.addValidation(this.id+"-createElement-type",function u(B,x,A,z,w,y){return B.options[B.selectedIndex].value!=="-"},null,"change");v.setShowSubmitStateDynamically(true,false)};if(this.currentNode.subType!=null){n=this.currentNode.parentType;j=this.currentNode.itemType}k=Alfresco.constants.URL_SERVICECONTEXT+"modules/model-designer/create-element?currentType="+n;if(j!=null){k+="&assocType="+j}this.modules.createElement=new Alfresco.module.SimpleDialog(this.id+"-createElement").setOptions({width:"30em",templateUrl:k,actionUrl:m,destroyOnHide:true,doSetupFormsValidation:{fn:t,scope:this},firstFocus:this.id+"-createElement-type",onSuccess:{fn:function s(u){if(u.json&&u.json.persistedObject){var v=u.json.treeNode;YAHOO.Bubbling.fire("elementCreated",{node:v,focusNodeRef:u.json.persistedObject,tree:q.tree});Alfresco.util.PopupManager.displayMessage({text:this.msg("message.create-element.success")})}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.create-element.failure")})}},scope:this},onFailure:{fn:function l(u){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.create-element.failure")})},scope:this}});this.modules.createElement.show()},onDesignerModelNodeChange:function e(k,j){var m=j[1],l=m.node;if(m.tree!=null){this.tree=m.tree;this.readOnly=m.tree.isReadOnly}this.currentNode=l;if(l.nodeRef!=null){this.widgets.newRowButton.set("disabled",this.readOnly||false);this.widgets.deleteButton.set("disabled",this.readOnly||false);if(l.subType!=null){this.widgets.deleteButton.set("disabled",true)}if(l.itemType=="m2:type"||(l.itemType=="dsg:form"&&(l.name==""||l.name=="default"||l.name=="create"))){this.widgets.previewButton.set("disabled",false)}else{this.widgets.previewButton.set("disabled",true)}if(l.itemType=="m2:model"||l.itemType=="dsg:config"){this.widgets.publishButton.set("disabled",this.readOnly||false);this.widgets.unPublishButton.set("disabled",this.readOnly||false)}else{this.widgets.publishButton.set("disabled",true);this.widgets.unPublishButton.set("disabled",true)}}else{this.widgets.newRowButton.set("disabled",true);this.widgets.deleteButton.set("disabled",true)}}},true)})();