(function(){var c=YAHOO.util.Dom,A=YAHOO.util.Event,l=YAHOO.Bubbling;beCPG.component.DesignerTree=function(C){this.id=C;beCPG.component.DesignerTree.superclass.constructor.call(this,"beCPG.component.DesignerTree",C,["button","container"]);YAHOO.Bubbling.on("selectedModelChanged",this.renderModelTree,this);YAHOO.Bubbling.on("selectedConfigChanged",this.renderConfigTree,this);YAHOO.Bubbling.on("elementCreated",this.onElementCreated,this);YAHOO.Bubbling.on("elementDeleted",this.onElementDeleted,this);return this};YAHOO.extend(beCPG.component.DesignerTree,Alfresco.component.Base,{options:{modelNodeRef:null,configNodeRef:null},selectedNode:null,onReady:function r(){var I=YUISelector.query("h2",this.id);this.widgets.modelSelect=Alfresco.util.createYUIButton(this,"modelSelect-button",this.onModelSelect,{type:"menu",menu:"modelSelect-menu",lazyloadmenu:false});var H=this.widgets.modelSelect.getMenu();this.widgets.configSelect=Alfresco.util.createYUIButton(this,"configSelect-button",this.onConfigSelect,{type:"menu",menu:"configSelect-menu",lazyloadmenu:false});var C=this.widgets.configSelect.getMenu();if(YAHOO.lang.isArray(I)){for(var D in I){Alfresco.util.createTwister(I[D],this.filterName)}}var F=C.getItem(0);var G=H.getItem(0);var J=null,E=null;if(this.options.modelNodeRef!=null&&this.options.modelNodeRef.length>0){l.fire("selectedModelChanged",{nodeRef:this.options.modelNodeRef,readOnly:false})}else{if(G){E=G._oAnchor.children[0].attributes[0].nodeValue;J=E.split("|")[1];l.fire("selectedModelChanged",{nodeRef:E.split("|")[0],readOnly:J!=null?J=="true":false})}}if(this.options.configNodeRef!=null&&this.options.configNodeRef.length>0){l.fire("selectedConfigChanged",{nodeRef:this.options.configNodeRef,readOnly:false})}else{if(F){E=F._oAnchor.children[0].attributes[0].nodeValue;J=E.split("|")[1];l.fire("selectedConfigChanged",{nodeRef:E.split("|")[0],readOnly:J!=null?J=="true":false})}}},onConfigSelect:function i(H,G,F){var D=G[1],C=Alfresco.util.findEventClass(D),E=C.split("|")[1];l.fire("selectedConfigChanged",{nodeRef:C.split("|")[0],readOnly:E!=null?E=="true":false})},onModelSelect:function j(H,G,F){var D=G[1],C=Alfresco.util.findEventClass(D),E=C.split("|")[1];l.fire("selectedModelChanged",{nodeRef:C.split("|")[0],readOnly:E!=null?E=="true":false})},renderModelTree:function f(E,C){var D=C[1];this.options.modelNodeRef=D.nodeRef;this.renderTree(this.id+"-model-tree",D.nodeRef,D.readOnly)},renderConfigTree:function p(E,C){var D=C[1];this.options.configNodeRef=D.nodeRef;this.renderTree(this.id+"-form-tree",D.nodeRef,D.readOnly)},renderTree:function f(G,F,J){var I=this;var K={success:function D(M){C.destroy();var L=YAHOO.lang.JSON.parse(M.responseText);if(L){this._buildTree(G,L,F,J)}},failure:function H(L){C.destroy();if(L.status==401){window.location.reload()}alert("Unexpected error")},scope:I};var E=this._buildTreeNodeUrl(F);var C=Alfresco.util.PopupManager.displayMessage({text:this.msg("message.tree-loading"),spanClass:"wait",displayTime:0});YAHOO.util.Connect.asyncRequest("GET",E,K)},onNodeClicked:function k(C){return function(D){var E=D.node;if(E!=this.selectedNode){this._updateSelectedNode(E,C)}A.stopEvent(D.event);return false}},onElementCreated:function d(F,E){var H=E[1],D;if(H!==null){D=H.tree;var C=D.getNodeByProperty("nodeRef",H.node.nodeRef);if(C!==null){var I=this._buildTreeNode(H.node,C.parent,true);I.insertBefore(C);D.removeNode(C);D.render()}var G=D.getNodeByProperty("nodeRef",H.focusNodeRef);if(G!=null){G.parent.expand();this._updateSelectedNode(G,D)}}},onElementDeleted:function n(F,E){var H=E[1];if(H!==null){var G=null;var D=H.tree;if(H.nodeRef){G=D.getNodeByProperty("nodeRef",H.nodeRef)}if(G!==null){var C=G.parent;D.removeNode(G);if(C!==null){if(!C.hasChildren()){C.isLeaf=true}}D.render();if(C!=null){this._updateSelectedNode(C,D)}}}},_buildTree:function h(I,G,E,H){var C=new YAHOO.widget.TreeView(I);C.modelNodeRef=E;C.isReadOnly=H;YAHOO.widget.TreeView.FOCUS_CLASS_NAME="";var D=C.getRoot();var F=this._buildTreeNode(G,D,true);C.subscribe("clickEvent",this.onNodeClicked(C),this,true);C.subscribe("expandComplete",this.onExpandComplete(C),this,true);C.render();if(F!=null){this._updateSelectedNode(F,C)}},_applyDropTargets:function q(D){var G=D.getEl();var C=c.getElementsByClassName("m2-property","span",G);for(var F=0,E=C.length;F<E;F++){new beCPG.DnD(C[F].parentNode,this,D,"property")}ndTargets=c.getElementsByClassName("m2-propertyOverride","span",G);for(var F=0,E=C.length;F<E;F++){new beCPG.DnD(C[F].parentNode,this,D,"property")}C=c.getElementsByClassName("m2-association","span",G);for(var F=0,E=C.length;F<E;F++){new beCPG.DnD(C[F].parentNode,this,D,"association")}C=c.getElementsByClassName("m2-childAssociation","span",G);for(var F=0,E=C.length;F<E;F++){new beCPG.DnD(C[F].parentNode,this,D,"association")}C=c.getElementsByClassName("dsg-formField","span",G);for(var F=0,E=C.length;F<E;F++){new beCPG.DnD(C[F].parentNode,this,D,"field")}C=c.getElementsByClassName("m2-type","span",G);for(var F=0,E=C.length;F<E;F++){new beCPG.DnD(C[F].parentNode,this,D,"type")}C=c.getElementsByClassName("m2-aspect","span",G);for(var F=0,E=C.length;F<E;F++){new beCPG.DnD(C[F].parentNode,this,D,"aspect")}},onExpandComplete:function B(C){return function(D){this._applyDropTargets(C)}},_showHighlight:function z(C){if(this.selectedNode!==null){if(C){c.addClass(this.selectedNode.getEl(),"selected")}else{c.removeClass(this.selectedNode.getEl(),"selected")}}},_updateSelectedNode:function t(D,C){this._showHighlight(false);this.selectedNode=D;this._showHighlight(true);YAHOO.Bubbling.fire("designerModelNodeChange",{node:D.data,tree:C})},_buildTreeNode:function w(C,F,E){try{var G=new YAHOO.widget.TextNode({label:((C.title!=null&&C.title.length>0)?C.title:C.name),entityTitle:((C.title!=null&&C.title.length>0)?C.title:C.name),name:C.name,nodeRef:C.nodeRef,itemType:C.type,parentType:(F!=null&&F.data!=null)?F.data.itemType:null,subType:C.subType,description:C.description,draggable:C.draggable,accepts:C.accepts,formId:C.formId?C.formId:null,formKind:C.formKind?C.formKind:null,formType:C.formType?C.formType:null},F,E);if(C.hasError){G.labelStyle=C.type.replace(":","-")}else{G.labelStyle="dsg-error"}if(C.childrens.length>0){for(var D in C.childrens){this._buildTreeNode(C.childrens[D],G,false)}}else{G.isLeaf=true}return G}catch(H){alert(H)}},_buildTreeNodeUrl:function y(C){var D="becpg/designer/tree/node/"+C.replace("://","/");return Alfresco.constants.PROXY_URI+D}});beCPG.DnD=function(H,G,D,C,E){beCPG.DnD.superclass.constructor.call(this,H,C,E);var F=this.getDragEl();c.setStyle(F,"opacity",0.67);this.designerTree=G;this.tree=D};YAHOO.extend(beCPG.DnD,YAHOO.util.DDProxy,{_inFlight:false,startDrag:function b(D,F){var C=this.getDragEl();var E=this.getEl();C.innerHTML=E.innerHTML;c.setStyle(C,"color",c.getStyle(E,"color"));c.setStyle(C,"background-image",c.getStyle(E,"background-image"));c.setStyle(C,"background-repeat",c.getStyle(E,"background-repeat"));c.setStyle(C,"background-position",c.getStyle(E,"background-position"));c.setStyle(C,"background-size",c.getStyle(E,"background-size"));c.setStyle(C,"padding-left",c.getStyle(E,"padding-left"));c.setStyle(C,"background-color","#E3EAEC");c.setStyle(C,"border","1px solid #6CA5CE");c.setStyle(C,"width",c.getStyle(E,"width"))},endDrag:function a(E){if(!this._inFlight){var C=this.getEl();var D=this.getDragEl();this.animateResult(D,C)}},animateResult:function v(F,C){c.setStyle(F,"visibility","");var D=new YAHOO.util.Motion(F,{points:{to:c.getXY(C)}},0.2,YAHOO.util.Easing.easeOut);var E=F.id;var G=this.id;D.onComplete.subscribe(function(){c.setStyle(E,"visibility","hidden");c.setStyle(G,"visibility","")});D.animate()},onDragDrop:function g(D,F){var E=c.get(F);if(c.hasClass(E,"elementDroppable")){var C={elementId:F,callback:this.onDropTargetOwnerCallBack,scope:this};this._inFlight=true;YAHOO.Bubbling.fire("dropTargetOwnerRequest",C);this._setFailureTimeout()}},onDropTargetOwnerCallBack:function u(E,D,C){this._clearTimeout();var F=new Alfresco.util.NodeRef(E);this._performDND(F,D,C)},_performDND:function x(K,J,E){try{var C=this.getEl().id,D,F=null;if(C!=null&&(C.indexOf("formSets_")>-1||C.indexOf("formControls_")>-1)){D=Alfresco.constants.PROXY_URI+"becpg/designer/dnd/"+C+"?nodeRef="+K}else{var H=this.tree.getNodeByElement(this.getEl());F=H.data.nodeRef;D=Alfresco.constants.PROXY_URI+"becpg/designer/dnd/"+F.replace(":/","")+"?nodeRef="+K}var I=this;var L=function(M){if(M.json&&M.json.persistedObject){var O=M.json.treeNode;if(F!=null&&F==M.json.persistedObject){var N=E.getNodeByProperty("nodeRef",F);if(N!=null){E.removeNode(N)}}YAHOO.Bubbling.fire("elementCreated",{node:O,tree:E,focusNodeRef:M.json.persistedObject});Alfresco.util.PopupManager.displayMessage({text:I.designerTree.msg("message.dnd.success")})}else{Alfresco.util.PopupManager.displayMessage({text:I.designerTree.msg("message.dnd.failure")})}};Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.POST,url:D,successCallback:{fn:L,scope:this},failureMessage:I.designerTree.msg("message.dnd.failure"),scope:this,execScripts:false})}catch(G){alert(G)}},_currTimeoutId:null,_clearTimeout:function o(){if(this._currTimeoutId!=null){window.clearTimeout(this._currTimeoutId);this._currTimeoutId=null;this._inFlight=false}},_setFailureTimeout:function m(){this._clearTimeout();var C=this;this._currTimeoutId=window.setTimeout(function(){C.animateResult(C.getDragEl(),C.getEl());C._inFlight=false;C._currTimeoutId=null},500)},onDragOver:function s(E,F){var C=c.get(F);if(c.hasClass(C,"elementDroppableHighlights")){var D={elementId:F,event:E};YAHOO.Bubbling.fire("elementDragOver",D)}},onDragOut:function e(E,F){var C=c.get(F);if(c.hasClass(C,"elementDroppableHighlights")){var D={elementId:F,event:E};YAHOO.Bubbling.fire("elementDragOut",D)}}})})();