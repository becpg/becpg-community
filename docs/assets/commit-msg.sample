#!/bin/sh
# Git hook: .git/hooks/commit-msg
# Enforces commit message convention (one-line, optional ticket, tag, description)

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(head -n1 "$COMMIT_MSG_FILE")  # Only check first line

# Regex for validation:
# - Optional "InProgress|Fix #1234 - "
# - Then [Tag]
# - Then " - Short description"
PATTERN='^((InProgress|Fix) #[0-9]+ - )?\[(Feature|Bug|Setup|Cleanup|Migration|Security|Merge|Issue)\] - .+$'

# Check if commit message is multiple lines
if [ "$(wc -l < "$COMMIT_MSG_FILE")" -gt 1 ]; then
  echo "❌ Commit message must be ONE line only."
  exit 1
fi

# Validate commit message format
if ! echo "$COMMIT_MSG" | grep -Eq "$PATTERN"; then
  echo "❌ Invalid commit message format!"
  echo "👉 Expected format:"
  echo "   InProgress/Fix #1234 - [Tag] - Description"
  echo "   or"
  echo "   [Tag] - Description"
  exit 1
fi

echo "✅ Commit message format OK"
exit 0
