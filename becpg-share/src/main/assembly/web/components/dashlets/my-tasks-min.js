(function(){var b=YAHOO.util.Dom,q=YAHOO.util.Event,j=YAHOO.util.Selector;var h=Alfresco.util.encodeHTML,m=Alfresco.util.siteURL;Alfresco.dashlet.MyTasks=function g(s){Alfresco.dashlet.MyTasks.superclass.constructor.call(this,"Alfresco.dashlet.MyTasks",s,["button","container","datasource","datatable","paginator","history","animation"]);this.services.preferences=new Alfresco.service.Preferences();return this};YAHOO.extend(Alfresco.dashlet.MyTasks,Alfresco.component.Base);YAHOO.lang.augmentProto(Alfresco.dashlet.MyTasks,Alfresco.action.WorkflowActions);YAHOO.lang.augmentObject(Alfresco.dashlet.MyTasks.prototype,{PREFERENCES_TASKS_DASHLET:"",PREFERENCES_TASKS_DASHLET_FILTER:"",options:{hiddenTaskTypes:[],maxItems:50,filters:{}},onReady:function p(){this.widgets.filterMenuButton=Alfresco.util.createYUIButton(this,"filters",this.onFilterSelected,{type:"menu",menu:"filters-menu",lazyloadmenu:false});this.PREFERENCES_TASKS_DASHLET=this.services.preferences.getDashletId(this,"tasks");this.PREFERENCES_TASKS_DASHLET_FILTER=this.PREFERENCES_TASKS_DASHLET+".filter";var t=this.services.preferences.get();var w=Alfresco.util.findValueByDotNotation(t,this.PREFERENCES_TASKS_DASHLET_FILTER,"activeTasks");w=this.options.filters.hasOwnProperty(w)?w:"activeTasks";this.widgets.filterMenuButton.set("label",this.msg("filter."+w)+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.filterMenuButton.value=w;this.configureSearch();b.removeClass(j.query(".toolbar div",this.id,true),"hidden");var v=YAHOO.lang.substitute("api/task-instances?authority={authority}&properties={properties}&exclude={exclude}",{authority:encodeURIComponent(Alfresco.constants.USERNAME),properties:["bpm_priority","bpm_status","bpm_dueDate","bpm_description"].join(","),exclude:this.options.hiddenTaskTypes.join(",")});this.widgets.alfrescoDataTable=new Alfresco.util.DataTable({dataSource:{url:Alfresco.constants.PROXY_URI+v,filterResolver:this.bind(function(){var z=this.widgets.filterMenuButton.value;var A=this.options.filters[z];return this.substituteParameters(A)||""})},dataTable:{container:this.id+"-tasks",columnDefinitions:[{key:"isPooled",sortable:false,formatter:this.bind(this.renderCellIcons),width:24},{key:"title",sortable:false,formatter:this.bind(this.renderCellTaskInfo)},{key:"name",sortable:false,formatter:this.bind(this.renderCellActions),width:45}],config:{MSG_EMPTY:this.msg("message.noTasks")}},paginator:{history:false,hide:false,config:{containers:[this.id+"-paginator"],template:"{FirstPageLink} {PreviousPageLink} {CurrentPageReport} {NextPageLink} {LastPageLink}",firstPageLinkLabel:"&lt;&lt;",previousPageLinkLabel:"&lt;",nextPageLinkLabel:"&gt;",lastPageLinkLabel:"&gt;&gt;",pageReportTemplate:this.msg("pagination.template.page-report"),rowsPerPage:this.options.maxItems}}});var x=this,y=this.widgets.alfrescoDataTable.getDataTable(),u=y.doBeforeLoadData;y.doBeforeLoadData=function s(z,A,B){if(A.results.length===0){b.addClass(this.configs.paginator.getContainerNodes(),"hidden")}else{b.removeClass(this.configs.paginator.getContainerNodes(),"hidden")}if(A.results.length===0){A.results.unshift({isInfo:true,title:x.msg("empty.title"),description:x.msg("empty.description")})}return u.apply(this,arguments)}},onFilterSelected:function e(t,s){var u=s[1];if(u){this.widgets.alfrescoDataTable.currentSkipCount=0;this.widgets.filterMenuButton.set("label",u.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.filterMenuButton.value=u.value;var v=this.substituteParameters(this.options.filters[u.value],{});this.widgets.alfrescoDataTable.loadDataTable(v);this.services.preferences.set(this.PREFERENCES_TASKS_DASHLET_FILTER,u.value)}},renderCellIcons:function i(A,B,x,s){var u=B.getData(),w="";if(u.isInfo){x.width=52;b.setStyle(A,"width",x.width+"px");b.setStyle(A.parentNode,"width",x.width+"px");w='<img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/help-task-bw-32.png" />'}else{var z=u.properties.bpm_priority,y={"1":"high","2":"medium","3":"low"},t=y[z+""],v=u.isPooled;w='<img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/priority-"+t+'-16.png" title="'+this.msg("label.priority",this.msg("priority."+t))+'"/>';if(v){w+='<br/><img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/pooled-task-16.png" title="'+this.msg("label.pooledTask")+'"/>'}}A.innerHTML=w},renderCellTaskInfo:function k(w,I,y,C){var K=I.getData(),E="";if(K.isInfo){E+='<div class="empty"><h3>'+K.title+"</h3>";E+="<span>"+K.description+"</span></div>"}else{var t=K.id,z=K.properties.bpm_description,A=K.properties.bpm_dueDate,J=A?Alfresco.util.fromISO8601(A):null,G=new Date(),u=K.title,B=K.properties.bpm_status,H=K.owner;if(K.propertyLabels&&Alfresco.util.isValueSet(K.propertyLabels.bpm_status,false)){B=K.propertyLabels.bpm_status}if(z==u){z=this.msg("workflow.no_message")}var D;if(K.isEditable){D=m("task-edit?taskId="+t)+'" class="theme-color-1" title="'+this.msg("title.editTask")}else{D=m("task-details?taskId="+t)+'" class="theme-color-1" title="'+this.msg("title.viewTask")}var v='<h3><a href="'+D+'">'+h(z)+"</a></h3>",F=J?'<h4><span class="'+(G>J?"task-delayed":"")+'" title="'+this.msg("title.dueOn",Alfresco.util.formatDate(J,"longDate"))+'">'+Alfresco.util.formatDate(J,"longDate")+"</span></h4>":"",s='<div title="'+this.msg("title.taskSummary",u,B)+'">'+this.msg("label.taskSummary",u,B)+"</div>",x="";E=v+F}w.innerHTML=E},renderCellActions:function f(u,s,v,x){var t=s.getData(),w="";if(t.isInfo){v.width=0;b.setStyle(u,"width",v.width+"px");b.setStyle(u.parentNode,"width",v.width+"px")}else{if(t.isEditable){w+='<a href="'+m("task-edit?taskId="+t.id)+'" class="edit-task" title="'+this.msg("title.editTask")+'">&nbsp;</a>'}w+='<a href="'+m("task-details?taskId="+t.id)+'" class="view-task" title="'+this.msg("title.viewTask")+'">&nbsp;</a>'}u.innerHTML=w},configureSearch:function a(){this.widgets.searchBox=b.get(this.id+"-searchText");this.defaultSearchText=this.msg("header.search.default");q.addListener(this.widgets.searchBox,"focus",this.onSearchFocus,null,this);q.addListener(this.widgets.searchBox,"blur",this.onSearchBlur,null,this);this.setDefaultSearchText();var s=this;this.widgets.searchEnterListener=new YAHOO.util.KeyListener(this.widgets.searchBox,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:s.onSearchButtonClick,scope:this,correctScope:true},"keydown").enable()},onSearchFocus:function r(){if(this.widgets.searchBox.value==this.defaultSearchText){b.removeClass(this.widgets.searchBox,"faded");this.widgets.searchBox.value=""}else{this.widgets.searchBox.select()}},onSearchBlur:function o(){var s=YAHOO.lang.trim(this.widgets.searchBox.value);if(s.length===0){YAHOO.lang.later(100,this,this.setDefaultSearchText,[])}},setDefaultSearchText:function l(){b.addClass(this.widgets.searchBox,"faded");this.widgets.searchBox.value=this.defaultSearchText},getSearchText:function d(){var s=YAHOO.lang.trim(this.widgets.searchBox.value);if(s!=this.defaultSearchText){return s}return""},_cleanSearchText:function c(){var s=this.getSearchText();if(s.indexOf("*")>0&&s.replace(/\*/g,"").length<3){this.searchTerm=null}else{this.searchTerm=s}},onSearchButtonClick:function n(){this._cleanSearchText();this.setDefaultSearchText();this.widgets.alfrescoDataTable.loadDataTable("q="+this.searchTerm)}})})();