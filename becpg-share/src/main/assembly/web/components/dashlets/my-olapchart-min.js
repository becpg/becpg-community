(function(){var h="fr.becpg.olap.chart.dashlet",c="query",m="chartType";beCPG.dashlet.OlapChart=function(n){this.id=n;beCPG.dashlet.OlapChart.superclass.constructor.call(this,"beCPG.dashlet.OlapChart",n,["button","container","menu","datasource"]);this.preferencesService=new Alfresco.service.Preferences()};YAHOO.extend(beCPG.dashlet.OlapChart,Alfresco.component.Base,{dataSource:null,cDataSource:null,saikuUrl:null,options:{siteId:"",regionId:""},onChartSelected:function g(o){var n=this;if(o){n.chartPicker.value=encodeURIComponent(o.value);n.preferencesService.set(n.getPreference(c),n.chartPicker.value,{successCallback:{fn:n.onChartClicked(n),scope:this}})}},onChartClicked:function(n){this.loadChartData()},onChartTypeSelected:function g(o){var n=this;if(o){n.chartTypePicker.value=o.value;n.preferencesService.set(n.getPreference(m),n.chartTypePicker.value,{successCallback:{fn:n.render(),scope:this}})}},getPreference:function a(o){var n=this.options;return h+"."+n.regionId+(n.siteId?("."+n.siteId):"")+(o?"."+o:"")},onChartTypeClicked:function d(n){this.render()},onReady:function b(){var n=this;this.chartPicker=new YAHOO.widget.Button(n.id+"-charPicker-button",{type:"split",menu:n.id+"-charPicker-select",lazyloadmenu:true});this.chartTypePicker=new YAHOO.widget.Button(n.id+"-chartTypePicker-button",{type:"split",menu:n.id+"-chartTypePicker-select",lazyloadmenu:false});this.chartPicker.on("click",n.onChartClicked,n,true);this.chartTypePicker.on("click",n.onChartTypeClicked,n,true);this.chartPicker.getMenu().subscribe("click",function(p,o){var q=o[1];if(q){n.chartPicker.set("label",q.cfg.getProperty("text"));n.onChartSelected.call(n,q)}});this.chartTypePicker.getMenu().subscribe("click",function(p,o){var q=o[1];if(q){n.chartTypePicker.set("label",q.cfg.getProperty("text"));n.onChartTypeSelected.call(n,q)}});Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"becpg/olap/chart",successCallback:{fn:n.fillQueries,scope:this},failureCallback:{fn:function(){},scope:this}})},fillQueries:function k(o){var r=this,q=o.json,n=[],s="";if(q!==null){for(var p in q.queries){if(p===0){s=q.queries[p].queryId}n.push({text:q.queries[p].queryName,value:q.queries[p].queryId})}n.sort(function(u,t){return u.text.toLowerCase().localeCompare(t.text.toLowerCase())});r.chartPicker.getMenu().addItems(n);r.chartPicker.getMenu().render(document.body);r.selectMenuValue(r.chartPicker,encodeURIComponent(s));r.saikuUrl=q.metadata.olapSSOUrl}r.selectMenuValue(r.chartTypePicker,"barChart");this.preferencesService.request(r.getPreference(),{successCallback:{fn:function(v){var t=Alfresco.util.findValueByDotNotation(v.json,r.getPreference(c),null);if(t!==null){r.selectMenuValue(r.chartPicker,t)}var u=Alfresco.util.findValueByDotNotation(v.json,r.getPreference(m),null);if(u!==null){r.selectMenuValue(r.chartTypePicker,u)}r.loadChartData()},scope:this},failureCallback:{fn:function(){r.loadChartData()},scope:this}})},selectMenuValue:function e(o,q){o.value=q;var p=o.getMenu().getItems();for(var n in p){if(p.hasOwnProperty(n)){if(p[n].value===q){o.set("label",p[n].cfg.getProperty("text"));break}}}},loadChartData:function f(){if(this.chartPicker.value!==null&&this.chartPicker.value.length>0){Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"becpg/olap/chart?olapQueryId="+this.chartPicker.value,successCallback:{fn:this.processData,scope:this},failureCallback:{fn:function(){},scope:this}})}},processData:function i(n){this.data=n.json;this.cDataSource={};this.cDataSource.metadata=this.data.metadatas;this.cDataSource.resultset=this.data.resultsets;var p=[];this.columnDefs=[];this.seriesDef=[];this.barChartSeriesDef=[];for(var o in this.data.metadatas){p.push("col"+o);this.columnDefs.push({key:"col"+o,label:this.data.metadatas[o].colName});if(o>0){this.seriesDef.push({displayName:this.data.metadatas[o].colName,yField:"col"+o});this.barChartSeriesDef.push({displayName:this.data.metadatas[o].colName,xField:"col"+o})}}this.dataSource=new YAHOO.util.DataSource(this.data.resultsets);this.dataSource.responseType=YAHOO.util.DataSource.TYPE_JSARRAY;this.dataSource.responseSchema={fields:p};this.render()},showTooltipMessage:function j(n){return n.vars.series.label+"<br /> "+n.vars.category.label+"<br /> "+n.vars.value.value},render:function j(){var n=this;require(dojoConfig,["bccc"],function(q){if(n.dataSource!==null){var p=document.getElementById(n.id+"-chartContainer").offsetWidth;var o=document.getElementById(n.id+"-chartContainer").offsetHeight;if(n.chartTypePicker.value=="lineChart"){new q.LineChart({canvas:n.id+"-chart",width:p,height:o,dotsVisible:true,baseAxisSize:40,baseAxisDomainRoundMode:"nice",legend:true,legendPosition:"bottom",legendAlign:"center",legendDot_shape:"circle",animate:true,selectable:true,hoverable:true,tooltipFormat:function(r){return n.showTooltipMessage(r)}}).setData(n.cDataSource,{crosstabMode:true}).render()}else{if(n.chartTypePicker.value=="barChart"){new q.BarChart({canvas:n.id+"-chart",width:p,height:o,orientation:"horizontal",axisGrid:true,axisGrid_strokeStyle:"#F7F8F9",axisLabel_font:'normal 10px "Open Sans"',panelSizeRatio:0.3,legend:true,legendPosition:"bottom",legendAlign:"center",animate:true,selectable:true,hoverable:true,tooltipFormat:function(r){return n.showTooltipMessage(r)}}).setData(n.cDataSource,{crosstabMode:true}).render()}else{if(n.chartTypePicker.value=="columnChart"){new q.BarChart({canvas:n.id+"-chart",width:p,height:o,panelSizeRatio:0.3,legend:true,legendPosition:"bottom",legendAlign:"center",animate:true,baseAxisGrid:true,selectable:true,tooltipFormat:function(r){return n.showTooltipMessage(r)}}).setData(n.cDataSource,{crosstabMode:true}).render()}else{if(n.chartTypePicker.value=="pieChart"){new q.PieChart({canvas:n.id+"-chart",width:p,height:o,valuesVisible:true,valuesFont:'lighter 11px "Open Sans"',explodedSliceRadius:"10%",slice_offsetRadius:function(r){return r.isSelected()?"10%":0},legend:true,legendPosition:"right",legendAlign:"center",legendDot_shape:"circle",legendLabel_textStyle:function(s){var r=n.panel.axes.color.scale;return r(n.getValue())},selectable:true,hoverable:true,tooltipFormat:function(r){return n.showTooltipMessage(r)}}).setData(n.cDataSource,{crosstabMode:true}).render()}else{if(n.chartTypePicker.value=="chartData"){new YAHOO.widget.DataTable(n.id+"-chart",n.columnDefs,n.dataSource)}}}}}}})},openSaikuClick:function l(){if(this.saikuUrl!==null){window.open(this.saikuUrl)}}})})();