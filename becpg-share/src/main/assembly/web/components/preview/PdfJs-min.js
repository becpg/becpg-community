(function(){var e=0;var Z=96/72;var B=0.05;var ai=5;var A=YAHOO.util.Dom,Q=YAHOO.util.Event,ac=YAHOO.util.Element;var f=Alfresco.util.encodeHTML;Alfresco.WebPreview.prototype.Plugins.PdfJs=function(aE,aD){this.pages=[];this.pageText=[];this.widgets={};this.documentConfig={};this.wp=aE;this.wp.id=aE.id;this.attributes=YAHOO.lang.merge(Alfresco.util.deepCopy(this.attributes),aD);this.onPdfLoaded=new YAHOO.util.CustomEvent("pdfLoaded",this);this.onResize=new YAHOO.util.CustomEvent("resize",this);return this};Alfresco.WebPreview.prototype.Plugins.PdfJs.prototype={attributes:{src:null,srcMaxSize:"",skipbrowsertest:"false",defaultScale:"1.25",scaleDelta:"1.1",autoMinScale:"0.65",autoMinScaleMobile:"0.525",autoMaxScale:"1.25",pageLayout:"multi",disableTextLayer:"false",useLocalStorage:"true",autoSearch:"false",progressiveLoading:"false",disabledPageLinking:true},pdfDocument:null,pageNum:1,pages:[],pageText:[],numPages:0,widgets:{},maximized:false,documentConfig:{},inDashlet:false,workerSrc:"",currentScaleSelection:null,report:function i(){var aD=true,aF=this.attributes.skipbrowsertest==="true",aE=this.attributes.srcMaxSize;if(aE.match(/^\d+$/)&&this.wp.options.size>parseInt(aE)){return this.wp.msg("PdfJs.tooLargeFile",Alfresco.util.formatFileSize(this.wp.options.size),parseInt(aE))}if(!aF){if(this._isCanvasSupported()){if(YAHOO.env.ua.webkit>0&&YAHOO.env.ua.webkit<534){aD=false}if(YAHOO.env.ua.ie>0&&YAHOO.env.ua.ie<10){aD=false}if(YAHOO.env.ua.gecko>0&&YAHOO.env.ua.gecko<5){aD=false}}else{aD=false}}if(!aD){return this.wp.msg("label.browserReport","&lt;canvas&gt; element")}},_isCanvasSupported:function o(){var aD=document.createElement("canvas");return !!(aD.getContext&&aD.getContext("2d"))},display:function Y(){this.inDashlet=A.getAncestorByClassName(this.wp.getPreviewerElement(),"body")!=null||A.getAncestorByClassName(this.wp.getPreviewerElement(),"yui-panel")!=null;Alfresco.util.YUILoaderHelper.require(["tabview"],this.onComponentsLoaded,this);Alfresco.util.YUILoaderHelper.loadComponents();this.wp.getPreviewerElement().innerHTML="";return null},onComponentsLoaded:function g(){this.workerSrc=Alfresco.constants.URL_CONTEXT+"res/components/preview/pdfjs/pdf.worker"+(Alfresco.constants.DEBUG?".js":"-min.js");var aD=document.getElementsByTagName("script");for(var aG=0,aF=aD.length;aG<aF;aG++){if(aD[aG].src.indexOf("components/preview/pdfjs/pdf.worker_")>-1){this.workerSrc=aD[aG].src;break}}this._loadDocumentConfig();this.attributes.disabledPageLinking=(Alfresco.constants.PAGEID==="document-details"||Alfresco.constants.PAGEID==="entity-data-lists")?false:true;var aE=Alfresco.util.getQueryStringParameters(window.location.hash.replace("#",""));if(this.disabledPageLinking){this.pageNum=this.documentConfig.pageNum?parseInt(this.documentConfig.pageNum):this.pageNum}else{this.pageNum=aE.page||(this.documentConfig.pageNum?parseInt(this.documentConfig.pageNum):this.pageNum)}this.pageNum=parseInt(this.pageNum);Alfresco.util.Ajax.request({url:Alfresco.constants.URL_CONTEXT+"noauth/components/preview/pdfjs?htmlid="+encodeURIComponent(this.wp.id),successCallback:{fn:this.onViewerLoaded,scope:this},failureMessage:this.wp.msg("error.viewerload")});Q.addListener(window,"resize",this.onRecalculatePreviewLayout,this,true);Q.addListener(window,"hashchange",this.onWindowHashChange,this,true);Q.addListener(window,"beforeunload",this.onWindowUnload,this,true)},onViewerLoaded:function q(aJ){this.wp.getPreviewerElement().innerHTML=aJ.serverResponse.responseText;this.controls=A.get(this.wp.id+"-controls");this.pageNumber=A.get(this.wp.id+"-pageNumber");this.sidebar=A.get(this.wp.id+"-sidebar");this.viewer=A.get(this.wp.id+"-viewer");if(this.attributes.pageLayout=="multi"){A.addClass(this.viewer,"multiPage")}this.widgets.sidebarButton=Alfresco.util.createYUIButton(this,"sidebarBtn",this.onSidebarToggle,{type:"checkbox",disabled:true},this.wp.id+"-sidebarBtn");this.widgets.nextButton=Alfresco.util.createYUIButton(this,"next",this.onPageNext,{disabled:true},this.wp.id+"-next");this.widgets.previousButton=Alfresco.util.createYUIButton(this,"previous",this.onPagePrevious,{disabled:true},this.wp.id+"-previous");Q.addListener(this.wp.id+"-pageNumber","change",this.onPageChange,this,true);this.widgets.zoomOutButton=Alfresco.util.createYUIButton(this,"zoomOut",this.onZoomOut,{disabled:true},this.wp.id+"-zoomOut");this.widgets.zoomInButton=Alfresco.util.createYUIButton(this,"zoomIn",this.onZoomIn,{disabled:true},this.wp.id+"-zoomIn");this.widgets.scaleMenu=new YAHOO.widget.Button(this.wp.id+"-scaleSelectBtn",{type:"menu",menu:this.wp.id+"-scaleSelect",disabled:true});this.widgets.scaleMenu.getMenu().subscribe("click",this.onZoomChange,null,this);var aD=[{text:this.wp.msg("link.download"),value:"",onclick:{fn:this.onDownloadClick,scope:this}}];if(beCPG.constants.SHOW_DOWNLOAD_LINKS&&(Alfresco.constants.PAGEID==="entity-data-lists"||window.location.pathname.match("/entity-data-lists$")||beCPG.constants.IS_REPORT)){if(this.attributes.src){aD.push({text:this.wp.msg("link.downloadPdf"),value:"",onclick:{fn:this.onDownloadbPDFClick,scope:this}});if(this.wp.getContentUrl().indexOf(".docx")>0){aD.push({text:this.wp.msg("link.downloadXlsx"),value:"",onclick:{fn:this.onDownloadXLSXClick,scope:this}})}else{aD.push({text:this.wp.msg("link.downloadDocx"),value:"",onclick:{fn:this.onDownloadDOCXClick,scope:this}})}}else{aD.push({text:this.wp.msg("link.downloadXlsx"),value:"",onclick:{fn:this.onDownloadXLSXClick,scope:this}});aD.push({text:this.wp.msg("link.downloadDocx"),value:"",onclick:{fn:this.onDownloadDOCXClick,scope:this}})}}else{if(this.attributes.src){aD.push({text:this.wp.msg("link.downloadPdf"),value:"",onclick:{fn:this.onDownloadPDFClick,scope:this}})}}this.widgets.downloadButton=new YAHOO.widget.Button(this.wp.id+"-download",{type:"menu",menu:aD});if(Alfresco.constants.PAGEID==="document-details"||Alfresco.constants.PAGEID==="documentlibrary"||Alfresco.constants.PAGEID==="entity-data-lists"||window.location.pathname.match("/document-details$")||window.location.pathname.match("/entity-data-lists$")){this.widgets.maximize=Alfresco.util.createYUIButton(this,"fullpage",this.onMaximizeClick,{title:this.wp.msg("button.maximize.tip",YAHOO.env.ua.os=="macintosh"?this.wp.msg("key.meta"):this.wp.msg("key.ctrl"))},this.wp.id+"-fullpage");A.getElementsByClassName("maximizebutton","span",this.controls,function aI(aK){A.setStyle(aK,"display","inline")});A.getElementsByClassName("maximizebuttonSep","span",this.controls,function aI(aK){A.setStyle(aK,"display","inline")})}if(Alfresco.constants.PAGEID==="document-details"||Alfresco.constants.PAGEID==="entity-data-lists"){A.getElementsByClassName("linkbutton","span",this.controls,function aI(aK){A.setStyle(aK,"display","inline")});this.widgets.linkBn=Alfresco.util.createYUIButton(this,"link",this.onLinkClick,{type:"checkbox"},this.wp.id+"-link")}Q.addListener(this.wp.id+"-findInput","change",this.onFindChange,this,true);var aH=this;Q.addListener(this.wp.id+"-findInput","keypress",function(aK){if(aK.keyCode==13){Q.stopEvent(aK);aH.onFindChange("find")}});this.widgets.previousSearchButton=Alfresco.util.createYUIButton(this,"findPrevious",this.onFindChange,{},this.wp.id+"-findPrevious");this.widgets.nextSearchButton=Alfresco.util.createYUIButton(this,"findNext",this.onFindChange,{},this.wp.id+"-findNext");this.widgets.searchHighlight=Alfresco.util.createYUIButton(this,"findHighlightAll",this.onFindChangeHighlight,{type:"checkbox"},this.wp.id+"-findHighlightAll");this.widgets.searchMatchCase=Alfresco.util.createYUIButton(this,"findMatchCase",this.onFindChangeMatchCase,{type:"checkbox"},this.wp.id+"-findMatchCase");this.widgets.searchBarToggle=Alfresco.util.createYUIButton(this,"searchBarToggle",this.onToggleSearchBar,{type:"checkbox",disabled:true,title:this.wp.msg("button.search.tip",YAHOO.env.ua.os=="macintosh"?this.wp.msg("key.meta"):this.wp.msg("key.ctrl"))},this.wp.id+"-searchBarToggle");this.onPdfLoaded.subscribe(function aE(aL,aK){this.widgets.sidebarButton.set("disabled",false);this.widgets.scaleMenu.set("disabled",false);this.widgets.searchBarToggle.set("disabled",false)},this,true);this._setPreviewerElementHeight();this._setViewerHeight();this._loadPdf();if(Alfresco.constants.PAGEID==="document-details"||Alfresco.constants.PAGEID==="entity-data-lists"){var aG=function aG(aL,aK){var aM=aK[1];if((aM.ctrlKey||aM.metaKey)&&this.widgets.searchBarToggle){Q.stopEvent(aM);aM.newValue=(!this.widgets.searchDialog||!this.widgets.searchDialog.cfg.getProperty("visible"));this.widgets.searchBarToggle.set("checked",!this.widgets.searchBarToggle.get("checked"))}};var aF=function aF(aL,aK){var aM=aK[1];if(aM.ctrlKey||aM.metaKey){Q.stopEvent(aM);this.onFullScreen(aM)}};new YAHOO.util.KeyListener(document,{keys:37},{fn:this.onPagePrevious,scope:this,correctScope:true}).enable();new YAHOO.util.KeyListener(document,{keys:39},{fn:this.onPageNext,scope:this,correctScope:true}).enable();new YAHOO.util.KeyListener(document,{keys:70,ctrl:true},{fn:aG,scope:this,correctScope:true}).enable();new YAHOO.util.KeyListener(document,{keys:13,ctrl:true},{fn:aF,scope:this,correctScope:true}).enable();if(YAHOO.env.ua.os=="macintosh"){new YAHOO.util.KeyListener(document,{keys:13},{fn:aF,scope:this,correctScope:true}).enable();new YAHOO.util.KeyListener(document,{keys:70},{fn:aG,scope:this,correctScope:true}).enable()}Q.addListener(window,"fullscreenchange",this.onFullScreenChange,this,true);Q.addListener(window,"mozfullscreenchange",this.onFullScreenChange,this,true);Q.addListener(window,"webkitfullscreenchange",this.onFullScreenChange,this,true)}new YAHOO.util.KeyListener(document,{keys:27},{fn:function(aK){if(this.maximized){this.onMaximizeClick()}},scope:this,correctScope:true}).enable()},_setPreviewerElementHeight:function aj(){if(!this.maximized){var aH;if(this.inDashlet){A.setStyle(this.wp.getPreviewerElement(),"height",(A.getClientHeight()-64)+"px")}else{if(aH=A.getAncestorByClassName(this.wp.getPreviewerElement(),"dijitDialogPaneContent")){var aI=A.getStyle(aH,"height");var aD=(parseInt(aI)-42)+"px";A.setStyle(this.wp.getPreviewerElement(),"height",aD)}else{var aG=new YAHOO.util.Element(this.wp.getPreviewerElement()),aF=A.getDocumentHeight(),aE=A.getClientHeight();var aD=((aF<aE)?aF:aE)-220;A.setStyle(this.wp.getPreviewerElement(),"height",aD+"px")}}}else{if(this.fullscreen){}else{A.setStyle(this.wp.getPreviewerElement(),"height",(window.innerHeight||A.getViewportHeight()).toString()+"px")}}},_setViewerHeight:function ao(){var aG=A.getRegion(this.viewer.parentNode),aL=A.getRegion(this.controls),aD=!this.fullscreen?aL.height:0,aE=aG.height-aD-1;if(aE===0){if(!this.maximized){var aH;if(aH=A.getAncestorByClassName(this.wp.getPreviewerElement(),"dijitDialogPaneContent")){var aI=A.getStyle(aH,"height");var aK=(parseInt(aI)-42-10-aD-1)+"px";A.setStyle(this.wp.getPreviewerElement(),"height",aK)}else{var aF=new YAHOO.util.Element(this.wp.getPreviewerElement()),aM=A.getDocumentHeight(),aJ=A.getClientHeight();var aK=((aM<aJ)?aM:aJ)-220;aE=aK-10-aD-1}}else{aE=A.getViewportHeight()-aD-1}}if(!this.fullscreen){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Setting viewer height to "+aE+"px (toolbar "+aD+"px, container "+aG.height+"px")}A.setStyle(this.viewer,"height",aE.toString()+"px");A.setStyle(this.sidebar,"height",aE.toString()+"px")}else{if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Setting viewer height to 100% (full-screen)")}A.setStyle(this.viewer,"height","100%")}},_loadPdf:function W(aF){this.wp.options.name=this.wp.options.name.replace(/[^\w_\-\. ]/g,"");var aE=this,aD=this.attributes.src?this.wp.getThumbnailUrl(this.attributes.src):this.wp.getContentUrl();if((Alfresco.constants.PAGEID==="entity-data-lists"||window.location.href.indexOf("entity-data-lists")>0||beCPG.constants.IS_REPORT)&&aD.indexOf("thumbnails")<0){aD=aD.replace("/api/","/becpg/report/")+(!beCPG.constants.IS_REPORT?"&entityNodeRef="+YAHOO.util.History.getQueryStringParameter("nodeRef"):"")}if(aD.substr(0,4).toLowerCase()!=="http"){aD=window.location.protocol+"//"+window.location.host+aD}aF=aF||{};aF.url=aD;if(typeof window.Spinner==="function"){this.spinner=new Spinner({lines:13,length:7,width:4,radius:10,corners:1,rotate:0,color:"#666",speed:1,trail:60,shadow:false,hwaccel:false,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"}).spin(this.viewer);this.onPdfLoaded.subscribe(function aG(aI,aH){this.spinner.stop()},this,true)}else{Alfresco.logger.error("spinner.js is not loaded!")}PDFJS.workerSrc=this.workerSrc;PDFJS.cMapUrl="./cmaps/";PDFJS.cMapPacked=true;if(this.attributes.progressiveLoading=="true"&&PDFJS.disableRange!=true){PDFJS.disableRange=false;PDFJS.disableAutoFetch=false}else{PDFJS.disableRange=true}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Using PDFJS.disableRange="+PDFJS.disableRange+" PDFJS.disableAutoFetch:"+PDFJS.disableAutoFetch);Alfresco.logger.debug("Loading PDF file from "+aD)}PDFJS.getDocument(aF).then(Alfresco.util.bind(this._onGetDocumentSuccess,this),Alfresco.util.bind(this._onGetDocumentFailure,this))},_onGetDocumentSuccess:function al(aD){this.pdfDocument=aD;this.numPages=this.pdfDocument.numPages;if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Rendering PDF with fingerprint "+aD.fingerprint+" for "+this.wp.options.name)}this._renderPdf();this._updatePageControls();this.onPdfLoaded.fire(aD)},_onGetDocumentFailure:function ag(aO,aG){if(this.spinner){this.spinner.stop()}if(aG&&aG.name==="PasswordException"){var aI="prompt.password.text";if(aG.code==="incorrectpassword"){aI="error.incorrectpassword"}if(aG.code==="needpassword"||aG.code==="incorrectpassword"){var aH=this,aE=Alfresco.util.generateDomId(),aL=Alfresco.util.bind(function(aP){if(aP&&aP.length>0){this._loadPdf({password:aP})}},this),aF=Alfresco.util.PopupManager.getUserInput({title:this.wp.msg("prompt.password.title"),html:'<label for="'+aE+'">'+f(this.wp.msg(aI))+'</label><br/><br/><input id="'+aE+'" tabindex="0" type="password" value=""/>',buttons:[{text:Alfresco.util.message("button.ok",this.name),handler:function aM(){aL(A.get(aE).value);this.destroy()},isDefault:true},{text:Alfresco.util.message("button.cancel",this.name),handler:function aJ(){this.destroy()}}]}),aK=aF.getButtons()[0];YAHOO.util.Event.addListener(aE,"keyup",function(aP,aQ){if(aQ!=null){aQ.set("disabled",YAHOO.lang.trim(this.value||this.text||"").length==0)}},aK);new YAHOO.util.KeyListener(aE,{keys:[YAHOO.util.KeyListener.KEY.ENTER]},function aN(aP){aL(A.get(aE).value);aF.destroy()}).enable();if(A.get(aE)){A.get(aE).focus()}return}}var aD=this.wp.msg("error.pdfload");if(aG&&aG.name==="InvalidPDFException"){aD=this.wp.msg("error.invalidpdf")}Alfresco.util.PopupManager.displayMessage({text:aD});if(aG&&aG.name){Alfresco.logger.error("Could not load PDF due to error "+aG.name+" (code "+aG.code+"): "+aO)}},_renderPdf:function ar(){var aG=[],aH={},aD=this.numPages;for(var aJ=1;aJ<=aD;aJ++){aG.push(this.pdfDocument.getPage(aJ))}var aM=Promise.all(aG);var aL=this.pdfDocument.getDestinations();var aF=Alfresco.util.bind(function(aT){var aN=this;this.documentView=new I(this.wp.id+"-viewer",{name:"documentView",pageLayout:this.attributes.pageLayout,currentScale:e,defaultScale:this.documentConfig.scale?this.documentConfig.scale:this.attributes.defaultScale,disableTextLayer:this.attributes.disableTextLayer=="true"||YAHOO.env.ua.ios||YAHOO.env.ua.android,autoMinScale:parseFloat(A.getClientWidth()>1024?this.attributes.autoMinScale:this.attributes.autoMinScaleMobile),autoMaxScale:parseFloat(this.attributes.autoMaxScale),pdfJsPlugin:aN,pdfDocument:this.pdfDocument});this.documentView.onScrollChange.subscribe(function aR(){var aU=this.documentView.getScrolledPageNumber();if(this.pageNum!=aU){this.pageNum=aU;this._updatePageControls();this.documentView.setActivePage(this.pageNum)}},this,true);this.thumbnailView=null;this.pages=aT;this.documentView.addPages(aT);for(var aP=0;aP<aT.length;aP++){var aQ=aT[aP],aS=aQ.ref;aH[aS.num+" "+aS.gen+" R"]=aP}this.documentView.render();if(this.pageNum>this.pdfDocument.numPages){this.pageNum=this.pdfDocument.numPages;this._updatePageControls()}this.documentView.scrollTo(this.pageNum);this.documentView.setActivePage(this.pageNum);this._updateZoomControls();A.get(this.wp.id+"-numPages").textContent=this.numPages;A.setAttribute(this.wp.id+"-pageNumber","max",this.numPages);A.setAttribute(this.wp.id+"-pageNumber","disabled",this.numPages>1?null:"disabled");A.get(this.wp.id+"-pageNumber").removeAttribute("disabled");if(this.attributes.autoSearch=="true"&&document.referrer&&document.referrer.indexOf("/search?")>0){var aO=Alfresco.util.getQueryStringParameter("t",document.referrer);if(aO){this.widgets.searchBarToggle.set("checked",true);A.get(this.wp.id+"-findInput").value=aO;this.onFindChange("find")}}},this);var aI=Alfresco.util.bind(function(aN){this.destinations=aN},this);var aK=Alfresco.util.bind(function(aN){this._addOutline(aN)},this);var aE=Alfresco.util.bind(function(){this.pdfDocument.getOutline().then(aK)},this);aM.then(aF);this.pagesRefMap=aH;aL.then(aI);Promise.all([aM,aL]).then(aE)},_updatePageControls:function ad(){this.pageNumber.value=this.pageNum;this.widgets.nextButton.set("disabled",this.pageNum>=this.pdfDocument.numPages);this.widgets.previousButton.set("disabled",this.pageNum<=1)},_updateZoomControls:function V(aE){var aD=this.documentView.currentScale;this.widgets.zoomInButton.set("disabled",aD*this.attributes.scaleDelta>ai);this.widgets.zoomOutButton.set("disabled",aD/this.attributes.scaleDelta<B);this.widgets.scaleMenu.set("label",""+Math.round(aD*100)+"%")},_scrollToPage:function ab(aD){this.documentView.removeScrollListener();this.documentView.scrollTo(aD);this.documentView.setActivePage(this.pageNum);this.pageNum=aD;this._updatePageControls();if(this.thumbnailView&&this.thumbnailView.pages&&this.thumbnailView.pages[0]&&this.thumbnailView.pages[0].container){this.thumbnailView.setActivePage(this.pageNum)}YAHOO.lang.later(50,this.documentView,this.documentView.addScrollListener)},_addOutline:function az(aD){var aJ=A.get(this.wp.id+"-outlineView");if(aD&&aD.length>0){var aI=[{parent:aJ,items:aD}];while(aI.length>0){var aE=aI.shift();var aH,aG=aE.items.length;for(aH=0;aH<aG;aH++){var aM=aE.items[aH];var aF=document.createElement("div");aF.className="outlineItem";var aL=document.createElement("a");A.setAttribute(aL,"href","#");YAHOO.util.Event.addListener(aL,"click",function(aO,aN){YAHOO.util.Event.stopEvent(aO);this._navigateTo(aN)},aM.dest,this);aL.textContent=aM.title;aF.appendChild(aL);if(aM.items.length>0){var aK=document.createElement("div");aK.className="outlineItems";aF.appendChild(aK);aI.push({parent:aK,items:aM.items})}aE.parent.appendChild(aF)}}}else{aJ.innerHTML="<p>"+this.wp.msg("msg.noOutline")+"</p>"}},_navigateTo:function c(aE){if(typeof aE==="string"){aE=this.destinations[aE]}if(aE instanceof Array){var aF=aE[0];var aD=aF instanceof Object?this.pagesRefMap[aF.num+" "+aF.gen+" R"]:(aF+1);if(aD>this.documentView.pages.length-1){aD=this.documentView.pages.length-1}if(typeof aD==="number"){this._scrollToPage(aD+1)}}},_loadDocumentConfig:function aw(){if(this.attributes.useLocalStorage!="true"||!this._browserSupportsHtml5Storage()){this.documentConfig={}}else{var aD="org.alfresco.pdfjs.document."+this.wp.options.nodeRef.replace(":/","").replace("/",".")+".";this.documentConfig={pageNum:window.localStorage[aD+"pageNum"],scale:window.localStorage[aD+"scale"]};if(this.documentConfig.scale=="null"){this.documentConfig.scale=null}}},_browserSupportsHtml5Storage:function aA(){try{return"localStorage" in window&&window.localStorage!==null}catch(aD){return false}},onSidebarToggle:function am(aG){var aD=A.getStyle(this.sidebar,"display")=="block";A.setStyle(this.sidebar,"display",aD?"none":"block");if(aD){A.removeClass(this.viewer,"sideBarVisible")}else{A.addClass(this.viewer,"sideBarVisible");if(!this.thumbnailView){this.thumbnailView=new I(this.wp.id+"-thumbnailView",{name:"thumbnailView",pageLayout:"single",defaultScale:"page-width",disableTextLayer:true,pdfJsPlugin:this});this.thumbnailView.addPages(this.pages)}}this.documentView.alignRows();this.documentView.setScale(this.documentView.parseScale(this.currentScaleSelection?this.currentScaleSelection:this.attributes.defaultScale));this._scrollToPage(this.pageNum);this.documentView.renderVisiblePages();var aF=function aF(aI,aH){YAHOO.util.Event.stopEvent(aI);this._scrollToPage(aH.pn)};this.widgets.tabview=this.widgets.tabview||new YAHOO.widget.TabView(this.wp.id+"-sidebarTabView");if(this.thumbnailView&&this.thumbnailView.pages.length>0&&!this.thumbnailView.pages[0].container){this.thumbnailView.render();for(var aE=0;aE<this.thumbnailView.pages.length;aE++){YAHOO.util.Event.addListener(this.thumbnailView.pages[aE].container,"click",function(aI,aH){this.thumbnailView.setActivePage(aH.pn);this.documentView.scrollTo(aH.pn)},{pn:aE+1},this)}this.thumbnailView.scrollTo(this.pageNum);this.thumbnailView.setActivePage(this.pageNum)}},onPagePrevious:function l(aD){if(this.pageNum<=1){return}this.pageNum--;this._scrollToPage(this.pageNum)},onPageNext:function M(aD){if(this.pageNum<this.pdfDocument.numPages){this.pageNum++;this._scrollToPage(this.pageNum)}},onFullScreen:function U(aE){var aD=this.viewer;if((document.fullScreenElement&&document.fullScreenElement!==null)||(!document.mozFullScreenElement&&!document.webkitFullScreenElement&&!document.webkitFullscreenElement)){Q.removeListener(window,"resize",this.onRecalculatePreviewLayout,this,true);if(aD.requestFullScreen){aD.requestFullScreen()}else{if(aD.mozRequestFullScreen){aD.mozRequestFullScreen()}else{if(aD.webkitRequestFullScreen){aD.webkitRequestFullScreen(ac.ALLOW_KEYBOARD_INPUT)}}}}else{if(document.cancelFullScreen){document.cancelFullScreen()}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else{if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}}}}},onFullScreenChange:function b(aD){if(aD.type&&aD.type.indexOf("attrmodified-"===0)){}else{if((document.fullScreenElement&&document.fullScreenElement!==null)||(!document.mozFullScreenElement&&!document.webkitFullScreenElement&&!document.webkitFullscreenElement)){Alfresco.logger.debug("Leaving full screen mode");this.fullscreen=false;this.documentView.fullscreen=false;this.documentView.setScale(this.oldScale);this._setViewerHeight();this.onResize.fire();this.documentView.alignRows();this._scrollToPage(this.pageNum);Q.addListener(window,"resize",this.onRecalculatePreviewLayout,this,true)}else{Alfresco.logger.debug("Entering full screen mode");this.documentView.fullscreen=true;this.fullscreen=true;this.oldScale=this.documentView.currentScale;this.oldPageNum=this.pageNum;this._setViewerHeight();this.onResize.fire();this.documentView.setScale(this.documentView.parseScale("page-fit"));this.documentView.alignRows();this._scrollToPage(this.pageNum)}}},onPageChange:function ay(aE){var aD=parseInt(aE.currentTarget.value);if(aD<1||aD>this.numPages){Alfresco.util.PopupManager.displayMessage({text:this.wp.msg("error.badpage")})}else{this.pageNum=aD;this._scrollToPage(this.pageNum)}},onToggleSearchBar:function O(aE){if(!this.widgets.searchDialog){this.widgets.searchDialog=new YAHOO.widget.SimpleDialog(this.wp.id+"-searchDialog",{close:false,draggable:false,effect:null,modal:false,visible:false,width:"265px",context:[this.viewer,"tr","tr",["beforeShow","windowResize"],[-20,3]],underlay:"none"});this.widgets.searchDialog.render();new YAHOO.util.KeyListener(A.get(this.wp.id+"-searchDialog"),{keys:27},{fn:function(aG,aF){if(this.widgets.searchBarToggle.get("checked")){var aH=aF[1];Q.stopEvent(aH);this.widgets.searchBarToggle.set("checked",false)}},scope:this,correctScope:true}).enable()}if(this.widgets.linkBn&&this.widgets.linkBn.get("checked")===true){this.widgets.linkBn.set("checked",false)}if(aE.newValue===true){this.widgets.searchDialog.show();this.widgets.searchDialog.bringToTop();var aD=A.get(this.wp.id+"-findInput");aD.focus();aD.select();if(!r.pdfPageSource){r.initialize({pdfPageSource:this.documentView});r.resolveFirstPage()}r.reset();r.extractText()}else{this.widgets.searchDialog.hide();r.active=false}},onFindChangeMatchCase:function j(aD){this.onFindChange("casesensitivitychange")},onFindChangeHighlight:function w(aD){this.onFindChange("highlightallchange")},onFindChange:function at(aK){var aJ=A.get(this.wp.id+"-findInput").value;if(!aJ){return}var aI=document.createEvent("CustomEvent"),aH=false,aG="find",aF=this.widgets.searchHighlight.get("checked"),aD=this.widgets.searchMatchCase.get("checked"),aE;if(aK.currentTarget){aE=aK.currentTarget.id}else{aE=aK}switch(aE){case this.wp.id+"-findNext":aG+="again";break;case this.wp.id+"-findPrevious":aG+="again";aH=true;break;case"highlightallchange":aG+="highlightallchange";break;case"casesensitivitychange":aG+="casesensitivitychange";break;default:if(aJ===this.lastSearchQuery){aG+="again";break}else{break}}this.lastSearchQuery=aJ;aI.initCustomEvent(aG,true,true,{query:aJ,caseSensitive:aD,highlightAll:aF,findPrevious:aH});window.dispatchEvent(aI)},onZoomOut:function s(aE){var aD=Math.max(B,this.documentView.currentScale/this.attributes.scaleDelta);this.documentView.setScale(this.documentView.parseScale(aD));this._scrollToPage(this.pageNum);this._updateZoomControls()},onZoomIn:function R(aE){var aD=Math.min(ai,this.documentView.currentScale*this.attributes.scaleDelta);this.documentView.setScale(this.documentView.parseScale(aD));this._scrollToPage(this.pageNum);this._updateZoomControls()},onZoomChange:function d(aF,aE){var aD=aE[0],aG=aE[1];this.currentScaleSelection=aG.value;this.documentView.setScale(this.documentView.parseScale(aG.value));this._scrollToPage(this.pageNum);this._updateZoomControls()},onDownloadClick:function an(aD){window.open(this.wp.getContentUrl(true).replace("api/node","slingshot/node"),"_blank")},onDownloadPDFClick:function X(aD){window.open(this.wp.getThumbnailUrl(this.attributes.src)+"&a=true","_blank")},onDownloadXLSXClick:function a(aD){window.open(this.getDownloadAtFormat(aD,"xlsx").replace("docx","xlsx").replace("pdf","xlsx"),"_blank")},onDownloadDOCXClick:function av(aD){window.open(this.getDownloadAtFormat(aD,"docx").replace("pdf","docx").replace("xlsx","docx"),"_blank")},onDownloadbPDFClick:function av(aD){window.open(this.getDownloadAtFormat(aD,"pdf").replace("docx","pdf").replace("xlsx","pdf"),"_blank")},getDownloadAtFormat:function av(aE,aD){return this.wp.getContentUrl(true).replace("/api/","/becpg/report/")+(!beCPG.constants.IS_REPORT?"&entityNodeRef="+YAHOO.util.History.getQueryStringParameter("nodeRef"):"")+"&format="+aD},onMaximizeClick:function z(aD){this.maximized=!this.maximized;if(this.maximized){A.addClass(this.wp.getPreviewerElement(),"fullPage");this.widgets.maximize.set("label",this.wp.msg("button.minimize"));this.widgets.maximize.set("title",this.wp.msg("button.minimize.tip",YAHOO.env.ua.os=="macintosh"?this.wp.msg("key.meta"):this.wp.msg("key.ctrl")))}else{A.removeClass(this.wp.getPreviewerElement(),"fullPage");this.widgets.maximize.set("label",this.wp.msg("button.maximize"));this.widgets.maximize.set("title",this.wp.msg("button.maximize.tip",YAHOO.env.ua.os=="macintosh"?this.wp.msg("key.meta"):this.wp.msg("key.ctrl")))}this._setPreviewerElementHeight();this._setViewerHeight();this.onResize.fire();this.documentView.setScale(this.documentView.parseScale(this.currentScaleSelection?this.currentScaleSelection:this.attributes.defaultScale));this._scrollToPage(this.pageNum);this.documentView.alignRows();this.documentView.renderVisiblePages();if(this.thumbnailView){this.thumbnailView.renderVisiblePages()}if(this.widgets.searchDialog){this.widgets.searchDialog.align("tr","tr")}if(this.widgets.linkDialog){this.widgets.linkDialog.align("tr","tr")}},onLinkClick:function h(aK){var aJ=this.wp.id+"-linkDialog",aH=aJ+"-input";var aD=function aE(){var aO=this.widgets.linkDialogBg.get("checkedButton").get("id");var aN=window.location.href.replace(window.location.hash,"")+(aO.indexOf("-doc")>0?"":"#page="+this.pageNum);var aM=A.get(aH);aM.value=aN;aM.focus();aM.select()};if(!this.widgets.linkDialog){var aL=new YAHOO.widget.SimpleDialog(aJ,{close:false,draggable:false,effect:null,modal:false,visible:false,context:[this.viewer,"tr","tr",["beforeShow","windowResize"],[-20,3]],width:"40em",underlay:"none"});var aF=window.location.href.replace(window.location.hash,"")+"#page="+this.pageNum;aL.render();new YAHOO.util.KeyListener(A.get(aJ),{keys:27},{fn:function(aN,aM){if(this.widgets.linkBn.get("checked")){var aO=aM[1];Q.stopEvent(aO);this.widgets.linkBn.set("checked",false)}},scope:this,correctScope:true}).enable();var aI=new YAHOO.widget.ButtonGroup(aJ+"-bg");for(var aG=0;aG<aI.getCount();aG++){aI.getButton(aG).addListener("click",aD,null,this)}this.widgets.linkDialogBg=aI;this.widgets.linkDialog=aL;YAHOO.util.Event.addListener(aH,"click",function(){this.focus();this.select()})}if(this.widgets.searchBarToggle.get("checked")===true){this.widgets.searchBarToggle.set("checked",false)}if(!this.widgets.linkDialog.cfg.getProperty("visible")){this.widgets.linkDialog.show();this.widgets.linkDialog.bringToTop();aD.call(this)}else{this.widgets.linkDialog.hide()}},onRecalculatePreviewLayout:function aq(aD){if(this.documentView){Alfresco.logger.debug("onRecalculatePreviewLayout");this._setPreviewerElementHeight();this._setViewerHeight();this.onResize.fire();this.documentView.setScale(this.documentView.parseScale(this.currentScaleSelection?this.currentScaleSelection:this.attributes.defaultScale));this._scrollToPage(this.pageNum);this.documentView.alignRows();this.documentView.renderVisiblePages()}if(this.thumbnailView){this.thumbnailView.renderVisiblePages()}},onWindowHashChange:function N(aE){if(this.disabledPageLinking){return}var aD=Alfresco.util.getQueryStringParameters(window.location.hash.replace("#",""));pn=aD.page;if(pn){if(pn>this.pdfDocument.numPages){pn=this.pdfDocument.numPages}else{if(pn<1){pn=1}}this.pageNum=parseInt(pn);this._scrollToPage(this.pageNum)}},onWindowUnload:function p(){if(this.attributes.useLocalStorage=="true"&&this._browserSupportsHtml5Storage()&&this.documentView){var aD="org.alfresco.pdfjs.document."+this.wp.options.nodeRef.replace(":/","").replace("/",".")+".";if(this.pageNum){window.localStorage[aD+"pageNum"]=this.pageNum}if(this.documentView.lastScale){window.localStorage[aD+"scale"]=this.documentView.lastScale}if(this.widgets.sidebarButton){window.localStorage[aD+"sidebar-enabled"]=this.widgets.sidebarButton.get("checked")}}}};var u=function(aH,aG,aF,aE,aD){this.id=aH;this.content=aG;this.parent=aF;this.canvas=null;this.container=null;this.loadingIconDiv=null;this.textLayerDiv=null;this.config=aE||{};this.textContent=null;this.textLayerDiv=null;this.pdfJsPlugin=aD};u.prototype={render:function C(){var aE=document.createElement("div");aE.id=this.parent.id+"-pageContainer-"+this.id;A.addClass(aE,"page");this.parent.viewer.appendChild(aE);var aD=document.createElement("div");A.addClass(aD,"loadingIcon");aE.appendChild(aD);this.container=aE;this.loadingIconDiv=aD;this._setPageSize()},getRegion:function k(){return A.getRegion(this.container)},getVPos:function ah(aD){return this.container.getBoundingClientRect().top+A.getDocumentScrollTop()-this.parent.viewerRegion.top},renderContent:function t(){var aN=this.getRegion(),aE=document.createElement("canvas");aE.id=this.container.id.replace("-pageContainer-","-canvas-");aE.mozOpaque=true;this.container.appendChild(aE);this.canvas=aE;A.setStyle(aE,"visibility","hidden");aE.width=aN.width;aE.height=aN.height;var aL=this.content.getViewport(this.parent.currentScale);var aH=null;if(!this.parent.config.disableTextLayer){aH=document.createElement("div");aH.className="textLayer";this.container.appendChild(aH)}this.textLayerDiv=aH;this.textLayer=aH?new ak(aH,this.id-1,this.pdfJsPlugin,aL):null;var aK=this.content,aO=aK.view,aP=aE.getContext("2d");var aF={canvasContext:aP,viewport:aL,textLayer:this.textLayer};var aD=0;if(Alfresco.logger.isDebugEnabled()){aD=Date.now()}var aG=Alfresco.util.bind(function aI(aQ){this.textLayer.setTextContent(aQ)},this);var aJ=Alfresco.util.bind(function aM(){if(this.textLayer){this.getTextContent().then(aG)}if(this.loadingIconDiv){A.setStyle(this.loadingIconDiv,"display","none")}A.setStyle(this.canvas,"visibility","visible");if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Rendered "+this.parent.name+" page "+this.id+" in "+(Date.now()-aD)+"ms")}},this);aK.render(aF).promise.then(aJ)},_setPageSize:function G(aD){var aE=this.content.getViewport(this.parent.currentScale);A.setStyle(this.container,"height",Math.floor(aE.height)+"px");A.setStyle(this.container,"width",Math.floor(aE.width)+"px")},reset:function n(){this._setPageSize();if(this.canvas){this.container.removeChild(this.canvas);delete this.canvas;this.canvas=null}if(this.loadingIconDiv){A.setStyle(this.loadingIconDiv,"display","block")}},getTextContent:function F(){if(!this.textContent){this.textContent=this.content.getTextContent()}return this.textContent},scrollIntoView:function D(aE,aD){var aF=0;if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Page Scroll")}if(aE){aF+=aE.offsetTop;if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Page Scroll offsetTop "+aE.offsetTop)}}if(aD){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Page Scroll spot "+aD.top)}aF+=aD.top}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Page Scroll "+aF)}this.parent.scrollTo(this.id,aF)}};var I=function(aF,aE){this.id=aF;this.config=aE||{};this.pages=[];this.viewer=A.get(aF);this.viewerRegion=A.getRegion(this.viewer);this.currentScale=aE.currentScale||e;this.name=this.config.name||"";this.pdfJsPlugin=aE.pdfJsPlugin;this.pdfDocument=aE.pdfDocument;this.lastScroll=0;var aD=this;this.viewer.addEventListener("scroll",function(){aD.lastScroll=Date.now()},false);this.pdfJsPlugin.onResize.subscribe(this.onResize,this,true);this.addScrollListener();this.onScrollChange=new YAHOO.util.CustomEvent("scrollChange",this)};I.prototype={activePage:null,lastScale:null,renderOnScrollZero:0,addPage:function E(aF,aD){var aE=new u(aF,aD,this,{},this.pdfJsPlugin);this.pages.push(aE)},addPages:function J(aD){for(var aE=0;aE<aD.length;aE++){var aF=aD[aE];this.addPage(aE+1,aF)}},render:function P(){for(var aD=0;aD<this.pages.length;aD++){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Rendering "+this.name+" page container "+(aD+1))}this.pages[aD].render()}if(this.currentScale===e){this.setScale(this.parseScale(this.config.defaultScale))}else{this.alignRows()}},reset:function ax(){for(var aD=0;aD<this.pages.length;aD++){this.pages[aD].reset()}this.alignRows()},alignRows:function aB(){var aD=-1,aG=0,aH=0,aK=A.getDocumentScrollTop();if(this.config.pageLayout=="multi"){A.setStyle(this.viewer,"padding-left","0px");for(var aI=0;aI<this.pages.length;aI++){var aJ=this.pages[aI],aE=aJ.container,aL=aE.getBoundingClientRect(),aM=aL.top+aK-aJ.parent.viewerRegion.top,aF=parseInt(A.getStyle(aE,"margin-left"));if(aM!=aD){aG=aF}aG+=aL.width+aF;aH=Math.max(aH,aG);aD=aM}A.setStyle(this.viewer,"padding-left",Math.floor((this.viewer.clientWidth-aH)/2)+"px")}},renderVisiblePages:function x(){this.viewerRegion=A.getRegion(this.viewer);var aL=this.viewerRegion.height,aK=this.viewerRegion.top,aJ=A.getDocumentScrollTop();if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Render "+this.name+" visible pages: viewer height "+this.viewerRegion.height+"px")}for(var aF=0;aF<this.pages.length;aF++){var aH=this.pages[aF];if(!aH.canvas){var aE=aH.container.getBoundingClientRect(),aI=aE.top+aJ-aK,aD=aI+aE.height,aG=1.5;if(aI<0&&0<aD||-aL*aG<aD&&aD<aL||0<aI&&aI<aL*(aG+1)){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Rendering "+this.name+" page "+(aF+1)+" content (page top:"+aI+", bottom:"+aD+")")}aH.renderContent()}}}},scrollTo:function v(aH,aG){var aD=this.pages[aH-1].getVPos(),aF=this.pages[0].getVPos();if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Scrolling "+this.name+" to page "+aH+". New page top is "+aD+"px. First page top is "+aF+"px")}var aE=aD-aF;if(aG){aE+=aG}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Old scrollTop was "+this.viewer.scrollTop+"px");Alfresco.logger.debug("Set scrollTop to "+aE+"px");Alfresco.logger.debug("scrollTop offsetY "+aG)}this.viewer.scrollTop=aE;this.pageNum=aH;this.renderVisiblePages()},setScale:function af(aD){if(aD==this.currentScale){return}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Scale is now "+aD)}this.currentScale=aD;this.reset();this.alignRows()},parseScale:function aa(aN){var aV=parseFloat(aN);if(aV){this.lastScale=aN;return aV}if(this.pages.length!==0){var aQ=this.pages[0],aL=aQ.container,aI=parseInt(A.getStyle(aL,"margin-left"))+parseInt(A.getStyle(aL,"margin-right")),aK=parseInt(A.getStyle(aL,"margin-top")),aM=parseInt(aQ.content.pageInfo.view[2]),aP=parseInt(aQ.content.pageInfo.view[3]),aO=aQ.content.pageInfo.rotate,aS=this.fullscreen?window.screen.width:this.viewer.clientWidth-1,aH=this.fullscreen?window.screen.height:this.viewer.clientHeight;Alfresco.logger.debug("Client height: "+this.viewer.clientHeight);if(aO===90||aO===270){var aU=aM;aM=aP;aP=aU}switch(aN){case"page-width":var aE=(aS-aI*2)/aM;aV=aE;break;case"two-page-width":var aE=(aS-aI*3)/aM;aV=aE/2;break;case"page-height":var aD=(aH-aK*2)/aP;aV=aD;break;case"page-fit":var aE=(aS-aI*2)/aM,aD=(aH-aK*2)/aP;aV=Math.min(aE,aD);break;case"two-page-fit":var aE=(aS-aI*3)/aM,aD=(aH-aK*2)/aP;aV=Math.min(aE/2,aD);break;case"auto":var aF=this.parseScale("two-page-fit"),aJ=this.parseScale("page-fit"),aW=this.parseScale("page-width"),aR=this.parseScale("two-page-width"),aT=this.config.autoMinScale,aG=this.config.autoMaxScale;if(aF>aT&&this.numPages>1){aV=aF}else{if(aJ>aT){aV=aJ}else{if(aR>aT&&this.numPages>1){aV=aR}else{aV=aW}}}if(aG){aV=Math.min(aV,aG)}break;default:throw"Unrecognised zoom level '"+aN+"'"}}else{throw"Unrecognised zoom level - no pages"}this.lastScale=aN;return aV},getScrolledPageNumber:function L(){for(var aD=0;aD<this.pages.length;aD++){var aE=this.pages[aD],aF=aE.getVPos();if(aF+parseInt(aE.container.style.height)/2>0){return aD+1}}return this.pages.length},setActivePage:function m(aD){if(this.activePage){A.removeClass(this.activePage.container,"activePage")}A.addClass(this.pages[aD-1].container,"activePage");this.activePage=this.pages[aD-1]},onResize:function H(){this.viewerRegion=A.getRegion(this.viewer)},addScrollListener:function y(){Q.addListener(this.viewer,"scroll",this.onScrollEvent,this,true)},removeScrollListener:function y(){Q.removeListener(this.viewer,"scroll",this.onScrollEvent)},onScrollEvent:function au(aD){this.renderOnScrollZero++;YAHOO.lang.later(50,this,this.onScroll,aD)},onScroll:function aC(aD){this.renderOnScrollZero--;if(this.renderOnScrollZero==0){this.renderVisiblePages();this.onScrollChange.fire(this)}}};var T=-50;var K=-400;var ak=function S(aJ,aD,aM,aN){var aK=document.createDocumentFragment();this.textDivs=[];this.viewport=aN;this.textLayerDiv=aJ;this.layoutDone=false;this.divContentDone=false;this.pageIdx=aD;this.matches=[];this.pdfJsPlugin=aM;this.isViewerInPresentationMode=false;if(typeof r==="undefined"){window.PDFFindController=null}if(typeof this.lastScrollSource==="undefined"){this.lastScrollSource=null}this.renderLayer=function aI(){var aV=this.textDivs;var aQ=document.createElement("canvas");var aZ=aQ.getContext("2d");var aS=100000;if(aV.length>aS){return}for(var aU=0,aX=aV.length;aU<aX;aU++){var aT=aV[aU];if("isWhitespace" in aT.dataset){continue}aZ.font=aT.style.fontSize+" "+aT.style.fontFamily;var aP=aZ.measureText(aT.textContent).width;if(aP>0){aK.appendChild(aT);var aW=aT.dataset.canvasWidth/aP;var aY=aT.dataset.angle;var aR="scale("+aW+", 1)";aR="rotate("+aY+"deg) "+aR;A.setStyle(aT,"-ms-transform","scale("+aW+", 1)");A.setStyle(aT,"-webkit-transform","scale("+aW+", 1)");A.setStyle(aT,"-moz-transform","scale("+aW+", 1)");A.setStyle(aT,"-ms-transformOrigin","0% 0%");A.setStyle(aT,"-webkit-transformOrigin","0% 0%");A.setStyle(aT,"-moz-transformOrigin","0% 0%")}}this.textLayerDiv.appendChild(aK);this.renderingDone=true;this.updateMatches()};this.setupRenderLayoutTimer=function aO(){var aR=200;var aP=this;var aQ=(this.lastScrollSource===null?0:this.lastScrollSource.lastScroll);if(Date.now()-aQ>aR){this.renderLayer()}else{if(this.renderTimer){clearTimeout(this.renderTimer)}this.renderTimer=setTimeout(function(){aP.setupRenderLayoutTimer()},aR)}};this.appendText=function aE(aS,aV){var aT=aV[aS.fontName];var aQ=document.createElement("div");this.textDivs.push(aQ);if(!/\S/.test(aS.str)){aQ.dataset.isWhitespace=true;return}var aP=PDFJS.Util.transform(this.viewport.transform,aS.transform);var aW=Math.atan2(aP[1],aP[0]);if(aT.vertical){aW+=Math.PI/2}var aU=Math.sqrt((aP[2]*aP[2])+(aP[3]*aP[3]));var aR=(aT.ascent?aT.ascent*aU:(aT.descent?(1+aT.descent)*aU:aU));aQ.style.position="absolute";aQ.style.left=(aP[4]+(aR*Math.sin(aW)))+"px";aQ.style.top=(aP[5]-(aR*Math.cos(aW)))+"px";aQ.style.fontSize=aU+"px";aQ.style.fontFamily=aT.fontFamily;aQ.textContent=aS.str;aQ.dataset.fontName=aS.fontName;aQ.dataset.angle=aW*(180/Math.PI);if(aT.vertical){aQ.dataset.canvasWidth=aS.height*this.viewport.scale}else{aQ.dataset.canvasWidth=aS.width*this.viewport.scale}};this.setTextContent=function aL(aR){this.textContent=aR;var aQ=aR.items;for(var aP=0;aP<aQ.length;aP++){this.appendText(aQ[aP],aR.styles)}this.divContentDone=true;this.setupRenderLayoutTimer()};this.convertMatches=function aF(aV){var aT=0;var aW=0;var aP=this.textContent.items;var aS=aP.length-1;var aR=(r===null?0:r.state.query.length);var aX=[];for(var aQ=0;aQ<aV.length;aQ++){var aY=aV[aQ];while(aT!==aS&&aY>=(aW+aP[aT].str.length)){aW+=aP[aT].str.length;aT++}if(aT==aP.length){console.error("Could not find matching mapping")}var aU={begin:{divIdx:aT,offset:aY-aW}};aY+=aR;while(aT!==aS&&aY>(aW+aP[aT].str.length)){aW+=aP[aT].str.length;aT++}aU.end={divIdx:aT,offset:aY-aW};aX.push(aU)}return aX};this.renderMatches=function aH(aP){if(aP.length===0){return}var a4=this.textContent.items;var aZ=this.textDivs;var aQ=null;var a1=(r===null?false:(this.pageIdx===r.selected.pageIdx));var a5=(r===null?-1:r.selected.matchIdx);var a6=(r===null?false:r.state.highlightAll);var aW={divIdx:-1,offset:undefined};function a9(bb,ba){var bc=bb.divIdx;var bd=aZ[bc];bd.textContent="";aS(bc,0,bb.offset,ba)}function a7(bc,bb,ba){aS(bc.divIdx,bc.offset,bb.offset,ba)}function aS(bg,bb,ba,bd){var bh=aZ[bg];var bf=a4[bg].str.substring(bb,ba);var be=document.createTextNode(bf);if(bd){var bc=document.createElement("span");bc.className=bd;bc.appendChild(be);bh.appendChild(bc);return}bh.appendChild(be)}function aT(bb,ba){aZ[bb].className=ba}var a2=a5,a0=a2+1,a3;if(a6){a2=0;a0=aP.length}else{if(!a1){return}}for(a3=a2;a3<a0;a3++){var aU=aP[a3];var a8=aU.begin;var aR=aU.end;var aV=a1&&a3===a5;var aY=(aV?" selected":"");if(aV&&!this.isViewerInPresentationMode){this.pdfJsPlugin.documentView.pages[this.pageIdx].scrollIntoView(aZ[a8.divIdx],{top:T,left:K})}if(!aQ||a8.divIdx!==aQ.divIdx){if(aQ!==null){a7(aQ,aW)}a9(a8)}else{a7(aQ,a8)}if(a8.divIdx===aR.divIdx){a7(a8,aR,"highlight"+aY)}else{a7(a8,aW,"highlight begin"+aY);for(var aX=a8.divIdx+1;aX<aR.divIdx;aX++){aT(aX,"highlight middle"+aY)}a9(aR,"highlight end"+aY)}aQ=aR}if(aQ){a7(aQ,aW)}};this.updateMatches=function aG(){if(!this.renderingDone){return}var aU=this.matches;var aW=this.textDivs;var aQ=this.textContent.items;var aX=-1;for(var aT=0;aT<aU.length;aT++){var aV=aU[aT];var aS=Math.max(aX,aV.begin.divIdx);for(var aR=aS;aR<=aV.end.divIdx;aR++){var aP=aW[aR];aP.textContent=aQ[aR].str;aP.className=""}aX=aV.end.divIdx+1}if(r===null||!r.active){return}this.matches=aU=(this.convertMatches(r===null?[]:(r.pageMatches[this.pageIdx]||[])));this.renderMatches(this.matches)}};var ap={FIND_FOUND:0,FIND_NOTFOUND:1,FIND_WRAPPED:2,FIND_PENDING:3};var r={startedTextExtraction:false,extractTextPromises:[],pendingFindMatches:{},active:false,pageContents:[],pageMatches:[],selected:{pageIdx:-1,matchIdx:-1},offset:{pageIdx:null,matchIdx:null},resumePageIdx:null,state:null,dirtyMatch:false,findTimeout:null,pdfPageSource:null,integratedFind:false,initialize:function(aD){this.pdfPageSource=aD.pdfPageSource;this.integratedFind=aD.integratedFind;var aF=["find","findagain","findhighlightallchange","findcasesensitivitychange"];this.firstPagePromise=new Promise(function(aG){this.resolveFirstPage=aG}.bind(this));this.handleEvent=this.handleEvent.bind(this);for(var aE=0;aE<aF.length;aE++){window.addEventListener(aF[aE],this.handleEvent)}},reset:function ae(){this.startedTextExtraction=false;this.extractTextPromises=[];this.active=false},calcFindMatch:function(aE){var aH=this.pageContents[aE];var aJ=this.state.query;var aF=this.state.caseSensitive;var aD=aJ.length;if(aD===0){return}if(!aF){aH=aH.toLowerCase();aJ=aJ.toLowerCase()}var aI=[];var aG=-aD;while(true){aG=aH.indexOf(aJ,aG+aD);if(aG===-1){break}aI.push(aG)}this.pageMatches[aE]=aI;this.updatePage(aE);if(this.resumePageIdx===aE){this.resumePageIdx=null;this.nextPageMatch()}},extractText:function(){if(this.startedTextExtraction){return}this.startedTextExtraction=true;this.pageContents=[];var aH=[];for(var aE=0,aF=this.pdfPageSource.pdfDocument.numPages;aE<aF;aE++){this.extractTextPromises.push(new Promise(function(aI){aH.push(aI)}))}var aD=this;function aG(aI){aD.pdfPageSource.pages[aI].getTextContent().then(function aJ(aM){var aL=aM.items;var aN="";for(var aK=0;aK<aL.length;aK++){aN+=aL[aK].str}aD.pageContents.push(aN);aH[aI](aI);if((aI+1)<aD.pdfPageSource.pages.length){aG(aI+1)}})}aG(0)},handleEvent:function(aD){if(this.state===null||aD.type!=="findagain"){this.dirtyMatch=true}this.state=aD.detail;this.updateUIState(ap.FIND_PENDING);this.firstPagePromise.then(function(){this.extractText();clearTimeout(this.findTimeout);if(aD.type==="find"){this.findTimeout=setTimeout(this.nextMatch.bind(this),250)}else{this.nextMatch()}}.bind(this))},updatePage:function(aD){var aE=this.pdfPageSource.pages[aD];if(this.selected.pageIdx===aD){aE.scrollIntoView()}if(aE.textLayer){aE.textLayer.updateMatches()}},nextMatch:function(){var aG=this.state.findPrevious;var aJ=this.pdfPageSource.pageNum-1;var aE=this.pdfPageSource.pages.length;this.active=true;if(this.dirtyMatch){this.dirtyMatch=false;this.selected.pageIdx=this.selected.matchIdx=-1;this.offset.pageIdx=aJ;this.offset.matchIdx=null;this.hadMatch=false;this.resumePageIdx=null;this.pageMatches=[];var aD=this;for(var aF=0;aF<aE;aF++){this.updatePage(aF);if(!(aF in this.pendingFindMatches)){this.pendingFindMatches[aF]=true;this.extractTextPromises[aF].then(function(aK){delete aD.pendingFindMatches[aK];aD.calcFindMatch(aK)})}}}if(this.state.query===""){this.updateUIState(ap.FIND_FOUND);return}if(this.resumePageIdx){return}var aI=this.offset;if(aI.matchIdx!==null){var aH=this.pageMatches[aI.pageIdx].length;if((!aG&&aI.matchIdx+1<aH)||(aG&&aI.matchIdx>0)){this.hadMatch=true;aI.matchIdx=aG?aI.matchIdx-1:aI.matchIdx+1;this.updateMatch(true);return}this.advanceOffsetPage(aG)}this.nextPageMatch()},matchesReady:function(aF){var aG=this.offset;var aE=aF.length;var aD=this.state.findPrevious;if(aE){this.hadMatch=true;aG.matchIdx=aD?aE-1:0;this.updateMatch(true);return true}else{this.advanceOffsetPage(aD);if(aG.wrapped){aG.matchIdx=null;if(!this.hadMatch){this.updateMatch(false);return true}}return false}},nextPageMatch:function(){if(this.resumePageIdx!==null){console.error("There can only be one pending page.")}do{var aD=this.offset.pageIdx;var aE=this.pageMatches[aD];if(!aE){this.resumePageIdx=aD;break}}while(!this.matchesReady(aE))},advanceOffsetPage:function(aE){var aF=this.offset;var aD=this.extractTextPromises.length;aF.pageIdx=aE?aF.pageIdx-1:aF.pageIdx+1;aF.matchIdx=null;if(aF.pageIdx>=aD||aF.pageIdx<0){aF.pageIdx=aE?aD-1:0;aF.wrapped=true;return}},updateMatch:function(aG){var aF=ap.FIND_NOTFOUND;var aE=this.offset.wrapped;this.offset.wrapped=false;if(aG){var aD=this.selected.pageIdx;this.selected.pageIdx=this.offset.pageIdx;this.selected.matchIdx=this.offset.matchIdx;aF=aE?ap.FIND_WRAPPED:ap.FIND_FOUND;if(aD!==-1&&aD!==this.selected.pageIdx){this.updatePage(aD)}}this.updateUIState(aF,this.state.findPrevious);if(this.selected.pageIdx!==-1){this.updatePage(this.selected.pageIdx,true)}},updateUIState:function(aG,aF){var aD="";var aE="";if(aG===ap.FIND_FOUND||aG===ap.FIND_PENDING){return}switch(aG){case ap.FIND_FOUND:aD=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.found");break;case ap.FIND_PENDING:aD=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.pending");break;case ap.FIND_NOTFOUND:aD=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.notfound");break;case ap.FIND_WRAPPED:if(aF){aD=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.wrapped.bottom")}else{aD=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.wrapped.top")}break}Alfresco.util.PopupManager.displayMessage({text:aD})}}})();