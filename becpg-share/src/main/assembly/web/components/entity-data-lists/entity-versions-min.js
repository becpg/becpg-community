(function(){var f=YAHOO.util.Dom,l=YAHOO.util.Event;var e=Alfresco.util.encodeHTML;beCPG.component.EntityVersions=function k(q){beCPG.component.EntityVersions.superclass.constructor.call(this,"beCPG.component.EntityVersions",q,["datasource","datatable","paginator","history","animation"]);YAHOO.Bubbling.on("metadataRefresh",this.doRefresh,this);return this};YAHOO.extend(beCPG.component.EntityVersions,Alfresco.component.Base,{options:{nodeRef:null,siteId:"",list:null},versions:[],earliestVersion:{},latestVersion:null,versionCache:null,onReady:function p(){var s=f.get(this.id+"-branches");if(!s){return}var r=this;this.widgets.alfrescoDataTable=new Alfresco.util.DataTable({dataSource:{url:Alfresco.constants.PROXY_URI+"becpg/api/entity-version?mode=branches&nodeRef="+this.options.nodeRef,doBeforeParseData:this.bind(function(u,t){r.latestVersion=t.versions.splice(0,1)[0];r.versionCache=t.versions;if(!r.widgets.versionMenu){r.createMenu();var v=f.getElementsByClassName("version-historic-nav","a",r.id);l.addListener(v[0],"click",r.onNavButtonClick,r,true);l.addListener(v[1],"click",r.onNavButtonClick,r,true);r.updateNavState();f.removeClass(this.id+"-body","hidden")}return({data:t.branches})})},dataTable:{container:this.id+"-branches",columnDefinitions:[{key:"version",sortable:false,formatter:this.bind(this.renderCellVersion)}],config:{MSG_EMPTY:this.msg("message.noVersions")}}});var q=this.widgets.alfrescoDataTable.loadDataTable;this.widgets.alfrescoDataTable.loadDataTable=function(){if(this.fromFilterChange){this.fromFilterChange=false;return}q.call(this)};this.widgets.alfrescoDataTable.setFilterState=function(){this.fromFilterChange=true}},renderCellVersion:function o(r,q,s,t){r.innerHTML=this.getDocumentVersionMarkup(q.getData())},getDocumentVersionMarkup:function g(u){var s=Alfresco.constants.PROXY_URI+"becpg/entity/compare/"+this.options.nodeRef.replace(":/","")+"/compare?entities="+u.nodeRef,r="",t=(this.options.nodeRef==u.nodeRef),q=beCPG.util.entityURL(u.siteId,u.nodeRef,u.itemType,null,this.options.list);r+='<div class="entity-branches'+(t?" current":"")+'">';r+='   <span class="document-version">'+e(u.label)+"</span>";r+='   <span class="'+u.metadata+'" ><a title="'+u.description+'" href="'+q+'">'+e(u.name)+"</a></span>";if(!t){r+='   <span class="actions"><a href="'+s+'" class="compare" title="'+this.msg("label.compare")+'">&nbsp;</a></span>'}else{r+='  <span class="actions"><a href="#" name=".onVersionsGraphClick" rel="'+this.options.nodeRef+"@"+u.label+'" class="'+this.id+' versions-graph" title="'+this.msg("label.versionsGraph")+'">&nbsp;</a></span>'}r+="</div>";return r},onVersionMenuChange:function d(u,t,s){var r=t[1],q=r.value;this.update(q)},update:function j(q){if(q){this.options.nodeRef=q;var r={filterId:"all",datagridFirstTimeNav:true};if(this.latestVersion.nodeRef!=q){r={filterOwner:"beCPG.component.EntityVersions",filterId:"version",filterData:q,datagridFirstTimeNav:true}}YAHOO.Bubbling.fire("versionChangeFilter",r);this.setMenuTitle();this.updateNavState()}},updateNavState:function m(){var q=f.getElementsByClassName("version-historic-nav","a",this.id+"-body");f.removeClass(q,"disabled");if(this.options.nodeRef===this.earliestVersion.nodeRef){f.addClass(q[0],"disabled")}else{if(this.options.nodeRef===this.latestVersion.nodeRef||this.options.nodeRef===this.latestVersion.entityNodeRef){f.addClass(q[1],"disabled")}}},createMenu:function c(){var s=f.get(this.id+"-versionNav-menu"),A=f.getElementsByClassName("nav","div",f.get(this.id+"-body"))[0],t=document.createElement("h6"),x=document.createElement("h6"),z=Alfresco.util.message("version-historic.menu.title",this.name,{"0":this.latestVersion.label}),q=[];q.push({value:this.latestVersion.nodeRef,text:z});for(var u in this.versionCache){var w=this.versionCache[u],y=Alfresco.util.message("version-historic.menu.title",this.name,{"0":w.label});if(parseInt(u,10)===this.versionCache.length-1){this.earliestVersion=w}q.push({value:w.nodeRef,text:y})}for(var u=0;u<q.length;u++){var v=document.createElement("option");v.text=q[u].text;v.value=q[u].value;s.add(v)}this.widgets.versionMenu=new Alfresco.util.createYUIButton(this,"versionNav-button",this.onVersionMenuChange,{type:"menu",menu:s,lazyloadmenu:false});this.setMenuTitle(z);var B=f.getElementsByClassName("first-of-type","ul",A)[0],r=f.getElementsByClassName("first-of-type","li",B)[0];t.innerHTML=Alfresco.util.message("version-historic.menu.current",this.name);x.innerHTML=Alfresco.util.message("version-historic.menu.previous",this.name);f.insertBefore(t,r);f.insertAfter(x,r)},getVersionNodeRef:function a(s){var u=this.options.nodeRef,v,r,q=null;r=-1;for(var t in this.versionCache){if(this.versionCache[t].nodeRef===u){r=t}if(this.versionCache[t].label===s){q=t}}if(s===this.latestVersion.label){return this.latestVersion.nodeRef}else{if(s==="next"){q=parseInt(r,10)-1}else{if(s==="previous"){q=parseInt(r,10)+1}}}if(q===-1){return this.latestVersion.nodeRef}returnVersion=this.versionCache[q];if(typeof(returnVersion)!=="undefined"){v=returnVersion.nodeRef;return v}},onNavButtonClick:function i(s,u){var t=l.getTarget(s),r=t.rel,q=this.getVersionNodeRef(r);if(!f.hasClass(t,"disabled")){this.update(q)}l.preventDefault(s)},setMenuTitle:function n(s){var q="",r=null;if(!s){if(this.options.nodeRef===this.latestVersion.nodeRef){q=this.latestVersion.label;title=Alfresco.util.message("version-historic.menu.title.latest",this.name,{"0":q})}else{for(r in this.versionCache){if(this.versionCache[r].nodeRef===this.options.nodeRef){q=this.versionCache[r].label}}title=Alfresco.util.message("version-historic.menu.title",this.name,{"0":q})}}else{title=s}this.widgets.versionMenu.set("label",title)},onVersionsGraphClick:function b(s){var q,t=s.split("@"),r=t[0];if(t.length>1){q=t[1]}beCPG.module.getVersionsGraphInstance().show({nodeRef:r,label:q})},doRefresh:function h(){YAHOO.Bubbling.unsubscribe("metadataRefresh",this.doRefresh,this);this.refresh("components/entity-data-lists/entity-versions?nodeRef={nodeRef}"+(this.options.siteId?"&site={siteId}":"")+(this.options.list?"&list={list}":""))}})})();