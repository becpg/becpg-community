(function(){beCPG.custom.NodeHeader=function a(f){beCPG.custom.NodeHeader.superclass.constructor.call(this,f);YAHOO.Bubbling.on("folderCopied",this.onEntityCopied,this);YAHOO.Bubbling.on("dirtyDataTable",this.entityUpdated,this);return this};YAHOO.extend(beCPG.custom.NodeHeader,Alfresco.component.NodeHeader,{ws:null,onReady:function c(){var j=this;if(this.options.siteId!=this.options.actualSiteId){if(this.options.actualSiteId!=null){var n=this.options.actualSiteId===null,f=window.location.protocol+"//"+window.location.host+Alfresco.constants.URL_PAGECONTEXT+(n?"":"site/"+this.options.actualSiteId+"/")+"entity-data-lists"+window.location.search;window.location=f}else{var f="/share/page/entity-data-lists?list=View-properties&nodeRef="+this.options.nodeRef;window.location=f}}try{var h=null;if(sessionStorage.pathBreadCrumbs!=null){h=JSON.parse(sessionStorage.pathBreadCrumbs)}if(h==null){h={currentNode:null,path:[]}}var m=function(s){YAHOO.util.Dom.removeClass(j.id+"-bcpath","hidden");var q='<ul class="bcpath">';for(var p=0;p<s.length;p++){var r=s[p].type;if(r=="pjt:taskList"){var o=Alfresco.constants.URL_PAGECONTEXT+"task-edit?taskId="+s[p].nodeRef}else{var o=beCPG.util.entityURL(s[p].siteId,s[p].nodeRef,r,null,s[p].listId)+"&bcPath=true"}q+='<li style="z-index:'+(20-p)+'"><span class="'+r.split(":")[1]+'" ><a href="'+o+'">'+Alfresco.util.encodeHTML(s[p].name)+"</a></li>"}q+="</ul>";YAHOO.util.Dom.get(j.id+"-bcpath").innerHTML=q};if(this.options.showRelativePath){if(this.options.taskFrom!=null){h={currentNode:{siteId:this.options.siteId,nodeRef:this.options.nodeRef,name:this.options.itemName,type:this.options.itemType,listId:this.options.listId},path:[{nodeRef:this.options.taskFrom,name:this.msg("label.path.task",this.options.taskFrom.split("$")[1]),type:"pjt:taskList"}]};m(h.path)}else{if(h.currentNode!=null&&h.currentNode.nodeRef!=this.options.nodeRef){var l=false;for(var g=0;g<h.path.length;g++){if(h.path[g].nodeRef==this.options.nodeRef){h.path=h.path.slice(0,g);l=true;break}}if(!l){if(this.options.listFrom!=null){h.currentNode.listId=this.options.listFrom}h.path.push(h.currentNode)}h.currentNode={siteId:this.options.siteId,nodeRef:this.options.nodeRef,name:this.options.itemName,type:this.options.itemType,listId:this.options.listId};m(h.path)}else{if(h.currentNode!=null){m(h.path)}}}}else{if(h.currentNode==null||h.currentNode.nodeRef!=this.options.nodeRef){h={currentNode:{siteId:this.options.siteId,nodeRef:this.options.nodeRef,name:this.options.itemName,type:this.options.itemType,listId:this.options.listId},path:[]}}else{if(h.path!=null&&h.path.length>0){m(h.path)}}}sessionStorage.pathBreadCrumbs=JSON.stringify(h)}catch(k){delete sessionStorage.pathBreadCrumbs}this.registerWebSocket();this.nodeType="entity"},entityUpdated:function b(g,f){if(this.ws!=null){var h={type:"UPDATE",user:Alfresco.constants.USERNAME};this.ws.send(YAHOO.lang.JSON.stringify(h))}},registerWebSocket:function b(){if("WebSocket" in window&&this.ws==null){var f=(window.location.protocol==="https:")?"wss:":"ws:",g=this;g.ws=new WebSocket(f+"//"+location.host+"/share/becpgws/"+this.options.nodeRef.replace(":/","")+"/"+Alfresco.constants.USERNAME);g.ws.onmessage=function(h){var k=YAHOO.lang.JSON.parse(h.data);if(k.type&&k.type=="JOINING"&&k.user!=Alfresco.constants.USERNAME){if(YAHOO.util.Dom.get(g.id+"-chat-user-"+k.user)==null){var j=YAHOO.util.Dom.get(g.id+"-node-users");var i=j.innerHTML;i+='<span id="'+g.id+"-chat-user-"+k.user+'" class="avatar" title="'+k.user+'">';i+=Alfresco.Share.userAvatar(k.user,32);i+="</span>";j.innerHTML=i}}else{if(k.type=="LEAVING"&&k.user!=Alfresco.constants.USERNAME){var l=document.getElementById(g.id+"-chat-user-"+k.user);if(l!=null){l.parentNode.removeChild(l)}}else{if(k.type=="UPDATE"&&k.user!=Alfresco.constants.USERNAME){YAHOO.util.Dom.addClass(g.id+"-chat-user-"+k.user,"user-activiti");setTimeout(function(){YAHOO.Bubbling.fire("refreshDataGrids");YAHOO.util.Dom.removeClass(g.id+"-chat-user-"+k.user,"user-activiti")},3000)}}}}}},onEntityCopied:function e(g,f){var i=f[1];if(i){var h=null;if(i.destination!=null&&i.destination.indexOf("Sites")>0&&i.destination.split("/").length>1){h=i.destination.split("/")[2]}window.location="/share/page/"+(h?"site/"+h+"/":"")+"entity-data-lists?list="+(this.options.listId?this.options.listId:"View-properties")+"&nodeRef="+i.nodeRef}},doRefresh:function d(){YAHOO.Bubbling.unsubscribe("metadataRefresh",this.doRefresh,this);var f="components/entity-data-lists/entity-header?nodeRef={nodeRef}&rootPage={rootPage}&rootLabelId={rootLabelId}&showPath={showPath}"+(this.options.pagecontext?"&pagecontext={pagecontext}":"")+(this.options.libraryRoot?"&libraryRoot={libraryRoot}":"")+(this.options.siteId?"&site={siteId}":"")+(this.options.showOnlyLocation?"&showOnlyLocation={showOnlyLocation}":"");this.refresh(f)}})})();