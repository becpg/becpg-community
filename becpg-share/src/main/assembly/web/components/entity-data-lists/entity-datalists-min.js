(function(){var g=YAHOO.util.Dom,b=YAHOO.Bubbling,j=YAHOO.util.Event;var e=Alfresco.util.encodeHTML,f=Alfresco.util.combinePaths;beCPG.component.EntityDataLists=function(l){return beCPG.component.EntityDataLists.superclass.constructor.call(this,l)};YAHOO.extend(beCPG.component.EntityDataLists,Alfresco.component.DataLists,{entity:null,options:{entityNodeRef:"",listId:"",listTypes:[],sortOptions:[],showCreate:false},views:{compoList:"formulation-view",processList:"formulation-view",packagingList:"formulation-view",taskList:"gantt-view",ingLabelingList:"labeling-view"},onReady:function i(){this.widgets.spinner=new YAHOO.widget.Panel(this.id+"-waitPanel",{width:"240px",fixedcenter:true,close:false,draggable:false,zindex:99,modal:true,visible:false});this.widgets.spinner.setHeader(this.msg("message.loading"));this.widgets.spinner.setBody('<div style="text-align:center;"><img class="icon16" src="'+Alfresco.constants.URL_RESCONTEXT+'/components/images/lightbox/loading.gif" /></div>');this.widgets.spinner.render(document.body);if(this.options.showCreate){this.widgets.newList=Alfresco.util.createYUIButton(this,"newListButton",this.onNewList,{disabled:true})}this.populateDataLists({fn:function l(){this.renderDataLists();if(this.options.listId.length>0&&this.dataLists[this.options.listId]){YAHOO.Bubbling.fire("activeDataListChanged",{list:this.options.listId,dataList:this.dataLists[this.options.listId],entity:this.entity,scrollTo:true})}else{YAHOO.Bubbling.fire("hideFilter")}if(this.options.showCreate){if(this.dataListsLength===0||window.location.hash==="#new"){this.widgets.newList.fireEvent("click")}}},scope:this})},populateDataLists:function c(m){if(document.referrer===null||document.referrer.indexOf("entity-data-lists")<1){this.showLoadingAjaxSpinner(true)}var n=function o(r,w){this.showLoadingAjaxSpinner(false);var q=r.json.datalists,v,u=this;if(r.json.listTypes){this.options.listTypes=r.json.listTypes}this.dataLists={};if(r.json.container){this.containerNodeRef=new Alfresco.util.NodeRef(r.json.container)}else{this.containerNodeRef=new Alfresco.util.NodeRef(this.options.entityNodeRef)}this.entity=r.json.entity;if(this.options.showCreate){this.widgets.newList.set("disabled",!r.json.permissions.create)}if(this.options.sortOptions!=null&&this.options.sortOptions.length>0){q.sort(function(B,y){var A=500,x=500;for(var C in u.options.sortOptions){if(B.name.indexOf(u.options.sortOptions[C].id)>-1){A=u.options.sortOptions[C].sortIndex}if(y.name.indexOf(u.options.sortOptions[C].id)>-1){x=u.options.sortOptions[C].sortIndex}if(A!=500&&A!=500){break}}return A-x})}for(var s=0,t=q.length;s<t;s++){v=q[s];this.dataLists[v.name]=v}this.dataListsLength=q.length;if(m&&(typeof m.fn=="function")){m.fn.call(m.scope||this,m.obj)}};var p=function l(q){this.showLoadingAjaxSpinner(false);if(q.status==401){window.location.reload()}else{this.dataLists=null;this.containerNodeRef=null;this.widgets.newList.set("disabled",true);var r="";try{r=e(YAHOO.lang.JSON.parse(q.responseText).message)}catch(s){r=this.msg("message.error-unknown")}Alfresco.util.PopupManager.displayMessage({text:r})}};Alfresco.util.Ajax.jsonGet({url:f(Alfresco.constants.PROXY_URI,"becpg/entitylists/node",this.options.entityNodeRef.replace(":/","")),successCallback:{fn:n,obj:m,scope:this},failureCallback:{fn:p,scope:this}})},showLoadingAjaxSpinner:function(l){if(l){this.widgets.spinner.show()}else{this.widgets.spinner.hide()}},renderDataLists:function a(s){var N=this,L=g.get(this.id+"-lists"),t="selected";L.innerHTML="";var r=function p(z){return function P(){if(z!=null&&(z.indexOf("View-")<0&&N.options.listId.indexOf("View-")<0&&(N.views[z]==N.views[N.options.listId]))){var Q=Selector.query("li",L);g.removeClass(Q,t);g.addClass(this,t);N.options.listId=z;YAHOO.Bubbling.fire("activeDataListChanged",{list:N.options.listId,dataList:N.dataLists[N.options.listId],entity:N.entity,scrollTo:true});return false}return true}};var F=function l(P,z){return function Q(R){if(z){N.onEditList(P)}j.stopEvent(R||window.event)}};var C=function n(P,z){return function Q(R){if(z){Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.POST,url:Alfresco.constants.PROXY_URI+"becpg/entitylist/node/"+P.nodeRef.replace(":/","")+"?state="+("Valid"==P.state?"ToValidate":"Valid"),successCallback:{fn:function(S){P.state="Valid"==P.state?"ToValidate":"Valid";Alfresco.util.PopupManager.displayMessage({text:N.msg("message.entitylist.state.change.success")});b.fire("dataListDetailsUpdated",{dataList:P})},scope:this}})}j.stopEvent(R||window.event)}};var o=function x(P,z){return function Q(R){if(z){N.onDeleteList(P)}j.stopEvent(R||window.event)}};var K=function G(P,z){return function Q(R){if(z){N.onDeleteChildrenList(P)}j.stopEvent(R||window.event)}};try{var M=this.dataLists,J,v,w=null,y,m,A,E;if(this.dataListsLength===0){L.innerHTML='<div class="no-lists">'+this.msg("message.no-lists")+"</div>"}else{y=document.createElement("ul");L.appendChild(y);for(var q in M){if(M.hasOwnProperty(q)){J=M[q];if(this.options.listId===null||this.options.listId.length<1){this.options.listId=J.name;if(this.options.sortOptions!=null&&this.options.sortOptions.length>0){for(var u in this.options.sortOptions){if(J.name.indexOf(this.options.sortOptions[u].id)>-1){if(this.options.sortOptions[u].isView){window.location.href="entity-data-lists?list="+e(J.name)+"&nodeRef="+e(this.options.entityNodeRef)}break}}}}v=J.permissions;m=document.createElement("li");m.onclick=r(J.name);A=document.createElement("a");A.title=J.description;A.href="entity-data-lists?list="+e(J.name)+"&nodeRef="+e(this.options.entityNodeRef);if(v.edit){var I=document.createElement("span");I.className="edit";I.title=this.msg("label.edit-list");j.addListener(I,"click",F(J.name,true));A.appendChild(I)}if(v["delete"]){var D=document.createElement("span");D.className="delete";D.title=this.msg("label.delete-list");j.addListener(D,"click",o(J.name,true));var B=false;for(var q in this.entity.aspects){if(this.entity.aspects[q]==="bcpg:entityTplAspect"){B=true}}var O=null;if(B){var O=document.createElement("span");O.className="delete";O.title=this.msg("label.delete-list");j.addListener(O,"click",K(J.name,true));A.appendChild(O)}else{A.appendChild(D)}}elState=document.createElement("span");elState.className="state";if(v.changeState&&J.name.indexOf("WUsed")<0){elState.title=this.msg("button.datalist-state.description");j.addListener(elState,"click",C(J,true))}if(J.name.indexOf("WUsed")>-1){elState.className="state WUsed"}else{elState.className="state dl-"+J.name}if(J.state&&J.state.length>0){elState.className+=" "+J.state}E=document.createTextNode(J.title);A.appendChild(elState);A.appendChild(E);m.appendChild(A);y.appendChild(m);if(J.name==this.options.listId){g.addClass(m,"selected")}if(J.name==s){w=m}}}if(w){Alfresco.util.Anim.pulse(w)}}}catch(H){L.innerHTML='<span class="error">'+this.msg("message.error-unknown")+"</span>"}},onNewList:function h(r,w){var v=this.containerNodeRef.nodeRef,m="theme-bg-selected",u=this;var t=function n(A,G,z){var E=function H(J,K){return function I(){var O=Selector.query("div",A);g.removeClass(O,m);g.addClass(J,m);if("CustomView"==K){var N=g.get(G);var L=document.createElement("label");L.id=u.id+"-CustomViewLabel";L.innerHTML='<label  for="'+G+'">'+u.msg("label.view.type.header")+'<span class="mandatory-indicator">(*)</span></label>';g.insertBefore(L,N);var P=document.createElement("div");P.id=u.id+"-CustomViewName";P.className="form-field";P.innerHTML='<label for="'+u.id+'-prop_cm_name">'+u.msg("label.view.name")+':<span class="mandatory-indicator">*</span> </label><input type="text"  name="prop_cm_name" id="'+u.id+'-prop_cm_name"  class="mandatory" >';N.type="text";N.value="";g.insertAfter(P,N.parentNode)}else{var M=document.getElementById(u.id+"-CustomViewLabel");if(M){M.parentNode.removeChild(M)}M=document.getElementById(u.id+"-CustomViewName");if(M){M.parentNode.removeChild(M)}g.get(G).type="hidden";g.get(G).value=K}z.validate();return false}};var D,y,C=g.get(A);for(var B=0,F=this.options.listTypes.length;B<F;B++){D=this.options.listTypes[B];y=document.createElement("div");if(D.title!=null&&D.title.length>0){y.innerHTML="<h4>"+e(D.title)+"</h4><span>"+e(D.description)+"</span>";y.onclick=E(y,D.name);C.appendChild(y)}}};var x=function s(y,B){Alfresco.util.populateHTML([B.id+"-dialogTitle",this.msg("label.new-list.title")],[B.id+"-dialogHeader",this.msg("label.new-list.header")],[B.id+"-dataListItemType",this.msg("label.item-type")]);t.apply(this,[B.id+"-itemTypesContainer",B.id+"-dataListItemType-field",y]);var A=function z(H,D,G,F,C,E){return(H.value.length>0)};y.addValidation(B.id+"-dataListItemType-field",A,null,null,null,{validationType:"mandatory"})};var o=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&destination={destination}&mode={mode}&submitType={submitType}&showCancelButton=true",{itemKind:"type",itemId:"dl:dataList",destination:v,mode:"create",submitType:"json"});var p=new Alfresco.module.SimpleDialog(this.id+"-newList");p.setOptions({width:"33em",templateUrl:o,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:x,scope:this},onSuccess:{fn:function l(y){var B=new Alfresco.util.NodeRef(y.json.persistedObject),z=y.config.dataObj.prop_cm_title,A=this.getListTypeTitle(y.config.dataObj.prop_dl_dataListItemType);b.fire("dataListCreated");Alfresco.util.PopupManager.displayMessage({text:this.msg("message.new-list.success",z)})},scope:this},onFailure:{fn:function q(y){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.new-list.failure")})},scope:this}}).show()},onDeleteList:function d(q){var p=this.dataLists[q],o=this;var n=function l(s){var v=new Alfresco.util.NodeRef(s.nodeRef),u=this.getListTypeTitle(s.itemType);Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.DELETE,url:Alfresco.constants.PROXY_URI+"slingshot/datalists/list/node/"+v.uri,successCallback:{fn:function w(x,y){if(y.name==this.options.listId){window.location="entity-data-lists?nodeRef="+e(o.options.entityNodeRef);return}Alfresco.util.PopupManager.displayMessage({text:this.msg("message.delete-list.success")});delete this.dataLists[s.name];this.dataListsLength--;this.renderDataLists()},obj:s,scope:this},failureCallback:{fn:function t(x){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.delete-list.failure")})},scope:this}})};Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.delete-list.title"),text:this.msg("message.delete-list.description",e(p.title)),buttons:[{text:this.msg("button.delete"),handler:function m(){this.destroy();n.call(o,p)}},{text:this.msg("button.cancel"),handler:function r(){this.destroy()},isDefault:true}]})},onDeleteChildrenList:function k(m){var n=this.dataLists[m],o=this;var l=function t(u){var x=new Alfresco.util.NodeRef(u.nodeRef),w=this.getListTypeTitle(u.itemType);Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.DELETE,url:Alfresco.constants.PROXY_URI+"slingshot/datalists/list/node/"+x.uri,successCallback:{fn:function y(z,A){if(A.name==this.options.listId){window.location="entity-data-lists?nodeRef="+e(o.options.entityNodeRef);return}Alfresco.util.PopupManager.displayMessage({text:this.msg("message.delete-list.success")});delete this.dataLists[u.name];this.dataListsLength--;this.renderDataLists()},obj:u,scope:this},failureCallback:{fn:function v(z){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.delete-list.failure")})},scope:this}})};var s=function t(u){var x=new Alfresco.util.NodeRef(u.nodeRef),w=this.getListTypeTitle(u.itemType);Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.GET,url:Alfresco.constants.PROXY_URI+"becpg/entity/entityTpl/"+this.options.entityNodeRef.replace(":/","")+"/datalistRecursiveDelete?datalist="+n.itemType,successCallback:{fn:function y(z,A){if(A.name==this.options.listId){window.location="entity-data-lists?nodeRef="+e(o.options.entityNodeRef);return}Alfresco.util.PopupManager.displayMessage({text:this.msg("message.delete-list.success")});delete this.dataLists[u.name];this.dataListsLength--;this.renderDataLists()},obj:u,scope:this},failureCallback:{fn:function v(z){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.delete-list.failure")})},scope:this}})};Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.delete-list.title"),text:this.msg("message.delete-list.description",e(n.title)),buttons:[{text:this.msg("button.delete-template"),handler:function q(){this.destroy();l.call(o,n)}},{text:this.msg("button.delete-children"),handler:function r(){this.destroy();s.call(o,n)}},{text:this.msg("button.cancel"),handler:function p(){this.destroy()},isDefault:true}]})}})})();