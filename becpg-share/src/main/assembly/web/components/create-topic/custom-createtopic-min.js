(function(){var b=YAHOO.util.Dom,t=YAHOO.util.Event,k=YAHOO.util.Element;var l=Alfresco.util.encodeHTML,p=Alfresco.util.hasEventInterest;Alfresco.CreateTopic=function(u){this.name="Alfresco.CreateTopic";this.id=u;this.widgets={};this.modules={};Alfresco.util.ComponentManager.register(this);Alfresco.util.YUILoaderHelper.require(["datasource","json","connection","event","button","menu","editor"],this.onComponentsLoaded,this);return this};Alfresco.CreateTopic.prototype={options:{siteId:"",containerId:"discussions",editMode:false,topicId:""},widgets:null,modules:null,discussionsTopicData:null,setOptions:function f(u){this.options=YAHOO.lang.merge(this.options,u);return this},setMessages:function r(u){Alfresco.util.addMessages(u,this.name);return this},onComponentsLoaded:function i(){YAHOO.util.Event.onContentReady(this.id,this.onReady,this,true)},onReady:function c(){Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/people-finder/people-finder",dataObj:{htmlid:this.id+"-peopleFinder"},successCallback:{fn:this.onPeopleFinderLoaded,scope:this},failureMessage:"Could not load People Finder component",execScripts:true});if(this.options.editMode){this._loadDiscussionsTopicData()}else{this._initializeDiscussionsTopicForm()}},onPeopleFinderLoaded:function n(v){var u=b.get(this.id+"-peopleFinder");u.innerHTML=v.serverResponse.responseText;this.widgets.reassignPanel=Alfresco.util.createYUIPanel(this.id+"-reassignPanel");this.widgets.peopleFinder=Alfresco.util.ComponentManager.get(this.id+"-peopleFinder");this.widgets.peopleFinder.setOptions({singleSelectMode:true,addButtonLabel:this._msg("button.select")});YAHOO.Bubbling.on("personSelected",this.onPersonSelected,this)},onPersonSelected:function g(v,u){if(p(this.widgets.peopleFinder,u)){this.widgets.reassignPanel.hide();this.widgets.supplierUserName=u[1].userName;this._updatePeopleProperties({supplier_substitute:u[1].firstName+" "+u[1].lastName+" ("+u[1].userName+")"},"invite")}},onReassignButtonClick:function o(v,u){this.widgets.peopleFinder.clearResults();this.widgets.reassignPanel.show()},_updatePeopleProperties:function s(u,v){b.get(this.id+"-supplier").value=u.supplier_substitute},_loadDiscussionsTopicData:function h(){var w=this;var x=function u(y){var z=y.json.item;w.discussionsTopicData=z;w._initializeDiscussionsTopicForm()};var v=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/forum/post/site/{site}/{container}/{topicId}",{site:this.options.siteId,container:this.options.containerId,topicId:this.options.topicId});Alfresco.util.Ajax.request({url:v,method:"GET",responseContentType:"application/json",successCallback:{fn:x,scope:this},failureMessage:this._msg("message.loadpostdata.failure")})},_initializeDiscussionsTopicForm:function q(){var x,u=true,z="",w="",y=null,v="";if(this.options.editMode){x=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/forum/post/site/{site}/{container}/{topicId}",{site:this.options.siteId,container:this.options.containerId,topicId:this.options.topicId})}else{x=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/forum/site/{site}/{container}/posts",{site:this.options.siteId,container:this.options.containerId})}b.get(this.id+"-form").setAttribute("action",x);b.get(this.id+"-site").setAttribute("value",this.options.siteId);b.get(this.id+"-container").setAttribute("value",this.options.containerId);if(this.options.editMode){z=this.discussionsTopicData.title}b.get(this.id+"-title").setAttribute("value",z);if(this.options.editMode){w=this.discussionsTopicData.content;v=this.discussionsTopicData.nodeRef}if(this.options.editMode){y=this.discussionsTopicData.supplierAccountRef}b.get(this.id+"-content").value=w;if(this.options.editMode&&y!=null){this.widgets.supplierUserName=y.userName;this._updatePeopleProperties({supplier_substitute:y.firstName+" "+y.lastName+" ("+y.userName+")"},"invite")}this._registerCreateTopicForm()},_registerCreateTopicForm:function e(){this.modules.tagLibrary=new Alfresco.module.TagLibrary(this.id);this.modules.tagLibrary.setOptions({siteId:this.options.siteId});if(this.options.editMode&&this.discussionsTopicData.tags.length>0){this.modules.tagLibrary.setTags(this.discussionsTopicData.tags)}this.widgets.reassignButton=Alfresco.util.createYUIButton(this,"reassign",this.onReassignButtonClick);this.widgets.okButton=new YAHOO.widget.Button(this.id+"-submit",{type:"submit"});YUIDom.addClass(this.widgets.okButton._button.parentElement.parentElement,"alf-primary-button");this.widgets.cancelButton=new YAHOO.widget.Button(this.id+"-cancel");this.widgets.cancelButton.subscribe("click",this.onFormCancelButtonClick,this,true);this.widgets.editor=new Alfresco.util.RichEditor(Alfresco.constants.HTML_EDITOR,this.id+"-content",this.options.editorConfig);this.widgets.editor.addPageUnloadBehaviour(this._msg("message.unsavedChanges.discussion"));this.widgets.editor.render();this.widgets.topicForm=new Alfresco.forms.Form(this.id+"-form");this.widgets.topicForm.addValidation(this.id+"-title",Alfresco.forms.validation.mandatory,null,"keyup");this.widgets.topicForm.addValidation(this.id+"-title",Alfresco.forms.validation.length,{max:256,crop:true},"keyup");this.widgets.topicForm.setSubmitElements(this.widgets.okButton);this.widgets.topicForm.setAJAXSubmit(true,{successMessage:this._msg("message.savetopic.success"),successCallback:{fn:this.onFormSubmitSuccess,scope:this},failureMessage:this._msg("message.savetopic.failure"),failureCallback:{fn:this.onFormSubmitFailure,scope:this}});if(this.options.editMode){this.widgets.topicForm.setAjaxSubmitMethod(Alfresco.util.Ajax.PUT)}this.widgets.topicForm.setSubmitAsJSON(true);this.widgets.topicForm.doBeforeFormSubmit={fn:function(u,v){this.widgets.cancelButton.set("disabled",false);this.widgets.editor.save();if(this.widgets.supplierUserName){b.get(this.id+"-supplier").value=this.widgets.supplierUserName}else{b.get(this.id+"-supplier").setAttribute("name","")}this.modules.tagLibrary.updateForm(this.id+"-form","tags");this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message(this._msg("message.submitting")),spanClass:"wait",displayTime:0})},scope:this};this.modules.tagLibrary.initialize(this.widgets.topicForm);this.widgets.topicForm.init();b.removeClass(this.id+"-topic-create-div","hidden");b.get(this.id+"-title").focus()},onFormSubmitSuccess:function a(u,w){var v=Alfresco.util.discussions.getTopicViewPage(this.options.siteId,this.options.containerId,u.json.item.name);window.location=v},onFormSubmitFailure:function j(){this.widgets.cancelButton.set("disabled",true);this.widgets.feedbackMessage.destroy()},onFormCancelButtonClick:function d(v,u){this.widgets.cancelButton.set("disabled",true);history.go(-1)},_msg:function m(u){return Alfresco.util.message.call(this,u,"Alfresco.CreateTopic",Array.prototype.slice.call(arguments).slice(1))}}})();