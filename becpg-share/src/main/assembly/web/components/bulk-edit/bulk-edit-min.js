(function(){var E=YAHOO.util.Dom,D=YAHOO.util.Event,u=YAHOO.util.Selector,j=YAHOO.Bubbling;var z=Alfresco.util.encodeHTML,v=Alfresco.util.combinePaths;beCPG.component.BulkEdit=function(N){beCPG.component.BulkEdit.superclass.constructor.call(this,"beCPG.component.BulkEdit",N,["button","container","datasource","datatable","calendar","paginator","animation","history"]);this.rendererHelper=beCPG.module.EntityDataRendererHelper;this.datalistColumns={};this.dataTableColumn=[];this.selectedFields=[];this.dataRequestFields=[];this.dataResponseFields=[];this.currentPage=1;this.selectedItems={};this.afterBulkEditUpdate=[];YAHOO.Bubbling.on("selectedItemsChanged",this.onSelectedItemsChanged,this);YAHOO.Bubbling.on("selectedTypeChanged",this.onSelectedTypeChanged,this);YAHOO.Bubbling.on("dataItemUpdated",this.onDataItemUpdated,this);YAHOO.Bubbling.on("bulkDataChanged",this.onBulkEditShow,this);YAHOO.Bubbling.on("folderSelected",this.onSimulationFolderSelected,this);this.deferredListPopulation=new Alfresco.util.Deferred(["onReady"],{fn:this.populateBulkEdit,scope:this});return this};YAHOO.extend(beCPG.component.BulkEdit,Alfresco.component.Base);YAHOO.lang.augmentObject(beCPG.component.BulkEdit.prototype,{options:{siteId:"",siteTitle:"",initialSearchTerm:"",initialSearchTag:"",initialSearchAllSites:true,initialSearchRepository:false,initialSort:"",searchQuery:"",usePagination:false,initialPage:1,pageSize:75,totalRecords:null,maxResults:1000,loadingMessageDelay:1000,searchQuery:null,itemType:null,formId:null,editSelectedFormId:"create",nodeRef:null,entityNodeRefs:null,showThumbnails:false},rendererHelper:null,currentPage:null,currentSort:null,currentSortDir:null,queryExecutionId:null,currentQueryExecutionId:null,totalRecords:null,selectedItems:null,allPages:false,afterBulkEditUpdate:null,datalistColumns:null,dataTableColumn:null,dataRequestFields:null,dataResponseFields:null,selectedFields:null,widgets:{},dataUrl:Alfresco.constants.PROXY_URI_RELATIVE+"becpg/entity/datalists/data/node",itemUrl:Alfresco.constants.PROXY_URI_RELATIVE+"becpg/entity/datalists/item/node/",columnsUrl:Alfresco.constants.URL_SERVICECONTEXT+"module/entity-datagrid/config/columns",saveFieldUrl:Alfresco.constants.PROXY_URI_RELATIVE+"becpg/bulkedit/save",fnRenderCellSelected:function I(){var O=this;return function N(Q,P,R,T){var S=P.getData().permissions.userAccess.edit;if(S){E.setStyle(Q,"width",R.width+"px");E.setStyle(Q.parentNode,"width",R.width+"px");Q.innerHTML='<input id="checkbox-'+P.getId()+'" type="checkbox" name="fileChecked" value="'+T+'"'+(O.selectedItems[T]?' checked="checked">':">")}}},fnRenderCellThumbnail:function s(){return function N(W,X,T,O){var P=100,R=X.getData(),S="";R.jsNode={};R.jsNode.type=R.nodeType;var Q=R.itemData.prop_cm_name.value,V=new Alfresco.util.NodeRef(R.nodeRef),U=Q.substring(Q.lastIndexOf("."));S='<span class="thumbnail"><img src="'+Alfresco.constants.PROXY_URI+"api/node/"+V.uri+'/content/thumbnails/doclib?c=queue&ph=true" alt="'+U+'" title="'+z(Q)+'" /></span>';T.width=P;E.setStyle(W,"width",T.width+"px");E.setStyle(W.parentNode,"width",T.width+"px");W.innerHTML=S}},fnRenderCellCode:function o(N){return function O(U,S,V,W){var Q="";if(S&&V){if(!W){W=S.getData("itemData")[V.field]}if(W){W=YAHOO.lang.isArray(W)?W:[W];for(var P=0,R=W.length,T;P<R;P++){T=W[P];Q+='<a href="'+Alfresco.util.siteURL("entity-data-lists?list=View-properties&nodeRef="+S.getData("nodeRef"),{site:S.getData("site")!=null?S.getData("site").shortName:null})+'">'+z(T.displayValue)+"</a>"}}}U.innerHTML=Q}},fnRenderCellActions:function t(){var N=this;return function O(Q,P,R,T){var S=P.getData().permissions.userAccess.edit;if(S){E.setStyle(Q,"width",R.width+"px");E.setStyle(Q.parentNode,"width",R.width+"px");Q.innerHTML='<div id="'+N.id+"-actions-"+P.getId()+'" class="action-set simple" ><div class="onActionEdit"><a title="'+N.msg("action.modify")+'"  class="action-link" href="" rel="edit"><span>'+N.msg("action.modify")+"</span></a></div></div>"}}},onSelectedItemsChanged:function(){if(this.allPages){E.get(this.id+"-message").innerHTML='<span class="info">'+this.msg("message.edit.allPages",this.totalRecords)+"</span>";E.removeClass(this.id+"-message","hidden")}else{E.addClass(this.id+"-message","hidden")}var U=this.getSelectedItems(),X,Y={},V,O=this.widgets.selectedItems.getMenu().getItems(),N,Q,R,S,W,P;for(S=0,W=U.length;S<W;S++){X=U[S];V=X.permissions.userAccess;for(var T in V){if(V.hasOwnProperty(T)){Y[T]=(Y[T]===undefined?V[T]:Y[T]&&V[T])}}}for(var T in O){if(O.hasOwnProperty(T)){N=O[T];R=false;P=true;if(N.element.firstChild){if(N.element.firstChild.rel&&N.element.firstChild.rel!==""){Q=N.element.firstChild.rel.split(",");for(S=0,W=Q.length;S<W;S++){if(Q[S]!="allPages"&&Q[S]!="supplier"){if((!Y[Q[S]])){R=true;break}}else{if(Q[S]=="supplier"){if(this.options.itemType!="bcpg:rawMaterial"&&this.options.itemType!="bcpg:packagingMaterial"&&this.options.itemType!="bcpg:supplier"){R=true}}else{P=false}}}}if(this.allPages&&(this.queryExecutionId==null||P)){R=true}N.cfg.setProperty("disabled",R)}}}this.widgets.selectedItems.set("disabled",(U.length===0))},onSelectedItems:function w(S,R,Q){var O=R[0],P=R[1];var N=Alfresco.util.findEventClass(P);if(N&&(typeof this[N]=="function")){this[N].call(this,this.getSelectedItems())}D.preventDefault(O)},onSelectedTypeChanged:function(){this.populateBulkEdit();this.widgets.showButton.set("disabled",false)},onReady:function d(){var Q=this;this.widgets.typeSelect=Alfresco.util.createYUIButton(this,"itemTypeSelect-button",this.onTypeSelect,{type:"menu",menu:"itemTypeSelect-menu",lazyloadmenu:false});this.widgets.typeSelect.getMenu().subscribe("click",function(T,S){var U=S[1];if(U){Q.widgets.typeSelect.set("label",U.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL)}});this.widgets.itemSelect=Alfresco.util.createYUIButton(this,"itemSelect-button",this.onItemSelect,{type:"menu",menu:"itemSelect-menu",disabled:true});var R=this.widgets.typeSelect.getMenu().getItem(0);if(R){Q.widgets.typeSelect.set("label",R.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);var P=R._oAnchor.children[0].attributes[0].nodeValue;this.options.itemType=P.split("#")[0];this.options.formId=P.split("#")[1];this.options.editSelectedFormId=P.split("#")[2]}this.widgets.selectedItems=Alfresco.util.createYUIButton(this,"selectedItems-button",this.onSelectedItems,{type:"menu",menu:"selectedItems-menu",lazyloadmenu:false,disabled:true});var N=function O(U,T){var S=j.getOwnerByTagName(T[1].anchor,"div");if(S!==null){if(typeof Q[S.className]=="function"){T[1].stop=true;var V=Q.widgets.dataTable.getRecord(T[1].target.offsetParent).getData();Q[S.className].call(Q,V,S)}}return true};j.addDefaultAction("action-link",N);this.widgets.showButton=Alfresco.util.createYUIButton(this,"show-button",this.onBulkEditShow,{disabled:false});this.widgets.exportCSVButton=Alfresco.util.createYUIButton(this,"export-csv",this.onExportCSV,{disabled:true,value:"export"});this.widgets.showThumbnailsButton=Alfresco.util.createYUIButton(this,"show-thumbnails",this.onShowThumbnails,{type:"checkbox",value:this.options.showThumbnails,checked:this.options.showThumbnails});E.removeClass(this.id+"-selectTypeMessage","hidden");this.deferredListPopulation.fulfil("onReady");E.setStyle(this.id+"-body","visibility","visible")},_onDataListFailure:function H(P,O){Alfresco.util.PopupManager.displayPrompt({title:O.title,text:O.text,modal:true,buttons:[{text:this.msg("button.ok"),handler:function N(){this.destroy()},isDefault:true}]})},populateBulkEdit:function q(){if(this.options.itemType!=null){Alfresco.util.Ajax.jsonGet({url:v(this.columnsUrl+"?mode=bulk-edit&itemType="+encodeURIComponent(this.options.itemType)+"&formId="+encodeURIComponent(this.options.formId)),successCallback:{fn:this.onDatalistColumns,scope:this},failureCallback:{fn:this._onDataListFailure,obj:{title:this.msg("message.error.columns.title"),text:this.msg("message.error.columns.description")},scope:this}})}},onDatalistColumns:function k(N){this.datalistColumns=N.json.columns;this._setupPropsPicker();E.addClass(this.id+"-selectTypeMessage","hidden")},_buildDataParamsUrl:function J(N,O){var P=this.options.initialSearchAllSites?"":this.options.siteId;var Q=YAHOO.lang.substitute("dataListName=bulk-edit&site={site}&repo={repo}&itemType={itemType}&pageSize={pageSize}&maxResults={maxResults}",{site:encodeURIComponent(P),repo:(this.options.initialSearchRepository||this.options.searchQuery.length!==0).toString(),maxResults:O?O:this.options.maxResults,itemType:encodeURIComponent(this.options.itemType),pageSize:N?N:this.options.pageSize});if(this.options.entityNodeRefs!=null){Q+="&entityNodeRef="+this.options.entityNodeRefs}return Q},_setupDataSource:function x(){for(var P=0,R=this.datalistColumns.length;P<R;P++){var Q=this.datalistColumns[P],O=Q.name.replace(":","_"),N=this._buildFormsName(Q);if(this._isSelectedProp(N)){this.dataRequestFields.push(O);this.dataResponseFields.push(N);this.dataTableColumn.push(Q)}this.datalistColumns[N]=Q}this.widgets.dataSource=new YAHOO.util.DataSource(this.dataUrl+"?"+this._buildDataParamsUrl(),{connMethodPost:true,responseType:YAHOO.util.DataSource.TYPE_JSON,responseSchema:{resultsList:"items",metaFields:{startIndex:"startIndex",totalRecords:"totalRecords",queryExecutionId:"queryExecutionId"}}});this.widgets.dataSource.connMgr.setDefaultPostHeader(Alfresco.util.Ajax.JSON)},_isSelectedProp:function b(O){if("prop_cm_name"==O||"prop_bcpg_code"==O){return true}for(var N in this.selectedFields){if(O==this.selectedFields[N].value){if(this.selectedFields[N].checked){return true}}}return false},_setupPropsPicker:function G(){var T=E.get(this.id+"-itemProps-container"),S="";if(T!=null){var O=0;var V=0;for(var Q=0,W=this.datalistColumns.length;Q<W;Q++){var P=this.datalistColumns[Q];var R=this._buildFormsName(P);var N=P.label;if(!(P.protectedField||P.disabled||"prop_cm_name"==R||"prop_bcpg_code"==R)){var U="";if(V<Math.floor(O/5)){U="reset "}V=Math.floor(O/5);U+="column-"+V;S+='<li class="'+U+'"><input id="propSelected-'+Q+'" type="checkbox" name="propChecked" value="'+R+'" /><label for="propSelected-'+Q+'" >'+N+"</label></li>";O++}}T.innerHTML='<ul style="width:'+((V+1)*20)+'em;">'+S+"</ul>";this.selectedFields=u.query('input[type="checkbox"]',T)}},_setupDataTable:function c(P){var T=[{key:"nodeRef",label:"",sortable:false,formatter:this.fnRenderCellSelected(),width:16}];if(this.options.showThumbnails){T.push({key:"thumbnail",label:"",sortable:false,formatter:this.fnRenderCellThumbnail(),width:100})}var O,X;for(var R=0,Y=this.dataTableColumn.length;R<Y;R++){O=this.dataTableColumn[R];X=this._buildFormsName(O);if(this._isSelectedProp(X)){T.push({key:this.dataResponseFields[R],label:O.label,sortable:(O.type=="property"),sortOptions:{field:this.dataResponseFields[R],sortFunction:this.rendererHelper.getSortFunction()},formatter:X=="prop_bcpg_code"?this.fnRenderCellCode(O):this.rendererHelper.getCellFormatter(this),editor:X=="prop_bcpg_code"?null:this.rendererHelper.getCellEditor(this,O,this.saveFieldUrl)})}}T.sort(function(ac,aa){var ab=ac.key;var Z=aa.key;if(ab=="nodeRef"){return -1}else{if(Z=="nodeRef"){return 1}}if(ab=="thumbnail"){return -1}else{if(Z=="thumbnail"){return 1}}if(ab=="prop_cm_name"&&Z!="prop_bcpg_code"){return -1}else{if(ab=="prop_bcpg_code"){return -1}else{if(Z=="prop_bcpg_code"){return 1}else{if(Z=="prop_cm_name"&&ab!="prop_bcpg_code"){return 1}}}}return 0});T.push({key:"actions",label:"",sortable:false,formatter:this.fnRenderCellActions(),width:35});var V=this;this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-grid",T,this.widgets.dataSource,{renderLoopSize:this.options.usePagination?16:32,initialLoad:false,dynamicData:false,MSG_EMPTY:this.msg("message.empty"),MSG_ERROR:this.msg("message.error"),paginator:null});this.widgets.dataTable.handleDataReturnPayload=function N(aa,Z,ab){if(V.widgets.paginator){V.widgets.paginator.set("totalRecords",Z.meta.totalRecords);V.widgets.paginator.setPage(Z.meta.startIndex,true)}if(V.currentSort!=null){V.widgets.dataTable.set("sortedBy",{key:V.currentSort,dir:V.currentSortDir})}V.totalRecords=Z.meta.totalRecords;V.queryExecutionId=Z.meta.queryExecutionId;return Z.meta};this.widgets.dataTable.doBeforeLoadData=function W(aa,ab,ad){if(ab.error){try{var Z=YAHOO.lang.JSON.parse(ab.responseText);V.widgets.dataTable.set("MSG_ERROR",Z.message)}catch(ac){V._setDefaultDataTableErrors(V.widgets.dataTable)}}if(ab.results.length===0){this.fireEvent("renderEvent",{type:"renderEvent"})}return true};this.widgets.dataTable.doBeforeSortColumn=function U(aa,Z){if(aa.key.indexOf("prop_")==0){V.currentSort=aa.key;V.currentSortDir=Z;V.currentPage=1;V.currentQueryExecutionId=null;V._updateBulkEdit.call(V);return false}else{V.currentSort=null;return true}};this.widgets.dataTable.subscribe("checkboxClickEvent",function(Z){var aa=Z.target.value;this.selectedItems[aa]=Z.target.checked;j.fire("selectedItemsChanged")},this,true);this.widgets.dataTable.subscribe("cellMouseoverEvent",function(Z){var aa=Z.target;if(YAHOO.util.Dom.hasClass(aa,"yui-dt-editable")){this.highlightCell(aa)}});this.widgets.dataTable.subscribe("cellMouseoutEvent",this.widgets.dataTable.onEventUnhighlightCell);this.widgets.dataTable.subscribe("cellClickEvent",this.widgets.dataTable.onEventShowCellEditor);this.widgets.dataTable.subscribe("cellUpdateEvent",this.onCellChanged);if(V.options.usePagination){V.currentPage=parseInt(V.options.initialPage,10);this.widgets.paginator=new YAHOO.widget.Paginator({containers:[V.id+"-paginatorTop",V.id+"-paginatorBottom"],rowsPerPage:V.options.pageSize,initialPage:this.options.initialPage,template:V.msg("pagination.template"),pageReportTemplate:V.msg("pagination.template.page-report"),previousPageLinkLabel:V.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:V.msg("pagination.nextPageLinkLabel")});var Q=function S(aa,Z){Z.currentPage=aa.page;Z.currentQueryExecutionId=Z.queryExecutionId;Z._updateBulkEdit.call(Z)};this.widgets.paginator.subscribe("changeRequest",Q,this);E.setStyle(V.id+"-bulk-editBarBottom","display","block");if(!this.widgets.paginator.getContainerNodes().length){this.widgets.paginator.set("containers",this.widgets.dataTable._defaultPaginatorContainers(true))}this.widgets.paginator.render()}},onItemSelect:function f(R,Q,P){var N=Q[0],O=Q[1];this.selectItems(Alfresco.util.findEventClass(O));D.preventDefault(N)},onTypeSelect:function e(R,Q,P){var O=Q[1];var N=Alfresco.util.findEventClass(O);this.options.itemType=N.split("#")[0];this.options.formId=N.split("#")[1];this.options.editSelectedFormId=N.split("#")[2];j.fire("selectedTypeChanged")},getSelectedItems:function h(){var O=[],R=this.widgets.dataTable.getRecordSet(),P=0,S=R.getLength(),N;for(var Q=P;Q<=S;Q++){N=R.getRecord(Q);if(N!=null&&this.selectedItems[N.getData("nodeRef")]){O.push(N.getData())}}return O},selectItems:function l(U){var T=this.widgets.dataTable.getRecordSet(),R=u.query('input[type="checkbox"]',this.widgets.dataTable.getTbodyEl()),Q=0,O=R.length,P,S,N;switch(U){case"selectAll":case"selectAllPages":N=function(V,W){return true};break;case"selectNone":N=function(V,W){return false};break;case"selectInvert":N=function(V,W){return !W};break;default:N=function(V,W){return W}}if(U=="selectAllPages"){this.allPages=true}else{this.allPages=false}for(S=0;S<O;S++){P=T.getRecord(S+Q);this.selectedItems[P.getData("nodeRef")]=R[S].checked=N(P.getData("type"),R[S].checked)}j.fire("selectedItemsChanged")},onCellChanged:function K(N,O,P){},onBulkEditShow:function M(N){this.dataRequestFields=[];this.dataResponseFields=[];this.dataTableColumn=[];this._setupDataSource();this._setupDataTable();this.widgets.itemSelect.set("disabled",false);this.widgets.exportCSVButton.set("disabled",false);this._updateBulkEdit.call(this)},_setDefaultDataTableErrors:function n(N){var O=Alfresco.util.message;N.set("MSG_EMPTY",O("message.empty","beCPG.component.BulkEdit"));N.set("MSG_ERROR",O("message.error","beCPG.component.BulkEdit"))},_updateBulkEdit:function L(Y){Y=Y||{};var V=null,R=null,W=this;var S=function O(){if(R){V=Alfresco.util.PopupManager.displayMessage({displayTime:0,text:'<span class="wait">'+z(this.msg("message.loading"))+"</span>",noEscape:true});if(YAHOO.env.ua.ie>0){this.loadingMessageShowing=true}else{V.showEvent.subscribe(function(){this.loadingMessageShowing=true},this,true)}}};this._setDefaultDataTableErrors(this.widgets.dataTable);this.loadingMessageShowing=false;R=YAHOO.lang.later(this.options.loadingMessageDelay,this,S);var Z=null;Z=function Q(){if(R){R.cancel();R=null}if(V){if(this.loadingMessageShowing){V.destroy();V=null}else{if(Z!=null){YAHOO.lang.later(100,W,Z)}}}};var U=function T(aa,ab,ac){Z();this.currentPage=Y.page||1;this.currentQueryExecutionId=null;this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,aa,ab,ac)};var P=function N(ab,ac){Z();this.afterBulkEditUpdate=[];if(ac.status==401){window.location.reload(true)}else{try{var aa=YAHOO.lang.JSON.parse(ac.responseText);this.widgets.dataTable.set("MSG_ERROR",aa.message);this.widgets.dataTable.showTableMessage(aa.message,YAHOO.widget.DataTable.CLASS_ERROR);if(ac.status==404){j.fire("deactivateAllControls")}}catch(ad){this._setDefaultDataTableErrors(this.widgets.dataTable)}}};var X=this._buildBulkEditParams();this.widgets.dataSource.connMgr.setDefaultPostHeader(Alfresco.util.Ajax.JSON);if(Alfresco.util.CSRFPolicy.isFilterEnabled()){W.widgets.dataSource.connMgr.initHeader(Alfresco.util.CSRFPolicy.getHeader(),Alfresco.util.CSRFPolicy.getToken(),false)}this.widgets.dataSource.sendRequest(YAHOO.lang.JSON.stringify(X),{success:U,failure:P,scope:this})},_buildBulkEditParams:function a(O){var N={fields:this.dataRequestFields,page:O?O:this.currentPage};if(this.currentSort!=null){N.sort=this.currentSort.replace("prop_","").replace("_",":")+"|"+((this.currentSortDir=="yui-dt-asc")?"true":"false")}if(this.currentQueryExecutionId!=null){N.queryExecutionId=this.currentQueryExecutionId}if(this.options.nodeRef!=null&&this.options.nodeRef.length>0){N.filter={filterId:"nodePath",filterData:this.options.nodeRef}}else{if(this.options.searchQuery!=null&&this.options.searchQuery.length>0){N.filter={filterId:"filterform",filterData:this.options.searchQuery};if(this.options.initialSearchTerm!=null&&this.options.initialSearchTerm.length>0){N.extraParams=YAHOO.lang.JSON.stringify({searchTerm:this.options.initialSearchTerm})}}else{if(this.options.initialSearchTerm!=null&&this.options.initialSearchTerm.length>0){N.filter={filterId:"fts",filterData:this.options.initialSearchTerm}}else{if(this.options.initialSearchTag!=null&&this.options.initialSearchTag.length>0){N.filter={filterId:"tag",filterData:this.options.initialSearchTag}}}}}return N},_buildFormsName:function g(O){var N="";if(O.type=="association"){N="assoc_"}else{N="prop_"}N+=O.name.replace(/:/g,"_");return N},onExportCSV:function A(){var N="";for(var O in this.dataRequestFields){if(N.length>0){N+="$"}N+=this.dataRequestFields[O]}var P=5000;var Q=1;window.location=this.dataUrl+"/export?format=xlsx&"+this._buildDataParamsUrl(P,P)+"&metadata="+encodeURIComponent(YAHOO.lang.JSON.stringify(this._buildBulkEditParams(Q)))},onShowThumbnails:function p(){this.options.showThumbnails=!this.options.showThumbnails;this.onBulkEditShow.call(this)},onEditSelected:function F(){var Z=function O(aa,ab){Alfresco.util.populateHTML([ab.id+"-dialogTitle",this.msg("label.edit-selected.title")],[ab.id+"-dialogHeader",this.msg("label.edit-selected.header")]);if(E.get(ab.id+"-form-bulkAction")){E.setStyle(ab.id+"-form-bulkAction","display","none");E.setStyle(ab.id+"-form-bulkAction-msg","display","none")}};var U=[];for(var R in this.selectedFields){if(this.selectedFields[R].checked){U.push(this.selectedFields[R].value)}}if(U.length<1){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit-selected.nofields")});return false}var N="bulk-edit",Y="",X=0;var S='<div class="hd">'+this.msg("header."+N+".picker")+"</div>";S+='<div class="bd">';S+='<form  class="form-container">';S+='<div class="form-fields '+N+'">';S+='   <div class="set">';S+='        <div class="form-field">';S+='			<div  id="'+this.id+'-columns-list" />';for(R in U){var Q=this.datalistColumns.find(function(aa){return aa.formsName==U[R]});Y+='<li><input id="propSelected-'+R+'"  type="checkbox" name="propChecked" value="'+U[R]+'" /> <label for="propSelected-'+R+'" >'+Q.label+"</label></li>"}S+="<span>"+this.msg("label.edit-columns.title")+'</span><br/><br/><ul style="width:'+((X+1)*20)+'em;">'+Y+"</ul>";S+="          </div>";S+="       </div>";S+="    </div>";S+='<div id="'+this.id+"-"+N+'-ft" class="bdft">';S+="</div>";S+="</form></div>";var V=document.createElement("div");V.innerHTML=S;this.widgets.columnsListPanel=Alfresco.util.createYUIPanel(V,{draggable:true,width:"33em"});var W=E.get(this.id+"-"+N+"-ft");W.innerHTML='<input id="'+this.id+'-bulk-edit-ok" type="button" value="'+this.msg("button.ok")+'" />';this.widgets.columnsListPanel.show();var T=E.get(this.id+"-columns-list").parentNode;this.widgets.okBkButton=Alfresco.util.createYUIButton(this,"bulk-edit-ok",function(){var ac=this,aa=u.query('input[type="checkbox"]',T);U=[];for(var ab in aa){if(aa[ab].checked){U.push(aa[ab].value)}}ac.widgets.columnsListPanel.hide();P.call(ac)});var P=function(){var ab=this.getSelectedItems(),ac="";for(var ad in ab){if(ac.length>0){ac+=","}ac+=ab[ad].nodeRef.replace(/workspace:\/\/SpacesStore\//g,"")}var aa=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?formId={formId}&bulkEdit=true&fields={fields}&submissionUrl={submissionUrl}&itemKind={itemKind}&itemId={itemId}&mode={mode}&submitType={submitType}&showCancelButton=true",{itemKind:"type",formId:this.options.editSelectedFormId,itemId:this.options.itemType,mode:"create",submitType:"json",submissionUrl:encodeURIComponent("/becpg/bulkedit/type/"+this.options.itemType.replace(":","_")+"/bulksave?nodeRefs="+ac+"&allPages="+this.allPages+"&queryExecutionId="+this.queryExecutionId),fields:encodeURIComponent(U)});var af=new Alfresco.module.SimpleDialog(this.id+"-bulk-createRow");var ah=U.length>1?false:true;var ag="message.confirm.edit-columns.description";if(U.length==1&&U[0]=="prop_bcpg_erpCode"){ah=false;ag="message.confirm.edit-erpcode.description"}af.setOptions({width:"36em",templateUrl:aa,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:Z,scope:this},doBeforeFormSubmit:{fn:function(){if(!ah){Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.confirm.edit-columns.title"),text:this.msg(ag),buttons:[{text:this.msg("button.yes"),handler:function ak(){this.destroy();ah=true;af.widgets.okButton._button.click()}},{text:this.msg("button.no"),handler:function aj(){this.destroy();ah=false},isDefault:true}]})}},scope:this},doBeforeAjaxRequest:{fn:function(){return ah},scope:this},onSuccess:{fn:function ae(aj){YAHOO.Bubbling.fire("bulkDataChanged");Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit-selected.success")})},scope:this},onFailure:{fn:function ai(aj){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit-selected.failure",aj.json.message)})},scope:this}}).show()}},onExportAsZip:function(){alert("Not yet implemented")},onSendToSupplier:function(){var P=this.getSelectedItems(),N="";for(var Q in P){if(N.length>0){N+=","}N+=P[Q].nodeRef}var S=Alfresco.constants.PROXY_URI+"becpg/supplier/send-to-supplier?nodeRefs="+N+"&allPages="+this.allPages+"&queryExecutionId="+this.queryExecutionId;this.modules.sendToSupplier=new Alfresco.module.SimpleDialog(this.id+"-sendToSupplier").setOptions({width:"33em",templateUrl:Alfresco.constants.URL_SERVICECONTEXT+"modules/supplier/send-to-supplier",actionUrl:S,validateOnSubmit:false,destroyOnHide:true,firstFocus:this.id+"-sendToSupplier-projectTpl-field",doBeforeFormSubmit:{fn:function O(U){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.send-to-supplier.inprogress")})},scope:this},onSuccess:{fn:function R(U){if(U.json){window.location.href=beCPG.util.entityURL(recordSiteName,U.json.persistedObject,p_record.node.type)}},scope:this},onFailure:{fn:function T(U){if(U.json&&U.json.message){Alfresco.util.PopupManager.displayMessage({text:U.json.message})}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.import.failure")})}},scope:this}});this.modules.sendToSupplier.show()},onSimulateSelected:function r(){if(!this.modules.simulateFolderPicker){this.modules.simulateFolderPicker=new Alfresco.module.DoclibGlobalFolder()}this.modules.simulateFolderPicker.setOptions({allowedViewModes:[Alfresco.module.DoclibGlobalFolder.VIEW_MODE_SITE],title:this.msg("message.simulate-selected.chooseFolder",z(this.options.siteTitle))}).showDialog()},onSimulationFolderSelected:function B(S,P){var R=P[1].selectedFolder.nodeRef;if(R!=null){var O=this.getSelectedItems(),N="";for(var Q in O){if(N.length>0){N+=","}N+=O[Q].nodeRef}Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.POST,responseContentType:Alfresco.util.Ajax.JSON,url:Alfresco.constants.PROXY_URI+"becpg/entity/simulation/create?nodeRefs="+N+"&allPages="+this.allPages+"&queryExecutionId="+this.queryExecutionId+"&destNodeRef="+R+"&mode=recur",successCallback:{fn:function(U){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.branch-entities.inprogress")})},scope:this},failureCallback:{fn:function T(U){if(U.json&&U.json.message){Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.branch-entity.failure"),text:U.json.message})}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.branch-entity.failure")})}},scope:this}})}},onActionEdit:function y(R){var Q=this;var P=function N(V,W){Alfresco.util.populateHTML([W.id+"-dialogTitle",this.msg("label.edit-row.title")]);if(E.get(W.id+"-form-bulkAction")){E.get(W.id+"-form-bulkAction").checked=true;E.get(W.id+"-form-bulkAction-msg").innerHTML=this.msg("button.bulk-action-edit")}};var T=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?formId=bulk-edit&itemKind={itemKind}&itemId={itemId}&mode={mode}&submitType={submitType}&showCancelButton=true&siteId={siteId}",{itemKind:"node",itemId:R.nodeRef,mode:"edit",submitType:"json",siteId:this.options.siteId});var S=new Alfresco.module.SimpleDialog(this.id+"bulk-editDetails");S.setOptions({width:"850px",templateUrl:T,actionUrl:null,destroyOnHide:false,doBeforeDialogShow:{fn:P,scope:this},onSuccess:{fn:function U(V){Alfresco.util.Ajax.jsonPost({url:this.itemUrl+new Alfresco.util.NodeRef(R.nodeRef).uri,dataObj:this._buildBulkEditParams(),successCallback:{fn:function W(aa){j.fire("dataItemUpdated",{item:aa.json.item});var Y=E.get(this.id+"bulk-editDetails-form-bulkAction");if(Y&&Y.checked){var Z=Q._findNextItemByParameter(aa.json.item.nodeRef,"nodeRef");if(Z!=null){Q.onActionEdit(Z)}}Alfresco.util.PopupManager.displayMessage({text:this.msg("message.details.success")})},scope:this},failureCallback:{fn:function X(Y){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.details.failure")})},scope:this}})},scope:this},onFailure:{fn:function O(V){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.details.failure")})},scope:this}}).show()},_findNextItemByParameter:function m(R,Q){var P=this.widgets.dataTable.getRecordSet();for(var O=0,N=P.getLength();O<N;O++){if(P.getRecord(O).getData(Q)==R){if((O+1)!=N){return P.getRecord(O+1).getData()}}}return null},onDataItemUpdated:function C(O,N){var R=N[1];if(R&&(R.item!==null)){var Q=this._findRecordByParameter(R.item.nodeRef,"nodeRef");if(Q!==null){this.widgets.dataTable.updateRow(Q,R.item);var P=this.widgets.dataTable.getTrEl(Q);Alfresco.util.Anim.pulse(P)}}},_findRecordByParameter:function i(R,Q){var P=this.widgets.dataTable.getRecordSet();for(var O=0,N=P.getLength();O<N;O++){if(P.getRecord(O).getData(Q)==R){return P.getRecord(O)}}return null}},true)})();