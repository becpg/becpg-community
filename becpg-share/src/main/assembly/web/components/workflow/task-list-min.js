(function(){var d=YAHOO.util.Dom,i=YAHOO.util.Event;var b=Alfresco.util.encodeHTML,c=Alfresco.util.siteURL;Alfresco.component.TaskList=function(l){Alfresco.component.TaskList.superclass.constructor.call(this,"Alfresco.component.TaskList",l,["button","menu","container","datasource","datatable","paginator","json","history"]);YAHOO.Bubbling.on("filterChanged",this.onFilterChanged,this);YAHOO.Bubbling.on("filterSearch",this.onFilterSearch,this);return this};YAHOO.extend(Alfresco.component.TaskList,Alfresco.component.Base);YAHOO.lang.augmentProto(Alfresco.component.TaskList,Alfresco.action.WorkflowActions);YAHOO.lang.augmentObject(Alfresco.component.TaskList.prototype,{options:{hiddenTaskTypes:[],filterParameters:[],maxItems:50},onReady:function a(){var l=Alfresco.constants.PROXY_URI+"api/task-instances?authority="+encodeURIComponent(Alfresco.constants.USERNAME)+"&exclude="+this.options.hiddenTaskTypes.join(",")+"&properties="+["bpm_priority","bpm_status","bpm_dueDate","bpm_description"].join(","),m=this;this.widgets.pagingDataTable=new Alfresco.util.DataTable({dataTable:{container:this.id+"-tasks",columnDefinitions:[{key:"id",sortable:true,label:"",formatter:this.bind(this.renderCellPriority),width:16},{key:"isPooled",sortable:false,label:"",formatter:this.bind(this.renderCellPooled),width:16},{key:"description",sortable:true,label:this.msg("label.description"),formatter:this.bind(this.renderTitleCell)},{key:"title",sortable:true,label:this.msg("label.type"),formatter:this.bind(this.renderTaskTypeCell)},{key:"path",sortable:true,label:this.msg("label.due"),formatter:this.bind(this.renderDueDateCell)},{key:"state",sortable:true,label:this.msg("label.started"),formatter:this.bind(this.renderStartDateCell)},{key:"owner",sortable:true,label:this.msg("label.initiator"),formatter:this.bind(this.renderInitiatorCell)},{key:"name",sortable:false,label:"",formatter:this.bind(this.renderCellActions),width:200}],config:{MSG_EMPTY:this.msg("message.noTasks")}},dataSource:{url:l,defaultFilter:{filterId:"workflows.active"},filterResolver:this.bind(function(n){return this.createFilterURLParameters(n,this.options.filterParameters)})},paginator:{config:{containers:[this.id+"-paginator",this.id+"-paginatorBottom"],rowsPerPage:this.options.maxItems}}});this.widgets.pagingDataTable.getDataTable().sortColumn=function(s,o){if(s&&(s instanceof YAHOO.widget.Column)){if(!s.sortable){d.addClass(this.getThEl(s),DT.CLASS_SORTABLE)}if(o&&(o!==DT.CLASS_ASC)&&(o!==DT.CLASS_DESC)){o=null}var u=o||this.getColumnSortDir(s);var r=this.get("sortedBy")||{};var z=(r.key===s.key)?true:false;var w=this.doBeforeSortColumn(s,u);if(w){if(this.get("dynamicData")){var y=this.getState();if(y.pagination){y.pagination.recordOffset=0}y.sortedBy={key:s.key,dir:u};var t=this;y=y||{pagination:null,sortedBy:null};var q=encodeURIComponent((y.sortedBy)?y.sortedBy.key:t.getColumnSet().keys[0].getKey());var n=(y.sortedBy&&y.sortedBy.dir===YAHOO.widget.DataTable.CLASS_DESC)?"desc":"asc";var v=m.widgets.pagingDataTable.createUrlParameters(),p=v+"&sort="+q+"&dir="+n;this.unselectAllRows();this.unselectAllCells();var x={success:this.onDataReturnSetRows,failure:this.onDataReturnSetRows,argument:y,scope:this};this._oDataSource.sendRequest(p,x)}this.fireEvent("columnSortEvent",{column:s,dir:u});return}}}},onFilterChanged:function k(m,l){var n=Alfresco.util.cleanBubblingObject(l[1]);d.get(this.id+"-filterTitle").innerHTML=b(this.msg("filter."+n.filterId+(n.filterData&&n.filterId!="search"?"."+n.filterData:""),n.filterData))},onFilterSearch:function k(m,l){var n=Alfresco.util.cleanBubblingObject(l[1]);this.widgets.pagingDataTable.setPagingState("|");this.widgets.pagingDataTable.loadDataTable("q="+n.filterData)},renderCellPriority:function f(p,n,q,r){var m=n.getData("properties")["bpm_priority"],o={"1":"high","2":"medium","3":"low"},l=o[m+""];p.innerHTML='<img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/priority-"+l+'-16.png" title="'+this.msg("label.priority",this.msg("priority."+l))+'"/>'},renderCellPooled:function e(m,l,n,q){var p=l.getData("isPooled");var o="";if(p){o+='<img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/pooled-task-16.png" title="'+this.msg("label.pooledTask")+'"/>'}m.innerHTML=o},renderCellTaskInfo:function h(p,B,q,v){var l=B.getData("id"),r=b(B.getData("properties")["bpm_description"]),t=B.getData("properties")["bpm_dueDate"],C=t?Alfresco.util.fromISO8601(t):null,s=B.getData("workflowInstance"),w=s.startDate?Alfresco.util.fromISO8601(s.startDate):null,m=b(B.getData("title")),u=b(B.getData("properties")["bpm_status"]),A=B.getData("owner"),x=b(B.getData("description")),n;if(s.initiator){n=b(s.initiator.firstName)}var D=B.getData();if(D.propertyLabels&&Alfresco.util.isValueSet(D.propertyLabels.bpm_status,false)){u=D.propertyLabels.bpm_status}if(r==m){r=this.msg("workflow.no_message")}var y;if(B.getData("isEditable")){y=c("task-edit?taskId="+l+"&referrer=tasks&myTasksLinkBack=true")+'" class="theme-color-1" title="'+this.msg("link.editTask")}else{y=c("task-details?taskId="+l+"&referrer=tasks&myTasksLinkBack=true")+'" class="theme-color-1" title="'+this.msg("link.viewTask")}var z='<h3><a href="'+y+'">'+r+"</a></h3>";z+='<div class="due"><label>'+this.msg("label.due")+":</label><span>"+(C?Alfresco.util.formatDate(C,"longDate"):this.msg("label.none"))+"</span></div>";z+='<div class="started"><label>'+this.msg("label.started")+":</label><span>"+(w?Alfresco.util.formatDate(w,"longDate"):this.msg("label.none"))+"</span></div>";if(!s.isActive){var o=s.endDate?Alfresco.util.fromISO8601(s.endDate):null;z+='<div class=ended"><label>'+this.msg("label.ended")+":</label><span>"+(o?Alfresco.util.formatDate(o,"longDate"):this.msg("label.none"))+"</span></div>"}z+='<div class="status"><label>'+this.msg("label.status")+":</label><span>"+u+"</span></div>";z+='<div class="type"><label>'+this.msg("label.type",m)+":</label><span>"+m+"</span></div>";z+='<div class="description"><label>'+this.msg("label.description")+":</label><span>"+x+"</span></div>";if(n){z+='<div class="initiator"><label>'+this.msg("label.initiator")+":</label><span>"+n+"</span></div>"}if(!A||!A.userName){z+='<div class="unassigned"><span class="theme-bg-color-5 theme-color-5 unassigned-task">'+this.msg("label.unassignedTask")+"</span></div>"}p.innerHTML=z;this.widgets.alfrescoDataTable.loadDataTable("q="+encodeURIComponent(this.searchTerm))},renderInitiatorCell:function(n,m,o,p){var l=m.getData("workflowInstance");if(l.initiator){n.innerHTML='<span class="person">'+Alfresco.util.userProfileLink(l.initiator.userName,l.initiator.firstName+" "+l.initiator.lastName)+"</span>"}},renderTaskTypeCell:function(n,m,o,p){var l=m.getData();n.innerHTML=l.title},renderDueDateCell:function(o,n,p,q){var l=n.getData();var m=Alfresco.util.fromISO8601(l.properties.bpm_dueDate);o.innerHTML=(m!==null?Alfresco.util.formatDate(m,"mediumDate"):"")},renderStartDateCell:function(p,o,q,r){var l=o.getData("workflowInstance");var m=o.getData();var n=Alfresco.util.fromISO8601(l.startDate);p.innerHTML=(n!==null?Alfresco.util.formatDate(n,"mediumDate"):"")},renderTitleCell:function(u,w,r,m){var p=w.getData();var s=p.id,x=b(p.properties.bpm_description),t=b(p.title),q=w.getData("owner"),l="",o=b(w.getData("properties")["bpm_status"]),v=o;if(o!=null){o=o.toUpperCase().replace(/\s/g,"_")}if(x===t){x=this.msg("workflow.no_message")}if(p.propertyLabels&&Alfresco.util.isValueSet(p.propertyLabels.bpm_status,false)){v=p.propertyLabels.bpm_status}if(w.getData("isEditable")){l=c("task-edit?taskId="+s+"&referrer=tasks&myTasksLinkBack=true")+'" class="theme-color-1" title="'+this.msg("link.editTask")}else{l=c("task-details?taskId="+s+"&referrer=tasks&myTasksLinkBack=true")+'" class="theme-color-1" title="'+this.msg("link.viewTask")}var n='<h3><span title="'+v+'" class="'+o+'"><a href="'+l+'">'+x+"</a></span></h3>";if(!q||!q.userName){n+='<div class="unassigned"><span class="theme-bg-color-5 theme-color-5 unassigned-task">'+this.msg("label.unassignedTask")+"</span></div>"}u.innerHTML=n},renderCellActions:function j(n,m,o,p){if(m.getData("isEditable")){this.createAction(n,this.msg("link.editTask"),"task-edit-link",c("task-edit?taskId="+m.getData("id")+"&referrer=tasks&myTasksLinkBack=true"))}this.createAction(n,this.msg("link.viewTask"),"task-view-link",c("task-details?taskId="+m.getData("id")+"&referrer=tasks&myTasksLinkBack=true"));this.createAction(n,this.msg("link.viewWorkflow"),"workflow-view-link",c("workflow-details?workflowId="+m.getData("workflowInstance").id+"&taskId="+m.getData("id")+"&referrer=tasks&myTasksLinkBack=true"));var l=m.getData("workflowInstance");if(l&&l.isActive){this.createAction(n,this.msg("link.viewWorkflowDiagram"),"workflow-view-diagram",function(){this.viewWorkflowDiagram(m)})}},viewWorkflowDiagram:function(m){var l="api/workflow-instances/"+m.getData("workflowInstance").id+"/diagram";Alfresco.Lightbox.show({src:Alfresco.constants.PROXY_URI+l})},createAction:function g(q,m,n,p,o){var r=document.createElement("div");d.addClass(r,n);r.onmouseover=function(){d.addClass(this,n+"-over")};r.onmouseout=function(){d.removeClass(this,n+"-over")};var l=document.createElement("a");if(YAHOO.lang.isFunction(p)){i.addListener(l,"click",p,o,this);l.setAttribute("href","#")}else{l.setAttribute("href",p)}l.setAttribute("title",m);r.appendChild(l);q.appendChild(r)}},true)})();