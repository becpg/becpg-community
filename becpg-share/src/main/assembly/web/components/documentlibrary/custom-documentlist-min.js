(function(){var f=YAHOO.util.Dom;var c=Alfresco.util.encodeHTML,d=Alfresco.util.combinePaths,e=Alfresco.util.siteURL,a=Alfresco.util.isValueSet;beCPG.custom.DocumentList=function b(o){beCPG.custom.DocumentList.superclass.constructor.call(this,o);YAHOO.Bubbling.on("doclistMetadata",this.onDoclistMetadata,this);return this};YAHOO.extend(beCPG.custom.DocumentList,Alfresco.DocumentList,{onDoclistMetadata:function(s,q){var r=q[1].metadata,t=this;if(r!==null&&beCPG.util.isEntity(r.parent)){var v=f.get(t.id+"-becpg-entityFolder-message"),p=r.parent.type.split(":")[1],o;var u="product";if(p=="rawMaterial"||p=="finishedProduct"||p=="semiFinishedProduct"||p=="localSemiFinishedProduct"||p=="packagingKit"||p=="packagingMaterial"||p=="resourceProduct"){u="product"}else{if(p=="projet"||p=="systemEntity"||p=="aclGroup"||p=="entityTplFolder"){u=p}else{u="entity"}}o="<img  src='"+Alfresco.constants.PROXY_URI+"/api/node/"+r.parent.nodeRef.replace(":/","")+"/content/thumbnails/doclib?c=queue&ph=true' class='node-thumbnail' width='48'>";o+="<span >"+Alfresco.util.message("page.documentlibrary.instructions."+u)+"</span>";v.innerHTML=o;this.widgets.viewEntityLists=Alfresco.util.createYUIButton(t,"viewEntityLists-button",function(y,x,w){window.location.href=beCPG.util.entityURL(t.options.siteId,t.doclistMetadata.parent.nodeRef,t.doclistMetadata.parent.type)});f.removeClass(t.id+"-becpg-entityFolder-buttons","hidden");f.removeClass(t.id+"-becpg-entityFolder-instructions","hidden")}else{f.addClass(t.id+"-becpg-entityFolder-instructions","hidden")}},_buildDocListParams:function k(t){var q=a(this.options.siteId),r={path:this.currentPath,type:this.options.showFolders?"all":"documents",site:this.options.siteId,container:this.options.containerId,filter:this.currentFilter};if(this.options.disableSiteMode){q=false}if(this.options.usePagination){r.page=this.widgets.paginator.getCurrentPage()||this.currentPage;r.pageSize=this.widgets.paginator.getRowsPerPage()}if(typeof t==="object"){r=YAHOO.lang.merge(r,t)}var p=("alfresco://company/shared"==this.options.rootNode);var o=q?"site/{site}/{container}":p?"node/alfresco/company/shared":"node/alfresco/user/home",s=YAHOO.lang.substitute("{type}/"+o+(r.filter.filterId==="path"?"{path}":""),{type:encodeURIComponent(r.type),site:encodeURIComponent(r.site),container:encodeURIComponent(r.container),path:d("/",Alfresco.util.encodeURIPath(r.path))});s+="?filter="+encodeURIComponent(r.filter.filterId);if(r.filter.filterData&&r.filter.filterId!=="path"){s+="&filterData="+encodeURIComponent(r.filter.filterData)}if(this.options.usePagination){s+="&size="+r.pageSize+"&pos="+r.page}s+="&sortAsc="+this.options.sortAscending+"&sortField="+encodeURIComponent(this.options.sortField);if(!q){s+="&libraryRoot="+encodeURIComponent(this.options.rootNode.toString())}s+="&view="+this.actionsView+"&noCache="+new Date().getTime();return s},onDocumentListDrop:function l(L){try{if(L.dataTransfer.files!==undefined&&L.dataTransfer.files!==null&&L.dataTransfer.files.length>0){var I=Alfresco.getDNDUploadProgressInstance();var D=false;var J="",H,G;G=L.dataTransfer.files.length;for(H=0;H<G;H++){if(L.dataTransfer.files[H].size>0){D=true}else{J+='"'+L.dataTransfer.files[H].fileName+'", '}}if(!D){J=J.substring(0,J.lastIndexOf(", "));Alfresco.util.PopupManager.displayMessage({text:I.msg("message.zeroByteFiles",J)})}if(D&&I.uploadMethod===I.INMEMORY_UPLOAD){var q=0;G=L.dataTransfer.files.length;for(H=0;H<G;H++){q+=L.dataTransfer.files[H].size}if(q>I.getInMemoryLimit()){D=false;Alfresco.util.PopupManager.displayPrompt({text:I.msg("inmemory.uploadsize.exceeded",Alfresco.util.formatFileSize(I.getInMemoryLimit()))})}}if(D){var o=this.currentPath,F=o.substring(o.lastIndexOf("/")+1),O=this.doclistMetadata.parent?this.doclistMetadata.parent.nodeRef:null,E=O;var N=this.widgets.dataTable.getRecord(L.target);if(N!==null){var B=this.widgets.dataTable.getColumn(L.target),v=N.getData();if((L.target.tagName=="IMG"||L.target.className=="droppable")&&v.jsNode.isContainer){var r=v.location;F=r.file;o=d(r.path,r.file);E=v.nodeRef}}f.removeClass(this.widgets.dataTable.getTrEl(L.target),"dndFolderHighlight");f.removeClass(this.widgets.dataTable.getContainerEl(),"dndDocListHighlight");var x=[];var y={uploadDirectoryName:F,parentNodeRef:O,filter:[],mode:I.MODE_MULTI_UPLOAD,thumbnails:"doclib",onFileUploadComplete:{fn:function A(P){if(x.length!==0){var Q={destination:E,paths:x};Alfresco.util.Ajax.jsonRequest({method:"POST",url:Alfresco.constants.PROXY_URI+"slingshot/doclib2/mkdir",dataObj:Q})}this.onFileUploadComplete(P)},scope:this}};if(a(this.options.siteId)&&!this.options.disableSiteMode){y.siteId=this.options.siteId;y.containerId=this.options.containerId;y.uploadDirectory=o}else{y.destination=E}var t=this.options.dndMaxFileLimit;var w=function p(Q,V,S){V.limit=t;V.pending=V.pending||0;V.files=V.files||[];V.dirmap=V.dirmap||{};var P=Q.createReader(),R=Q.fullPath.replace(/^\//,"");var T=function U(){V.pending++;P.name=Q.name;P.readEntries(function W(X){V.pending--;X.forEach(function(Y){if(Y.isFile){V.pending++;Y.file(function(Z){switch(Z.name.toLowerCase()){case"thumbs.db":case"desktop.ini":case".ds_store":break;default:if(V.dirmap[Q.fullPath]){V.dirmap[Q.fullPath].push(Y.name)}Z.relativePath=R;V.files.push(Z);if(V.limit&&V.files.length>V.limit){throw new Error("Maximum dnd file limit reached: "+V.limit)}}if(--V.pending===0){V(V.files,V.dirmap)}},S)}else{V.dirmap[Y.fullPath]=[];w(Y,V,S)}});if(X.length!==0){T()}if(V.pending===0){V(V.files,V.dirmap)}},S)};T()};var s=function u(P){y.files=P;I.show(y)};var C=L.dataTransfer.items||[],M;if(C[0]&&C[0].webkitGetAsEntry&&(M=C[0].webkitGetAsEntry())){var K=[];if(YAHOO.env.ua.gecko){Object.keys(C).forEach(function(P){K.push(C[P].webkitGetAsEntry().filesystem.root)},this)}else{K.push(M.filesystem.root)}K.forEach(function(P){w(P,function(R,S){Object.keys(S).forEach(function(V){if(S[V].length===0){x.push(V)}});for(var T,U=0;U<x.length;U++){T=x[U];for(var Q=0;Q<x.length;Q++){if(Q!==U&&x[Q].indexOf(T)===0){x.splice(U--,1);break}}}s(R)},function(){s(L.dataTransfer.files)})},this)}else{s(L.dataTransfer.files)}}}else{Alfresco.logger.debug("DL_onDocumentListDrop: A drop event was detected, but no files were present for upload: ",L.dataTransfer)}}catch(z){Alfresco.logger.error("DL_onDocumentListDrop: The following error occurred when files were dropped onto the Document List: ",z)}L.stopPropagation();L.preventDefault()},onLikes:function n(u){var r=u;if(typeof this.viewRenderers[this.options.viewRendererName]==="object"){r=this.viewRenderers[this.options.viewRendererName].getDataTableRecordIdFromRowElement(this,u)}var v=this.widgets.dataTable.getRecord(r),s=v.getData(),t=s.jsNode.nodeRef,p=s.likes;p.isLiked=!p.isLiked;p.totalLikes+=(p.isLiked?1:-1);var w={successCallback:{fn:function o(D,A){var E=D.json.data;if(E){var C=this._findRecordByParameter(A,"nodeRef"),x=C.getData(),B=x.node,y=x.likes;y.totalLikes=E.ratingsCount;this.widgets.dataTable.updateRow(C,x);if(y.isLiked){var z={fileName:x.fileName,nodeRef:B.nodeRef};if(beCPG.util.isEntity(x)){this.modules.actions.postActivity(this.options.siteId,"entity-liked","entity-data-lists",z)}else{if(B.isContainer){this.modules.actions.postActivity(this.options.siteId,"folder-liked","folder-details",z)}else{this.modules.actions.postActivity(this.options.siteId,"file-liked","document-details",z)}}}}},scope:this,obj:t.toString()},failureCallback:{fn:function q(B,z){var A=this._findRecordByParameter(z,"nodeRef"),x=A.getData(),y=x.likes;y.isLiked=!y.isLiked;y.totalLikes+=(y.isLiked?1:-1);this.widgets.dataTable.updateRow(A,x);Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.save.failure",x.displayName)})},scope:this,obj:t.toString()}};if(p.isLiked){this.services.likes.set(t,1,w)}else{this.services.likes.remove(t,w)}this.widgets.dataTable.updateRow(v,s)}});Alfresco.DocumentList.generateFileFolderLinkMarkup=function i(z,s){var o=s.jsNode,x=Alfresco.DocumentList.getRecordSite(s),A=z.options.siteId,u=s.location.path,v=s.location.repoPath,r;if(o.isLink){var q=a(o.linkedNode.properties)?o.linkedNode.properties.name:null;var w=o.linkedNode.isContainer;if(!w&&(Alfresco.constants.PAGECONTEXT=="shared"||Alfresco.constants.PAGECONTEXT=="mine")){var t=o.linkedNode.nodeRef.toString();r=window.location.protocol+"//"+window.location.host+Alfresco.constants.URL_PAGECONTEXT+"document-details?nodeRef="+t}else{if(w){if(a(z.options.siteId)&&s.location.site&&s.location.site.name!==z.options.siteId){r=e("documentlibrary?path="+encodeURIComponent(u+(u!="/"?"/":"")+q),{site:s.location.site.name})}else{r=window.location.protocol+"//"+window.location.host+Alfresco.constants.URL_PAGECONTEXT+"repository?path="+encodeURIComponent(v+(v!="/"?"/":"")+q)}}else{if(a(z.options.siteId)&&s.location.site&&s.location.site.name!==z.options.siteId){r=z.getActionUrls(s,s.location.site.name).documentDetailsUrl}else{r=z.getActionUrls(s).documentDetailsUrl}}}}else{if(o.isContainer){if(beCPG.util.isEntity(s)){var p=z.getActionUrls(s);if(a(z.options.siteId)&&((s.location.repoPath!=null&&s.location.repoPath.length>0&&s.location.repoPath.indexOf("/Sites/"+z.options.siteId)==0)||(s.location.path!=null&&s.location.path.length>0&&!a(s.location.site)))){p=z.getActionUrls(s,z.options.siteId)}r=p.documentDetailsUrl.replace("document-details?","entity-data-lists?list=View-properties&")}else{if(A!==""&&x!==null&&A!==x){u=z.currentPath}if(s.parent.isContainer||s.node.isContainer){var y={};y.path=u;y.file=s.location.file;r='#" class="filter-change" rel="'+Alfresco.DocumentList.generatePathMarkup(y)}else{if(u==="/"){r='#" class="filter-change" rel="'+Alfresco.DocumentList.generateFilterMarkup({filterId:"path",filterData:d(u,"")})}else{r="#"}}}}else{var p=z.getActionUrls(s);r=p.documentDetailsUrl}}return'<a href="'+r+'">'};Alfresco.DocumentListSimpleViewRenderer.prototype.renderCellThumbnail=function h(o,q,C,u,z){var p=C.getData(),y=p.jsNode,r=y.properties,F=p.displayName,s=y.isContainer,t=y.isLink,v=F.substring(F.lastIndexOf(".")),A=y.nodeRef.nodeRef,D=beCPG.util.isEntity(p);if(D){v=y.type.substring(y.type.lastIndexOf(":"))}var E;u.width=40;f.setStyle(q,"width",u.width+"px");f.setStyle(q.parentNode,"width",u.width+"px");if(s&&!D){q.innerHTML='<span class="folder-small">'+(t?'<span class="link"></span>':"")+(o.dragAndDropEnabled?'<span class="droppable"></span>':"")+Alfresco.DocumentList.generateFileFolderLinkMarkup(o,p)+'<img id="'+A+'" src="'+this.getFolderIcon(p.node)+'" /></a>';E=new YAHOO.util.DDTarget(A)}else{var w=o.id+"-preview-"+C.getId();var B=Alfresco.util.getFileIcon(F,y.type);if(B=="generic-file-32.png"){B=Alfresco.util.getFileIconByMimetype(y.mimetype)}q.innerHTML='<span id="'+w+'" class="icon32">'+(t?'<span class="link"></span>':"")+Alfresco.DocumentList.generateFileFolderLinkMarkup(o,p)+'<img id="'+A+'" src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/filetypes/"+B+'" alt="'+v+'" title="'+c(F)+'" /></a></span>';o.previewTooltips.push(w)}var x=new Alfresco.DnD(A,o)};Alfresco.DocumentListViewRenderer.prototype.renderCellThumbnail=function j(B,A,D,w,s){var v=D.getData(),t=v.jsNode,y=t.properties,p=v.displayName,r=t.isContainer,C=beCPG.util.isEntity(v),u=t.isLink,x=p.substring(p.lastIndexOf(".")),o=t.nodeRef.nodeRef;var z;if(window.location.href.search(/\/sharedfiles/)!=-1&&v.location.path.search("/Shared")==0){v.location.path=v.location.path.substring(7)}w.width=this.thumbnailColumnWidth;f.setStyle(A,"width",w.width+"px");f.setStyle(A.parentNode,"width",w.width+"px");if((r||(u&&t.linkedNode.isContainer))&&!C){A.innerHTML='<span class="folder">'+(u?'<span class="link"></span>':"")+(B.dragAndDropEnabled?'<span class="droppable"></span>':"")+Alfresco.DocumentList.generateFileFolderLinkMarkup(B,v)+'<img id="'+o+'" src="'+this.getFolderIcon(v.node)+'" /></a>';z=new YAHOO.util.DDTarget(o)}else{A.innerHTML='<span class="thumbnail">'+(u?'<span class="link"></span>':"")+Alfresco.DocumentList.generateFileFolderLinkMarkup(B,v)+'<img id="'+o+'" src="'+Alfresco.DocumentList.generateThumbnailUrl(v)+'" alt="'+x+'" title="'+c(p)+'" /></a></span>'}var q=new Alfresco.DnD(o,B)};Alfresco.DocumentList.generateLikes=function m(r,o){var s=o.node,p=o.likes,t="like."+(s.isContainer&&!beCPG.util.isEntity(o)?"folder.":"document."),q="";if(p.isLiked){q='<a class="like-action enabled" title="'+r.msg(t+"remove.tip")+'" tabindex="0"></a>'}else{q='<a class="like-action" title="'+r.msg(t+"add.tip")+'" tabindex="0">'+r.msg(t+"add.label")+"</a>"}q+='<span class="likes-count">'+c(p.totalLikes)+"</span>";return q};Alfresco.DocumentList.generateComments=function g(r,o){var u=o.node,t=r.getActionUrls(o),p=t[u.isContainer?"folderDetailsUrl":"documentDetailsUrl"]+"#comment",v="comment."+(u.isContainer&&!beCPG.util.isEntity(o)?"folder.":"document.");if(beCPG.util.isEntity(o)){p=p.replace("folder-details?","entity-data-lists?list=View-properties&")}var s=(u.properties["fm:commentCount"]!==undefined);var q='<a href="'+p+'" class="comment'+(s?" hasComments":"")+'" title="'+r.msg(v+"tip")+'" tabindex="0">'+r.msg(v+"label")+"</a>";if(s){q+='<span class="comment-count">'+c(u.properties["fm:commentCount"])+"</span>"}return q}})();