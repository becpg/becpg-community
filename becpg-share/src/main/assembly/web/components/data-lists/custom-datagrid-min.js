(function(){var a=Alfresco.util.encodeHTML,h=Alfresco.util.activateLinks,e=Alfresco.util.userProfileLink;var c=Alfresco.util.generateDomId(null,"like");beCPG.component.DataGrid=function f(i){beCPG.component.DataGrid.superclass.constructor.call(this,i);this.services.likes=new Alfresco.service.Ratings(Alfresco.service.Ratings.LIKES);return this};YAHOO.extend(beCPG.component.DataGrid,Alfresco.component.DataGrid);YAHOO.lang.augmentProto(beCPG.component.DataGrid,Alfresco.service.DataListActions);YAHOO.lang.augmentObject(beCPG.component.DataGrid.prototype,{onLikes:function g(p){var m=this.widgets.dataTable.getRecord(p).getData(),o=new Alfresco.util.NodeRef(m.nodeRef),k=m.likes;k.isLiked=!k.isLiked;k.totalLikes+=(k.isLiked?1:-1);var l={successCallback:{fn:function i(v,t){var w=v.json.data;if(w){var q=this._findRecordByParameter(t,"nodeRef"),u=q.getData(),r=u.likes;r.totalLikes=w.ratingsCount;this.widgets.dataTable.updateRow(q,u);if(r.isLiked){var s={fileName:q.fileName,nodeRef:u.nodeRef},x=(u.itemData.prop_cm_title!=null&&u.itemData.prop_cm_title.displayValue)?u.itemData.prop_cm_title.displayValue:"";Alfresco.Share.postActivity(this.options.siteId,"org.alfresco.documentlibrary.file-liked",x,"data-lists?list="+this.datalistMeta.name,s)}}},scope:this,obj:o.toString()},failureCallback:{fn:function n(u,s){var q=this._findRecordByParameter(s,"nodeRef"),t=q.getData(),r=t.likes;r.isLiked=!r.isLiked;r.totalLikes+=(r.isLiked?1:-1);this.widgets.dataTable.updateRow(q,t);Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.save.failure",s)})},scope:this,obj:o.toString()}};if(k.isLiked){this.services.likes.set(o,1,l)}else{this.services.likes.remove(o,l)}var j=this._findRecordByParameter(o,"nodeRef");this.widgets.dataTable.updateRow(j,m)},onReady:function b(){me=this;beCPG.component.DataGrid.superclass.onReady.call(this);var j=function i(m,l){var k=YAHOO.Bubbling.getOwnerByTagName(l[1].anchor,"div");if(k!==null){me.onLikes.call(me,l[1].target.offsetParent,k)}return true};YAHOO.Bubbling.addDefaultAction(c,j)},getCellFormatter:function d(){var j=this;return function i(r,t,p,k){var o="";if(!t){t=this.getRecord(r)}if(!p){p=this.getColumn(r.parentNode.cellIndex)}if(t&&p){if(!k){k=t.getData("itemData")[p.field]}var q=j.datalistColumns[p.key];if(q){if(q.name=="cm:likesRatingSchemeCount"){var l=t.getData().likes;o+='<div class="detail detail-social"><span class="item item-social">';if(l.isLiked){o+='<a class="like-action '+c+' enabled" title="'+j.msg("like.document.remove.tip")+'" tabindex="0"></a>'}else{o+='<a class="like-action '+c+'" title="'+j.msg("like.document.add.tip")+'" tabindex="0">'+j.msg("like.document.add.label")+"</a>"}o+='<span class="likes-count">'+a(l.totalLikes)+"</span></span></div>"}else{if(k){k=YAHOO.lang.isArray(k)?k:[k];for(var n=0,s=k.length,m;n<s;n++){m=k[n];switch(q.dataType.toLowerCase()){case"cm:person":o+='<span class="person">'+e(m.metadata,m.displayValue)+"</span>";break;case"datetime":o+=Alfresco.util.formatDate(Alfresco.util.fromISO8601(m.value),j.msg("date-format.default"));break;case"date":o+=Alfresco.util.formatDate(Alfresco.util.fromISO8601(m.value),j.msg("date-format.defaultDateOnly"));break;case"text":o+=h(a(m.displayValue));break;default:if(q.type=="association"){o+='<a href="'+Alfresco.util.siteURL((m.metadata=="container"?"folder":"document")+"-details?nodeRef="+m.value)+'">';o+='<img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/filetypes/"+Alfresco.util.getFileIcon(m.displayValue,(m.metadata=="container"?"cm:folder":null),16)+'" width="16" alt="'+a(m.displayValue)+'" title="'+a(m.displayValue)+'" />';o+=" "+a(m.displayValue)+"</a>"}else{o+=h(a(m.displayValue))}break}if(n<s-1){o+="<br />"}}}}}}r.innerHTML=o}}},true)})();