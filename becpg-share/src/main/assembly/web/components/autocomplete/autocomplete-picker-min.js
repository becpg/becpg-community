(function(){var e=YAHOO.util.Dom,l=YAHOO.util.Event,g=YAHOO.util.Lang,b=YAHOO.util.Element;beCPG.component.AutoCompletePicker=function k(p,o,n){beCPG.component.AutoCompletePicker.superclass.constructor.call(this,"beCPG.component.AutoCompletePicker",p,["button","menu","container"]);YAHOO.Bubbling.on("beforeFormRuntimeInit",this.beforeFormRuntimeInit,this);this.controlId=p;this.fieldHtmlId=o;this.isAssoc=n;YAHOO.Bubbling.on(this.fieldHtmlId+"refreshContent",this.refreshContent,this);YAHOO.Bubbling.on("formContainerDestroyed",this.onFormContainerDestroyed,this);return this};YAHOO.extend(beCPG.component.AutoCompletePicker,Alfresco.component.Base);YAHOO.extend(beCPG.component.AutoCompletePicker,Alfresco.component.Base,{objectRenderer:new Alfresco.ObjectRenderer(this),openOnce:false,options:{currentValue:"",mode:"view",readOnly:false,multipleSelectMode:true,targetLinkTemplate:null,dsStr:null,parentFieldHtmlId:null,isMandatory:false,isLocalProxy:false,showColor:false,showToolTip:false,showPage:true,saveTitle:true,urlParamsToPass:null,isParentMode:false},onFormContainerDestroyed:function h(o,n){if(this.widgets.oAC){this.widgets.oAC.destroy();delete this.widgets.oAC}},destroy:function m(){try{YAHOO.Bubbling.unsubscribe("formContainerDestroyed",this.onFormContainerDestroyed,this);YAHOO.Bubbling.unsubscribe(this.fieldHtmlId+"refreshContent",this.refreshContent,this);YAHOO.Bubbling.unsubscribe("beforeFormRuntimeInit",this.beforeFormRuntimeInit,this)}catch(n){}beCPG.component.AutoCompletePicker.superclass.destroy.call(this)},onReady:function i(){var u=this,s=null,v="";if(u.options.multipleSelectMode||u.isAssoc){u.loadItems()}if(u.options.mode!="view"&&!this.options.readOnly){var t=null,p=null,o=[],r={},n="";if(this.options.isLocalProxy){t=new YAHOO.util.XHRDataSource(Alfresco.constants.URL_SERVICECONTEXT+u.options.dsStr)}else{t=new YAHOO.util.XHRDataSource(Alfresco.constants.PROXY_URI+u.options.dsStr)}t.responseType=YAHOO.util.XHRDataSource.TYPE_JSON;t.responseSchema={resultsList:"result",fields:["value","name","cssClass","metadatas"],metaFields:{page:"page",pageSize:"pageSize",fullListSize:"fullListSize"}};u.widgets.oAC=new YAHOO.widget.AutoComplete(u.fieldHtmlId,u.fieldHtmlId+"-container",t);u.widgets.oAC.queryDelay=0.1;u.widgets.oAC.page=1;u.widgets.oAC.maxResultsDisplayed=15;u.widgets.oAC.forceSelection=false;if(e.get(u.fieldHtmlId).hasFocus){u.widgets.oAC._onTextboxFocus(this,u.widgets.oAC)}if(u.options.multipleSelectMode){l.delegate(u.controlId+"-basket","click",function(y,w,q){var x=w.id.split("ac-close-"+u.fieldHtmlId+"-")[1];u.removeFromBasket(x);YAHOO.Bubbling.fire("mandatoryControlValueUpdated",u.widgets.oAC.getInputEl());l.preventDefault(y);l.stopPropagation(y)},"span.ac-closebutton");l.on(e.get(u.fieldHtmlId).form,"reset",function(w){u.widgets.oAC._clearSelection();e.get(u.controlId+"-basket").innerHTML="";var y=e.get(u.controlId+"-orig"),x=e.get(u.controlId+"-added"),q=e.get(u.controlId+"-removed");if(y!=null){x.value=y.value}else{x.value=""}if(q!=null){q.value=""}})}u.widgets.oAC.generateRequest=function(y){u.openOnce=true;if(u.options.multipleSelectMode&&y.indexOf("%2C%20")>0){var w=y.split("%2C%20");y=w[w.length-1]}var x=null;if(u.options.parentFieldHtmlId!=null){var q=null;if(u.isAssoc){x=u.getValuesFromId(u.options.parentFieldHtmlId)}else{q=e.get(u.options.parentFieldHtmlId);if(q!=null){x=q.value}}}if(x!=null){v=g.substitute("q={query}&parent={parent}&page={page}",{query:y,parent:x,page:u.widgets.oAC.page})}else{v=g.substitute("q={query}&page={page}",{query:y,page:u.widgets.oAC.page})}if(u.options.urlParamsToPass!=null){v=v+"&"+u.options.urlParamsToPass}if(u.options.dsStr.indexOf("?")>0){return"&"+v}return"?"+v};u.widgets.oAC.setHeader("<div class='ac-header' ><span>"+u.msg("autocomplete.header.msg")+"</span></div>");if(u.options.showToolTip){s=new YAHOO.widget.Tooltip("previewTooltip",{container:u.fieldHtmlId+"-container",width:"108px",showDelay:500,zIndex:9999});s.contextTriggerEvent.subscribe(function(B,A){var w=A[0];var D=w.id.split("ac-choice-"+u.fieldHtmlId+"-")[1].replace(":/","");var x=r[w.id],C="",E="",q=108;if(x!=null){for(var y=0;y<x.length;y++){if(x[y].key=="title"){C=x[y].value}if(x[y].key=="description"){E=x[y].value}}}var z='<table><tr><td><img src="'+Alfresco.constants.PROXY_URI_RELATIVE+"api/node/"+D+'/content/thumbnails/doclib?c=queue&ph=true" /></td><td>';if(C!=null&&C.length>0){q=350;z+="<h3>"+C+"</h3>"}if(E!=null&&E.length>0){q=350;z+="<p>"+E+"</p>"}z+="</td></table>";this.cfg.setProperty("text",z);this.cfg.setProperty("width",q+"px")})}u.widgets.oAC.formatResult=function(w,y,q){if(u.options.showToolTip){o.push("ac-choice-"+u.fieldHtmlId+"-"+w[0]);r["ac-choice-"+u.fieldHtmlId+"-"+w[0]]=w[3]}getColor=function(A){var z=null;for(key in A){obj=A[key];if(obj.key=="color"){z=obj.value}}return z};var x="";if(u.options.showColor){x="<span class='show-color' style='background:"+getColor(w[3])+"'>&nbsp;</span>"}return x+"<span id='ac-choice-"+u.fieldHtmlId+"-"+w[0]+"' class='"+w[2]+"'><span class='ctn-fav'></span> "+w[1]+"</span>"};p=e.get(u.fieldHtmlId+"-toggle-autocomplete");l.on(u.fieldHtmlId+"-autocomplete","click",function(q){if(!u.widgets.oAC.isContainerOpen()){u.widgets.oAC.getInputEl().focus()}});l.on(p,"click",function(q){if(u.widgets.oAC.isContainerOpen()){u.widgets.oAC.collapseContainer()}else{u.widgets.oAC.getInputEl().focus();n=u.widgets.oAC.getInputEl().value;setTimeout(function(){u.widgets.oAC.sendQuery("*")},0)}u.widgets.oAC.page=1;o=[];r={};l.preventDefault(q);l.stopPropagation(q)});u.widgets.oAC.containerExpandEvent.subscribe(function(){e.addClass(p,"openToggle")});u.widgets.oAC.containerCollapseEvent.subscribe(function(){e.removeClass(p,"openToggle");u.widgets.oAC.page=1;o=[];r={}});u.widgets.oAC.doBeforeLoadData=function(x,q,w){if(u.options.showPage){u.widgets.oAC.fullListSize=q.meta.fullListSize;u.widgets.oAC.pageSize=q.meta.pageSize;u.widgets.oAC.page=q.meta.page}return true};u.widgets.oAC.doBeforeExpandContainer=function(z,w,y,x){if(!u.options.showPage||parseInt(u.widgets.oAC.fullListSize)<parseInt(u.widgets.oAC.pageSize)+1){u.widgets.oAC.setFooter("")}else{u.widgets.oAC.setFooter("<div class='ac-footer'><div id='"+u.fieldHtmlId+"-container-paging'></div></div>");var q=new YAHOO.widget.Paginator({rowsPerPage:u.widgets.oAC.pageSize,totalRecords:u.widgets.oAC.fullListSize,containers:u.fieldHtmlId+"-container-paging",initialPage:parseInt(u.widgets.oAC.page),template:"<div>{CurrentPageReport}</div> {PreviousPageLink} {PageLinks} {NextPageLink}",pageReportTemplate:u.msg("autocomplete.pagination.template.page-report"),previousPageLinkLabel:u.msg("autocomplete.pagination.previousPageLinkLabel"),nextPageLinkLabel:u.msg("autocomplete.pagination.nextPageLinkLabel")});q.subscribe("changeRequest",function(A){u.widgets.oAC.page=A.page;o=[];r={};setTimeout(function(){var B=u.widgets.oAC.getInputEl().value;if(B==n){u.widgets.oAC.sendQuery("*")}else{u.widgets.oAC.sendQuery(B)}},0)});q.render()}if(u.options.showToolTip&&s!=null){s.cfg.setProperty("context",o)}return true};u.widgets.oAC.textboxKeyEvent.subscribe(function(){u.widgets.oAC.page=1;o=[]});u.widgets.oAC.textboxBlurEvent.subscribe(function(){if(u.openOnce&&(!u.widgets.oAC._bOverContainer||(u.widgets.oAC._nKeyCode==9))){if(!u.widgets.oAC._bItemSelected){var w=u.widgets.oAC._textMatchesOption();if(!u.widgets.oAC._bContainerOpen||(u.widgets.oAC._bContainerOpen&&(w===null))){u.widgets.oAC._clearSelection()}}}if(!u.options.multipleSelectMode&&u.isAssoc){if(u.widgets.oAC.getInputEl().value==null||u.widgets.oAC.getInputEl().value.length<1){var y=e.get(u.controlId+"-orig"),x=e.get(u.controlId+"-added"),q=e.get(u.controlId+"-removed");if(y!=null&&y.value!=""){q.value=y.value}x.value=""}}});u.widgets.oAC.itemSelectEvent.subscribe(function(z,x){var y=x[2],B=y[0],q=y[1];if(u.isAssoc||u.options.multipleSelectMode){var A=e.get(u.controlId+"-added");if(!u.options.multipleSelectMode||u.options.isParentMode){var C=e.get(u.controlId+"-orig"),w=e.get(u.controlId+"-removed");if(C!=null){if(C.value!=B){if(C.value!=""){w.value=C.value}A.value=B}else{w.value="";A.value=""}}else{A.value=B}}else{if(A.value!=""){A.value+=","}A.value+=B}}if(u.options.multipleSelectMode){u.addToBasket(e.get(u.controlId+"-basket"),q,B);u.widgets.oAC.getInputEl().value=""}else{if(u.options.saveTitle){u.widgets.oAC.getInputEl().value=q}else{u.widgets.oAC.getInputEl().value=B}}YAHOO.Bubbling.fire("mandatoryControlValueUpdated",u.widgets.oAC.getInputEl());return true});e.removeClass(u.widgets.oAC.getInputEl(),"hidden")}else{if(!u.options.multipleSelectMode&&!u.isAssoc){e.removeClass(u.fieldHtmlId+"-values","hidden")}}},addToBasket:function f(p,n,q){var o="<span id='ac-m-selected-"+this.fieldHtmlId+"-"+q+"' class='ac-m-selected'>";if(this.options.isParentMode&&p!=null&&p.innerHTML!=""){o+="<span  class='ac-parent-sep' >&nbsp;</span>"}o+="<span class='ac-m-selected-body'>";o+=n;o+="</span>";o+="<span id='ac-close-"+this.fieldHtmlId+"-"+q+"' class='ac-closebutton' ></span>";o+="</span>";p.innerHTML+=o},removeFromBasket:function j(o){var p=new b(this.controlId+"-basket"),q=e.get(this.controlId+"-added");p.removeChild(e.get("ac-m-selected-"+this.fieldHtmlId+"-"+o));if(this.isAssoc&&e.get(this.controlId+"-removed")){var n=e.get(this.controlId+"-removed");if(n.value!=""){n.value+=","}n.value+=o}if(q){q.value=q.value.replace(","+o,"").replace(o+",","").replace(o,"")}},loadItems:function d(){var q=this;if(q.options.currentValue!=""){if(q.isAssoc){Alfresco.util.Ajax.jsonRequest({url:Alfresco.constants.PROXY_URI+"api/forms/picker/items",method:"POST",dataObj:{items:q.options.currentValue.split(",")},successCallback:{fn:function(u){var t=u.json.data.items,w={};for(var v=0,s=t.length;v<s;v++){w[t[v].nodeRef]=t[v]}q.renderItems(w)},scope:this}})}else{var o=q.options.currentValue.split(",");for(var p=0,n=o.length;p<n;p++){var r=e.get(q.controlId+"-basket");q.addToBasket(r,o[p],o[p])}}}},renderItems:function a(n){var p="",r;if(n===null){p='<span class="error">'+this.msg("form.control.object-picker.current.failure")+"</span>"}else{if(this.options.mode=="view"||this.options.readOnly){for(var o in n){var q=n[o];if(p!=""){p+=", "}if(this.options.targetLinkTemplate!=null){r=Alfresco.util.siteURL(g.substitute(this.options.targetLinkTemplate,q),{site:q.site});p+=this.objectRenderer.renderItem(q,16,"<div>{icon} <a href='"+r+"'>{name}</a></div>")}else{p+=q.name}}e.get(this.fieldHtmlId+"-values").innerHTML=p;e.removeClass(this.fieldHtmlId+"-values","hidden")}else{if(this.options.multipleSelectMode){var s=e.get(this.controlId+"-basket");for(var o in n){var q=n[o];this.addToBasket(s,q.name,q.nodeRef)}}else{var t=e.get(this.fieldHtmlId);for(var o in n){var q=n[o];p+=q.name}t.value=p;YAHOO.Bubbling.fire("mandatoryControlValueUpdated",t);e.removeClass(this.fieldHtmlId,"hidden")}}}},getValues:function c(){return this.getValuesFromId(this.controlId)},getValuesFromId:function c(p){var r=e.get(p+"-added");inputOrig=e.get(p+"-orig"),inputRemoved=e.get(p+"-removed"),orig=[],removed=[],ret=[];if(r!=null&&r.value.length>0){ret=r.value.split(",")}if(inputOrig!=null&&inputOrig.value.length>0){orig=inputOrig.value.split(",")}if(inputRemoved!=null&&inputRemoved.value.length>0){removed=inputRemoved.value.split(",")}for(var o in orig){var q=true;for(var n in removed){if(orig[o]==removed[n]){q=false;break}}if(q){ret.push(orig[o])}}return ret.join()},refreshContent:function(o,n){var p=e.get(this.controlId+"-basket");if(p!=null){p.innerHTML=""}this.options.currentValue=n[1];if(!(this.options.multipleSelectMode||this.isAssoc)){this.loadItems()}},beforeFormRuntimeInit:function(p,o){var q=this,r=o[1].runtime;if(this.options.multipleSelectMode&&this.fieldHtmlId.indexOf(r.formId.replace("-form",""))>-1){for(var n=0;n<o[1].runtime.validations.length;n++){if(o[1].runtime.validations[n].fieldId==this.fieldHtmlId){o[1].runtime.validations[n].handler=function s(x,u,w,v){var t=q.getValues();return YAHOO.lang.trim(t).length!==0}}}}}})})();