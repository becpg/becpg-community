(function(){var f=YAHOO.util.Dom,c=YAHOO.Bubbling;var e=Alfresco.util.siteURL;beCPG.component.WizardMgr=function i(j){beCPG.component.WizardMgr.superclass.constructor.call(this,"beCPG.component.WizardMgr",j);c.on("beforeFormRuntimeInit",this.onBeforeFormRuntimeInit,this);return this};YAHOO.extend(beCPG.component.WizardMgr,Alfresco.component.Base,{currentIndex:0,options:{siteId:"",nodeRef:"",destination:"",wizardStruct:[]},onReady:function a(){var l=this;this.widgets.wizard=jQuery("#"+this.id+"-wizard").steps({stepsOrientation:"vertical",enableCancelButton:true,enableKeyNavigation:false,labels:{cancel:l.msg("wizard.cancel.button"),current:l.msg("wizard.current.step"),pagination:l.msg("wizard.pagination"),finish:l.msg("wizard.finish.button"),next:l.msg("wizard.next.button"),previous:l.msg("wizard.previous.button"),loading:l.msg("wizard.loading.msg")},onStepChanging:function(p,m,n){if(m>n){return true}var q=false;var o=l.options.wizardStruct[m];if(o!=null){if(o.type=="form"){if(o.form!=null){f.get(l.id+"-step-"+o.id+"-form-submit").click();q=o.form.validate(Alfresco.forms.Form.NOTIFICATION_LEVEL_CONTAINER)}}else{q=true}}return q},onStepChanged:function(p,n,q){l.currentIndex=n;var o=l.options.wizardStruct[q];var m=l.options.wizardStruct[n];if(o!=null&&m!=null&&(o.type!="form"||n<q)){if(n>q){m.nodeRef=o.nodeRef}l.loadStep(m)}},onFinished:function(o,m){var p=true;var n=l.options.wizardStruct[m];if(n!=null){if(n.type=="form"){if(n.form!=null){f.get(l.id+"-step-"+n.id+"-form-submit").click();p=n.form.validate(Alfresco.forms.Form.NOTIFICATION_LEVEL_CONTAINER);n.finish=true}else{p=true}}}if(p&&!(n!=null&&n.finish)){l._navigateForward(l.options.wizardStruct[0].nodeRef)}return p},onCanceled:function(n,m){if(l.options.nodeRef==""&&l.options.wizardStruct[0].nodeRef){Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.DELETE,url:Alfresco.constants.PROXY_URI+"slingshot/doclib/action/file/node/"+l.options.wizardStruct[0].nodeRef.replace("://","/"),scope:this,execScripts:false,successCallback:{fn:function(o){l._navigateForward()},scope:this}})}else{l._navigateForward()}}});for(var j=0;j<this.options.wizardStruct.length;j++){var k=this.options.wizardStruct[j];k.index=j;this.widgets.wizard.steps("add",{title:this.msg(k.label),content:"<div id='"+this.id+"-step-"+k.id+"'>"+this.msg("wizard.loading.msg")+"</div>"});if(j==0){l.loadStep(k)}}},onBeforeFormRuntimeInit:function d(l,j){var p=j[1].eventGroup.split("-step-"),n=this;if(p.length==2){var o=p[1];for(var k=0;k<this.options.wizardStruct.length;k++){var m=this.options.wizardStruct[k];if(m.id+"-form"==o){m.form=j[1].runtime;m.form.setAJAXSubmit(true,{successCallback:{fn:n.onFormSubmit,scope:this}})}}}},onFormSubmit:function(k){var n=this;if(k.json.persistedObject){var m=n.options.wizardStruct[n.currentIndex-1];if(m!=null){m.nodeRef=k.json.persistedObject;if(m.finish){n._navigateForward(n.options.wizardStruct[0].nodeRef)}else{var j=n.options.wizardStruct[n.currentIndex];if(j!=null){if(m.nextStepWebScript!=null){var l=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+m.nextStepWebScript,{nodeRef:m.nodeRef});Alfresco.util.Ajax.jsonRequest({url:l,method:"GET",successCallback:{fn:function(o){j.nodeRef=o.json.nodeRef;n.loadStep(j)},scope:this}})}else{j.nodeRef=m.nodeRef;n.loadStep(j)}}}}else{m=n.options.wizardStruct[n.currentIndex];if(m.finish){n._navigateForward(n.options.wizardStruct[0].nodeRef)}}}},loadStep:function h(k){if(!k.title||k.title==null){f.get(this.id+"-wizardTitle").innerHTML="";f.addClass(this.id+"-wizardTitle","hidden")}else{f.get(this.id+"-wizardTitle").innerHTML=this.msg(k.title);f.removeClass(this.id+"-wizardTitle","hidden")}if(k.type=="entityDataList"){f.addClass(this.id+"-wizard-p-"+k.index,"entity-data-lists")}else{f.removeClass(this.id+"-wizard-p-"+k.index,"entity-data-lists")}if(!k.nodeRef||k.nodeRef==null||k.nodeRef.length<1){k.nodeRef=this.options.nodeRef}if(k.nodeRefStepIndex!=null&&k.nodeRefStepIndex!=""){k.nodeRef=this.options.wizardStruct[k.nodeRefStepIndex].nodeRef}var j=null;if(k.type=="form"){j=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?destination={destination}&formId={formId}&itemId={itemId}&itemKind={itemKind}&mode={mode}&submitType=json&showCancelButton=false&showSubmitButton=true",{mode:(k.nodeRef!=null&&k.nodeRef.length>0)?"edit":"create",itemKind:(k.nodeRef!=null&&k.nodeRef.length>0)?"node":"type",itemId:(k.nodeRef!=null&&k.nodeRef.length>0)?k.nodeRef:k.itemId,destination:this.options.destination,formId:k.formId})}else{if(k.type=="entityDataList"){j=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/entity-charact-views/simple-view?list={list}&nodeRef={nodeRef}&itemType={itemType}&title={title}",{nodeRef:k.nodeRef,list:k.listId,itemType:k.itemId,title:encodeURIComponent(k.label)})}}if(j!=null){if(k.type!="entityDataList"||!k.loaded){Alfresco.util.Ajax.request({url:j,dataObj:{htmlid:this.id+"-step-"+k.id},successCallback:{fn:function(l){f.get(this.id+"-step-"+k.id).innerHTML=l.serverResponse.responseText;k.loaded=true;if(k.type=="entityDataList"){this.loadDataList(k)}},scope:this},scope:this,execScripts:true})}}},loadDataList:function b(k){var j=this;Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"becpg/entitylists/node/"+k.nodeRef.replace(":/",""),successCallback:{fn:function(m){var l=m.json.datalists,p;for(var n=0,o=l.length;n<o;n++){p=l[n];if(p.name==k.listId){var q=j.widgets.wizard.steps("getStepAnchor");q.parent().addClass(p.state);YAHOO.Bubbling.fire("simpleView-"+j.id+"-step-"+k.id+"scopedActiveDataListChanged",{list:p.name,dataList:p,entity:null})}}},scope:this}})},_navigateForward:function g(j){if(YAHOO.lang.isObject(j)){window.location.href=e("entity-data-lists?list=View-properties&nodeRef="+j.toString())}else{if(document.referrer){if(document.referrer.match(/documentlibrary([?]|$)/)||document.referrer.match(/repository([?]|$)/)){history.go(-1)}else{document.location.href=document.referrer}}else{if(this.options.siteId&&this.options.siteId!==""){window.location.href=e("documentlibrary")}else{if(Alfresco.constants.PORTLET){window.location.href=e("repository")}else{window.location.href=Alfresco.constants.URL_CONTEXT}}}}}})})();