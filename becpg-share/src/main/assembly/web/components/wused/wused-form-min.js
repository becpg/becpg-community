(function(){beCPG.component.WUsedForm=function(f){beCPG.component.WUsedForm.superclass.constructor.call(this,"beCPG.component.WUsedForm",f,["button","container"]);return this};YAHOO.extend(beCPG.component.WUsedForm,Alfresco.component.Base);YAHOO.lang.augmentObject(beCPG.component.WUsedForm.prototype,{options:{type:null,itemType:null,assocType:null,filterType:null,nodeRefs:null,searchQuery:null,searchTerm:null,aspectSubstitutions:null},onReady:function a(){var k=this;this.widgets.wusedTypeSelect=Alfresco.util.createYUIButton(this,"wusedTypeSelect-button",this.onWusedTypeSelect,{type:"menu",menu:"wusedTypeSelect-menu",lazyloadmenu:false});if(this.widgets.wusedTypeSelect==null){this.widgets.operators=Alfresco.util.createYUIButton(this,"operators",function(o,i){var p=i[1];if(p){this.widgets.operators.set("label",p.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.operators.value=p.value}},{type:"menu",menu:"operators-menu",lazyloadmenu:false});this.widgets.operators.value=k.options.searchQuery?"OR":"AND";this.widgets.operators.set("label",this.msg("operator."+this.widgets.operators.value.toLowerCase())+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.typeSelect=Alfresco.util.createYUIButton(this,"itemTypeSelect-button",this.onTypeSelect,{type:"menu",menu:"itemTypeSelect-menu",lazyloadmenu:false});this.widgets.typeSelect.getMenu().subscribe("click",function(o,i){var p=i[1];if(p){k.widgets.typeSelect.set("label",p.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL)}});this.widgets.typeFilterSelect=Alfresco.util.createYUIButton(this,"typeFilterSelect-button",this.onTypeFilterSelect,{type:"menu",menu:"typeFilterSelect-menu",lazyloadmenu:false});this.widgets.typeFilterSelect.getMenu().subscribe("click",function(o,i){var p=i[1];if(p){k.widgets.typeFilterSelect.set("label",p.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL)}});var j=Alfresco.util.ComponentManager.find({name:"beCPG.module.EntityDataGrid"})[0],m=j.onDatalistColumns;var n=function(){if(!k.options.searchQuery){j.options.entityNodeRef=k._getNodeRefs();if(j.options.entityNodeRef==null||j.options.entityNodeRef.length<1){return}j.options.extraParams=YAHOO.lang.JSON.stringify({operator:k.widgets.operators.value,typeFilter:k.options.filterType})}else{j.options.extraParams=YAHOO.lang.JSON.stringify({operator:k.widgets.operators.value,searchQuery:YAHOO.lang.JSON.parse(k.options.searchQuery),searchTerm:k.options.searchTerm,typeFilter:k.options.filterType})}j.onDatalistColumns=function(o){var i=true,p="assoc_"+k.options.assocType.replace(":","_");if(o.json.columns.length<1){o.json.columns.push({type:"association",name:k.options.assocType,formsName:p,label:k.msg("column.wused"),dataType:k.options.itemType});i=false}m.call(this,o);if(i){YAHOO.Bubbling.fire("columnRenamed",{columnId:p,label:k.msg("column.wused")})}};YAHOO.Bubbling.fire("registerDataGridRenderer",{propertyName:[k.options.itemType+"_"+k.options.assocType],renderer:function(q,r,o,p){var i=beCPG.util.entityURL(r.siteId,r.value);return'<span class="'+r.metadata+'" ><a href="'+i+'">'+Alfresco.util.encodeHTML(r.displayValue)+"</a></span>"}});YAHOO.Bubbling.fire("activeDataListChanged",{dataList:{name:"WUsed-"+k.options.assocType.replace(":","_"),itemType:k.options.itemType,entity:null}})};this.widgets.showButton=Alfresco.util.createYUIButton(this,"show-button",n,{disabled:true});if(!k.options.searchQuery){this.widgets.entitiesPicker=new beCPG.component.AutoCompletePicker(this.id+"-entities",this.id+"-entities-field",true).setOptions({mode:"edit",currentValue:this.options.nodeRefs,multipleSelectMode:true,dsStr:"/becpg/autocomplete/targetassoc/associations/"+this.options.type})}var f=this.widgets.typeSelect.getMenu().getItems();for(var g in f){var l=f[g];if(l){k.widgets.typeSelect.set("label",l.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);var h=l._oAnchor.children[0].attributes[0].nodeValue;this._extractValues(h);if(h.indexOf("selected")>-1){break}}}}},onTypeSelect:function b(j,i,h){var g=i[1];var f=Alfresco.util.findEventClass(g);this._extractValues(f)},onTypeFilterSelect:function e(j,i,h){var g=i[1];var f=Alfresco.util.findEventClass(g);this.options.filterType=f.split("#")[0];if(this.options.itemType!=null&&this.options.assocType!=null){this.widgets.showButton.set("disabled",false)}},onWusedTypeSelect:function b(j,i,h){var g=i[1];var f=Alfresco.util.findEventClass(g);window.location.href=Alfresco.constants.URL_PAGECONTEXT+"wused?type="+f},_extractValues:function d(g){this.options.itemType=g.split("#")[0];if(this.options.aspectSubstitutions!=null){for(var f in this.options.aspectSubstitutions){if(this.options.aspectSubstitutions[f].name==this.options.itemType){this.options.itemType=this.options.aspectSubstitutions[f].type;break}}}this.options.assocType=g.split("#")[1]},_getNodeRefs:function c(){return this.widgets.entitiesPicker.getValues()}},true)})();