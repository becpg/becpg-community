(function(){var g=YAHOO.util.Dom,b=YAHOO.util.KeyListener;var d=Alfresco.util.generateDomId(null,"download");var f=Alfresco.util.encodeHTML,p=Alfresco.Share.userAvatar;beCPG.module.VersionsGraph=function(r){this.name="beCPG.module.VersionsGraph";this.id=r;var q=Alfresco.util.ComponentManager.get(this.id);if(q!==null){throw new Error("An instance of beCPG.module.VersionsGraph already exists.")}Alfresco.util.ComponentManager.register(this);Alfresco.util.YUILoaderHelper.require(["datasource","datatable","button","container"],this.onComponentsLoaded,this);return this};beCPG.module.VersionsGraph.prototype={options:{nodeRef:null},graphData:[],colors:[[1,0,0],[1,1,0],[0,1,0],[0,1,1],[0,0,1],[1,0,1],[1,1,0],[0,0,0]],line_width:2,dot_radius:5,widgets:{},onComponentsLoaded:function e(){if(this.id===null){return}},show:function m(q){this.options=YAHOO.lang.merge(this.options,q);if(this.options.nodeRef===undefined){throw new Error("A nodeRef, must be provided")}if(this.widgets.panel){this.update();this._showPanel()}else{Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"modules/entity-version/versions-graph?htmlid="+this.id,successCallback:{fn:this.onTemplateLoaded,scope:this},failureMessage:"Could not load html template for version graph",execScripts:true});this.widgets.escapeListener=new b(document,{keys:b.KEY.ESCAPE},{fn:this.onCancelButtonClick,scope:this,correctScope:true})}},onTemplateLoaded:function i(q){var s=document.createElement("div");s.innerHTML=q.serverResponse.responseText;var r=YAHOO.util.Dom.getFirstChild(s);this.widgets.panel=Alfresco.util.createYUIPanel(r,{draggable:true,width:"45em"});this.update();YAHOO.Bubbling.addDefaultAction(d,function(A,z){var y=z[1].anchor,w=y.getAttribute("name")||y.name,t=y.getAttribute("rel"),u=Alfresco.getArchiveAndDownloadInstance(),v={nodesToArchive:[{nodeRef:t}],archiveName:encodeURIComponent(w)};u.show(v);return true});this._showPanel()},onCancelButtonClick:function l(){this.widgets.panel.hide();this.widgets.escapeListener.disable()},update:function a(){var q=this;this.widgets.alfrescoDataTable=new Alfresco.util.DataTable({dataSource:{url:Alfresco.constants.PROXY_URI+"becpg/api/entity-version?mode=graph&nodeRef="+this.options.nodeRef,doBeforeParseData:function(s,r){q.graphData=r;return({data:r})}},dataTable:{container:this.id+"-graphContent",columnDefinitions:[{key:"version",sortable:false,formatter:this.renderCellVersion},{key:"date",sortable:false,formatter:this.renderCellDate},{key:"author",sortable:false,formatter:this.renderCellAuthor}],config:{MSG_EMPTY:Alfresco.util.message("message.noVersions",this.name)}}});this.widgets.alfrescoDataTable.getDataTable().subscribe("postRenderEvent",function(){q.widgets.canvas=g.get(q.id+"-graphCanvas");if(window.G_vmlCanvasManager){q.widgets.canvas=window.G_vmlCanvasManager.initElement(q.widgets.canvas)}q.ctx=q.widgets.canvas.getContext("2d");q.ctx.clearRect(0,0,q.widgets.canvas.width,q.widgets.canvas.height);q.ctx.strokeStyle="rgb(0, 0, 0)";q.ctx.fillStyle="rgb(0, 0, 0)";q.renderGraph(100)})},renderCellVersion:function k(t,s,w,y){var q="",v=s.getData(),u=(beCPG.module.getVersionsGraphInstance().options.nodeRef==v.entityNodeRef),r=null;if(!u||v.label!=beCPG.module.getVersionsGraphInstance().options.label){if(u){r=Alfresco.constants.PROXY_URI+"becpg/entity/compare/"+beCPG.module.getVersionsGraphInstance().options.nodeRef.replace(":/","")+"/"+encodeURIComponent(v.label)+"/"+encodeURIComponent(v.name)}else{r=Alfresco.constants.PROXY_URI+"becpg/entity/compare/"+beCPG.module.getVersionsGraphInstance().options.nodeRef.replace(":/","")+"/compare?entities="+v.entityNodeRef}}q+='<div id="graph-version-row-'+this.getRecordIndex(s)+'" class="entity-branches">';q+='   <span class="document-version">'+f(v.label)+"</span>";q+='   <span class="'+v.metadata+(u?" current":"")+'" >';if(u){q+=f(v.name)}else{q+='<a href="'+beCPG.util.entityURL(null,v.nodeRef)+'&bcPath=true">'+f(v.name)+"</a>"}if(r!=null){q+='   <a href="'+r+'" class="compare" title="'+Alfresco.util.message("label.compare")+'">&nbsp;</a>'}if(u){q+='   <a href="#" name="'+f(v.name)+'" rel="'+v.nodeRef+'" class="'+d+' download" title="'+Alfresco.util.message("label.download")+'">&nbsp;</a>'}q+='</span><div class="version-details">';q+=((v.description||"").length>0)?f(v.description,true):'<span class="faded">('+Alfresco.util.message("label.noComment",beCPG.module.getVersionsGraphInstance().name)+")</span>";q+="</div>";q+="</div>";t.innerHTML=q},renderCellAuthor:function c(t,s,v,w){var q="",u=s.getData();var r=Alfresco.util.uriTemplate("userprofilepage",{userid:u.creator.userName});q+='<a href="'+r+'" title="'+f(u.creator.firstName+" "+u.creator.lastName)+'">'+p(u.creator.userName,32)+"</a>";t.innerHTML=q},renderCellDate:function j(r,q,t,u){var s=q.getData();r.innerHTML=Alfresco.util.relativeTime(Alfresco.util.fromISO8601(s.createdDateISO))},setColor:function o(u,v,r){var t=u%this.colors.length;var z=(this.colors[t][0]*r)||v;var y=(this.colors[t][1]*r)||v;var q=(this.colors[t][2]*r)||v;z=Math.round(z*255);y=Math.round(y*255);q=Math.round(q*255);var w="rgb("+z+", "+y+", "+q+")";this.ctx.strokeStyle=w;this.ctx.fillStyle=w},renderGraph:function n(K){this.graphData.reverse();var D=0,E={},M=false,r={};for(var H in this.graphData){var A=this.graphData[H].entityNodeRef,z=this.graphData[H].entityFromBranch;var J=E[A];if(!J&&J!=0){if(z){for(var G in E){if(E[G]>E[z]){E[G]=E[G]+1}}E[this.graphData[H].entityNodeRef]=E[z]+1}else{E[this.graphData[H].entityNodeRef]=D}D++}}var N=this.dot_radius+2;var F=Math.min(18,Math.floor((K-N*2)/(D)));var C=K-N-10;var q={},s=15;D=0;var B=this.graphData.length-1;var w=g.getY(this.id+"-graphNodes")-s;for(var H in this.graphData){var L=g.getY("graph-version-row-"+(B-1))-w;var P=g.getY("graph-version-row-"+(B))-w;var A=this.graphData[H].entityNodeRef,z=this.graphData[H].entityFromBranch;var J=r[A];if(!J&&J!=0){r[A]=D++;M=true}for(var G in r){var t=E[G],y=(M&&G==A&&z!=null)?z:G,v=E[y];this.setColor(t,0,0.65);x=C-F*v;this.ctx.lineWidth=this.line_width;this.ctx.beginPath();if(v!=t){var u=g.getY("graph-version-row-"+(q[y]))-w-this.dot_radius;this.ctx.moveTo(x,u);var I=C-F*t;var O=(P+u)/2;this.ctx.bezierCurveTo(x,O,I,O,I,P);this.ctx.moveTo(I,P);this.ctx.lineTo(I,L,3)}else{this.ctx.moveTo(x,P);this.ctx.lineTo(x,L,3)}this.ctx.stroke()}M=false;radius=this.dot_radius;x=C-F*E[A];q[A]=B;this.ctx.beginPath();this.setColor(E[A],0.25,0.75);this.ctx.arc(x,P,radius,0,Math.PI*2,true);this.ctx.fill();B--}},_showPanel:function h(){this.widgets.escapeListener.enable();this.widgets.panel.show()}}})();beCPG.module.getVersionsGraphInstance=function(){var a="becpg-versionsGraph-instance";return Alfresco.util.ComponentManager.get(a)||new beCPG.module.VersionsGraph(a)};