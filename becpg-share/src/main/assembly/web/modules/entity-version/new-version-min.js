(function(){Alfresco.module.NewEntityVersion=function(j){this.name="Alfresco.module.NewEntityVersion";this.id=j;var i=Alfresco.util.ComponentManager.get(this.id);if(i!==null){throw new Error("An instance of Alfresco.module.NewEntityVersion already exists.")}Alfresco.util.ComponentManager.register(this);Alfresco.util.YUILoaderHelper.require(["button","container","datatable","datasource"],this.onComponentsLoaded,this);return this};Alfresco.module.NewEntityVersion.prototype={defaultShowConfig:{nodeRef:null,filename:null,version:null,merge:false,onNewEntityVersionComplete:null},showConfig:{},widgets:{},onComponentsLoaded:function f(){if(this.id===null){return}},show:function e(i){this.showConfig=YAHOO.lang.merge(this.defaultShowConfig,i);if(this.showConfig.nodeRef===undefined&&this.showConfig.filename===undefined&&this.showConfig.version===undefined){throw new Error("A nodeRef, filename and version must be provided")}Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"modules/entity-version/new-version?htmlid="+this.id+"&merge="+this.showConfig.merge,successCallback:{fn:this.onTemplateLoaded,scope:this},failureMessage:"Could not load html new version template",execScripts:true})},onTemplateLoaded:function b(i){var k=YAHOO.util.Dom;var m=document.createElement("div");m.innerHTML=i.serverResponse.responseText;var j=YAHOO.util.Dom.getFirstChild(m);this.widgets.panel=Alfresco.util.createYUIPanel(j);if(this.showConfig.merge){this.widgets.autocomplete=new beCPG.component.AutoCompletePicker(this.id+"-entities",this.id+"-entities-field",true).setOptions({mode:"edit",multipleSelectMode:false,isMandatory:true,dsStr:"becpg/autocomplete/branches?entityNodeRef="+this.showConfig.nodeRef})}this.widgets.headerText=k.get(this.id+"-header-span");this.widgets.nodeRef=k.get(this.id+"-nodeRef-hidden");this.widgets.version=k.get(this.id+"-version-hidden");this.widgets.description=YAHOO.util.Dom.get(this.id+"-description-textarea");this.widgets.minorVersion=YAHOO.util.Dom.get(this.id+"-minorVersion-radioButton");this.widgets.okButton=Alfresco.util.createYUIButton(this,"ok-button",null,{type:"submit"});this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onCancelButtonClick);var l=new Alfresco.forms.Form(this.id+"-NewEntityVersion-form");this.widgets.form=l;l.setSubmitElements(this.widgets.okButton);l.doBeforeFormSubmit={fn:function(){this.widgets.okButton.set("disabled",true);this.widgets.cancelButton.set("disabled",true);this.widgets.panel.hide();this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.creatingNewVersion",this.name,{"0":this.showConfig.filename}),spanClass:"wait",displayTime:0})},obj:null,scope:this};l.setAJAXSubmit(true,{successCallback:{fn:this.onNewVersionSuccess,scope:this},failureCallback:{fn:this.onNewVersionFailure,scope:this}});l.setSubmitAsJSON(true);l.applyTabFix();l.init();this._showPanel()},onNewVersionSuccess:function h(i){this.widgets.feedbackMessage.destroy();YAHOO.Bubbling.fire("newVersionCreated",{nodeRef:this.showConfig.nodeRef,filename:this.showConfig.filename,version:this.showConfig.version});var j={successful:[{nodeRef:i.json.results[0].nodeRef,version:this.showConfig.version}]};var k=this.showConfig.onNewEntityVersionComplete;if(k&&typeof k.fn=="function"){k.fn.call((typeof k.scope=="object"?k.scope:this),j,k.obj)}},onNewVersionFailure:function d(i){this.widgets.feedbackMessage.destroy();this.widgets.okButton.set("disabled",false);Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.failure",this.name,{"0":this.showConfig.filename})})},onCancelButtonClick:function a(){this.widgets.panel.hide();this.widgets.okButton.set("disabled",false)},_applyConfig:function c(){var k=YAHOO.util.Dom;if(!this.showConfig.merge){var m=Alfresco.util.message("header.new-version",this.name,{"0":this.showConfig.filename});this.widgets.headerText.innerHTML=m;var j=(this.showConfig.version||"1.0").split("."),i=parseInt(j[0],10),l=parseInt(j[1],10);k.get(this.id+"-minorVersion").innerHTML=Alfresco.util.message("label.minorVersion.more",this.name,{"0":i+"."+(1+l)});k.get(this.id+"-majorVersion").innerHTML=Alfresco.util.message("label.majorVersion.more",this.name,{"0":(1+i)+".0"})}else{var m=Alfresco.util.message("header.merge-branch",this.name,{"0":this.showConfig.filename});this.widgets.headerText.innerHTML=m}this.widgets.cancelButton.set("disabled",false);this.widgets.nodeRef.value=this.showConfig.nodeRef;this.widgets.version.value=this.showConfig.version},_showPanel:function g(){this.widgets.description.value="";this.widgets.minorVersion.checked=true;this._applyConfig();this.widgets.panel.show()}}})();Alfresco.module.getNewEntityVersionInstance=function(){var a="alfresco-NewEntityVersion-instance";return Alfresco.util.ComponentManager.get(a)||new Alfresco.module.NewEntityVersion(a)};