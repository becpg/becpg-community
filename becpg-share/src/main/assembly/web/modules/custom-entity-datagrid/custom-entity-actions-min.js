(function(){beCPG.module.CustomEntityDataGridActions={};beCPG.module.CustomEntityDataGridActions.prototype={onActionShowDetails:function g(t){var p=YAHOO.lang.isArray(t)?t:[t],u=[];for(var r=0,s=p.length;r<s;r++){u.push(p[r].nodeRef)}var q=Alfresco.constants.URL_SERVICECONTEXT+"modules/entity-charact-details/entity-charact-details?entityNodeRef="+this.options.entityNodeRef+"&itemType="+encodeURIComponent(this.options.itemType!=null?this.options.itemType:this.datalistMeta.itemType)+"&dataListName="+encodeURIComponent(this.datalistMeta.name)+"&dataListItems="+u.join(",");this._showPanel(q,this.id,null,"60em")},onActionSelectColor:function g(s){var p=YAHOO.lang.isArray(s)?s:[s],u=[];for(var q=0,r=p.length;q<r;q++){u.push(p[q].nodeRef)}var t=this.options.itemType!=null?this.options.itemType:this.datalistMeta.itemType;beCPG.module.getColorPickerInstance().show({nodeRefs:u,itemType:t})},onActionBulkEdit:function n(q){var p=YAHOO.lang.isArray(q)?q:[q],r=this;function s(y,w){var x=[];for(var u=0,v=p.length;u<v;u++){if(!w){x.push(p[u].nodeRef)}else{if(p[u].itemData[y].value){x.push(p[u].itemData[y].value)}else{for(var t in p[u].itemData[y]){x.push(p[u].itemData[y][t].value)}}}}if(!w){r._setupPropsPicker(x)}else{window.location=Alfresco.constants.URL_PAGECONTEXT+"bulk-edit?nodeRefs="+x.join()+"&a=true&r=true"}}this._showWusedPopup("bulk-edit",p,s)},_setupPropsPicker:function k(u){var r=Dom.get(this.id+"-wused-selected-picker").parentNode,p="";if(r!=null){var s=0;var q=0;var t=this.options.itemType!=null?this.options.itemType:this.datalistMeta.itemType;if(t!=null){Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.URL_SERVICECONTEXT+"module/entity-datagrid/config/columns?mode=bulk-edit&itemType="+encodeURIComponent(t)+"&formId=bulk-edit",successCallback:{fn:function(v){for(var w=0,A=v.json.columns.length;w<A;w++){var z=v.json.columns[w];var C=this._buildFormsName(z);var y=z.label;if(!z.protectedField&&!z.disabled&&y!="hidden"&&!z.readOnly){var x="";if(q<Math.floor(s/5)){x="reset "}q=Math.floor(s/5);x+="column-"+q;p+='<li class="'+x+'"><input id="propSelected-'+w+'" type="checkbox" name="propChecked" value="'+C+'" /><label for="propSelected-'+w+'" >'+y+"</label></li>";s++}}p="<span>"+this.msg("label.select-prop.title")+'</span><br/><br/><ul style="width:'+((q+1)*20)+'em;">'+p+"</ul>";r.innerHTML=p;var B=Dom.get(this.id+"-bulk-edit-ft");B.innerHTML='<input id="'+this.id+'-bulk-edit-ok" type="button" value="'+this.msg("button.ok")+'" />';this.widgets.okBkButton=Alfresco.util.createYUIButton(this,"bulk-edit-ok",function(){this.widgets.wUsedPanel.hide();this._onEditSelected(u,r)})},scope:this}})}}},_buildFormsName:function c(q){var p="";if(q.type=="association"){p="assoc_"}else{p="prop_"}p+=q.name.replace(/:/g,"_");return p},_onEditSelected:function m(s,w){var z=this;var r=Selector.query('input[type="checkbox"]',w);var B=function q(C,D){Alfresco.util.populateHTML([D.id+"-dialogTitle",this.msg("label.edit-selected.title")],[D.id+"-dialogHeader",this.msg("label.edit-selected.header")]);if(Dom.get(D.id+"-form-bulkAction")){Dom.setStyle(D.id+"-form-bulkAction","display","none");Dom.setStyle(D.id+"-form-bulkAction-msg","display","none")}};var y=[];for(var t in r){if(r[t].checked){y.push(r[t].value)}}if(y.length<1){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit-selected.nofields")});return false}var x=this.options.itemType!=null?this.options.itemType:this.datalistMeta.itemType;var p=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?formId={formId}&bulkEdit=true&entityNodeRef={entityNodeRef}&fields={fields}&submissionUrl={submissionUrl}&itemKind={itemKind}&itemId={itemId}&mode={mode}&submitType={submitType}&showCancelButton=true",{itemKind:"type",formId:"create",itemId:x,mode:"create",entityNodeRef:z.options.entityNodeRef,submitType:"json",submissionUrl:encodeURIComponent("/becpg/bulkedit/type/"+x.replace(":","_")+"/bulksave?nodeRefs="+s.join()+"&allPages="+z.allPages+"&queryExecutionId="+z.queryExecutionId),fields:encodeURIComponent(y)});var v=new Alfresco.module.SimpleDialog(this.id+"-bulkEditRow");v.setOptions({width:"36em",templateUrl:p,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:B,scope:this},onSuccess:{fn:function u(C){if(s.length>10){z._updateDataGrid.call(z,{page:z.currentPage})}else{for(var D=0,E=s.length;D<E;D++){YAHOO.Bubbling.fire(z.scopeId+"dataItemUpdated",{nodeRef:s[D]})}}Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit-selected.success")})},scope:this},onFailure:{fn:function A(C){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit-selected.failure")})},scope:this}}).show()},_showWusedPopup:function l(p,v,r){var z=false,x=0,w=null,u=(this.entity!=null&&this.entity.type!=null&&this.entity.type=="bcpg:systemEntity");var s='<div class="hd">'+this.msg("header."+p+".picker")+"</div>";s+='<div class="bd">';s+='<form  class="form-container">';s+='<div class="form-fields '+p+'">';s+='   <div class="set">';s+='        <div class="form-field">';s+='            <select  id="'+this.id+'-wused-selected-picker">';s+='                  <option value="">'+this.msg(p+".picker.choose")+"</option>";if(p=="bulk-edit"){s+='                  <option value="selectlines">'+this.msg(p+".picker.selectedlines")+"</option>"}for(var A in v[0].itemData){if(A.indexOf("assoc_")>-1&&this.datalistColumns[A]&&this.datalistColumns[A].label!="hidden"){if(p!="bulk-edit"||A=="assoc_bcpg_compoListProduct"||A=="assoc_bcpg_packagingListProduct"||A=="assoc_mpm_plResource"){z=true;s+="<option value='"+A+"'>"+this.datalistColumns[A].label+"</option>";x++;w=A}}else{if(A=="prop_bcpg_charactName"){u=true}}}s+="            </select>";s+="          </div>";s+="       </div>";s+="    </div>";s+='<div id="'+this.id+"-"+p+'-ft" class="bdft">';s+="</div>";s+="</form></div>";if(p=="bulk-edit"||(z&&!u&&this.datalistMeta.name.indexOf("WUsed")!=0)){if(p=="wused"&&x==1){r.call(this,w,w);return}var y=document.createElement("div");y.innerHTML=s;this.widgets.wUsedPanel=Alfresco.util.createYUIPanel(y,{draggable:true,width:"33em"});this.widgets.wUsedPanel.show();if(z){YAHOO.util.Event.on(YAHOO.util.Dom.get(this.id+"-wused-selected-picker"),"change",function(B){var C=this.value=="selectlines"?null:this.value;r.call(this,C,C)})}else{r.call(this)}}else{if(this.datalistMeta.name.indexOf("WUsed")==0){var q=null,t="assoc_bcpg_compoListProduct";if(this.datalistMeta.name.indexOf("|")>0){q="assoc_"+this.datalistMeta.name.split("|")[1].replace(":","_")}else{if(this.datalistMeta.itemType==="bcpg:packagingList"){q="assoc_bcpg_packagingListProduct";t=q}else{if(this.datalistMeta.itemType==="mpm:processList"){q="assoc_mpm_plResource";t=q}else{q="assoc_bcpg_compoListProduct"}}}r.call(this,q,t)}else{r.call(this)}}},onActionShowWorkflows:function f(p){Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.GET,url:Alfresco.constants.URL_SERVICECONTEXT+"modules/entity-process/entity-process?nodeRef="+p.nodeRef+"&htmlid="+this.id,successCallback:{fn:function(r){var s=document.createElement("div");s.innerHTML=r.serverResponse.responseText;var q=Dom.getFirstChild(s);this.widgets.projects=Alfresco.util.createYUIPanel(q,{draggable:true,width:"40em"});this.widgets.projects.show()},scope:this},execScripts:true})},onActionShowComments:function h(q){var p=Alfresco.constants.URL_SERVICECONTEXT+"modules/comments/list?nodeRef="+q.nodeRef+"&activityType=datalist"+(q.siteId?"&site="+q.siteId:"")+(this.options.entityNodeRef?"&entityNodeRef="+this.options.entityNodeRef:"");this._showPanel(p,this.id+"_comments",q.nodeRef,"50em")},onActionShowWused:function e(q){var p=YAHOO.lang.isArray(q)?q:[q];function r(x,v){var w=[];for(var t=0,u=p.length;t<u;t++){if(!v){w.push(p[t].nodeRef)}else{if(p[t].itemData[x].value){w.push(p[t].itemData[x].value)}else{for(var s in p[t].itemData[x]){w.push(p[t].itemData[x][s].value)}}}}if(!v){window.location=Alfresco.constants.URL_PAGECONTEXT+"wused?type="+p[0].itemType+"&nodeRefs="+w.join()}else{window.location=Alfresco.constants.URL_PAGECONTEXT+"wused?assocName="+v+"&nodeRefs="+w.join()}}this._showWusedPopup("wused",p,r)},onAddLabelingAspect:function d(s){var p=YAHOO.lang.isArray(s)?s:[s];for(var q=0,r=p.length;q<r;q++){this._manageAspect(p[q].nodeRef,"pack:labelingAspect")}},onActionShowLabelingDetails:function b(r){var q=YAHOO.lang.isArray(r)?r:[r];var p=function s(u){var w="<ul><li >";if(u.name&&u.name!="root"){if(u.nodeRef){w+='<span class="'+u.cssClass+'">';if(u.cssClass=="ingType"){w+=u.legal+":"}else{if(!u.decl){w+=this.msg("label.labeling-details.tree.item.nodec",u.legal,beCPG.util.sigFigs(u.qte,4),beCPG.util.sigFigs(u.vol,4))}else{w+="<a href="+beCPG.util.entityURL(u.siteId,u.nodeRef)+">"+this.msg("label.labeling-details.tree.item",u.legal,beCPG.util.sigFigs(u.qte,4),beCPG.util.sigFigs(u.vol,4),u.decl)+"</a>"}}w+="</span>";if(u.cssClass!="ingType"&&(u.legal!=null&&u.legal.toLowerCase()!=u.name.toLowerCase())){w+="<p>&nbsp;&nbsp;<i>("+u.name+")</i></p>"}if(u.allergens){for(var v=0;v<u.allergens.length;v++){w+='&nbsp;<span class="allergen">';w+=u.allergens[v];w+="</span>"}}if(u.geoOrigins){for(var v=0;v<u.geoOrigins.length;v++){w+='&nbsp;<span class="geoOrigin">';w+=u.geoOrigins[v];w+="</span>"}}}else{w+='<span class="aggregation">';w+=this.msg("label.labeling-details.tree.item",u.legal,beCPG.util.sigFigs(u.qte,4),beCPG.util.sigFigs(u.vol,4),u.decl);w+="</span>"}}if(u.children){w+="<ul>";for(var v=0;v<u.children.length;v++){w+="<li>";w+=s.call(this,u.children[v]);w+="</li>"}w+="</ul>"}w+="</li></ul>";return w.replace(/\{(1|2)\}\%/g,this.msg("label.labeling-details.none"))};if(q.length>0){var t=q[0].nodeRef;Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.GET,url:Alfresco.constants.PROXY_URI+"becpg/labeling/showLabelingDetails?nodeRef="+t,requestContentType:Alfresco.util.Ajax.JSON,requestHeaders:{Accept:"application/json"},successCallback:{fn:function(v){var x=v.json;if(x){var u='<div class="hd">'+this.msg("label.labeling-details.title")+"</div>";u+='<div class="bd labeling-details">';u+=p.call(this,x);u+="</div>";var w=document.createElement("div");w.className="detailsDialog";w.innerHTML=u;this.widgets.labelingDetailsPanel=Alfresco.util.createYUIPanel(w,{draggable:true,width:"45em"});this.widgets.labelingDetailsPanel.show()}},scope:this}})}},onActionSimulate:function j(s){var p=YAHOO.lang.isArray(s)?s:[s],t=this,v="";for(var q=0,r=p.length;q<r;q++){if(v.length>0){v+=","}v+=p[q].nodeRef}Alfresco.util.PopupManager.displayMessage({text:this.msg("message.simulate-entity.inprogress"),displayTime:5});Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.POST,responseContentType:Alfresco.util.Ajax.JSON,url:Alfresco.constants.PROXY_URI+"becpg/entity/simulation/create?dataListItems="+v+(this.options.entityNodeRef?"&entityNodeRef="+this.options.entityNodeRef:""),successCallback:{fn:function(y){if(y.json){for(var w=0,x=p.length;w<x;w++){YAHOO.Bubbling.fire(t.scopeId+"dataItemUpdated",{nodeRef:p[w].nodeRef})}Alfresco.util.PopupManager.displayMessage({text:this.msg("message.simulate-entity.success")})}},scope:this},failureCallback:{fn:function u(w){if(w.json&&w.json.message){Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.branch-entity.failure"),text:w.json.message})}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.branch-entity.failure")})}},scope:this}})},onActionUploadContent:function a(q){var p=Alfresco.getFileUploadInstance();p.show({updateNodeRef:q.nodeRef,mode:p.MODE_SINGLE_UPLOAD,suppressRefreshEvent:true,onFileUploadComplete:{fn:function r(s){setTimeout(function(){YAHOO.Bubbling.fire("scopedActiveDataListChanged",{clearCache:true})},1000)},scope:this}})},_manageAspect:function i(r,p){var s=r.replace(":/",""),q=this;Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"/slingshot/doclib/aspects/node/"+s,method:Alfresco.util.Ajax.GET,successCallback:{fn:function(v){if(v.json){var u=null;var x="delete-aspect";if(beCPG.util.contains(v.json.current,"pack:labelingAspect")){u={added:[],removed:[p]}}else{x="add-aspect";u={added:[p],removed:[]}}Alfresco.util.PopupManager.displayPrompt({title:q.msg("message.confirm."+x+".title",q.msg("aspect."+p.replace(":","_"))),text:q.msg("message.confirm."+x+".description",q.msg("aspect."+p.replace(":","_"))),buttons:[{text:q.msg("button."+x),handler:function t(){this.destroy();Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"slingshot/doclib/action/aspects/node/"+s,method:Alfresco.util.Ajax.POST,requestContentType:Alfresco.util.Ajax.JSON,dataObj:u,successCallback:{fn:function(){YAHOO.Bubbling.fire(q.scopeId+"dataItemUpdated",{nodeRef:r})},scope:this},successMessage:q.msg("message.success."+x,q.msg("aspect."+p.replace(":","_")))})}},{text:this.msg("button.cancel"),handler:function w(){this.destroy()},isDefault:true}]})}},scope:this}})},_showPanel:function o(p,t,s,q){var r=this;Alfresco.util.Ajax.request({url:p,dataObj:{htmlid:t},successCallback:{fn:function(u){var w=document.createElement("div");w.innerHTML=u.serverResponse.responseText;var v=Dom.getFirstChild(w);this.widgets.panel=Alfresco.util.createYUIPanel(v,{draggable:true,width:q});if(s!=null){this.widgets.panel.subscribe("hide",function(){YAHOO.Bubbling.fire(r.scopeId+"dataItemUpdated",{nodeRef:s})})}this.widgets.panel.show()},scope:this},failureMessage:"Could not load dialog template from '"+p+"'.",scope:this,execScripts:true})}};YAHOO.lang.augmentProto(beCPG.module.EntityDataGridActions,beCPG.module.CustomEntityDataGridActions)})();