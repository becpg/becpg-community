(function(){var h="beCPG.module.EntityCharactDetails",p="chartType";var e=Alfresco.util.generateDomId(null,"barItem");beCPG.module.EntityCharactDetails=function(q){this.id=q;beCPG.module.EntityCharactDetails.superclass.constructor.call(this,"beCPG.module.EntityCharactDetails",q,["button","container","menu","datasource"]);this.preferencesService=new Alfresco.service.Preferences()};YAHOO.extend(beCPG.module.EntityCharactDetails,Alfresco.component.Base,{dataSource:null,cDataSource:null,options:{entityNodeRef:null,backEntityNodeRef:[],navigationPath:[],itemType:null,dataListItems:null,dataListName:null},onChartTypeSelected:function d(r){var q=this;if(r){if(r.value!="chartData"){q.options.level="1";q.widgets.levelMenu.set("label",q.msg("button.level"));q.widgets.levelMenu.set("disabled",true)}q.widgets.chartTypePicker.value=r.value;q.preferencesService.set(q.getPreference(p),q.widgets.chartTypePicker.value,{successCallback:{fn:q.loadChartData(),scope:this}})}},getPreference:function k(q){return h+(this.options.itemType?"."+this.options.itemType.replace(":","_"):"")+(q?"."+q:"")},onChartTypeClicked:function c(q){this.loadChartData()},onReady:function i(){var r=this;this.widgets.chartTypePicker=new YAHOO.widget.Button(r.id+"-chartTypePicker-button",{type:"split",menu:r.id+"-chartTypePicker-select",lazyloadmenu:false});this.widgets.chartTypePicker.on("click",r.onChartTypeClicked,r,true);this.widgets.chartTypePicker.getMenu().subscribe("click",function(t,s){var u=s[1];if(u){r.widgets.chartTypePicker.set("label",u.cfg.getProperty("text"));r.onChartTypeSelected.call(r,u)}});this.widgets.exportCSVButton=Alfresco.util.createYUIButton(this,"export-csv",this.onExportCSV,{disabled:false,value:"export"});this.widgets.backButton=Alfresco.util.createYUIButton(this,"back",this.onBack,{disabled:true,value:"back"});this.widgets.levelMenu=new YAHOO.widget.Button(r.id+"-level-button",{type:"split",menu:r.id+"-levelbuttonselect",lazyloadmenu:false,disabled:true});this.widgets.levelMenu.getMenu().subscribe("click",function(t,s){var u=s[1];if(u){r.widgets.levelMenu.set("label",u.cfg.getProperty("text"));r.options.level=u.value;r.loadChartData()}});this.selectMenuValue(this.widgets.chartTypePicker,"chartData");this.preferencesService.request(r.getPreference(),{successCallback:{fn:function(t){var s=Alfresco.util.findValueByDotNotation(t.json,r.getPreference(p),null);if(s!==null){r.selectMenuValue(r.widgets.chartTypePicker,s)}},scope:this}});r.loadChartData();var q=function q(v,u){var s=YAHOO.Bubbling.getOwnerByTagName(u[1].anchor,"span");if(s!==null){var x=s.className.split(" ");var w=x[0];r.options.entityNodeRef=w.replace("bar-","");for(var t=0;t<r.options.navigationPath.length;t++){if(r.options.navigationPath[t].nodeRef==r.options.entityNodeRef){r.options.navigationPath=r.options.navigationPath.slice(0,t+1);break}}r.loadChartData();return false}return true};YAHOO.Bubbling.addDefaultAction(e,q)},onExportCSV:function m(){if(this.options.entityNodeRef!=null&&this.options.entityNodeRef.length>0){window.location=this._buildDetailsUrl("csv")}},onBack:function o(){if(this.options.backEntityNodeRef!=null&&this.options.backEntityNodeRef.length>0){this.options.entityNodeRef=this.options.backEntityNodeRef.pop();this.options.navigationPath.pop();this.loadChartData()}if(this.options.backEntityNodeRef==null||this.options.backEntityNodeRef.length<1){this.widgets.backButton.set("disabled",true)}},selectMenuValue:function b(q,s){q.value=s;var r=q.getMenu().getItems();for(index in r){if(r.hasOwnProperty(index)){if(r[index].value===s){q.set("label",r[index].cfg.getProperty("text"));break}}}},loadChartData:function a(){if(this.options.entityNodeRef!=null&&this.options.entityNodeRef.length>0){Alfresco.util.Ajax.request({url:this._buildDetailsUrl("json"),successCallback:{fn:this.processData,scope:this},failureCallback:{fn:function(){},scope:this}})}},_buildDetailsUrl:function j(q){return Alfresco.constants.PROXY_URI+"becpg/charact/formulate"+(q!=null&&q.length>0?"."+q:"")+"?entityNodeRef="+this.options.entityNodeRef+"&itemType="+this.options.itemType+"&dataListName="+this.options.dataListName+"&dataListItems="+this.options.dataListItems+"&level="+(this.options.level!=null?this.options.level:"1")},processData:function n(r){var v=r.json;var u=[];this.columnDefs=[];this.seriesDef=[];this.barChartSeriesDef=[];var s=0;for(s=0;s<v.metadatas.length;s++){var t=v.metadatas[s].colName+(v.metadatas[s].colUnit!=null?" ("+v.metadatas[s].colUnit+")":"");u.push({key:"col"+s,parser:function(x){if(!YAHOO.lang.isValue(x)||(x==="")){return null}var w=x*1;if(YAHOO.lang.isNumber(w)){return w.toFixed(4)}return x}});var q={key:"col"+s,label:t};if(s==0){q.formatter=function(x,w,z,A){if(w.getData("cssClass")){var y=w.getData("level")*25;x.innerHTML='<span class="'+w.getData("cssClass")+'" style="margin-left:'+y+'px;">'+A+"</span>"}else{x.innerHTML="<b>"+A+"</b>"}}}else{q.formatter=function(x,w,y,z){Dom.setStyle(x,"text-align","right");if(w.getData("cssClass")){if(YAHOO.lang.isNumber(z)){x.innerHTML=(new Intl.NumberFormat(Alfresco.constants.JS_LOCALE.replace("_","-"),{minimumFractionDigits:4,maximumFractionDigits:4})).format(z)}else{x.innerHTML=z}}else{x.innerHTML="<b>"+z+"</b>"}}}this.columnDefs.push(q);if(s>0){this.seriesDef.push({displayName:t,yField:"col"+s});this.barChartSeriesDef.push({displayName:t,xField:"col"+s})}}u.push({key:"nodeRef"});u.push({key:"type"});u.push({key:"cssClass"});u.push({key:"level"});if(this.widgets.chartTypePicker.value!="chartData"){v.resultsets.pop()}this.cDataSource={};this.cDataSource.metadata=v.metadatas;this.cDataSource.resultset=v.resultsets;this.dataSource=new YAHOO.util.DataSource(v.resultsets);this.dataSource.responseType=YAHOO.util.DataSource.TYPE_JSARRAY;this.dataSource.responseSchema={fields:u};this.render()},onClickChart:function f(t,r){var q=r.cDataSource.resultset.filter(function(u){return u[0]===t.firstAtoms.category.value});if(q[0][r.cDataSource.metadata.length+1].indexOf("Material")<0){var s=q[0][r.cDataSource.metadata.length];r.options.backEntityNodeRef.push(r.options.entityNodeRef);r.options.navigationPath.push({name:t.firstAtoms.category.value,nodeRef:s,cssClass:q[0][r.cDataSource.metadata.length+2]});r.options.entityNodeRef=s;r.widgets.backButton.set("disabled",false);r.loadChartData()}},showTooltipMessage:function l(q){return q.vars.series.label+"<br /> "+q.vars.category.label+"<br /> "+q.vars.value.value},render:function g(){var q=this;require(dojoConfig,["bccc"],function(v){if(q.dataSource!=null){var u=document.getElementById(q.id+"-chartContainer").offsetWidth-10;var t=document.getElementById(q.id+"-chartContainer").offsetHeight;if(q.widgets.chartTypePicker.value=="lineChart"){new v.LineChart({canvas:q.id+"-chart",width:u,height:t,dotsVisible:true,baseAxisSize:40,baseAxisDomainRoundMode:"nice",legend:true,legendPosition:"bottom",legendAlign:"center",legendDot_shape:"circle",animate:true,selectable:true,hoverable:true,clickable:true,clickAction:function(w){q.onClickChart(w,q)},tooltipFormat:function(w){return q.showTooltipMessage(w)}}).setData(q.cDataSource,{crosstabMode:true}).render()}else{if(q.widgets.chartTypePicker.value=="barChart"){new v.BarChart({canvas:q.id+"-chart",width:u,height:t,orientation:"horizontal",axisGrid:true,axisGrid_strokeStyle:"#F7F8F9",axisLabel_font:'normal 10px "Open Sans"',legend:true,legendPosition:"bottom",legendAlign:"center",panelSizeRatio:0.3,animate:true,selectable:true,hoverable:true,clickable:true,clickAction:function(w){q.onClickChart(w,q)},tooltipFormat:function(w){return q.showTooltipMessage(w)}}).setData(q.cDataSource,{crosstabMode:true}).render()}else{if(q.widgets.chartTypePicker.value=="columnChart"){new v.BarChart({canvas:q.id+"-chart",width:u,height:t,legend:true,legendPosition:"bottom",legendAlign:"center",panelSizeRatio:0.3,animate:true,baseAxisGrid:true,selectable:true,clickable:true,clickAction:function(w){q.onClickChart(w,q)},tooltipFormat:function(w){return q.showTooltipMessage(w)}}).setData(q.cDataSource,{crosstabMode:true}).render()}else{if(q.widgets.chartTypePicker.value=="pieChart"){new v.PieChart({canvas:q.id+"-chart",width:u,height:t,valuesVisible:true,valuesFont:'lighter 11px "Open Sans"',explodedSliceRadius:"10%",slice_offsetRadius:function(w){return w.isSelected()?"10%":0},legend:true,legendPosition:"right",legendAlign:"center",legendDot_shape:"circle",legendLabel_textStyle:function(x){var w=q.panel.axes.color.scale;return w(q.getValue())},selectable:true,hoverable:true,clickable:true,clickAction:function(w){q.onClickChart(w,q)},tooltipFormat:function(w){return q.showTooltipMessage(w)}}).setData(q.cDataSource,{crosstabMode:true}).render()}else{if(q.widgets.chartTypePicker.value=="chartData"){q.widgets.levelMenu.set("disabled",false);q.widgets.chart=null;q.widgets.dataTable=new YAHOO.widget.DataTable(q.id+"-chart",q.columnDefs,q.dataSource)}}}}}Dom.setStyle(q.id+"-chart","display","flex");if(q.widgets.chart!=null){q.widgets.chart.subscribe("itemClickEvent",function(w){if(w.item.type.indexOf("Material")<0){q.options.backEntityNodeRef.push(q.options.entityNodeRef);q.options.navigationPath.push({name:w.item.col0,nodeRef:w.item.nodeRef,cssClass:w.item.cssClass});q.options.entityNodeRef=w.item.nodeRef;q.widgets.backButton.set("disabled",false);q.loadChartData()}})}if(q.widgets.dataTable!=null){q.widgets.dataTable.subscribe("cellClickEvent",function(x){var A=x.target;var z=this.getRecordIndex(A);var y=this.getRecordSet(),w;w=y.getRecord(z);if((w.getData("type")).indexOf("Material")<0){q.options.backEntityNodeRef.push(q.options.entityNodeRef);q.options.navigationPath.push({name:w.getData("col0"),nodeRef:w.getData("nodeRef"),cssClass:w.getData("cssClass")});q.options.entityNodeRef=w.getData("nodeRef");q.widgets.backButton.set("disabled",false);q.loadChartData()}})}if(q.options.navigationPath!=null&&q.options.navigationPath.length>0){var s="";for(var r=0;r<q.options.navigationPath.length;r++){s+='<span class="separator"> > </span><span class="bar-'+q.options.navigationPath[r].nodeRef+" "+q.options.navigationPath[r].cssClass+'"><a href="#" class="'+e+'" >'+q.options.navigationPath[r].name+"</a></span>"}Dom.get(q.id+"-chartPath").innerHTML=s;Dom.setStyle(q.id+"-chartPath","visibility","inherit")}else{Dom.setStyle(q.id+"-chartPath","visibility","hidden")}Dom.setStyle(q.id+"-chart","visibility","inherit")}})}})})();