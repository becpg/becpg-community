(function(){var e=YAHOO.util.Dom,b=YAHOO.Bubbling;beCPG.module.EntityDataGridActions={};beCPG.module.EntityDataGridActions.prototype={onActionCreate:function g(o,r){var q=this.datalistMeta.nodeRef!=null?this.datalistMeta.nodeRef:this.options.parentNodeRef,n=this.options.itemType!=null?this.options.itemType:this.datalistMeta.itemType,p=this;var s=function u(v,w){Alfresco.util.populateHTML([w.id+"-dialogTitle",this.msg("label.new-row.title")],[w.id+"-dialogHeader",this.msg("label.new-row.header")]);if(e.get(w.id+"-form-bulkAction")){e.get(w.id+"-form-bulkAction").checked=this.onActionCreateBulkEdit;e.get(w.id+"-form-bulkAction-msg").innerHTML=this.msg("button.bulk-action-create")}if(this.options.formWidth!="34em"){e.addClass(w.id+"-dialog","large-dialog")}if(this.parentInputNodeRef!=null){e.get(w.id+"_prop_bcpg_parentLevel-added").value=this.parentInputNodeRef;b.fire(w.id+"_prop_bcpg_parentLevelrefreshContent",this.parentInputNodeRef,this)}};var k=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?bulkEdit=true&entityNodeRef={entityNodeRef}&itemKind={itemKind}&itemId={itemId}&destination={destination}&mode={mode}&submitType={submitType}&showCancelButton=true&dataListsName={dataListsName}&siteId={siteId}",{itemKind:"type",itemId:n,destination:q,mode:"create",submitType:"json",entityNodeRef:this.options.entityNodeRef,dataListsName:encodeURIComponent(this.datalistMeta.name!=null?this.datalistMeta.name:this.options.list),siteId:this.options.siteId});var m=new Alfresco.module.SimpleDialog(this.id+"-createRow");m.bulkEdit=false;m.setOptions({width:this.options.formWidth,templateUrl:k,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:s,scope:this},doBeforeFormSubmit:{fn:function(){var v=e.get(this.id+"-createRow-form-bulkAction");var w=e.get(this.id+"-createRow_prop_bcpg_parentLevel-added");if(w!=null&&w.value!=null&&w.value.length>0){p.parentInputNodeRef=w.value}else{p.parentInputNodeRef=null}if(v&&v.checked){p.onActionCreateBulkEdit=true}else{p.onActionCreateBulkEdit=false}},scope:this},onSuccess:{fn:function t(v){if(p.parentInputNodeRef!=null){url=Alfresco.constants.PROXY_URI+"becpg/entity/datalists/openclose?nodeRef="+p.parentInputNodeRef+"&expand=true&entityNodeRef="+p.options.entityNodeRef+"&listType="+n;Alfresco.util.Ajax.jsonPost({url:url,successCallback:{fn:function w(x){p.queryExecutionId=null;p._updateDataGrid.call(p,{page:p.currentPage});YAHOO.Bubbling.fire("dirtyDataTable");Alfresco.util.PopupManager.displayMessage({text:p.msg("message.new-row.success")});if(p.onActionCreateBulkEdit){p.onActionCreate()}},scope:this}})}else{YAHOO.Bubbling.fire(p.scopeId+"dataItemCreated",{nodeRef:v.json.persistedObject,callback:function(x){YAHOO.Bubbling.fire("refreshFloatingHeader");Alfresco.util.PopupManager.displayMessage({text:p.msg("message.new-row.success")});if(p.onActionCreateBulkEdit){p.onActionCreate()}}})}},scope:this},onFailure:{fn:function l(v){Alfresco.util.PopupManager.displayMessage({text:p.msg("message.new-row.failure")})},scope:this}}).show()},onActionEdit:function h(o){var n=this;var l=function m(s,t){Alfresco.util.populateHTML([t.id+"-dialogTitle",this.msg("label.edit-row.title")]);if(e.get(t.id+"-form-bulkAction")){e.get(t.id+"-form-bulkAction").checked=this.onActionEditBulkEdit;e.get(t.id+"-form-bulkAction-msg").innerHTML=this.msg("button.bulk-action-edit")}if(this.options.formWidth!="34em"){e.addClass(t.id+"-dialog","large-dialog")}};var q=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?bulkEdit=true&entityNodeRef={entityNodeRef}&itemKind={itemKind}&itemId={itemId}&mode={mode}&submitType={submitType}&showCancelButton=true&dataListsName={dataListsName}&siteId={siteId}",{itemKind:"node",itemId:o.nodeRef,mode:"edit",submitType:"json",entityNodeRef:this.options.entityNodeRef,dataListsName:encodeURIComponent(this.datalistMeta.name!=null?this.datalistMeta.name:this.options.list),siteId:this.options.siteId});var p=new Alfresco.module.SimpleDialog(this.id+"-editDetails");p.bulkEdit=false;p.setOptions({width:this.options.formWidth,templateUrl:q,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:l,scope:this},doBeforeFormSubmit:{fn:function(){var s=e.get(n.id+"-editDetails-form-bulkAction");if(s&&s.checked){n.onActionEditBulkEdit=true}else{n.onActionEditBulkEdit=false}},scope:this},onSuccess:{fn:function r(s){b.fire(n.scopeId+"dataItemUpdated",{nodeRef:s.json.persistedObject,callback:function(u){Alfresco.util.PopupManager.displayMessage({text:n.msg("message.details.success")});if(n.onActionEditBulkEdit){var t=n._findNextItemByParameter(s.json.persistedObject,"nodeRef");if(t!=null){n.onActionEdit(t)}}}})},scope:this},onFailure:{fn:function k(s){Alfresco.util.PopupManager.displayMessage({text:n.msg("message.details.failure")})},scope:this}}).show()},onActionUp:function f(l){var n=this;if(n.options.sortable){var k=YAHOO.lang.isArray(l)?l:[l];if(k.length>0){var m=n._findPrevItemByParameter(k[0].nodeRef,"nodeRef");if(m==null){m=k[0]}n._sort(k,m,"up")}}},onActionDown:function i(l){var n=this;if(n.options.sortable){var k=YAHOO.lang.isArray(l)?l:[l];if(k.length>0){var m=n._findNextItemByParameter(k[k.length-1].nodeRef,"nodeRef");if(m==null){m=k[k.length-1]}n._sort(k,m,"down")}}},_sort:function j(r,m,n){var s=this,o=[];if(s.options.sortable){for(var p=0,t=r.length;p<t;p++){o.push(r[p].nodeRef)}var k=s.options.sortUrl+"/"+m.nodeRef.replace(":/","")+"?selectedNodeRefs="+o.join(",")+"&dir="+n;Alfresco.util.Ajax.jsonPost({url:k,successCallback:{fn:function l(u){s.queryExecutionId=null;s._updateDataGrid.call(s,{page:s.currentPage})},scope:this},failureCallback:{fn:function q(u){Alfresco.util.PopupManager.displayMessage({text:s.msg("message.details.failure")})},scope:this}})}},_addSortDnD:function(){var n=this;var k="group-"+n.id;if(n.options.sortable){YAHOO.util.DragDropMgr.refreshCache();var l,o,m=n.widgets.dataTable.getTbodyEl().rows;for(l=0;l<m.length;l++){o=m[l].id;if(n.widgets.dataTable.dtdTargets[o]){n.widgets.dataTable.dtdTargets[o].unreg();delete n.widgets.dataTable.dtdTargets[o]}n.widgets.dataTable.dtdTargets[o]=new YAHOO.util.DDTarget(o,k)}}},onActionDelete:function a(n){var o=this,l=YAHOO.lang.isArray(n)?n:[n];var m=function p(r){var u=[];for(var s=0,t=r.length;s<t;s++){u.push(r[s].nodeRef)}this.modules.actions.genericAction({success:{event:{name:this.scopeId+"dataItemsDeleted",obj:{items:r}},message:this.msg("message.delete.success",r.length)},failure:{callback:{fn:function(v,w){if(v.json&&v.json.message){Alfresco.util.PopupManager.displayPrompt({title:o.msg("message.delete.failure"),text:v.json.message})}else{Alfresco.util.PopupManager.displayMessage({text:o.msg("message.delete.failure")})}}}},webscript:{method:Alfresco.util.Ajax.DELETE,name:"items"},config:{requestContentType:Alfresco.util.Ajax.JSON,dataObj:{nodeRefs:u}}})};Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.confirm.delete.title",l.length),text:this.msg("message.confirm.delete.description",l.length),buttons:[{text:this.msg("button.delete"),handler:function k(){this.destroy();m.call(o,l)}},{text:this.msg("button.cancel"),handler:function q(){this.destroy()},isDefault:true}]})},onActionDuplicate:function d(o){var s=this,q=YAHOO.lang.isArray(o)?o:[o],m=this.modules.dataGrid.datalistMeta.nodeRef!=null?new Alfresco.util.NodeRef(this.modules.dataGrid.datalistMeta.nodeRef):new Alfresco.util.NodeRef(this.modules.dataGrid.options.parentNodeRef),n=[];var k=function l(t){for(var u=0,v=t.length;u<v;u++){n.push(t[u].nodeRef)}this.modules.actions.genericAction({success:{event:{name:this.scopeId+"dataItemsDuplicated",obj:{items:t}},message:this.msg("message.duplicate.success",t.length)},failure:{message:this.msg("message.duplicate.failure")},webscript:{method:Alfresco.util.Ajax.POST,name:"duplicate/node/"+m.uri},config:{requestContentType:Alfresco.util.Ajax.JSON,dataObj:{nodeRefs:n}}})};Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.confirm.duplicate.title",q.length),text:this.msg("message.confirm.duplicate.description",q.length),buttons:[{text:this.msg("button.duplicate"),handler:function r(){this.destroy();k.call(s,q)}},{text:this.msg("button.cancel"),handler:function p(){this.destroy()},isDefault:true}]})},onActionColumnConf:function c(){if(!this.services.preferences){this.services.preferences=new Alfresco.service.Preferences()}var q=this;var k="columns-conf";var n='<div class="hd">'+this.msg("header."+k+".picker")+"</div>";n+='<div class="bd">';n+='<form  class="form-container">';n+='<div class="form-fields bulk-edit">';n+='   <div class="set">';n+='        <div class="form-field">';n+='			<div  id="'+this.id+'-columns-list" />';n+="          </div>";n+="       </div>";n+="    </div>";n+='<div id="'+this.id+"-"+k+'-ft" class="bdft">';n+="</div>";n+="</form></div>";var r=document.createElement("div");r.innerHTML=n;this.widgets.columnsListPanel=Alfresco.util.createYUIPanel(r,{draggable:true,width:"33em"});var m=["bcpg_startEffectivity","bcpg_endEffectivity","bcpg_depthLevel"];var p=this.options.itemType!=null?this.options.itemType:this.datalistMeta.itemType;var o=e.get(this.id+"-columns-list").parentNode,n="";var s=0;var l=this.options.siteId;Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.URL_SERVICECONTEXT+"module/entity-datagrid/config/columns?mode=datagrid-prefs&itemType="+encodeURIComponent(p)+"&clearCache=true"+(this.options.siteId?"&siteId="+this.options.siteId:""),successCallback:{fn:function(t){var u="fr.becpg.formulation.dashlet.custom.datagrid-prefs."+p.replace(":","_");for(var v=0;v<t.json.columns.length;v++){var x=t.json.columns[v];var w=x.label;var A=x.name.replace(":","_");var y=x.checked?"checked":"";if(w!="hidden"&&w&&m.indexOf(A)<0){n+='<li class=""><input id="propSelected-'+v+'" type="checkbox" name="propChecked" value="'+A+'" '+y+'/><label for="propSelected-'+v+'" >'+w+"</label></li>"}}n="<span>"+this.msg("label.select-columns.title")+'</span><br/><br/><ul style="width:'+((s+2)*20)+'em;">'+n+"</ul>";o.innerHTML=n;var z=e.get(this.id+"-columns-conf-ft");z.innerHTML='<input id="'+this.id+'-bulk-edit-ok" type="button" value="'+this.msg("button.ok")+'" />';this.widgets.okBkButton=Alfresco.util.createYUIButton(this,"bulk-edit-ok",function(){var C=Selector.query('input[type="checkbox"]',o);for(var E in C){var D=C[E].value;var B=u+"."+D;q.services.preferences.set(B,{checked:C[E].checked})}this.widgets.columnsListPanel.hide();setTimeout(function(){YAHOO.Bubbling.fire(q.scopeId+"scopedActiveDataListChanged",{clearCache:true})},1000)})},scope:this}});this.widgets.columnsListPanel.show()}}})();