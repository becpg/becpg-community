(function(){var g=YAHOO.util.Dom,n=YAHOO.util.Event;var d=Alfresco.util.encodeHTML;Alfresco.module.DoclibAspects=function(o){Alfresco.module.DoclibAspects.superclass.constructor.call(this,o,["button","container","datasource","datatable"]);this.eventGroup=o;this.currentValues=[];this.selectedValues={};return this};YAHOO.extend(Alfresco.module.DoclibAspects,Alfresco.module.SimpleDialog,{currentValues:null,selectedValues:null,setOptions:function f(o){Alfresco.module.DoclibAspects.superclass.setOptions.call(this,{width:"56em",templateUrl:Alfresco.constants.URL_SERVICECONTEXT+"modules/documentlibrary/aspects",doBeforeDialogShow:{fn:this.doBeforeDialogShow,obj:null,scope:this},doBeforeAjaxRequest:{fn:this.doBeforeAjaxRequest,obj:null,scope:this}});this.options=YAHOO.lang.merge(this.options,o);return this},renderItem:function b(q,p){var o=function(v,x,w){var s="";if(v.toLowerCase()=="icon"){var u="",r="",t;if(w&&w.length>0){t=w.split(" ");u=' width="'+t[0]+'"';if(t.length>1){r=' height="'+t[1]+'"'}}s='<img src="'+x+'"'+u+r+' alt="'+d(q.name)+'" title="'+d(q.name)+'" />'}else{s=d(x)}return s};return YAHOO.lang.substitute(p,q,o)},i18n:function l(o,q){var p="aspect."+o.replace(":","_"),r=this.msg(p);return(r!==p?r:this.options.labels[o])+" ("+o+")"},doBeforeDialogShow:function i(p,r,q){var o='<span class="light">'+d(this.options.file.displayName)+"</span>";g.get(this.id+"-title").innerHTML=this.msg("title",o);if(!this.modules.actions){this.modules.actions=new Alfresco.module.DoclibActions(Alfresco.doclib.MODE_REPOSITORY)}this._createAspectsControls();this._requestAspectData();this.widgets.okButton.set("disabled",false);this.widgets.okButton.addClass("alf-primary-button");this.widgets.cancelButton.set("disabled",false)},doBeforeAjaxRequest:function a(r){var p=function q(t){this.hide();Alfresco.util.PopupManager.displayMessage({text:this.msg(t.json.overallSuccess?"message.aspects.success":"message.aspects.failure")});if(t.json.results[0].tagScope){}};var s=function o(t){this.hide();Alfresco.util.PopupManager.displayMessage({text:this.msg("message.aspects.failure")})};this.modules.actions.genericAction({success:{event:{name:"metadataRefresh",obj:{highlightFile:this.options.file.name}},callback:{fn:p,scope:this}},failure:{callback:{fn:s,scope:this}},webscript:{method:Alfresco.util.Ajax.POST,name:"aspects/node/{nodeRef}",params:{nodeRef:this.options.file.jsNode.nodeRef.uri}},config:{requestContentType:Alfresco.util.Ajax.JSON,dataObj:{added:this.getAddedValues(),removed:this.getRemovedValues()}}});return false},getAddedValues:function m(){var q=[],o=Alfresco.util.arrayToObject(this.currentValues);for(var p in this.selectedValues){if(this.selectedValues.hasOwnProperty(p)){if(!(p in o)){q.push(p)}}}return q},getRemovedValues:function k(){var q=[],o=Alfresco.util.arrayToObject(this.currentValues);for(var p in o){if(o.hasOwnProperty(p)){if(!(p in this.selectedValues)){q.push(p)}}}return q},_createAspectsControls:function j(){var v=this;var t=function t(A,z,B,C){g.setStyle(A.parentNode,"width",B.width+"px");A.innerHTML=v.renderItem(z.getData(),"<div>{icon 16 16}</div>")};var x=function x(A,z,B,C){A.innerHTML=v.renderItem(z.getData(),'<h4 class="name">{name}</h4>')};var p=function p(A,z,B,C){g.setStyle(A.parentNode,"width",B.width+"px");if(z.getData("canAdd")){A.innerHTML='<a href="#" class="add-item add-'+v.eventGroup+'" title="'+v.msg("button.add")+'"><span class="addIcon">&nbsp;</span></a>'}};var r=function r(A,z,B,C){g.setStyle(A.parentNode,"width",B.width+"px");if(z.getData("canRemove")){A.innerHTML='<a href="#" class="remove-item remove-'+v.eventGroup+'" title="'+v.msg("button.remove")+'"><span class="removeIcon">&nbsp;</span></a>'}};this.widgets.dataSourceLeft=new YAHOO.util.DataSource([],{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});var w=function(A,z,C){if(!YAHOO.lang.isValue(A)){return(!YAHOO.lang.isValue(z))?0:1}else{if(!YAHOO.lang.isValue(z)){return -1}}var B=YAHOO.util.Sort.compare;return B(A.getData("name"),z.getData("name"),C)};var u=[{key:"icon",label:"icon",sortable:false,formatter:t,width:10},{key:"name",label:"name",sortable:true,formatter:x,sortOptions:{sortFunction:w},defaultDir:"asc"},{key:"id",label:"add",sortable:false,formatter:p,width:16}];this.widgets.dataTableLeft=new YAHOO.widget.DataTable(this.id+"-left",u,this.widgets.dataSourceLeft,{MSG_EMPTY:this.msg("label.loading")});var q=function o(C,B){var z=YAHOO.Bubbling.getOwnerByTagName(B[1].anchor,"div");if(z!==null){var E=B[1].target,D=E.offsetParent,A=v.widgets.dataTableLeft.getRecord(D);if(A){v.widgets.dataTableRight.addRow(A.getData());v.selectedValues[A.getData("id")]=A;v.widgets.dataTableLeft.deleteRow(D)}}return true};YAHOO.Bubbling.addDefaultAction("add-"+this.eventGroup,q,true);this.widgets.dataSourceRight=new YAHOO.util.DataSource([],{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});var s=[{key:"icon",label:"icon",sortable:false,formatter:t,width:10},{key:"name",label:"name",sortable:true,formatter:x},{key:"id",label:"remove",sortable:false,formatter:r,width:16}];this.widgets.dataTableRight=new YAHOO.widget.DataTable(this.id+"-right",s,this.widgets.dataSourceRight,{MSG_EMPTY:this.msg("label.loading")});var y=function y(C,B){var z=YAHOO.Bubbling.getOwnerByTagName(B[1].anchor,"div");if(z!==null){var E=B[1].target,D=E.offsetParent,A=v.widgets.dataTableRight.getRecord(D);if(A){v.widgets.dataTableLeft.addRow(A.getData());delete v.selectedValues[A.getData("id")];v.widgets.dataTableRight.deleteRow(D)}}return true};YAHOO.Bubbling.addDefaultAction("remove-"+this.eventGroup,y,true)},_requestAspectData:function e(){this.selectedValues={};Alfresco.util.Ajax.request({method:"GET",url:Alfresco.constants.PROXY_URI+"slingshot/doclib/aspects/node/"+this.options.file.jsNode.nodeRef.uri,successCallback:{fn:this._requestAspectDataSuccess,scope:this},failureCallback:{fn:this._requestAspectDataFailure,scope:this}})},_requestAspectDataFailure:function h(){this.widgets.dataTableLeft.set("MSG_EMPTY",this.msg("label.load-failure"));this.widgets.dataTableRight.set("MSG_EMPTY",this.msg("label.load-failure"))},_requestAspectDataSuccess:function c(s){this.currentValues={};if(typeof s.json!="undefined"){var r=s.json.current,p=Alfresco.util.arrayToObject(r),D=this.options.visible,C=Alfresco.util.arrayToObject(D),y=this.options.addable,t=this.options.removeable,u,B;this.currentValues=r;if(y.length===0){y=D.slice(0)}if(t.length===0){t=D.slice(0)}var w=Alfresco.util.arrayToObject(y),q=Alfresco.util.arrayToObject(t);var x,z,v,A=[],o=[];for(u=0,B=r.length;u<B;u++){x=r[u];v={id:x,icon:Alfresco.constants.URL_RESCONTEXT+"components/images/aspect-16.png",name:this.i18n(x),canAdd:x in w,canRemove:x in q};if(x in C){A.push(v)}this.selectedValues[x]=v}A.sort(function(F,E){return YAHOO.util.Sort.compare(F.name,E.name)});for(var u in A){this.widgets.dataTableRight.addRow(A[u])}for(u=0,B=y.length;u<B;u++){z=y[u];if((z in C)&&!(z in p)&&this.i18n(z).indexOf("undefined")<0){o.push({id:z,icon:Alfresco.constants.URL_RESCONTEXT+"components/images/aspect-16.png",name:this.i18n(z),canAdd:true,canRemove:true})}}o.sort(function(F,E){return YAHOO.util.Sort.compare(F.name,E.name)});for(var u in o){this.widgets.dataTableLeft.addRow(o[u])}this.widgets.dataTableLeft.set("MSG_EMPTY",this.msg("label.no-addable"));this.widgets.dataTableRight.set("MSG_EMPTY",this.msg("label.no-current"));this.widgets.dataTableLeft.render();this.widgets.dataTableRight.render()}}})})();var doclibAspects=new Alfresco.module.DoclibAspects("null");