(function(){Alfresco.module.DoclibCopyMoveTo=function(j){Alfresco.module.DoclibCopyMoveTo.superclass.constructor.call(this,j);this.name="Alfresco.module.DoclibCopyMoveTo";var k=Alfresco.module.DoclibGlobalFolder;Alfresco.util.ComponentManager.reregister(this);this.options=YAHOO.lang.merge(this.options,{allowedViewModes:[k.VIEW_MODE_SITE,k.VIEW_MODE_RECENT_SITES,k.VIEW_MODE_FAVOURITE_SITES,k.VIEW_MODE_SHARED,k.VIEW_MODE_REPOSITORY,k.VIEW_MODE_USERHOME],extendedTemplateUrl:Alfresco.constants.URL_SERVICECONTEXT+"modules/documentlibrary/copy-move-to"});return this};YAHOO.extend(Alfresco.module.DoclibCopyMoveTo,Alfresco.module.DoclibGlobalFolder,{setOptions:function e(l){var j={};if(typeof l.mode!=="undefined"){var k={copy:"copy-to",move:"move-to",unzip:"unzip-to"};if(typeof k[l.mode]=="undefined"){throw new Error("Alfresco.module.CopyMoveTo: Invalid mode '"+l.mode+"'")}j.dataWebScript=k[l.mode]}j.viewMode=Alfresco.module.DoclibGlobalFolder.VIEW_MODE_RECENT_SITES;this.modules.actions=new Alfresco.module.DoclibActions();return Alfresco.module.DoclibCopyMoveTo.superclass.setOptions.call(this,YAHOO.lang.merge(j,l))},onTemplateLoaded:function d(j){Alfresco.util.Ajax.request({url:this.options.extendedTemplateUrl,dataObj:{htmlid:this.id},successCallback:{fn:this.onExtendedTemplateLoaded,obj:j,scope:this},failureMessage:"Could not load 'copy-move-to' template:"+this.options.extendedTemplateUrl,execScripts:true})},onExtendedTemplateLoaded:function a(j,k){Alfresco.module.DoclibCopyMoveTo.superclass.onTemplateLoaded.call(this,k)},onCreateLink:function c(q,r){var m,s=[],n,p,o;this.options.mode="link";if(YAHOO.lang.isArray(this.options.files)){m=this.options.files}else{m=[this.options.files]}for(p=0,o=m.length;p<o;p++){s.push(m[p].node.nodeRef)}var l=new Alfresco.util.NodeRef(this.selectedNode.data.nodeRef);var k=Alfresco.constants.PROXY_URI+"api/node/doclink/"+l.storeType+"/"+l.storeId+"/"+l.id;Alfresco.util.Ajax.jsonPost({url:k,dataObj:{destinationNodeRef:l.nodeRef,multipleFiles:s},successCallback:{fn:function(j){this.widgets.dialog.hide();if(j&&j.serverResponse&&j.serverResponse.status==200){var t=JSON.parse(j.serverResponse.responseText);if(t){var w=t.successCount;var x=t.failureCount;if(w=="0"){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.failure"),zIndex:this.options.zIndex},this.options.parentElement)}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.success",w),zIndex:this.options.zIndex},this.options.parentElement)}YAHOO.Bubbling.fire("filesLinkCreated",{destination:this.currentPath,successCount:w,failureCount:x,sourceFilesObj:j.config.dataObj});for(var v=0;v<s.length;v++){var u=s[v];YAHOO.Bubbling.fire("fileLinkCreated",{multiple:true,nodeRef:u,destination:this.currentPath})}YAHOO.Bubbling.fire("metadataRefresh")}}},scope:this},wait:{message:this.msg("message.please-wait")},failureCallback:{fn:function(j){this.widgets.dialog.hide();var u="message.failure";var t=j.serverResponse.responseText.toString();if(j&&j.serverResponse&&j.serverResponse.status==408){u="message.timeout"}else{if(t.indexOf("already exists in the destination folder")!=-1){u="message.exists.failure"}else{if(t.indexOf("Cannot perform operation since the node")!=-1){u="message.locked.failure"}else{if(j.json&&j.json.message){Alfresco.util.PopupManager.displayPrompt({title:this.msg(u),text:j.json.message});return}}}}Alfresco.util.PopupManager.displayMessage({text:this.msg(u),zIndex:this.options.zIndex},this.options.parentElement)},scope:this}});this.widgets.okButton.set("disabled",true);this.widgets.linkButton.set("disabled",true);this.widgets.cancelButton.set("disabled",true)},onOK:function b(r,w){var l,x=[],o,q,p,n={copy:"Copied",move:"Moved",unzip:"Unzipped"};if(YAHOO.lang.isArray(this.options.files)){l=this.options.files}else{l=[this.options.files]}for(q=0,p=l.length;q<p;q++){x.push(l[q].node.nodeRef)}var v=function t(B){var y,D=B.json.successCount,E=B.json.failureCount;this.widgets.dialog.hide();if(!B.json.overallSuccess){var C="message.failure";for(var A=0,z=B.json.totalResults;A<z;A++){y=B.json.results[A];if(!y.success&&y.fileExist){if("folder"==y.type){C="message.exists.failure.folder"}else{C="message.exists.failure.file"}}}Alfresco.util.PopupManager.displayMessage({text:this.msg(C),zIndex:this.options.zIndex,displayTime:0},this.options.parentElement);return}YAHOO.Bubbling.fire("files"+n[this.options.mode],{destination:this.currentPath,successCount:D,failureCount:E,sourceFilesObj:B.config.dataObj});for(var A=0,z=B.json.totalResults;A<z;A++){y=B.json.results[A];if(y.success){YAHOO.Bubbling.fire((y.type=="folder"?"folder":"file")+n[this.options.mode],{multiple:true,nodeRef:y.nodeRef,destination:this.currentPath})}}if(this.options.mode=="move"&&(window.location.pathname.lastIndexOf("document-details")===(window.location.pathname.length-"document-details".length)||window.location.pathname.lastIndexOf("entity-data-lists")===(window.location.pathname.length-"entity-data-lists".length))){window.location.reload()}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.success",D),zIndex:this.options.zIndex},this.options.parentElement);YAHOO.Bubbling.fire("metadataRefresh")}};var m=function k(j){this.widgets.dialog.hide();var y="message.failure";if(j&&j.serverResponse&&j.serverResponse.status==408){y="message.timeout"}Alfresco.util.PopupManager.displayMessage({text:this.msg(y),zIndex:this.options.zIndex},this.options.parentElement)};var s=this.options.dataWebScript+"/node/{nodeRef}",u=new Alfresco.util.NodeRef(this.selectedNode.data.nodeRef);this.modules.actions.genericAction({success:{callback:{fn:v,scope:this}},failure:{callback:{fn:m,scope:this}},webscript:{method:Alfresco.util.Ajax.POST,name:s,params:{nodeRef:u.uri}},wait:{message:this.msg("message.please-wait")},config:{requestContentType:Alfresco.util.Ajax.JSON,dataObj:{nodeRefs:x,parentId:this.options.parentId}}});this.widgets.okButton.set("disabled",true);this.widgets.linkButton.set("disabled",true);this.widgets.cancelButton.set("disabled",true)},msg:function h(k){var j=Alfresco.util.message.call(this,this.options.mode+"."+k,this.name,Array.prototype.slice.call(arguments).slice(1));if(j==(this.options.mode+"."+k)){j=Alfresco.util.message.call(this,k,this.name,Array.prototype.slice.call(arguments).slice(1))}if(j==k){j=Alfresco.util.message(k,"Alfresco.module.DoclibGlobalFolder",Array.prototype.slice.call(arguments).slice(1))}return j},_showDialog:function g(){this.widgets.okButton.set("label",this.msg("button"));var j=this._canCreateLinks(this.options.files);if(this.options.mode!="copy"||j==false){this.widgets.linkButton.set("style","display:none")}else{this.widgets.linkButton.set("style","")}return Alfresco.module.DoclibCopyMoveTo.superclass._showDialog.apply(this,arguments)},_canCreateLinks:function f(j){var l=true;if(YAHOO.lang.isArray(j)){for(var k=0;k<j.length;k++){if(j[k].node.type=="st:site"||j[k].node.isLink){l=false;break}}}else{if(j.node.type=="st:site"||j.node.isLink){l=false}}return l}});var i=new Alfresco.module.DoclibCopyMoveTo("null")})();