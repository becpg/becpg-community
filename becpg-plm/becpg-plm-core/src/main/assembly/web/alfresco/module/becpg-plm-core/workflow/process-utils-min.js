function sendMail(b,i,h,l,j,a){try{if(b!=null){var c=actions.create("mail");c.parameters.template_model=g;if(b.typeShort&&b.typeShort=="cm:authorityContainer"){c.parameters.to_many=new Array(b.properties["cm:authorityName"])}else{if(b.typeShort&&b.typeShort=="cm:person"){c.parameters.to_many=new Array(b.properties["cm:userName"])}else{c.parameters.to_many=new Array(b)}}c.parameters.subject=h.replace("\n"," ").replace("\r"," ");if(i!=null){c.parameters.from=i.properties.email}c.parameters.ignore_send_failure=true;var k=search.xpathSearch(j)[0];if(k){c.parameters.template=k;var d=new Array();d.workflowTitle=l;d.workflowPooled=false;d.workflowDescription=bpm_workflowDescription;d.workflowDueDate=task.dueDate;d.workflowPriority=task.priority;d.workflowDocuments=a;d.workflowId="activiti$"+task.id;var g=new Array();g.args=d;c.parameters.template_model=g;c.execute(bpm_package)}else{logger.error("No template found for email : "+j)}}}catch(f){logger.error("Cannot send mail to :");logger.error(" - subject: "+h);logger.error(" - e: "+f)}}function getDelegate(c){var b=new Date(),a=(c.properties["pjt:delegationStartDate"]!=null?new Date(c.properties["pjt:delegationStartDate"].getTime()):null),e=(c.properties["pjt:delegationEndDate"]!=null?new Date(c.properties["pjt:delegationEndDate"].getTime()):null);if(c!=null&&c.properties["pjt:delegationActivated"]&&(a==null||a<=b)&&(e==null||b<=e)&&c.assocs["pjt:reassignTo"][0]!=null){var d=getDelegate(c.assocs["pjt:reassignTo"][0]);if(d!=null){return d}else{return c.assocs["pjt:reassignTo"][0].properties.userName}}return null}function getAssigneeOrDelegate(a){var b=getDelegate(a);if(b!=null){return b}else{return a.properties.userName}}function getAssignees(e){var d=new java.util.ArrayList();if(e!=null){for(var c=0;c<e.size();c++){if(e.get(c).isSubType("cm:authorityContainer")){var a=people.getMembers(e.get(c));for(var b in a){d.add(getAssigneeOrDelegate(a[b]))}}else{if(e.get(c).isSubType("cm:person")){d.add(getAssigneeOrDelegate(e.get(c)))}}}}return d}function onCreateProductValidationTask(c){if(typeof bpm_workflowDueDate!="undefined"){task.dueDate=bpm_workflowDueDate}if(typeof bpm_workflowPriority!="undefined"){task.priority=bpm_workflowPriority}var b=getAssignees(c);if(b!=null&&b.size()>0){if(b.size()==1){task.setAssignee(b.get(0))}else{for(var a=0;a<b.size();a++){task.addCandidateUser(b.get(a));if(bcpgwf_notifyAssignee){sendMail(b.get(a),initiator,bcpg.getMessage("productValidationWF.mail.notify.subject",bpm_workflowDescription),bcpg.getMessage("productValidationWF.mail.notify.message"),"/app:company_home/app:dictionary/app:email_templates/cm:workflownotification/cm:product-validation-notify-task-email.ftl",bpm_package.children)}}}}}function onAssignmentProductValidationTask(){if(bcpgwf_notifyAssignee){sendMail(task.assignee,initiator,bcpg.getMessage("productValidationWF.mail.notify.subject",bpm_workflowDescription),bcpg.getMessage("productValidationWF.mail.notify.message"),"/app:company_home/app:dictionary/app:email_templates/cm:workflownotification/cm:product-validation-notify-task-email.ftl",bpm_package.children)}}function startProductValidationWF(){execution.setVariable("bpm_comment",bcpgwf_pvTransmitterComment);execution.setVariable("bcpgwf_reviewRDApproval",null);execution.setVariable("bcpgwf_reviewPackagingApproval",null);execution.setVariable("bcpgwf_reviewProductionApproval",null);execution.setVariable("bcpgwf_reviewQualityApproval",null);execution.setVariable("bcpgwf_reviewCallerApproval",null);execution.setVariable("bcpgwf_reviewCaller2Approval",null);if(execution.getVariable("bcpgwf_pvRDApprovalActor")==null){execution.setVariable("bcpgwf_pvRDApprovalActor",null)}if(execution.getVariable("bcpgwf_pvPackagingApprovalActor")==null){execution.setVariable("bcpgwf_pvPackagingApprovalActor",null)}if(execution.getVariable("bcpgwf_pvProductionApprovalActor")==null){execution.setVariable("bcpgwf_pvProductionApprovalActor",null)}if(execution.getVariable("bcpgwf_pvQualityApprovalActor")==null){execution.setVariable("bcpgwf_pvQualityApprovalActor",null)}if(execution.getVariable("bcpgwf_pvCallerActor")==null){execution.setVariable("bcpgwf_pvCallerActor",null)}if(execution.getVariable("bcpgwf_pvCaller2Actor")==null){execution.setVariable("bcpgwf_pvCaller2Actor",null)}if(execution.getVariable("bcpgwf_notifyUsers")==null){execution.setVariable("bcpgwf_notifyUsers",null)}execution.setVariable("bcpgwf_pvRDApprovalActorAssignee",null);execution.setVariable("bcpgwf_pvPackagingApprovalActorAssignee",null);execution.setVariable("bcpgwf_pvProductionApprovalActorAssignee",null);execution.setVariable("bcpgwf_pvQualityApprovalActorAssignee",null);execution.setVariable("bcpgwf_pvCallerActorAssignee",null);execution.setVariable("bcpgwf_pvCaller2ActorAssignee",null);for(var a=0;a<bpm_package.children.length;a++){var b=bpm_package.children[a];if(b.isSubType("bcpg:product")&&b.properties["bcpg:productState"]!="ToValidate"){b.properties["bcpg:productState"]="ToValidate";b.save()}var c=execution.getVariable("bpm_workflowDescription");if(isEmpty(c)||isBlank(c)){bpm_workflowDescription=extractName(b);bpm_description=bpm_workflowDescription;execution.setVariable("bpm_workflowDescription",bpm_workflowDescription);execution.setVariable("bpm_description",bpm_workflowDescription)}}}function isEmpty(a){return(!a||0===a.length)}function isBlank(a){return(!a||/^\s*$/.test(a))}function extractName(b){var a=bcpg.getMessage("productValidationWF.workflow.title");a+=" - "+b.name;return a}function onCreateApproveProductTask(){if(typeof bpm_workflowDueDate!="undefined"){task.dueDate=bpm_workflowDueDate}if(typeof bpm_workflowPriority!="undefined"){task.priority=bpm_workflowPriority}task.setAssignee(getAssigneeOrDelegate(initiator));if(bcpgwf_notifyUsers!=null){for(var c=0;c<bcpgwf_notifyUsers.size();c++){sendMail(bcpgwf_notifyUsers.get(c),null,bcpg.getMessage("productValidationWF.mail.approved.subject",bpm_workflowDescription),bcpg.getMessage("productValidationWF.mail.approved.message"),"/app:company_home/app:dictionary/app:email_templates/cm:workflownotification/cm:product-validation-approved-task-email.ftl",bpm_package.children)}}for(var c=0;c<bpm_package.children.length;c++){var g=bpm_package.children[c];var l=["bcpgwf:pvCallerActor","bcpgwf:pvCaller2Actor","bcpgwf:pvRDApprovalActor","bcpgwf:pvPackagingApprovalActor","bcpgwf:pvQualityApprovalActor","bcpgwf:pvProductionApprovalActor","bcpgwf:pvTransmitterActor"];var h=[bcpgwf_pvCallerActorAssignee,bcpgwf_pvCaller2ActorAssignee,bcpgwf_pvRDApprovalActorAssignee,bcpgwf_pvPackagingApprovalActorAssignee,bcpgwf_pvQualityApprovalActorAssignee,bcpgwf_pvProductionApprovalActorAssignee,initiator];for(var b=0;b<l.length;b++){var d=l[b];var e=h[b];var f=g.assocs[d];if(f!=null){for(var a=0;a<f.length;a++){g.removeAssociation(f[a],d)}}if(e!=null){if(e.typeShort==null){e=people.getPerson(e)}g.createAssociation(e,d)}}g.properties["bcpgwf:pvValidationDate"]=new Date();g.save()}};