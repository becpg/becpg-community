define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dijit/_WidgetBase","dijit/_TemplatedMixin","alfresco/core/TemporalUtils","alfresco/core/FileSizeMixin","alfresco/renderers/_PublishPayloadMixin","dojo/text!./templates/SearchBox.html","dojo/text!./templates/BeCPGLiveSearch.html","dojo/text!./templates/LiveSearchItem.html","alfresco/core/Core","alfresco/core/CoreXhr","alfresco/enums/urlTypes","alfresco/header/AlfMenuBar","alfresco/util/urlUtils","service/constants/Default","dojo/json","dojo/dom-attr","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/date/stamp","dojo/on"],function(j,k,l,t,s,e,G,N,a,f,W,w,z,P,p,Y,E,n,T,aa,x,R,Z,L){var B=j([t,s,w],{i18nScope:"org.alfresco.SearchBox",searchBox:null,containerNodeEntities:null,containerNodeDocs:null,containerNodeSites:null,containerNodePeople:null,height:null,label:null,templateString:f,postMixInProperties:function D(){this.label={};this.label.documents=this.message(this.searchBox.documentsTitle);this.label.entities=this.message(this.searchBox.entitiesTitle);this.label.sites=this.message(this.searchBox.sitesTitle);this.label.people=this.message(this.searchBox.peopleTitle);this.label.more=this.message(this.searchBox.moreTitle);this.label.contextRespository=this.message(this.searchBox.contextRepositoryLabel);var af=this.searchBox.siteName?this.searchBox.siteName:this.searchBox.site;this.label.contextSite=this.message(this.searchBox.contextSiteLabel,af);this.label.repositoryTooltip=this.message(this.searchBox.repositoryTitle);this.label.siteTooltip=this.message(this.searchBox.siteTitle)},postCreate:function F(){var af=this.searchBox.site;if(this.contextNode&&(this.searchBox.enableContextLiveSearch===false||!af)){aa.set(this.contextNode,"display","none")}if(this.height){aa.set(this.domNode,{maxHeight:this.height,overflowX:"hidden",overflowY:"auto"})}},onSearchDocsMoreClick:function ad(af){this.searchBox.liveSearchDocuments(this.searchBox.lastSearchText,this.searchBox.resultsCounts.docs);af.preventDefault()},onSearchEntitiesMoreClick:function A(af){this.searchBox.liveSearchEntities(this.searchBox.lastSearchText,this.searchBox.resultsCounts.entities);af.preventDefault()}});var V=j([t,s,w,N],{searchBox:null,templateString:W,postCreate:function g(){this.inherited(arguments);this.linkNode.appendChild(document.createTextNode(this.label));this.linkNode.setAttribute("title",this.title);this.previewImgNode.setAttribute("alt",this.alt);this.previewLinkNode.setAttribute("title",this.label)},onResultClick:function J(af){this.searchBox.onSaveLastUserSearch();if(this.publishTopic){var ag=this.getGeneratedPayload(true);this.alfPublish(this.publishTopic,ag,this.publishGlobal,this.publishToParent)}else{this.alfPublish("ALF_NAVIGATE_TO_PAGE",{type:"FULL_PATH",url:this.link})}af&&af.preventDefault();af&&af.stopPropagation()},onMetaClick:function S(af){if(af.target&&af.target.href){if(this.publishTopic){var ag=this.getGeneratedPayload(true);this.alfPublish(this.publishTopic,ag,this.publishGlobal,this.publishToParent)}else{this.alfPublish("ALF_NAVIGATE_TO_PAGE",{type:"FULL_PATH",url:af.target.href})}}af.preventDefault();af.stopPropagation()}});return j([t,s,z,e,G],{i18nScope:"org.alfresco.SearchBox",cssRequirements:[{cssFile:"./css/SearchBox.css"}],i18nRequirements:[{i18nFile:"./i18n/SearchBox.properties"},{i18nFile:"./i18n/BeCPGSearchBox.properties"}],templateString:a,_LiveSearch:null,_keyRepeatWait:250,_lastSearchIndex:0,_minimumSearchLength:2,_requests:null,_resultPageSize:5,_searchMenu:null,accessibilityInstruction:"search.label",advancedSearch:true,alignment:"right",allsites:false,blogPage:"blog-postview",contextRepositoryLabel:"search.in-repository",contextSiteLabel:"search.in-site",defaultSearchScope:"repo",documentLibraryPage:"documentlibrary",documentPage:"document-details",documentsTitle:"search.documents",enableContextLiveSearch:false,liveSearchHeight:null,hiddenSearchTerms:"",lastSearchText:null,linkToFacetedSearch:true,liveSearch:true,liveSearchDocumentsUri:"slingshot/live-search-docs",liveSearchPeopleUri:"slingshot/live-search-people",liveSearchSitesUri:"slingshot/live-search-sites",moreTitle:"search.more",peoplePage:"profile",peopleTitle:"search.people",placeholder:"search.instruction",publishTopic:null,publishPayload:null,publishGlobal:false,publishToParent:false,publishPayloadType:null,publishPayloadModifiers:null,publishPayloadItemMixin:true,resultsCounts:null,repositoryTitle:"search.in-repository.tooltip",searchResultsPage:null,site:null,siteContext:false,sitePage:"dashboard",siteName:null,siteTitle:"search.in-site.tooltip",showDocumentResults:true,showEntitiesResults:true,entitiesTitle:"search.entities",liveSearchEntitiesUri:"slingshot/live-search-entities",showPeopleResults:true,showSiteResults:true,sitesTitle:"search.sites",suppressRedirect:false,width:"180",wikiPage:"wiki-page",postMixInProperties:function h(){this.label={};l.forEach(["clear"],k.hitch(this,function(ag){this.label[ag]=this.message("search."+ag)}));var af=parseInt(this.width,10);if(isNaN(af)){this.width="180";this._outerWidth="250"}else{this._outerWidth=(af+70)+""}},postCreate:function H(){this._requests=[];this.resultsCounts={};T.set(this._searchTextNode,"id","HEADER_SEARCHBOX_FORM_FIELD");T.set(this._searchTextNode,"placeholder",this.message(this.placeholder));L(this._searchTextNode,"keyup",k.hitch(this,function(af){this.onSearchBoxKeyUp(af)}));L(this._searchTextNode,"keydown",k.hitch(this,function(af){this.onSearchBoxKeyDown(af)}));L(this._searchTextNode,"paste",k.hitch(this,function(){setTimeout(k.hitch(this,function(){this.onSearchBoxKeyUp({keyCode:0})}),0)}));if(this.advancedSearch){this._searchMenu=new p({widgets:[{name:"alfresco/header/AlfMenuBarPopup",config:{id:this.id+"_DROPDOWN_MENU",showArrow:false,label:"",iconSrc:require.toUrl("alfresco/header/css/images/search-16-gray.png"),iconClass:"alf-search-icon",widgets:[{name:"alfresco/menus/AlfMenuItem",config:{id:this.id+"_ADVANCED_SEARCH",i18nScope:"org.alfresco.SearchBox",label:"header.becpg.adv.search.label",targetUrl:(this.site?"site/"+this.site+"/":"")+"advsearch"}},{name:"alfresco/menus/AlfMenuItem",config:{id:this.id+"_FACETED_SEARCH",i18nScope:"org.alfresco.SearchBox",label:"header.becpg.faceted.search.label",targetUrl:(this.site?"site/"+this.site+"/":"")+"dp/ws/faceted-search"}}]}}]});this._searchMenu.placeAt(this._searchMenuNode);this._searchMenu.startup()}else{R.create("span",{"class":"alfresco-header-SearchBox-menu--hideAdvancedSearch"},this._searchMenuNode)}if(this.liveSearch){this._LiveSearch=new B({searchBox:this,height:this.liveSearchHeight});if(this.alignment){x.add(this._LiveSearch.domNode,this.alignment)}this._LiveSearch.placeAt(this._searchLiveNode);L(this._LiveSearch.contextRepositoryNode,"click",k.hitch(this,function(af){x.add(this._LiveSearch.contextRepositoryNode,"alf-livesearch-context--active");x.remove(this._LiveSearch.contextSiteNode,"alf-livesearch-context--active");this.siteContext=false;this.lastSearchText="";this.onSearchBoxKeyUp(af);af.preventDefault()}));L(this._LiveSearch.contextSiteNode,"click",k.hitch(this,function(af){x.add(this._LiveSearch.contextSiteNode,"alf-livesearch-context--active");x.remove(this._LiveSearch.contextRepositoryNode,"alf-livesearch-context--active");this.siteContext=true;this.lastSearchText="";this.onSearchBoxKeyUp(af);af.preventDefault()}));L(window,"click",k.hitch(this,function(){aa.set(this._LiveSearch.containerNode,"display","none")}));L(this._searchTextNode,"click",k.hitch(this,function(af){this.updateResults();af.stopPropagation()}));L(this._LiveSearch,"click",function(af){af.stopPropagation()})}this.addAccessibilityLabel()},generateSearchTerm:function q(ag){var af=ag;if(this.hiddenSearchTerms){af="("+ag+") "+this.hiddenSearchTerms}return encodeURIComponent(af)},generateSearchPageLink:function y(ah){var af;var ag=(this.siteContext===true&&this.site)?this.site:this.defaultSearchScope;if(this.searchResultsPage){af=this.searchResultsPage+"#searchTerm="+this.generateSearchTerm(ah)+"&scope="+ag}else{if(this.linkToFacetedSearch===true){af="dp/ws/faceted-search#searchTerm="+this.generateSearchTerm(ah)+"&scope="+ag}else{af="search?t="+this.generateSearchTerm(ah)+(this.allsites?"&a=true&r=false":"&a=false&r=true")}}if(this.site){af="site/"+this.site+"/"+af}this.alfLog("log","Generated search page link",af,this);return af},_supportsLocalStorage:function Q(){try{return"localStorage" in window&&window.localStorage!==null}catch(af){return false}},onSaveLastUserSearch:function m(){var ag=k.trim(this._searchTextNode.value);if(ag.length!==0){if(this._supportsLocalStorage()){var af=n.parse(localStorage.getItem("ALF_SEARCHBOX_HISTORY"))||[];if(af.length===0||af[af.length-1]!==ag){af.push(ag);if(af.length>16){af=af.slice(af.length-16)}localStorage.setItem("ALF_SEARCHBOX_HISTORY",n.stringify(af))}}}},onSearchBoxKeyDown:function b(af){var ag;switch(af.keyCode){case 37:case 39:af&&af.stopPropagation();break;case 38:af&&af.stopPropagation();if(this._supportsLocalStorage()){ag=n.parse(localStorage.getItem("ALF_SEARCHBOX_HISTORY"));if(ag){if(this._lastSearchIndex===0){this._lastSearchIndex=ag.length-1}else{this._lastSearchIndex--}this._searchTextNode.value=ag[this._lastSearchIndex];this.onSearchBoxKeyUp(af)}}break;case 40:af&&af.stopPropagation();if(this._supportsLocalStorage()){ag=n.parse(localStorage.getItem("ALF_SEARCHBOX_HISTORY"));if(ag){if(this._lastSearchIndex===ag.length-1){this._lastSearchIndex=0}else{this._lastSearchIndex++}this._searchTextNode.value=ag[this._lastSearchIndex];this.onSearchBoxKeyUp(af)}}break}},onSearchBoxKeyUp:function ab(af){var ai=k.trim(this._searchTextNode.value);switch(af.keyCode){case 13:if(ai.length!==0&&this.suppressRedirect!==true){this.onSaveLastUserSearch();this.clearResults();this.alfLog("log","Search request for: ",ai);var ag=this.generateSearchPageLink(ai);this.alfPublish("ALF_NAVIGATE_TO_PAGE",{url:ag,type:P.PAGE_RELATIVE,target:"CURRENT"})}break;default:if(this.liveSearch){if(ai.length>=this._minimumSearchLength&&ai!==this.lastSearchText){this.lastSearchText=ai;for(var ah=0;ah<this._requests.length;ah++){this._requests[ah].cancel()}this._requests=[];if(this._timeoutHandle){clearTimeout(this._timeoutHandle)}var aj=this;this._timeoutHandle=setTimeout(function(){if(aj.showEntitiesResults){aj.liveSearchEntities(ai,0)}if(aj.showDocumentResults){aj.liveSearchDocuments(ai,0)}if(aj.showSiteResults){aj.liveSearchSites(ai,0)}if(aj.showPeopleResults){aj.liveSearchPeople(ai,0)}},this._keyRepeatWait)}}if(ai.length===0){this.clearResults()}}},createLiveSearchDocument:function o(af){return new V(af)},processLiveSearchDocument:function ac(am){var af=(am.site?"site/"+am.site.shortName+"/":"");var ah="";var an=Y.convertUrl(af+this.documentLibraryPage,P.PAGE_RELATIVE);if(am.site){ah+="<a href='"+an+"'>"+this.encodeHTML(am.site.title)+"</a> | "}ah+=this.formatFileSize(am.size);var ak="";var ai=Y.convertUrl("user/"+this.encodeHTML(am.modifiedBy)+"/"+this.peoplePage,P.PAGE_RELATIVE);ak+=this.getRelativeTime(am.modifiedOn)+" | ";ak+="<a href='"+ai+"'>"+this.encodeHTML(am.modifiedBy)+"</a>";var aj=am.title;if(am.description){aj+=(aj.length!==0?"\r\n":"")+am.description}var al;switch(am.container){case"wiki":al=this.wikiPage+"?title="+encodeURIComponent(am.name);break;case"blog":al=this.blogPage+"?postId="+encodeURIComponent(am.name);am.name=am.title;break;case"entity":al="entity-data-lists?list=View-properties&nodeRef="+am.nodeRef;break;default:al=this.documentPage+"?nodeRef="+am.nodeRef;break}var ag=am.lastThumbnailModification||1;return this.createLiveSearchDocument({searchBox:this,cssClass:"alf-livesearch-thumbnail",title:aj,label:am.name,link:Y.convertUrl(af+al,P.PAGE_RELATIVE),icon:E.PROXY_URI+"api/node/"+am.nodeRef.replace(":/","")+"/content/thumbnails/doclib?c=queue&ph=true&lastModified="+ag,alt:am.name,meta:ah,meta2:ak,currentItem:k.clone(am),publishTopic:this.publishTopic,publishPayload:this.publishPayload,publishGlobal:this.publishGlobal,publishToParent:this.publishToParent,publishPayloadType:this.publishPayloadType,publishPayloadItemMixin:this.publishPayloadItemMixin,publishPayloadModifiers:this.publishPayloadModifiers})},liveSearchDocuments:function u(ag,ah){var af=E.PROXY_URI+this.liveSearchDocumentsUri+"?t="+this.generateSearchTerm(ag)+"&maxResults="+this._resultPageSize+"&startIndex="+ah;if(this.siteContext===true&&this.site){af+="&s="+encodeURIComponent(this.site)}this._requests.push(this.serviceXhr({url:af,method:"GET",successCallback:function(ai){if(ah===0){this._LiveSearch.containerNodeDocs.innerHTML=""}l.forEach(ai.items,function(aj){var ak=this.processLiveSearchDocument(aj);ak.placeAt(this._LiveSearch.containerNodeDocs)},this);aa.set(this._LiveSearch.nodeDocsMore,"display",ai.hasMoreRecords?"block":"none");if(ah===0){this.resultsCounts.docs=0}this.resultsCounts.docs+=ai.items.length;this.updateResults()},failureCallback:function(){aa.set(this._LiveSearch.nodeDocsMore,"display","none");if(ah===0){this._LiveSearch.containerNodeDocs.innerHTML="";this.resultsCounts.docs=0}this.updateResults()},callbackScope:this}))},createLiveSearchSite:function X(af){return new V(af)},processLiveSearchSite:function i(ag){var af=ag.visibility;if(af){af=this.message("site.visibility.label."+af)}return this.createLiveSearchSite({searchBox:this,cssClass:"alf-livesearch-icon",title:ag.description,label:ag.title,link:Y.convertUrl("site/"+ag.shortName+"/"+this.sitePage,P.PAGE_RELATIVE),icon:E.URL_RESCONTEXT+"components/images/filetypes/generic-site-48.png",alt:ag.title,meta:ag.description?this.encodeHTML(ag.description):"&nbsp;",meta2:af?af:"&nbsp;",currentItem:k.clone(ag),publishTopic:this.publishTopic,publishPayload:this.publishPayload,publishGlobal:this.publishGlobal,publishToParent:this.publishToParent,publishPayloadType:this.publishPayloadType,publishPayloadItemMixin:this.publishPayloadItemMixin,publishPayloadModifiers:this.publishPayloadModifiers})},liveSearchSites:function K(af,ag){this._requests.push(this.serviceXhr({url:E.PROXY_URI+this.liveSearchSitesUri+"?t="+this.generateSearchTerm(af)+"&maxResults="+this._resultPageSize,method:"GET",successCallback:function(ah){this._LiveSearch.containerNodeSites.innerHTML="";l.forEach(ah.items,function(ai){var aj=this.processLiveSearchSite(ai);aj.placeAt(this._LiveSearch.containerNodeSites)},this);this.resultsCounts.sites=ah.items.length;this.updateResults()},failureCallback:function(){this._LiveSearch.containerNodeSites.innerHTML="";this.resultsCounts.sites=0;this.updateResults()},callbackScope:this}))},createLiveSearchPerson:function U(af){return new V(af)},processLiveSearchPerson:function I(af){var ai=af.firstName+" "+af.lastName;var ah=(af.jobtitle||"")+(af.organization?((af.jobtitle?", ":"")+af.organization):"");var ag=(af.email||"")+(af.location?((af.email?", ":"")+af.location):"");return this.createLiveSearchPerson({searchBox:this,cssClass:"alf-livesearch-icon",title:af.jobtitle||"",label:ai+" ("+af.userName+")",link:Y.convertUrl("user/"+encodeURIComponent(af.userName)+"/"+this.peoplePage,P.PAGE_RELATIVE),icon:E.PROXY_URI+"slingshot/profile/avatar/"+encodeURIComponent(af.userName)+"/thumbnail/avatar",alt:ai,meta:ah?this.encodeHTML(ah):"&nbsp;",meta2:ag?this.encodeHTML(ag):"&nbsp;",currentItem:k.clone(af),publishTopic:this.publishTopic,publishPayload:this.publishPayload,publishGlobal:this.publishGlobal,publishToParent:this.publishToParent,publishPayloadType:this.publishPayloadType,publishPayloadItemMixin:this.publishPayloadItemMixin,publishPayloadModifiers:this.publishPayloadModifiers})},liveSearchPeople:function O(af,ag){this._requests.push(this.serviceXhr({url:E.PROXY_URI+this.liveSearchPeopleUri+"?t="+this.generateSearchTerm(af)+"&maxResults="+this._resultPageSize,method:"GET",successCallback:function(ah){this._LiveSearch.containerNodePeople.innerHTML="";l.forEach(ah.items,function(ai){var aj=this.processLiveSearchPerson(ai);aj.placeAt(this._LiveSearch.containerNodePeople)},this);this.resultsCounts.people=ah.items.length;this.updateResults()},failureCallback:function(){this._LiveSearch.containerNodePeople.innerHTML="";this.resultsCounts.people=0;this.updateResults()},callbackScope:this}))},createLiveSearchEntity:function ae(af){return new V(af)},liveSearchEntities:function M(af,ag){this._requests.push(this.serviceXhr({url:E.PROXY_URI+this.liveSearchEntitiesUri+"?t="+this.generateSearchTerm(af)+"&maxResults="+this._resultPageSize+"&startIndex="+ag,method:"GET",successCallback:function(ah){if(ag===0){this._LiveSearch.containerNodeEntities.innerHTML=""}l.forEach(ah.items,function(ai){var aj=this.processLiveSearchEntities(ai);aj.placeAt(this._LiveSearch.containerNodeEntities)},this);aa.set(this._LiveSearch.nodeEntitiesMore,"display",ah.hasMoreRecords?"block":"none");if(ag===0){this.resultsCounts.entities=0}this.resultsCounts.entities+=ah.items.length;this.updateResults()},failureCallback:function(){aa.set(this._LiveSearch.nodeEntitiesMore,"display","none");if(ag===0){this._LiveSearch.containerNodeEntities.innerHTML="";this.resultsCounts.entities=0}this.updateResults()},callbackScope:this}))},processLiveSearchEntities:function C(am){var af=(am.site?"site/"+am.site.shortName+"/":"");var ah="";var an=Y.convertUrl(af+this.documentLibraryPage,P.PAGE_RELATIVE);if(am.site){ah+="<a href='"+an+"'>"+this.encodeHTML(am.site.title)+"</a>"}var ak="";var ai=Y.convertUrl("user/"+this.encodeHTML(am.modifiedBy)+"/"+this.peoplePage,P.PAGE_RELATIVE);ak+=this.getRelativeTime(am.modifiedOn)+" | ";ak+="<a href='"+ai+"'>"+this.encodeHTML(am.modifiedBy)+"</a>";var aj=am.title;if(am.description){aj+=(aj.length!==0?"\r\n":"")+am.description}var al="entity-data-lists?list=View-properties&nodeRef="+am.nodeRef;var ag=am.lastThumbnailModification||1;return this.createLiveSearchEntity({searchBox:this,cssClass:"alf-livesearch-thumbnail",title:aj,label:am.name,link:Y.convertUrl(af+al,P.PAGE_RELATIVE),icon:E.PROXY_URI+"api/node/"+am.nodeRef.replace(":/","")+"/content/thumbnails/doclib?c=queue&ph=true&lastModified="+ag,alt:am.name,meta:ah,meta2:ak,currentItem:k.clone(am),publishTopic:this.publishTopic,publishPayload:this.publishPayload,publishGlobal:this.publishGlobal,publishToParent:this.publishToParent,publishPayloadType:this.publishPayloadType,publishPayloadItemMixin:this.publishPayloadItemMixin,publishPayloadModifiers:this.publishPayloadModifiers})},updateResults:function c(){var af=false;if(this.resultsCounts.entities>0){af=true;aa.set(this._LiveSearch.titleNodeEntities,"display","block");aa.set(this._LiveSearch.containerNodeEntities,"display","block")}else{aa.set(this._LiveSearch.titleNodeEntities,"display","none");aa.set(this._LiveSearch.containerNodeEntities,"display","none")}if(this.resultsCounts.docs>0){af=true;aa.set(this._LiveSearch.titleNodeDocs,"display","block");aa.set(this._LiveSearch.containerNodeDocs,"display","block")}else{aa.set(this._LiveSearch.titleNodeDocs,"display","none");aa.set(this._LiveSearch.containerNodeDocs,"display","none")}if(this.resultsCounts.sites>0){af=true;aa.set(this._LiveSearch.titleNodeSites,"display","block");aa.set(this._LiveSearch.containerNodeSites,"display","block")}else{aa.set(this._LiveSearch.titleNodeSites,"display","none");aa.set(this._LiveSearch.containerNodeSites,"display","none")}if(this.resultsCounts.people>0){af=true;aa.set(this._LiveSearch.titleNodePeople,"display","block");aa.set(this._LiveSearch.containerNodePeople,"display","block")}else{aa.set(this._LiveSearch.titleNodePeople,"display","none");aa.set(this._LiveSearch.containerNodePeople,"display","none")}var ag=k.trim(this._searchTextNode.value);if(this.enableContextLiveSearch===true&&this.siteContext===true&&ag.length>=this._minimumSearchLength){af=true}if(af){aa.set(this._LiveSearch.containerNode,"display","block")}else{aa.set(this._LiveSearch.containerNode,"display","none")}},clearResults:function d(){this._searchTextNode.value="";if(this.liveSearch){this.lastSearchText="";for(var af=0;af<this._requests.length;af++){this._requests[af].cancel()}this._requests=[];this.resultsCounts={};this._LiveSearch.containerNodeEntities.innerHTML="";this._LiveSearch.containerNodeDocs.innerHTML="";this._LiveSearch.containerNodePeople.innerHTML="";this._LiveSearch.containerNodeSites.innerHTML="";aa.set(this._LiveSearch.nodeEntitiesMore,"display","none");aa.set(this._LiveSearch.nodeDocsMore,"display","none");this.updateResults()}this._searchTextNode.focus()},addAccessibilityLabel:function v(){R.create("label",{"for":"HEADER_SEARCHBOX_FORM_FIELD",innerHTML:this.message(this.accessibilityInstruction),"class":"hidden"},this._searchTextNode,"before")},onSearchClearClick:function r(af){this.clearResults();af.preventDefault()}})});