(function(){var b=YAHOO.util.Dom;beCPG.component.VariantPicker=function(e){beCPG.component.VariantPicker.superclass.constructor.call(this,"beCPG.component.VariantPicker",e,["button","container"]);this.name="beCPG.component.EntityDataListToolbar";return this};YAHOO.extend(beCPG.component.VariantPicker,Alfresco.component.Base);YAHOO.lang.augmentObject(beCPG.component.VariantPicker.prototype,{options:{entityNodeRef:"",entity:null,containerDiv:null,toolBarInstance:null,formWidth:"34em"},currentVariantNodeRef:null,onReady:function a(){var f=[{text:'<span class="variant-all">'+this.msg("picker.variant.all")+"</span>",value:"all",onclick:{fn:this.onMenuItemClick,scope:this}},{text:'<span class="variant-common">'+this.msg("picker.variant.common")+"</span>",value:"common",onclick:{fn:this.onMenuItemClick,scope:this}}];for(var e in this.options.entity.variants){var g='<span class="variant'+(this.options.entity.variants[e].isDefaultVariant?"-default":"")+'">'+this.options.entity.variants[e].name+"</span>";f.push({text:g,value:this.options.entity.variants[e].nodeRef,onclick:{fn:this.onMenuItemClick,scope:this}})}this.widgets.variantPicker=new YAHOO.widget.Button({type:"split",label:this.msg("picker.variant.choose"),name:"mymenubutton",menu:f,container:this.options.containerDiv,lazyloadmenu:false});this.widgets.createVariantButton=this.createYUIButton(this,"create-variant",this.onCreateVariant);this.widgets.editVariantButton=this.createYUIButton(this,"edit-variant",this.onEditVariant);this.widgets.duplicateVariantButton=this.createYUIButton(this,"duplicate-variant",this.onDuplicateVariant);this.widgets.deleteVariantButton=this.createYUIButton(this,"delete-variant",this.onDeleteVariant);b.setStyle(this.widgets.editVariantButton,"display","none");b.setStyle(this.widgets.duplicateVariantButton,"display","none");b.setStyle(this.widgets.deleteVariantButton,"display","none")},createYUIButton:function(f,g,j){var i=b.get("custom-toolBar-template-button"),h=null;var e=b.getFirstChild(i).cloneNode(true);b.addClass(e,g);b.setAttribute(e,"id",this.id+"-"+g+"Button");this.options.containerDiv.appendChild(e);h=Alfresco.util.createYUIButton(this,g+"Button",j);h.set("label",this.msg("button."+g));h.set("title",this.msg("button."+g+".description"));return h},onMenuItemClick:function(g,f,e){if(e){var h=e.cfg.getProperty("text"),i=e.value;this.widgets.variantPicker.set("label",h);if("all"===i||"common"===i){this.currentVariantNodeRef=null;b.setStyle(this.widgets.createVariantButton,"display","");b.setStyle(this.widgets.editVariantButton,"display","none");b.setStyle(this.widgets.duplicateVariantButton,"display","none");b.setStyle(this.widgets.deleteVariantButton,"display","none");if("all"===e.value){YAHOO.Bubbling.fire("changeFilter",{filterOwner:this.id,filterId:"all"})}else{if("common"===e.value){YAHOO.Bubbling.fire("changeFilter",{filterOwner:this.id,filterId:"fts",filterData:"ISNULL:bcpg\\:variantIds OR ISUNSET:bcpg\\:variantIds"})}}}else{YAHOO.Bubbling.fire("changeFilter",{filterOwner:this.id,filterId:"fts",filterData:'@bcpg\\:variantIds:"'+e.value+'" OR ISNULL:bcpg\\:variantIds OR ISUNSET:bcpg\\:variantIds'});this.currentVariantNodeRef=e.value;b.setStyle(this.widgets.createVariantButton,"display","none");b.setStyle(this.widgets.editVariantButton,"display","");b.setStyle(this.widgets.duplicateVariantButton,"display","");b.setStyle(this.widgets.deleteVariantButton,"display","")}}},onCreateVariant:function c(){var f=this;var g=function(k,l){Alfresco.util.populateHTML([l.id+"-dialogTitle",f.msg("label.new-variant.title")])};var j=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&destination={destination}&association={association}&mode={mode}&submitType={submitType}&showCancelButton=true&popup=true",{itemKind:"type",itemId:"bcpg:variant",destination:f.options.entityNodeRef,association:"bcpg:variants",mode:"create",submitType:"json"});var i=new Alfresco.module.SimpleDialog(f.id+"-createVariant");i.setOptions({width:f.options.formWidth,templateUrl:j,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:g,scope:this},onSuccess:{fn:function e(k){Alfresco.util.Ajax.jsonRequest({url:Alfresco.constants.PROXY_URI+"api/forms/picker/items",method:"POST",dataObj:{items:[k.json.persistedObject]},successCallback:{fn:function(p){var m=p.json.data.items,o=[];for(var n=0,l=m.length;n<l;n++){o.push({text:m[n].name,value:m[n].nodeRef,onclick:{fn:f.onMenuItemClick,scope:f}})}f.widgets.variantPicker.getMenu().addItems(o);Alfresco.util.PopupManager.displayMessage({text:f.msg("message.create-variant.success")})},scope:f}})},scope:this},onFailure:{fn:function h(k){Alfresco.util.PopupManager.displayMessage({text:f.msg("message.create-variant.failure")})},scope:this}}).show()},onDuplicateVariant:function d(){var f=this;var g=function(k,l){Alfresco.util.populateHTML([l.id+"-dialogTitle",f.msg("label.duplicate-variant.title")])};var j=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&formId=duplicate&itemId={itemId}&destination={destination}&association={association}&mode={mode}&submitType={submitType}&showCancelButton=true&popup=true",{itemKind:"type",itemId:"bcpg:variant",destination:f.options.entityNodeRef,association:"bcpg:variants",mode:"create",submitType:"json"});var i=new Alfresco.module.SimpleDialog(f.id+"-createVariant");i.setOptions({width:f.options.formWidth,templateUrl:j,actionUrl:Alfresco.constants.PROXY_URI+"/becpg/variant/duplicate?nodeRef="+f.currentVariantNodeRef,destroyOnHide:true,doBeforeDialogShow:{fn:g,scope:this},onSuccess:{fn:function e(k){Alfresco.util.Ajax.jsonRequest({url:Alfresco.constants.PROXY_URI+"api/forms/picker/items",method:"POST",dataObj:{items:[k.json.persistedObject]},successCallback:{fn:function(p){var m=p.json.data.items,o=[];for(var n=0,l=m.length;n<l;n++){o.push({text:m[n].name,value:m[n].nodeRef,onclick:{fn:f.onMenuItemClick,scope:f}})}f.widgets.variantPicker.getMenu().addItems(o);YAHOO.Bubbling.fire("changeFilter",{filterOwner:f.id,filterId:"all"});Alfresco.util.PopupManager.displayMessage({text:f.msg("message.duplicate-variant.success")})},scope:f}})},scope:this},onFailure:{fn:function h(k){Alfresco.util.PopupManager.displayMessage({text:f.msg("message.duplicate-variant.failure")})},scope:this}}).show()},onEditVariant:function c(){var e=this;if(e.currentVariantNodeRef){var g=function(i,j){Alfresco.util.populateHTML([j.id+"-dialogTitle",e.msg("label.edit-variant.title")])};var h=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&mode={mode}&submitType={submitType}&showCancelButton=true&popup=true",{itemKind:"node",itemId:e.currentVariantNodeRef,mode:"edit",submitType:"json"});var f=new Alfresco.module.SimpleDialog(e.id+"-editVariant");f.setOptions({width:e.options.formWidth,templateUrl:h,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:g,scope:this},onSuccess:{fn:function(i){Alfresco.util.Ajax.jsonRequest({url:Alfresco.constants.PROXY_URI+"api/forms/picker/items",method:"POST",dataObj:{items:[i.json.persistedObject]},successCallback:{fn:function(o){var k=o.json.data.items,n=e.widgets.variantPicker.getMenu().getItems();for(var m=0,j=k.length;m<j;m++){for(var l in n){if(n.hasOwnProperty(l)){if(n[l].value===k[m].nodeRef){e.widgets.variantPicker.getMenu().removeItem(n[l]);e.widgets.variantPicker.getMenu().addItem({text:k[m].name,value:k[m].nodeRef,onclick:{fn:e.onMenuItemClick,scope:e}});e.widgets.variantPicker.set("label",k[m].name)}}}}e.widgets.variantPicker.getMenu().addItems(n);Alfresco.util.PopupManager.displayMessage({text:e.msg("message.edit-variant.success")})},scope:e}})},scope:this},onFailure:{fn:function(i){Alfresco.util.PopupManager.displayMessage({text:e.msg("message.edit-variant.failure")})},scope:this}}).show()}},onDeleteVariant:function c(){var e=this,g=[e.currentVariantNodeRef];if(e.currentVariantNodeRef){var f=function(h){Alfresco.util.Ajax.jsonRequest({url:Alfresco.constants.PROXY_URI+"slingshot/datalists/action/items?alf_method=delete",method:"POST",dataObj:{nodeRefs:h},successCallback:{fn:function(k){var n=e.widgets.variantPicker.getMenu().getItems();for(var m=0,j=h.length;m<j;m++){for(var l in n){if(n.hasOwnProperty(l)){if(n[l].value===h[m]){e.widgets.variantPicker.getMenu().removeItem(n[l]);break}}e.widgets.variantPicker.set("label",e.msg("picker.variant.choose"));b.setStyle(e.widgets.createVariantButton,"display","");b.setStyle(e.widgets.editVariantButton,"display","none");b.setStyle(this.widgets.duplicateVariantButton,"display","none");b.setStyle(e.widgets.deleteVariantButton,"display","none")}}Alfresco.util.PopupManager.displayMessage({text:e.msg("message.delete-variant.success")})},scope:e}})};Alfresco.util.PopupManager.displayPrompt({title:e.msg("message.confirm.delete.title",g.length),text:e.msg("message.confirm.delete.description",g.length),buttons:[{text:e.msg("button.delete"),handler:function(){this.destroy();f.call(e,g)}},{text:e.msg("button.cancel"),handler:function(){this.destroy()},isDefault:true}]})}}},true)})();