(function(){var f=YAHOO.util.Dom,i=YAHOO.util.Event,b=YAHOO.util.Selector;var e=Alfresco.util.encodeHTML;var a=Alfresco.util.generateDomId(null,"notificationsReqType");beCPG.component.ProductNotifications=function(k){beCPG.component.ProductNotifications.superclass.constructor.call(this,"beCPG.component.ProductNotifications",k,["button","container"]);this.name="beCPG.component.EntityDataListToolbar";return this};YAHOO.extend(beCPG.component.ProductNotifications,Alfresco.component.Base);YAHOO.lang.augmentObject(beCPG.component.ProductNotifications.prototype,{options:{entityNodeRef:"",reqCtrlListNodeRef:"",containerDiv:null,list:null},filterId:"all",filterData:"",filterParams:null,currentPage:1,onReady:function h(){var k=this;this.widgets.panelDiv=document.createElement("div");this.widgets.panelDiv.style.zIndex="3";var l='<div class="notifications-panel"><div id="'+k.id+'-scoresDiv" class="ctrlSumPreview  " >';l+='</div><div id="'+k.id+'-notificationTable"></div></div>';this.widgets.panelDiv.innerHTML=l;this.widgets.showNotificationsButton=k.createShowNotificationButton(this,"show-notifications",this.widgets.panelDiv,function(){k.reloadDataTable()});this.loadPanelData();YAHOO.Bubbling.on("refreshDataGrids",this.loadPanelData,this);YAHOO.Bubbling.addDefaultAction(a,function(p,r){var m=YAHOO.Bubbling.getOwnerByTagName(r[1].anchor,"span");var o=document.getElementsByClassName("rclFilterSelected");for(var q=0;q<o.length;q++){o[q].classList.remove("rclFilterSelected")}var n=m;if(m.parentNode.nodeName=="LI"){n=m.parentNode}f.addClass(n,"rclFilterSelected");var u=m.className.split(" ")[0].split("-");var s=(u.length>2?u[2]:undefined);var t=u[1].charAt(0).toUpperCase()+u[1].slice(1);k.filterId=(s==="all"&&t==="All"?"all":"filterform");k.filterData=(s==="all"&&t==="All"?undefined:"{"+(s!==undefined?('"prop_bcpg_rclReqType":"'+s+'"'):"")+(t!==null?(s!==undefined?",":"")+('"prop_bcpg_rclDataType":"'+t+'"'):"")+"}");k.reloadDataTable()},true)},createShowNotificationButton:function(l,m,q,p){var o=f.get("custom-toolBar-template-button"),n=null;var k=f.getFirstChild(o).cloneNode(true);f.addClass(k,m);f.addClass(k,"loading");f.setAttribute(k,"id",l.id+"-"+m+"Button");this.options.containerDiv.appendChild(k);n=Alfresco.util.createYUIButton(l,m+"Button",null,{type:"menu",menu:q,lazyloadmenu:false});n.getMenu().subscribe("show",p,n,this);return n},createDataTable:function(){var k=this;k.widgets.dataSource=new YAHOO.util.DataSource(this.getWebscriptUrl(),{connMethodPost:true,responseType:YAHOO.util.DataSource.TYPE_JSON,responseSchema:{resultsList:"items",metaFields:{startIndex:"startIndex",totalRecords:"totalRecords"}}});var o=[{key:"detail",sortable:false,formatter:this.bind(this.renderCellDetail)}];k.widgets.notificationsDataTable=new YAHOO.widget.DataTable(k.id+"-notificationTable",o,k.widgets.dataSource,{initialLoad:false,dynamicData:false,MSG_EMPTY:'<span class="wait">'+e(this.msg("message.loading"))+"</span>",MSG_ERROR:this.msg("message.error"),className:"alfresco-datatable simple-doclist body notifications-list",renderLoopSize:4,paginator:null});k.widgets.notificationsDataTable.getDataTable=function(){return this};k.widgets.notificationsDataTable.getData=function(p){return this.getRecord(p).getData()};k.widgets.notificationsDataTable.loadDataTable=function m(q){k.widgets.dataSource.connMgr.setDefaultPostHeader(Alfresco.util.Ajax.JSON);if(Alfresco.util.CSRFPolicy.isFilterEnabled()){k.widgets.dataSource.connMgr.initHeader(Alfresco.util.CSRFPolicy.getHeader(),Alfresco.util.CSRFPolicy.getToken(),false)}k.widgets.dataSource.sendRequest(YAHOO.lang.JSON.stringify(q),{success:function p(s,r,t){k.widgets.notificationsDataTable.onDataReturnReplaceRows(s,r,t);if(k.widgets.paginator){k.widgets.paginator.set("totalRecords",r.meta.totalRecords);k.widgets.paginator.setPage(r.meta.startIndex,true)}},failure:k.widgets.notificationsDataTable.onDataReturnReplaceRows,scope:k.widgets.notificationsDataTable,argument:{}})};var n=k.widgets.notificationsDataTable.doBeforeLoadData;k.widgets.notificationsDataTable.doBeforeLoadData=function l(p,q,r){if(q.results&&q.results.length===0){q.results.unshift({isInfo:true,title:k.msg("empty.notifications.title"),description:k.msg("empty.notifications.description")})}return n.apply(this,arguments)}},loadPanelData:function(){var k=this;Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"becpg/product/reqctrllist/node/"+k.options.entityNodeRef.replace(":/",""),method:Alfresco.util.Ajax.GET,responseContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(m){if(m.json){var q="";if(m.json.scores!==undefined){var l=m.json.scores;var s=parseInt(l.global);var v=(s/5>>0);var r=k.msg("tooltip.components.validation")+": "+Math.floor(l.details.componentsValidation)+"%\n"+k.msg("tooltip.mandatory.completion")+": "+Math.floor(l.details.mandatoryFields)+"%\n"+k.msg("tooltip.specification.respect")+": "+Math.floor(l.details.specifications)+"%";q+='<ul><li class="title">'+k.msg("label.product.scores")+'</li><li class="score score-'+v+'" title="'+r+'">';q+="<span>"+Math.floor(l.global)+"%</span>";q+="</li></ul>";var z="score-"+v;var o=l.totalForbidden;if(!f.hasClass(k.widgets.showNotificationsButton,"score")){k.widgets.showNotificationsButton.removeClass("loading");k.widgets.showNotificationsButton.addClass("score");k.widgets.showNotificationsButton.addClass(z)}k.widgets.showNotificationsButton.set("label",Math.floor(l.global)+"%");if(o!==undefined&&o!==null&&o>0){k.widgets.showNotificationsButton.set("title",this.msg("tooltip.notifications-button",o));var p=f.getFirstChildBy(this.options.containerDiv,function(A){return A.className.indexOf("warning")>-1});if(p===null){p=document.createElement("span");p.className="warning";this.options.containerDiv.appendChild(p)}p.innerHTML=(o!==undefined&&o!==null&&o>0?o:"")}if(l.ctrlCount!==undefined&&l.ctrlCount!=null&&l.ctrlCount.length>0){q+='<div class="dataTypeList"><div class="title">'+k.msg("label.constraints.violations")+'<span class="req-all-all rclFilterSelected"><a class="req-filter '+a+'" href="#">'+k.msg("label.constraints.view-all")+"</a></span></div>";q+='<div class="rclFilterElt"><div>';for(var w in l.ctrlCount){var y="";var n=Object.keys(l.ctrlCount[w])[0];q+='<div class="div-'+n.toString().toLowerCase()+'"><span class="span-'+n.toString().toLowerCase()+'"><a class="req-filter '+a+'" href="#" >'+k.msg("label.constraints."+n.toString().toLowerCase())+y+"</a></span><ul>";var t=l.ctrlCount[w];for(var u in t[n]){var x=t[n][u];q+='<li><span class="req-'+n.toString().toLowerCase()+"-"+u+'" title="'+k.msg("reqTypes."+u)+'"><a class="req-filter '+a+'" href="#"><span class="reqType'+u+'"></span>'+x+"</a></li>"}q+="</ul></div>"}q+="</div></div></div>"}}if(f.get(k.id+"-scoresDiv")!=null){f.get(k.id+"-scoresDiv").innerHTML=q}if(!k.widgets.notificationsDataTable){k.createDataTable()}}},scope:k},failureMessage:"Could not load html template for version graph",execScripts:true})},getWebscriptUrl:function c(){return Alfresco.constants.PROXY_URI+"becpg/entity/datalists/data/node?guessContainer=true&repo=true&itemType=bcpg:reqCtrlList&pageSize=20&dataListName=reqCtrlList&entityNodeRef="+this.options.entityNodeRef},getParameters:function g(){var k={fields:["bcpg_rclReqType","bcpg_rclReqMessage","bcpg_rclSources","bcpg_rclDataType"],page:this.currentPage,filter:{filterId:this.filterId,filterOwner:null,filterData:this.filterData,filterParams:this.filterParams},extraParams:null};return k},renderCellDetail:function d(r,v,p,l){var n=v.getData(),o="",q="";if(n.isInfo){o+='<div class="empty"><h3>'+n.title+"</h3>";o+="<span>"+n.description+"</span></div>"}else{var k=v.getData("itemData")["prop_bcpg_rclReqType"].value;var u=v.getData("itemData")["assoc_bcpg_rclSources"];o+='<div class="rclReq-details">';if(k){o+='   <div class="icon" ><span class="reqType'+k+'" title="'+Alfresco.util.encodeHTML(this.msg("data.reqtype."+k.toLowerCase()))+'">&nbsp;</span></div>'}o+='      <div class="rclReq-title">'+Alfresco.util.encodeHTML(v.getData("itemData")["prop_bcpg_rclReqMessage"].displayValue)+"</div>";o+='      <div class="rclReq-content"><ul>';if(u){for(var m in u){var s=u[m],t=beCPG.util.entityURL(s.siteId,s.value);if(s.metadata.indexOf("finishedProduct")!=-1||s.metadata.indexOf("semiFinishedProduct")!=-1){t=beCPG.util.entityURL(s.siteId,s.value,null,null,"compoList")}else{if(s.metadata.indexOf("packagingKit")!=-1){t=beCPG.util.entityURL(s.siteId,s.value,null,null,"packagingList")}}if(t){t+="&bcPath=true&bcList="+this.options.list}o+='<li><span class="'+s.metadata+'" ><a href="'+t+'">'+Alfresco.util.encodeHTML(s.displayValue)+"</a></span></li>"}}+"</ul></div>";o+="   </div>";o+='   <div class="clear"></div>';o+="</div>"}r.innerHTML=o},reloadDataTable:function j(){this.widgets.notificationsDataTable.loadDataTable(this.getParameters())},destroy:function(){YAHOO.Bubbling.unsubscribe("refreshDataGrids",this.loadPanelData,this);this.widgets.showNotificationsButton.destroy();this.widgets.notificationsDataTable.destroy();this.options.containerDiv.parentNode.removeChild(this.options.containerDiv);this.options.containerDiv.innerHTML="";this.widgets.panelDiv.innerHTML=""}},true)})();