(function(){var b=YAHOO.util.Dom,E=YAHOO.util.Event,x=YAHOO.util.Selector;var t=Alfresco.util.encodeHTML,f=Alfresco.util.userProfileLink,e=Alfresco.util.relativeTime,z=Alfresco.util.isValueSet;var d="org.alfresco.share.product.catalog.dashlet{site}",o=d+".filter",D=d+".simpleView",s=d+".type";var h=Alfresco.util.generateDomId(null,"favourite")+"{type}";beCPG.dashlet.BeCPGCatalog=function v(F){return beCPG.dashlet.BeCPGCatalog.superclass.constructor.call(this,F)};YAHOO.extend(beCPG.dashlet.BeCPGCatalog,Alfresco.component.SimpleDocList,{searchTerm:null,onReady:function i(){this.widgets.filter=Alfresco.util.createYUIButton(this,"filters",this.onFilterChange,{type:"menu",menu:"filters-menu",lazyloadmenu:false});var I=this.options.filter;I=Alfresco.util.arrayContains(this.options.validFilters,I)?I:this.options.validFilters[0];this.widgets.filter.set("label",this.msg("filter."+I)+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.filter.value=I;this.widgets.type=Alfresco.util.createYUIButton(this,"types",this.onTypeChange,{type:"menu",menu:"types-menu",lazyloadmenu:false});this.widgets.type.set("label",this.msg("type."+this.options.catalogType)+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.type.value=this.options.catalogType;this.widgets.simpleDetailed=new YAHOO.widget.ButtonGroup(this.id+"-simpleDetailed");if(this.widgets.simpleDetailed!==null){this.widgets.simpleDetailed.check(this.options.simpleView?0:1);this.widgets.simpleDetailed.on("checkedButtonChange",this.onSimpleDetailed,this.widgets.simpleDetailed,this)}this.configureSearch();b.removeClass(x.query(".toolbar div",this.id,true),"hidden");var J=this;this.widgets.previewTooltip=new YAHOO.widget.Tooltip(this.id+"-previewTooltip",{width:"108px"});this.widgets.previewTooltip.contextTriggerEvent.subscribe(function(P,N){var O=N[0],M=J.widgets.alfrescoDataTable.getData(O.id),Q=Alfresco.constants.PROXY_URI+"api/node/"+M.nodeRef.replace(":/","")+"/content/thumbnails/doclib?c=queue&ph=true";this.cfg.setProperty("text",'<img src="'+Q+'" />')});this.widgets.metadataTooltip=new YAHOO.widget.Tooltip(this.id+"-metadataTooltip");this.widgets.metadataTooltip.contextTriggerEvent.subscribe(function(Q,O){var P=O[0],N=J.widgets.alfrescoDataTable.getData(P.id),M=N.location;var R="<em>"+J.msg("label.site")+":</em> "+t(M.siteTitle)+"<br />";R+="<em>"+J.msg("label.path")+":</em> "+t(M.path);this.cfg.setProperty("text",R)});this.widgets.alfrescoDataTable=new Alfresco.util.DataTable({dataSource:{url:this.getWebscriptUrl(),initialParameters:this.getParameters(),config:{responseSchema:{resultsList:"items"}}},dataTable:{container:this.id+"-documents",columnDefinitions:[{key:"thumbnail",sortable:false,formatter:this.bind(this.renderCellThumbnail),width:16},{key:"detail",sortable:false,formatter:this.bind(this.renderCellDetail)}],config:{className:"alfresco-datatable simple-doclist",renderLoopSize:4}}});var K=this.widgets.alfrescoDataTable.getDataTable(),H=K.doBeforeLoadData;K.doBeforeLoadData=function G(M,N,O){if(N.results&&N.results.length===0){N.results.unshift({isInfo:true,title:J.msg("empty.product.title"),description:J.msg("empty.product.description")})}return H.apply(this,arguments)};K.subscribe("renderEvent",function(){this.widgets.previewTooltip.cfg.setProperty("context",this.previewTooltips);this.widgets.metadataTooltip.cfg.setProperty("context",this.metadataTooltips)},this,true);var L=function F(O,N){var M=YAHOO.Bubbling.getOwnerByTagName(N[1].anchor,"div");if(M!==null){J.onFavourite.call(J,N[1].target.offsetParent,M)}return true};YAHOO.Bubbling.addDefaultAction(this.substitute(h),L)},getWebscriptUrl:function c(){if(Alfresco.constants.SITE!==null&&Alfresco.constants.SITE.length>0){return Alfresco.constants.PROXY_URI+"slingshot/doclib/doclist/product/site/"+Alfresco.constants.SITE+"/documentLibrary?max="+this.options.maxItems+"&sortField=cm:modified&sortAsc=false"}return Alfresco.constants.PROXY_URI+"slingshot/doclib/doclist/product/node/alfresco/company/home?max="+this.options.maxItems+"&sortField=cm:modified&sortAsc=false"},getParameters:function m(){var F="type="+this.widgets.type.value+"&filter="+this.widgets.filter.value;if(this.searchTerm!==null&&this.searchTerm.length>0){F+="&searchTerm="+this.searchTerm}return F},onFilterChange:function k(G,F){var H=F[1];if(H){this.widgets.filter.set("label",H.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.filter.value=H.value;this.services.preferences.set(this.substitute(o),this.widgets.filter.value);var I=this.getSearchText();if(I.replace(/\*/g,"").length<3){this.searchTerm=null}else{this.searchTerm=I}this.reloadDataTable()}},onTypeChange:function C(G,F){var H=F[1];if(H){this.widgets.type.set("label",H.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.type.value=H.value;this.services.preferences.set(this.substitute(s),this.widgets.type.value);var I=this.getSearchText();if(I.replace(/\*/g,"").length<3){this.searchTerm=null}else{this.searchTerm=I}this.reloadDataTable()}},onSimpleDetailed:function j(F,G){this.options.simpleView=F.newValue.index===0;this.services.preferences.set(this.substitute(D),this.options.simpleView);if(F){E.preventDefault(F)}this.reloadDataTable()},renderCellThumbnail:function B(O,R,L,G){var H=40,J=R.getData(),K="";J.jsNode={};J.jsNode.type=J.nodeType;if(J.isInfo){H=52;K='<img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/help-docs-bw-32.png" />'}else{var I=J.fileName,Q=z(J.location.site)?J.location.site:null,M=J.nodeType.substring(J.nodeType.lastIndexOf(":")+1),N=new Alfresco.util.NodeRef(J.nodeRef),P=beCPG.util.entityURL(Q,J.nodeRef,J.nodeType);if(this.options.simpleView){var F=this.id+"-preview-"+R.getId();K='<span id="'+F+'" class="icon32"><a href="'+P+'"><img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/filetypes/"+Alfresco.util.getFileIcon(I,J.nodeType)+'" alt="'+M+'" title="'+t(I)+'" /></a></span>';this.previewTooltips.push(F)}else{H=100;K='<span class="thumbnail"><a href="'+P+'"><img src="'+Alfresco.constants.PROXY_URI+"api/node/"+N.uri+'/content/thumbnails/doclib?c=queue&ph=true" alt="'+M+'" title="'+t(I)+'" /></a></span>'}}L.width=H;b.setStyle(O,"width",L.width+"px");b.setStyle(O.parentNode,"width",L.width+"px");O.innerHTML=K},renderCellDetail:function u(R,U,M,H){var K=U.getData(),L="";if(K.isInfo){L+='<div class="empty"><h3>'+K.title+"</h3>";L+="<span>"+K.description+"</span></div>"}else{var I=this.id+"-metadata-"+U.getId(),T=z(K.location.site)?K.location.site:null,N="",P="",O=K.location,S=beCPG.util.entityURL(T,K.nodeRef,K.nodeType,null,"View-properties");if(K.version&&K.version!==""){N='<span class="document-version">'+t(K.version)+"</span>"}var G="modified",F=K.modifiedOn;if(K.custom&&K.custom.isWorkingCopy){G="editing-started"}else{if(K.modifiedOn===K.createdOn){G="created";F=K.createdOn}}if(Alfresco.constants.SITE===""){P=this.msg("details."+G+"-in-site",e(F),Alfresco.util.siteDefaultPageLink(O.site,O.siteTitle,'class="site-link theme-color-1" id="'+I+'"'))}else{P=this.msg("details."+G+"-by",e(F),f(K.modifiedByUser,K.modifiedBy,'class="theme-color-1"'))}if(this.options.simpleView){L+='<h3 class="filename simple-view"><a class="theme-color-1" href="'+S+'">'+t(K.displayName)+"</a></h3>";L+='<div class="detail"><span class="item-simple">'+P+"</span></div>"}else{L+='<h3 class="filename"><a class="theme-color-1" href="'+S+'">'+t(K.displayName)+"</a>"+N+"</h3>";L+='<div class="detail">';L+='<span class="item">'+P+"</span>";L+="</div>";var J=beCPG.util.entityURL(T,K.nodeRef,K.nodeType),Q=beCPG.util.entityURL(T,K.nodeRef,K.nodeType,null,"View-reports");L+='<div class="detail detail-social">';L+='<span class="item item-social">'+this.generateFavourite(this,U)+"</span>";L+='<span class="item item-social item-separator"><a class="view-reports" href="'+Q+'"  title="'+this.msg("actions.entity.view-reports")+'" tabindex="0">'+this.msg("actions.entity.view-reports.short")+"</a></span>";L+='<span class="item item-social item-separator"><a class="view-characts" href="'+J+'" title="'+this.msg("actions.entity.view-datalists")+'" tabindex="0">'+this.msg("actions.entity.view-datalists.short")+"</a></span>";L+="</div>"}this.metadataTooltips.push(I)}R.innerHTML=L},generateFavourite:function p(H,F){var I="favourite.document.",G="";if(F.getData("isFavourite")){G='<a class="favourite-action '+H.substitute(h)+' enabled" title="'+H.msg(I+"remove.tip")+'" tabindex="0"></a>'}else{G='<a class="favourite-action '+H.substitute(h)+'" title="'+H.msg(I+"add.tip")+'" tabindex="0">'+H.msg(I+"add.label")+"</a>"}return G},onFavourite:function A(J){var F=this.widgets.alfrescoDataTable.getRecord(J),H=F.getData(),I=H.nodeRef;H.isFavourite=!H.isFavourite;this.widgets.alfrescoDataTable.getDataTable().updateRow(F,H);var G={failureCallback:{fn:function K(O,L){var M=this.widgets.alfrescoDataTable.getRecord(L),N=M.getData();N.isFavourite=!N.isFavourite;this.widgets.alfrescoDataTable.getDataTable().updateRow(M,N);Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.save.failure",N.displayName)})},scope:this,obj:J}};this.services.preferences[H.isFavourite?"add":"remove"].call(this.services.preferences,Alfresco.service.Preferences.FAVOURITE_FOLDERS,I,G)},configureSearch:function a(){this.widgets.searchBox=b.get(this.id+"-searchText");this.defaultSearchText=this.msg("header.search.default");E.addListener(this.widgets.searchBox,"focus",this.onSearchFocus,null,this);E.addListener(this.widgets.searchBox,"blur",this.onSearchBlur,null,this);this.setDefaultSearchText();var F=this;this.widgets.searchEnterListener=new YAHOO.util.KeyListener(this.widgets.searchBox,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:F.onSearchChange,scope:this,correctScope:true},"keydown").enable();this.widgets.searchMore=new YAHOO.widget.Button(this.id+"-search_more",{type:"menu",menu:this.id+"-searchmenu_more"})},onSearchFocus:function q(){if(this.widgets.searchBox.value==this.defaultSearchText){b.removeClass(this.widgets.searchBox,"faded");this.widgets.searchBox.value=""}else{this.widgets.searchBox.select()}},onSearchBlur:function l(){var F=YAHOO.lang.trim(this.widgets.searchBox.value);if(F.length===0){YAHOO.lang.later(100,this,this.setDefaultSearchText,[])}},setDefaultSearchText:function y(){b.addClass(this.widgets.searchBox,"faded");this.widgets.searchBox.value=this.defaultSearchText},getSearchText:function w(){var F=YAHOO.lang.trim(this.widgets.searchBox.value);if(F!=this.defaultSearchText){return F}return""},onSearchChange:function n(){this.searchTerm=this.getSearchText();this.reloadDataTable()},onActionShowCharact:function g(H){var F=this.widgets.alfrescoDataTable.getData(H);var G=z(F.location.site)?F.location.site:null;window.location.href=beCPG.util.entityURL(G,F.nodeRef,F.nodeType)},substitute:function r(F){return YAHOO.lang.substitute(F,{site:Alfresco.constants.SITE!==null&&Alfresco.constants.SITE.length>0?"."+Alfresco.constants.SITE:""})}})})();