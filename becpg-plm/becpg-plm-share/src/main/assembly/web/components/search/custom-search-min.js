(function(){var f=YAHOO.util.Dom,i=YAHOO.util.Event;var e=Alfresco.util.encodeHTML;beCPG.custom.Search=function d(o){beCPG.custom.Search.superclass.constructor.call(this,o);return this};YAHOO.extend(beCPG.custom.Search,Alfresco.Search,{options:{siteId:"",siteTitle:"",maxSearchResults:250,pageSize:50,initialSearchTerm:"",initialSearchTag:"",metadataFields:"",initialSearchAllSites:true,initialSearchRepository:false,initialSort:"",searchQuery:"",searchRootNode:"",minSearchTermLength:1},onReady:function h(){var v=this;var p=Alfresco.constants.PROXY_URI_RELATIVE+"becpg/search?";this.widgets.dataSource=new YAHOO.util.DataSource(p,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"items",metaFields:{page:"page",pageSize:"pageSize",fullListSize:"fullListSize"}}});var s=function u(y,x){x.currentPage=y.page;x.widgets.paginator.setState(y);YAHOO.Bubbling.fire("onSearch")};this.widgets.paginator=new YAHOO.widget.Paginator({containers:[this.id+"-paginator-top",this.id+"-paginator-bottom"],rowsPerPage:this.options.pageSize,initialPage:1,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});this.widgets.paginator.subscribe("changeRequest",s,this);this._setupDataTable();var r=f.get(this.id+"-search-text");r.value=this.options.initialSearchTerm;YAHOO.Bubbling.fire("onSearch",{searchTerm:this.options.initialSearchTerm,searchTag:this.options.initialSearchTag,searchSort:this.options.initialSort,searchAllSites:this.options.initialSearchAllSites,searchRepository:this.options.initialSearchRepository});this.widgets.sortButton=new YAHOO.widget.Button(this.id+"-sort-menubutton",{type:"menu",menu:this.id+"-sort-menu",menualignment:["tr","br"],lazyloadmenu:false});var o=this.widgets.sortButton.getMenu().getItems();for(var q in o){if(o[q].value===this.options.initialSort){this.widgets.sortButton.set("label",this.msg("label.sortby",o[q].cfg.getProperty("text"))+" "+Alfresco.constants.MENU_ARROW_SYMBOL);break}}this.widgets.sortButton.getMenu().subscribe("click",function(y,x){var z=x[1];if(z){v.refreshSearch({searchSort:z.value})}});this.widgets.bulkEditButton=Alfresco.util.createYUIButton(this,"bulk-edit",this.onBulkEditClick);if(f.get(this.id+"-wused")){this.widgets.wUsedButton=Alfresco.util.createYUIButton(this,"wused",this.onWUsedClick)}if(f.get(this.id+"-export-menubutton")){this.widgets.exportButton=new YAHOO.widget.Button(this.id+"-export-menubutton",{type:"menu",menu:this.id+"-export-menu",menualignment:["tr","br"],lazyloadmenu:false});var o=this.widgets.exportButton.getMenu().getItems();for(var q in o){if(o[q].value==="-"){this.widgets.exportButton.set("label",this.msg("label.export-search",o[q].cfg.getProperty("text"))+" "+Alfresco.constants.MENU_ARROW_SYMBOL);break}}this.widgets.exportButton.getMenu().subscribe("click",function(y,x){var z=x[1];if(z){v.exportSearch({reportTpl:z.value,reportFileName:z.srcElement.attributes.fileName.value,reportTplName:z.srcElement.attributes.reportTplName.value})}})}var w=function t(z,y){var x=YAHOO.Bubbling.getOwnerByTagName(y[1].anchor,"span");if(x!==null){if(typeof v[x.className]=="function"){y[1].stop=true;var A=x.id.substring(v.id.length+1);v[x.className].call(v,A)}}return true};YAHOO.Bubbling.addDefaultAction("search-tag",w);YAHOO.Bubbling.addDefaultAction("search-prop",w);f.setStyle(this.id+"-body","visibility","visible")},refreshSearch:function m(r){var p=this.searchTerm;if(r.searchTerm!==undefined){p=r.searchTerm}var s=this.searchTag;if(r.searchTag!==undefined){s=r.searchTag}var u=this.searchAllSites;if(r.searchAllSites!==undefined){u=r.searchAllSites}var v=this.searchRepository;if(r.searchRepository!==undefined){v=r.searchRepository}var o=this.searchSort;if(r.searchSort!==undefined){o=r.searchSort}var t=this.options.searchQuery;if(r.searchQuery!==undefined){t=r.searchQuery}var q=Alfresco.constants.URL_PAGECONTEXT;if(this.options.siteId.length!==0){q+="site/"+this.options.siteId+"/"}q+="search?t="+encodeURIComponent(p);q+="&s="+o;if(t.length!==0){q+="&q="+encodeURIComponent(t)}else{if(s.length!==0){q+="&tag="+encodeURIComponent(s)}}q+="&a="+u+"&r="+v;window.location=q},_setupDataTable:function n(){var r=this;renderCellThumbnail=function q(u,t,v,w){v.width=100;f.setStyle(u.parentNode,"width",v.width+"px");f.setStyle(u.parentNode,"background-color","#f4f4f4");f.addClass(u,"thumbnail-cell");if(t.getData("type")==="document"){f.addClass(u,"thumbnail")}u.innerHTML=r.buildThumbnailHtml(t)};renderCellDescription=function o(w,K,x,E){f.addClass(w.parentNode,"description");var C=K.getData("site");var u=r._getBrowseUrlForRecord(K);var v=K.getData("displayName");var y=K.getData("metadata");var I='<span class="itemname '+(y?(" "+y):"")+'"><a href="'+u+'" class="theme-color-1">'+e(v)+"</a>";var M=K.getData("title");if(M&&M!==v){I+='<span class="title">('+e(M)+")</span>"}I+="</span>";var B=K.getData("description");if(B){I+='<div class="details meta">'+e(B)+"</div>"}I+='<div class="details">';var t=K.getData("type");I+=r.buildTextForType(t);if(C){I+=" "+r.msg("message.insite");I+=' <a href="'+Alfresco.constants.URL_PAGECONTEXT+"site/"+e(C.shortName)+'/dashboard">'+e(C.title)+"</a>"}if(K.getData("size")!==-1){I+=" "+r.msg("message.ofsize");I+=' <span class="meta">'+Alfresco.util.formatFileSize(K.getData("size"))+"</span>"}if(K.getData("modifiedBy")){I+=" "+r.msg("message.modifiedby");I+=' <a href="'+Alfresco.constants.URL_PAGECONTEXT+"user/"+encodeURI(K.getData("modifiedByUser"))+'/profile">'+e(K.getData("modifiedBy"))+"</a>"}I+=" "+r.msg("message.modifiedon")+' <span class="meta">'+Alfresco.util.formatDate(K.getData("modifiedOn"))+"</span>";I+="</div>";var D=K.getData("path");I+=r.buildPath(t,D,C);var A=K.getData("tags");if(A&&A.length!==0){var H,F;I+='<div class="details"><span class="tags">'+r.msg("label.tags")+": ";for(H=0,F=A.length;H<F;H++){I+='<span id="'+r.id+"-"+e(A[H])+'" class="searchByTag"><a class="search-tag" href="#">'+e(A[H])+"</a> </span>"}I+="</span></div>"}var L=K.getData("itemType"),G=K.getData("itemData");if(G!=null){for(key in G){var J=G[key];var z=key+(J.type=="subtype"?"_added":"");if(J.displayValue!=null&&J.displayValue.length>0){I+='<div class="details">'+e(J.label)+": ";I+='<span id="'+r.id+"|"+e(z)+"|"+e(J.value)+"|"+e(L)+'" class="searchByProp" ><a class="search-prop" href="#">'+e(J.displayValue)+"</a></span>";I+="</div>"}else{if(J.length>0){for(jj in J){if(jj==0){I+='<div class="details">'+e(J[jj].label)+": "}else{I+=",&nbsp;"}I+='<span id="'+r.id+"|"+e(z)+"|"+e(J[jj].value)+"|"+e(L)+'" class="searchByProp" ><a class="search-prop" href="#">'+e(J[jj].displayValue)+"</a></span>"}I+="</div>"}}}}w.innerHTML=I};var s=[{key:"image",label:r.msg("message.preview"),sortable:false,formatter:renderCellThumbnail,width:100},{key:"summary",label:r.msg("label.description"),sortable:false,formatter:renderCellDescription}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-results",s,this.widgets.dataSource,{renderLoopSize:Alfresco.util.RENDERLOOPSIZE,initialLoad:false,MSG_LOADING:""});this._setDefaultDataTableErrors(this.widgets.dataTable);if(this.options.initialSearchTerm.length===0&&this.options.initialSearchTag.length===0){this.widgets.dataTable.set("MSG_EMPTY","")}this.widgets.dataTable.doBeforeLoadData=function p(u,v,x){if(v.error){try{var t=YAHOO.lang.JSON.parse(v.responseText);r.widgets.dataTable.set("MSG_ERROR",t.message)}catch(w){r._setDefaultDataTableErrors(r.widgets.dataTable)}}else{if(v.results){r.resultsCount=v.meta.fullListSize;r.currentPage=v.meta.page;r.widgets.dataTable.set("MSG_EMPTY","");r.hasMoreResults=(r.resultsCount>r.options.maxSearchResults);if(r.hasMoreResults){v.results=v.results.slice(0,r.options.maxSearchResults);r.resultsCount=r.options.maxSearchResults}if(r.resultsCount>r.options.pageSize){f.removeClass(r.id+"-paginator-top","hidden");f.removeClass(r.id+"-search-bar-bottom","hidden")}if(r.resultsCount===0){f.removeClass(r.id+"-help","hidden")}}}return true};r.widgets.dataTable.subscribe("renderEvent",function(){r.widgets.paginator.setState({page:r.currentPage,totalRecords:r.resultsCount});r.widgets.paginator.render()})},searchByProp:function l(q){var o=q.split("|")[0],p=q.split("|")[1];type=q.split("|")[2];this.refreshSearch({searchTag:"",searchTerm:this.searchTerm,searchQuery:encodeURIComponent('{"'+o+'":"'+p+'","datatype":"'+type+'"}')})},exportSearch:function a(s){var q=this.searchTerm;if(s.searchTerm!==undefined){q=s.searchTerm}var t=this.searchTag;if(s.searchTag!==undefined){t=s.searchTag}var p=this.searchSort;if(s.searchSort!==undefined){p=s.searchSort}var u=this.options.searchQuery;if(s.searchQuery!==undefined){u=s.searchQuery}var r=Alfresco.constants.PROXY_URI+"becpg/report/exportsearch/"+s.reportTpl.replace("://","/")+"/"+encodeURI(s.reportFileName);r+="?term="+encodeURIComponent(q);if(p.length!==0){r+="&sort="+encodeURIComponent(p)}if(u.length!==0){r+="&query="+encodeURIComponent(u)}else{if(t.length!==0){r+="&tag="+encodeURIComponent(t)}}r+="&site=&repo=true";if(s.reportFileName.indexOf(".zip")>0||s.reportTplName.indexOf(".xlsx")>0){r+="&async=true";var o=Alfresco.getArchiveAndDownloadInstance();o.mimeType=s.reportFileName.indexOf(".xlsx")>0?"-excel":"";o._resetGUI=function(){this.widgets.cancelOkButton.set("disabled",false);this._currentArchiveNodeURL="";f.setStyle(this.id+"-aggregate-progress-span","left","-300px");f.get(this.id+"-file-count-span").innerHTML="";f.get(this.id+"-aggregate-status-span").innerHTML=this.msg("status.label"+this.mimeType)};o.updateProgress=function(x){var w=x.done.replace(/,/g,"");var y=x.total.replace(/,/g,"");var v=y!=0?(w/y):0;var z=(-300+(v*300));f.setStyle(this.id+"-aggregate-progress-span","left",z+"px");f.get(this.id+"-file-count-span").innerHTML=this.msg("file.status"+this.mimeType,x.filesAdded,x.totalFiles)};o.showExport=function(v){this._resetGUI();this.widgets.escapeListener.enable();this.panel.setFirstLastFocusable();this.panel.show();this._currentArchiveName=v;Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.GET,url:r,responseContentType:"application/json",successCallback:{fn:this.archiveInitReqSuccess,scope:this},failureCallback:{fn:this.archiveInitReqFailure,scope:this}})};o.showExport(s.reportFileName)}else{window.location=r}},onBulkEditClick:function c(q,p){var o=Alfresco.constants.URL_PAGECONTEXT;o+="bulk-edit"+location.search;window.location=o},onWUsedClick:function k(q,p){var o=Alfresco.constants.URL_PAGECONTEXT;o+="wused"+location.search;window.location=o},_buildSearchParams:function b(t,s,p,r,o){var q=s?"":this.options.siteId;var u=YAHOO.lang.substitute("site={site}&term={term}&tag={tag}&maxResults={maxResults}&sort={sort}&query={query}&repo={repo}&metadataFields={metadataFields}&page={page}&pageSize={pageSize}&rootNode={rootNode}",{site:encodeURIComponent(q),repo:t.toString(),term:encodeURIComponent(p),tag:encodeURIComponent(r),sort:encodeURIComponent(o),query:encodeURIComponent(this.options.searchQuery),rootNode:encodeURIComponent(this.options.searchRootNode),metadataFields:encodeURIComponent(this.options.metadataFields),page:this.currentPage,pageSize:this.options.pageSize,maxResults:this.options.maxSearchResults+1});return u},_disableItems:function j(){var o=f.get(this.id+"-all-sites-link");if(o){i.removeListener(o,"click");o.style.color="#aaa"}o=f.get(this.id+"-repo-link");if(o){i.removeListener(o,"click");o.style.color="#aaa"}o=f.get(this.id+"-site-link");if(o){i.removeListener(o,"click");o.style.color="#aaa"}},_enableItems:function g(){var o=f.get(this.id+"-all-sites-link");if(o){i.addListener(o,"click",this.onAllSiteSearch,this,true);o.style.color=""}o=f.get(this.id+"-repo-link");if(o){i.addListener(o,"click",this.onRepositorySearch,this,true);o.style.color=""}o=f.get(this.id+"-site-link");if(o){i.addListener(o,"click",this.onSiteSearch,this,true);o.style.color=""}}})})();