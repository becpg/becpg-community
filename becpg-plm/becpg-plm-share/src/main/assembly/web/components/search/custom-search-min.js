(function(){var a=YAHOO.util.Dom,v=YAHOO.util.Event,t=YAHOO.util.Selector,g=YAHOO.Bubbling;var q=Alfresco.util.encodeHTML;beCPG.custom.Search=function i(w){beCPG.custom.Search.superclass.constructor.call(this,w);this.selectedItems={};YAHOO.Bubbling.on("selectedItemsChanged",this.onSelectedItemsChanged,this);return this};YAHOO.extend(beCPG.custom.Search,Alfresco.Search,{options:{siteId:"",siteTitle:"",maxSearchResults:250,pageSize:50,initialSearchTerm:"",initialSearchTag:"",metadataFields:"",initialSearchAllSites:true,initialSearchRepository:false,initialSort:"",searchQuery:"",searchRootNode:"",minSearchTermLength:1},onReady:function r(){var D=this;var x=Alfresco.constants.PROXY_URI_RELATIVE+"becpg/search?";this.widgets.dataSource=new YAHOO.util.DataSource(x,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"items",metaFields:{page:"page",pageSize:"pageSize",fullListSize:"fullListSize"}}});var A=function C(G,F){F.currentPage=G.page;F.widgets.paginator.setState(G);YAHOO.Bubbling.fire("onSearch")};this.widgets.paginator=new YAHOO.widget.Paginator({containers:[this.id+"-paginator-top",this.id+"-paginator-bottom"],rowsPerPage:this.options.pageSize,initialPage:1,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});this.widgets.paginator.subscribe("changeRequest",A,this);this._setupDataTable();var z=a.get(this.id+"-search-text");z.value=this.options.initialSearchTerm;YAHOO.Bubbling.fire("onSearch",{searchTerm:this.options.initialSearchTerm,searchTag:this.options.initialSearchTag,searchSort:this.options.initialSort,searchAllSites:this.options.initialSearchAllSites,searchRepository:this.options.initialSearchRepository});this.widgets.sortButton=new YAHOO.widget.Button(this.id+"-sort-menubutton",{type:"menu",menu:this.id+"-sort-menu",menualignment:["tr","br"],lazyloadmenu:false});var w=this.widgets.sortButton.getMenu().getItems();for(var y in w){if(w[y].value===this.options.initialSort){this.widgets.sortButton.set("label",this.msg("label.sortby",w[y].cfg.getProperty("text"))+" "+Alfresco.constants.MENU_ARROW_SYMBOL);break}}this.widgets.sortButton.getMenu().subscribe("click",function(G,F){var H=F[1];if(H){D.refreshSearch({searchSort:H.value})}});this.widgets.bulkEditButton=Alfresco.util.createYUIButton(this,"bulk-edit",this.onBulkEditClick);if(a.get(this.id+"-wused")){this.widgets.wUsedButton=Alfresco.util.createYUIButton(this,"wused",this.onWUsedClick)}if(a.get(this.id+"-export-menubutton")){this.widgets.exportButton=new YAHOO.widget.Button(this.id+"-export-menubutton",{type:"menu",menu:this.id+"-export-menu",menualignment:["tr","br"],lazyloadmenu:false});var w=this.widgets.exportButton.getMenu().getItems();for(var y in w){if(w[y].value==="-"){this.widgets.exportButton.set("label",this.msg("label.export-search",w[y].cfg.getProperty("text"))+" "+Alfresco.constants.MENU_ARROW_SYMBOL);break}}this.widgets.exportButton.getMenu().subscribe("click",function(G,F){var H=F[1];if(H){D.exportSearch({reportTpl:H.value,reportFileName:H.srcElement.attributes.fileName.value,reportTplName:H.srcElement.attributes.reportTplName.value})}})}var E=function B(H,G){var F=YAHOO.Bubbling.getOwnerByTagName(G[1].anchor,"span");if(F!==null){if(typeof D[F.className]=="function"){G[1].stop=true;var I=F.id.substring(D.id.length+1);D[F.className].call(D,I)}}return true};YAHOO.Bubbling.addDefaultAction("search-tag",E);YAHOO.Bubbling.addDefaultAction("search-prop",E);this.widgets.itemSelect=Alfresco.util.createYUIButton(this,"itemSelect-button",this.onItemSelect,{type:"menu",menu:"itemSelect-menu",disabled:false});this.widgets.selectedItems=Alfresco.util.createYUIButton(this,"selectedItems-button",this.onSelectedItems,{type:"menu",menu:"selectedItems-menu",lazyloadmenu:false,disabled:true});this.modules.actions=new Alfresco.module.DoclibActions();a.setStyle(this.id+"-body","visibility","visible")},refreshSearch:function j(z){var x=this.searchTerm;if(z.searchTerm!==undefined){x=z.searchTerm}var A=this.searchTag;if(z.searchTag!==undefined){A=z.searchTag}var C=this.searchAllSites;if(z.searchAllSites!==undefined){C=z.searchAllSites}var D=this.searchRepository;if(z.searchRepository!==undefined){D=z.searchRepository}var w=this.searchSort;if(z.searchSort!==undefined){w=z.searchSort}var B=this.options.searchQuery;if(z.searchQuery!==undefined){B=z.searchQuery}var y=Alfresco.constants.URL_PAGECONTEXT;if(this.options.siteId.length!==0){y+="site/"+this.options.siteId+"/"}y+="search?t="+encodeURIComponent(x);y+="&s="+w;if(B.length!==0){y+="&q="+encodeURIComponent(B)}else{if(A.length!==0){y+="&tag="+encodeURIComponent(A)}}y+="&a="+C+"&r="+D;window.location=y},_setupDataTable:function h(){var z=this;renderCellThumbnail=function y(C,B,D,E){D.width=100;a.setStyle(C.parentNode,"width",D.width+"px");a.addClass(C,"thumbnail-cell");if(B.getData("type")==="document"){a.addClass(C,"thumbnail")}C.innerHTML=z.buildThumbnailHtml(B)};renderCellSelected=function(C,B,D,E){a.setStyle(C,"width",D.width+"px");a.setStyle(C.parentNode,"width",D.width+"px");C.innerHTML='<input id="checkbox-'+B.getId()+'" type="checkbox" name="fileChecked" value="'+E+'"'+(z.selectedItems[E]?' checked="checked">':">")};renderCellDescription=function w(E,S,F,M){a.addClass(E.parentNode,"description");var K=S.getData("site");var C=z._getBrowseUrlForRecord(S);var D=S.getData("displayName");var G=S.getData("metadata");var Q='<span class="itemname '+(G?(" "+G):"")+'"><a href="'+C+'" class="theme-color-1">'+q(D)+"</a>";var U=S.getData("title");if(U&&U!==D){Q+='<span class="title">('+q(U)+")</span>"}Q+="</span>";var J=S.getData("description");if(J){Q+='<div class="details meta">'+q(J)+"</div>"}Q+='<div class="details">';var B=S.getData("type");Q+=z.buildTextForType(B);if(K){Q+=" "+z.msg("message.insite");Q+=' <a href="'+Alfresco.constants.URL_PAGECONTEXT+"site/"+q(K.shortName)+'/dashboard">'+q(K.title)+"</a>"}if(S.getData("size")!==-1){Q+=" "+z.msg("message.ofsize");Q+=' <span class="meta">'+Alfresco.util.formatFileSize(S.getData("size"))+"</span>"}if(S.getData("modifiedBy")){Q+=" "+z.msg("message.modifiedby");Q+=' <a href="'+Alfresco.constants.URL_PAGECONTEXT+"user/"+encodeURI(S.getData("modifiedByUser"))+'/profile">'+q(S.getData("modifiedBy"))+"</a>"}Q+=" "+z.msg("message.modifiedon")+' <span class="meta">'+Alfresco.util.formatDate(S.getData("modifiedOn"))+"</span>";Q+="</div>";var L=S.getData("path");Q+=z.buildPath(B,L,K);var I=S.getData("tags");if(I&&I.length!==0){var P,N;Q+='<div class="details"><span class="tags">'+z.msg("label.tags")+": ";for(P=0,N=I.length;P<N;P++){Q+='<span id="'+z.id+"-"+q(I[P])+'" class="searchByTag"><a class="search-tag" href="#">'+q(I[P])+"</a> </span>"}Q+="</span></div>"}var T=S.getData("itemType"),O=S.getData("itemData");if(O!=null){for(key in O){var R=O[key];var H=key+(R.type=="subtype"?"_added":"");if(R.displayValue!=null&&R.displayValue.length>0){Q+='<div class="details">'+q(R.label)+": ";Q+='<span id="'+z.id+"|"+q(H)+"|"+q(R.value)+"|"+q(T)+'" class="searchByProp" ><a class="search-prop" href="#">'+q(R.displayValue)+"</a></span>";Q+="</div>"}else{if(R.length>0){for(jj in R){if(jj==0){Q+='<div class="details">'+q(R[jj].label)+": "}else{Q+=",&nbsp;"}Q+='<span id="'+z.id+"|"+q(H)+"|"+q(R[jj].value)+"|"+q(T)+'" class="searchByProp" ><a class="search-prop" href="#">'+q(R[jj].displayValue)+"</a></span>"}Q+="</div>"}}}}E.innerHTML=Q};var A=[{key:"nodeRef",label:"",sortable:false,formatter:renderCellSelected,width:16,className:"search-select-cell-adv"},{key:"image",label:z.msg("message.preview"),sortable:false,formatter:renderCellThumbnail,width:100},{key:"summary",label:z.msg("label.description"),sortable:false,formatter:renderCellDescription}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-results",A,this.widgets.dataSource,{renderLoopSize:Alfresco.util.RENDERLOOPSIZE,initialLoad:false,MSG_LOADING:""});this._setDefaultDataTableErrors(this.widgets.dataTable);if(this.options.initialSearchTerm.length===0&&this.options.initialSearchTag.length===0){this.widgets.dataTable.set("MSG_EMPTY","")}this.widgets.dataTable.doBeforeLoadData=function x(C,D,F){if(D.error){try{var B=YAHOO.lang.JSON.parse(D.responseText);z.widgets.dataTable.set("MSG_ERROR",B.message)}catch(E){z._setDefaultDataTableErrors(z.widgets.dataTable)}}else{if(D.results){z.resultsCount=D.meta.fullListSize;z.currentPage=D.meta.page;z.widgets.dataTable.set("MSG_EMPTY","");z.hasMoreResults=(z.resultsCount>z.options.maxSearchResults);if(z.hasMoreResults){D.results=D.results.slice(0,z.options.maxSearchResults);z.resultsCount=z.options.maxSearchResults}if(z.resultsCount>z.options.pageSize){a.removeClass(z.id+"-paginator-top","hidden");a.removeClass(z.id+"-search-bar-bottom","hidden")}if(z.resultsCount===0){a.removeClass(z.id+"-help","hidden")}}}return true};z.widgets.dataTable.subscribe("renderEvent",function(){z.widgets.paginator.setState({page:z.currentPage,totalRecords:z.resultsCount});z.widgets.paginator.render()});z.widgets.dataTable.subscribe("checkboxClickEvent",function(B){var C=B.target.value;z.selectedItems[C]=B.target.checked;g.fire("selectedItemsChanged")},this,true)},searchByProp:function l(y){var w=y.split("|")[0],x=y.split("|")[1];type=y.split("|")[2];this.refreshSearch({searchTag:"",searchTerm:this.searchTerm,searchQuery:encodeURIComponent('{"'+w+'":"'+x+'","datatype":"'+type+'"}')})},exportSearch:function n(A){var y=this.searchTerm;if(A.searchTerm!==undefined){y=A.searchTerm}var B=this.searchTag;if(A.searchTag!==undefined){B=A.searchTag}var x=this.searchSort;if(A.searchSort!==undefined){x=A.searchSort}var C=this.options.searchQuery;if(A.searchQuery!==undefined){C=A.searchQuery}var z=Alfresco.constants.PROXY_URI+"becpg/report/exportsearch/"+A.reportTpl.replace("://","/")+"/"+encodeURI(A.reportFileName);z+="?term="+encodeURIComponent(y);if(x.length!==0){z+="&sort="+encodeURIComponent(x)}if(C.length!==0){z+="&query="+encodeURIComponent(C)}else{if(B.length!==0){z+="&tag="+encodeURIComponent(B)}}z+="&site=&repo=true";if(A.reportFileName.indexOf(".zip")>0||A.reportTplName.indexOf(".xlsx")>0){z+="&async=true";var w=Alfresco.getArchiveAndDownloadInstance();w.mimeType=A.reportFileName.indexOf(".xlsx")>0?"-excel":"";w._resetGUI=function(){this.widgets.cancelOkButton.set("disabled",false);this._currentArchiveNodeURL="";a.setStyle(this.id+"-aggregate-progress-span","left","-300px");a.get(this.id+"-file-count-span").innerHTML="";a.get(this.id+"-aggregate-status-span").innerHTML=this.msg("status.label"+this.mimeType)};w.updateProgress=function(F){var E=F.done.replace(/,/g,"");var G=F.total.replace(/,/g,"");var D=G!=0?(E/G):0;var H=(-300+(D*300));a.setStyle(this.id+"-aggregate-progress-span","left",H+"px");a.get(this.id+"-file-count-span").innerHTML=this.msg("file.status"+this.mimeType,F.filesAdded,F.totalFiles)};w.showExport=function(D){this._resetGUI();this.widgets.escapeListener.enable();this.panel.setFirstLastFocusable();this.panel.show();this._currentArchiveName=D;Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.GET,url:z,responseContentType:"application/json",successCallback:{fn:this.archiveInitReqSuccess,scope:this},failureCallback:{fn:this.archiveInitReqFailure,scope:this}})};w.showExport(A.reportFileName)}else{window.location=z}},onBulkEditClick:function d(y,x){var w=Alfresco.constants.URL_PAGECONTEXT;w+="bulk-edit"+location.search;window.location=w},onWUsedClick:function f(y,x){var w=Alfresco.constants.URL_PAGECONTEXT;w+="wused"+location.search;window.location=w},_buildSearchParams:function b(B,A,x,z,w){var y=A?"":this.options.siteId;var C=YAHOO.lang.substitute("site={site}&term={term}&tag={tag}&maxResults={maxResults}&sort={sort}&query={query}&repo={repo}&metadataFields={metadataFields}&page={page}&pageSize={pageSize}&rootNode={rootNode}",{site:encodeURIComponent(y),repo:B.toString(),term:encodeURIComponent(x),tag:encodeURIComponent(z),sort:encodeURIComponent(w),query:encodeURIComponent(this.options.searchQuery),rootNode:encodeURIComponent(this.options.searchRootNode),metadataFields:encodeURIComponent(this.options.metadataFields),page:this.currentPage,pageSize:this.options.pageSize,maxResults:this.options.maxSearchResults+1});return C},_disableItems:function m(){var w=a.get(this.id+"-all-sites-link");if(w){v.removeListener(w,"click");w.style.color="#aaa"}w=a.get(this.id+"-repo-link");if(w){v.removeListener(w,"click");w.style.color="#aaa"}w=a.get(this.id+"-site-link");if(w){v.removeListener(w,"click");w.style.color="#aaa"}},_enableItems:function s(){var w=a.get(this.id+"-all-sites-link");if(w){v.addListener(w,"click",this.onAllSiteSearch,this,true);w.style.color=""}w=a.get(this.id+"-repo-link");if(w){v.addListener(w,"click",this.onRepositorySearch,this,true);w.style.color=""}w=a.get(this.id+"-site-link");if(w){v.addListener(w,"click",this.onSiteSearch,this,true);w.style.color=""}},getSelectedItems:function o(){var x=[],B=this.widgets.dataTable.getRecordSet(),y=0,D=B.getLength(),w;for(var z=y;z<=D;z++){w=B.getRecord(z);if(w!=null&&this.selectedItems[w.getData("nodeRef")]){var C=w.getData();C.jsNode={};var A=w._oData.type!="document"?true:false;C.jsNode.isContainer=A;x.push(C)}}return x},selectItems:function p(D){var C=this.widgets.dataTable.getRecordSet(),A=t.query('input[type="checkbox"]',this.widgets.dataTable.getTbodyEl()),z=0,x=A.length,y,B,w;switch(D){case"selectAll":case"selectAllPages":w=function(E,F){return true};break;case"selectNone":w=function(E,F){return false};break;case"selectInvert":w=function(E,F){return !F};break;default:w=function(E,F){return F}}if(D=="selectAllPages"){this.allPages=true}else{this.allPages=false}for(B=0;B<x;B++){y=C.getRecord(B+z);this.selectedItems[y.getData("nodeRef")]=A[B].checked=w(y.getData("type"),A[B].checked)}g.fire("selectedItemsChanged")},onSelectedItemsChanged:function(){if(this.allPages){a.get(this.id+"-message").innerHTML='<span class="info">'+this.msg("message.edit.allPages",this.totalRecords)+"</span>";a.removeClass(this.id+"-message","hidden")}else{a.addClass(this.id+"-message","hidden")}var D=this.getSelectedItems(),G,H={},E,x=this.widgets.selectedItems.getMenu().getItems(),w,z,A,B,F,y;for(B=0,F=D.length;B<F;B++){G=D[B];if(!G.jsNode.isContainer){G.permissions.userAccess.content=true}E=G.permissions.userAccess;for(var C in E){if(E.hasOwnProperty(C)){H[C]=(H[C]===undefined?E[C]:H[C]&&E[C])}}}for(var C in x){if(x.hasOwnProperty(C)){w=x[C];A=false;y=true;if(w.element.firstChild){if(w.element.firstChild.rel&&w.element.firstChild.rel!==""){z=w.element.firstChild.rel.split(",");for(B=0,F=z.length;B<F;B++){if(z[B]!="allPages"){if((!H[z[B]])){A=true;break}}else{y=false}}}if(this.allPages&&(this.queryExecutionId==null||y)){A=true}w.cfg.setProperty("disabled",A)}}}this.widgets.selectedItems.set("disabled",(D.length===0))},onSelectedItems:function c(B,A,z){var x=A[0],y=A[1];var w=Alfresco.util.findEventClass(y);if(w&&(typeof this[w]=="function")){this[w].call(this,this.getSelectedItems())}v.preventDefault(x)},onItemSelect:function k(A,z,y){var w=z[0],x=z[1];this.selectItems(Alfresco.util.findEventClass(x));v.preventDefault(w)},onActionDeleteMultiple:function e(w){var B=this,x=[];if(typeof w.length==="undefined"){w=[w]}for(var A=0,y=w.length;A<y;A++){x.push('<span class="'+(w[A].jsNode.isContainer?"folder":"document")+'">'+q(w[A].displayName)+"</span>")}var E=this.msg("title.multiple-delete.confirm"),z=this.msg("message.multiple-delete.confirm",w.length);z+='<div class="toolbar-file-list">'+x.join("")+"</div>";Alfresco.util.PopupManager.displayPrompt({title:E,text:z,noEscape:true,modal:true,buttons:[{text:this.msg("button.delete"),handler:function D(){this.destroy();B._onActionDeleteConfirm.call(B,w)}},{text:this.msg("button.cancel"),handler:function C(){this.destroy()},isDefault:true}]})},_onActionDeleteConfirm:function u(w){var B=[],x,A;for(x=0,A=w.length;x<A;x++){B.push(w[x].nodeRef)}var z=function y(I,D){var C;var H=0;var F=0;if(!I.json.overallSuccess){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.multiple-delete.failure")});return}YAHOO.Bubbling.fire("filesDeleted");for(x=0,A=I.json.totalResults;x<A;x++){C=I.json.results[x];if(C.success){if(C.type=="folder"){F++}else{H++}YAHOO.Bubbling.fire(C.type=="folder"?"folderDeleted":"fileDeleted",{multiple:true,nodeRef:C.nodeRef})}}var G=F+H;if(Alfresco.util.isValueSet(this.options.siteId)){var E;if(G>0){if(G<this.options.groupActivitiesAt){for(x=0;x<G;x++){E={fileName:I.json.results[x].id,nodeRef:I.json.results[x].nodeRef,path:this.currentPath,parentNodeRef:this.doclistMetadata.parent.nodeRef};if(I.json.results[x].type=="folder"){this.modules.actions.postActivity(this.options.siteId,"folder-deleted","documentlibrary",E)}else{this.modules.actions.postActivity(this.options.siteId,"file-deleted","documentlibrary",E)}}}else{if(H>0){E={fileCount:H,path:this.currentPath,parentNodeRef:this.doclistMetadata.parent.nodeRef};this.modules.actions.postActivity(this.options.siteId,"files-deleted","documentlibrary",E)}if(F>0){E={fileCount:F,path:this.currentPath,parentNodeRef:this.doclistMetadata.parent.nodeRef};this.modules.actions.postActivity(this.options.siteId,"folders-deleted","documentlibrary",E)}}}}Alfresco.util.PopupManager.displayMessage({text:this.msg("message.multiple-delete.success",G)})};this.modules.actions.genericAction({success:{callback:{fn:z,scope:this,obj:w}},failure:{message:this.msg("message.multiple-delete.failure")},webscript:{method:Alfresco.util.Ajax.DELETE,name:"files"},wait:{message:this.msg("message.multiple-delete.please-wait")},config:{requestContentType:Alfresco.util.Ajax.JSON,dataObj:{nodeRefs:B}}})},});if(Alfresco.doclib&&Alfresco.doclib.Actions){YAHOO.lang.augmentProto(beCPG.custom.Search,Alfresco.doclib.Actions)}})();