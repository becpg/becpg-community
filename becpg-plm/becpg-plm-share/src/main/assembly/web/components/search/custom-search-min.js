(function(){var a=YAHOO.util.Dom,t=YAHOO.util.Event,s=YAHOO.util.Selector,f=YAHOO.Bubbling;var p=Alfresco.util.encodeHTML;beCPG.custom.Search=function h(u){beCPG.custom.Search.superclass.constructor.call(this,u);this.selectedItems={};YAHOO.Bubbling.on("selectedItemsChanged",this.onSelectedItemsChanged,this);return this};YAHOO.extend(beCPG.custom.Search,Alfresco.Search,{options:{siteId:"",siteTitle:"",maxSearchResults:250,pageSize:50,initialSearchTerm:"",initialSearchTag:"",metadataFields:"",initialSearchAllSites:true,initialSearchRepository:false,initialSort:"",searchQuery:"",searchRootNode:"",minSearchTermLength:1},onReady:function q(){var B=this;var v=Alfresco.constants.PROXY_URI_RELATIVE+"becpg/search?";this.widgets.dataSource=new YAHOO.util.DataSource(v,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"items",metaFields:{page:"page",pageSize:"pageSize",fullListSize:"fullListSize"}}});var y=function A(E,D){D.currentPage=E.page;D.widgets.paginator.setState(E);YAHOO.Bubbling.fire("onSearch")};this.widgets.paginator=new YAHOO.widget.Paginator({containers:[this.id+"-paginator-top",this.id+"-paginator-bottom"],rowsPerPage:this.options.pageSize,initialPage:1,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});this.widgets.paginator.subscribe("changeRequest",y,this);this._setupDataTable();var x=a.get(this.id+"-search-text");x.value=this.options.initialSearchTerm;YAHOO.Bubbling.fire("onSearch",{searchTerm:this.options.initialSearchTerm,searchTag:this.options.initialSearchTag,searchSort:this.options.initialSort,searchAllSites:this.options.initialSearchAllSites,searchRepository:this.options.initialSearchRepository});this.widgets.sortButton=new YAHOO.widget.Button(this.id+"-sort-menubutton",{type:"menu",menu:this.id+"-sort-menu",menualignment:["tr","br"],lazyloadmenu:false});var u=this.widgets.sortButton.getMenu().getItems();for(var w in u){if(u[w].value===this.options.initialSort){this.widgets.sortButton.set("label",this.msg("label.sortby",u[w].cfg.getProperty("text"))+" "+Alfresco.constants.MENU_ARROW_SYMBOL);break}}this.widgets.sortButton.getMenu().subscribe("click",function(E,D){var F=D[1];if(F){B.refreshSearch({searchSort:F.value})}});this.widgets.bulkEditButton=Alfresco.util.createYUIButton(this,"bulk-edit",this.onBulkEditClick);if(a.get(this.id+"-wused")){this.widgets.wUsedButton=Alfresco.util.createYUIButton(this,"wused",this.onWUsedClick)}if(a.get(this.id+"-export-menubutton")){this.widgets.exportButton=new YAHOO.widget.Button(this.id+"-export-menubutton",{type:"menu",menu:this.id+"-export-menu",menualignment:["tr","br"],lazyloadmenu:false});var u=this.widgets.exportButton.getMenu().getItems();for(var w in u){if(u[w].value==="-"){this.widgets.exportButton.set("label",this.msg("label.export-search",u[w].cfg.getProperty("text"))+" "+Alfresco.constants.MENU_ARROW_SYMBOL);break}}this.widgets.exportButton.getMenu().subscribe("click",function(E,D){var F=D[1];if(F){B.exportSearch({reportTpl:F.value,reportFileName:F.srcElement.attributes.fileName.value,reportTplName:F.srcElement.attributes.reportTplName.value})}})}var C=function z(F,E){var D=YAHOO.Bubbling.getOwnerByTagName(E[1].anchor,"span");if(D!==null){if(typeof B[D.className]=="function"){E[1].stop=true;var G=D.id.substring(B.id.length+1);B[D.className].call(B,G)}}return true};YAHOO.Bubbling.addDefaultAction("search-tag",C);YAHOO.Bubbling.addDefaultAction("search-prop",C);this.widgets.itemSelect=Alfresco.util.createYUIButton(this,"itemSelect-button",this.onItemSelect,{type:"menu",menu:"itemSelect-menu",disabled:false});this.widgets.selectedItems=Alfresco.util.createYUIButton(this,"selectedItems-button",this.onSelectedItems,{type:"menu",menu:"selectedItems-menu",lazyloadmenu:false,disabled:true});a.setStyle(this.id+"-body","visibility","visible")},refreshSearch:function i(x){var v=this.searchTerm;if(x.searchTerm!==undefined){v=x.searchTerm}var y=this.searchTag;if(x.searchTag!==undefined){y=x.searchTag}var A=this.searchAllSites;if(x.searchAllSites!==undefined){A=x.searchAllSites}var B=this.searchRepository;if(x.searchRepository!==undefined){B=x.searchRepository}var u=this.searchSort;if(x.searchSort!==undefined){u=x.searchSort}var z=this.options.searchQuery;if(x.searchQuery!==undefined){z=x.searchQuery}var w=Alfresco.constants.URL_PAGECONTEXT;if(this.options.siteId.length!==0){w+="site/"+this.options.siteId+"/"}w+="search?t="+encodeURIComponent(v);w+="&s="+u;if(z.length!==0){w+="&q="+encodeURIComponent(z)}else{if(y.length!==0){w+="&tag="+encodeURIComponent(y)}}w+="&a="+A+"&r="+B;window.location=w},_setupDataTable:function g(){var x=this;renderCellThumbnail=function w(A,z,B,C){B.width=100;a.setStyle(A.parentNode,"width",B.width+"px");a.setStyle(A.parentNode,"background-color","#f4f4f4");a.addClass(A,"thumbnail-cell");if(z.getData("type")==="document"){a.addClass(A,"thumbnail")}A.innerHTML=x.buildThumbnailHtml(z)};renderCellSelected=function(A,z,B,C){a.setStyle(A,"width",B.width+"px");a.setStyle(A.parentNode,"width",B.width+"px");A.innerHTML='<input id="checkbox-'+z.getId()+'" type="checkbox" name="fileChecked" value="'+C+'"'+(x.selectedItems[C]?' checked="checked">':">")};renderCellDescription=function u(C,Q,D,K){a.addClass(C.parentNode,"description");var I=Q.getData("site");var A=x._getBrowseUrlForRecord(Q);var B=Q.getData("displayName");var E=Q.getData("metadata");var O='<span class="itemname '+(E?(" "+E):"")+'"><a href="'+A+'" class="theme-color-1">'+p(B)+"</a>";var S=Q.getData("title");if(S&&S!==B){O+='<span class="title">('+p(S)+")</span>"}O+="</span>";var H=Q.getData("description");if(H){O+='<div class="details meta">'+p(H)+"</div>"}O+='<div class="details">';var z=Q.getData("type");O+=x.buildTextForType(z);if(I){O+=" "+x.msg("message.insite");O+=' <a href="'+Alfresco.constants.URL_PAGECONTEXT+"site/"+p(I.shortName)+'/dashboard">'+p(I.title)+"</a>"}if(Q.getData("size")!==-1){O+=" "+x.msg("message.ofsize");O+=' <span class="meta">'+Alfresco.util.formatFileSize(Q.getData("size"))+"</span>"}if(Q.getData("modifiedBy")){O+=" "+x.msg("message.modifiedby");O+=' <a href="'+Alfresco.constants.URL_PAGECONTEXT+"user/"+encodeURI(Q.getData("modifiedByUser"))+'/profile">'+p(Q.getData("modifiedBy"))+"</a>"}O+=" "+x.msg("message.modifiedon")+' <span class="meta">'+Alfresco.util.formatDate(Q.getData("modifiedOn"))+"</span>";O+="</div>";var J=Q.getData("path");O+=x.buildPath(z,J,I);var G=Q.getData("tags");if(G&&G.length!==0){var N,L;O+='<div class="details"><span class="tags">'+x.msg("label.tags")+": ";for(N=0,L=G.length;N<L;N++){O+='<span id="'+x.id+"-"+p(G[N])+'" class="searchByTag"><a class="search-tag" href="#">'+p(G[N])+"</a> </span>"}O+="</span></div>"}var R=Q.getData("itemType"),M=Q.getData("itemData");if(M!=null){for(key in M){var P=M[key];var F=key+(P.type=="subtype"?"_added":"");if(P.displayValue!=null&&P.displayValue.length>0){O+='<div class="details">'+p(P.label)+": ";O+='<span id="'+x.id+"|"+p(F)+"|"+p(P.value)+"|"+p(R)+'" class="searchByProp" ><a class="search-prop" href="#">'+p(P.displayValue)+"</a></span>";O+="</div>"}else{if(P.length>0){for(jj in P){if(jj==0){O+='<div class="details">'+p(P[jj].label)+": "}else{O+=",&nbsp;"}O+='<span id="'+x.id+"|"+p(F)+"|"+p(P[jj].value)+"|"+p(R)+'" class="searchByProp" ><a class="search-prop" href="#">'+p(P[jj].displayValue)+"</a></span>"}O+="</div>"}}}}C.innerHTML=O};var y=[{key:"nodeRef",label:"",sortable:false,formatter:renderCellSelected,width:16},{key:"image",label:x.msg("message.preview"),sortable:false,formatter:renderCellThumbnail,width:100},{key:"summary",label:x.msg("label.description"),sortable:false,formatter:renderCellDescription}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-results",y,this.widgets.dataSource,{renderLoopSize:Alfresco.util.RENDERLOOPSIZE,initialLoad:false,MSG_LOADING:""});this._setDefaultDataTableErrors(this.widgets.dataTable);if(this.options.initialSearchTerm.length===0&&this.options.initialSearchTag.length===0){this.widgets.dataTable.set("MSG_EMPTY","")}this.widgets.dataTable.doBeforeLoadData=function v(A,B,D){if(B.error){try{var z=YAHOO.lang.JSON.parse(B.responseText);x.widgets.dataTable.set("MSG_ERROR",z.message)}catch(C){x._setDefaultDataTableErrors(x.widgets.dataTable)}}else{if(B.results){x.resultsCount=B.meta.fullListSize;x.currentPage=B.meta.page;x.widgets.dataTable.set("MSG_EMPTY","");x.hasMoreResults=(x.resultsCount>x.options.maxSearchResults);if(x.hasMoreResults){B.results=B.results.slice(0,x.options.maxSearchResults);x.resultsCount=x.options.maxSearchResults}if(x.resultsCount>x.options.pageSize){a.removeClass(x.id+"-paginator-top","hidden");a.removeClass(x.id+"-search-bar-bottom","hidden")}if(x.resultsCount===0){a.removeClass(x.id+"-help","hidden")}}}return true};x.widgets.dataTable.subscribe("renderEvent",function(){x.widgets.paginator.setState({page:x.currentPage,totalRecords:x.resultsCount});x.widgets.paginator.render()});x.widgets.dataTable.subscribe("checkboxClickEvent",function(z){var A=z.target.value;x.selectedItems[A]=z.target.checked;f.fire("selectedItemsChanged")},this,true)},searchByProp:function k(w){var u=w.split("|")[0],v=w.split("|")[1];type=w.split("|")[2];this.refreshSearch({searchTag:"",searchTerm:this.searchTerm,searchQuery:encodeURIComponent('{"'+u+'":"'+v+'","datatype":"'+type+'"}')})},exportSearch:function m(y){var w=this.searchTerm;if(y.searchTerm!==undefined){w=y.searchTerm}var z=this.searchTag;if(y.searchTag!==undefined){z=y.searchTag}var v=this.searchSort;if(y.searchSort!==undefined){v=y.searchSort}var A=this.options.searchQuery;if(y.searchQuery!==undefined){A=y.searchQuery}var x=Alfresco.constants.PROXY_URI+"becpg/report/exportsearch/"+y.reportTpl.replace("://","/")+"/"+encodeURI(y.reportFileName);x+="?term="+encodeURIComponent(w);if(v.length!==0){x+="&sort="+encodeURIComponent(v)}if(A.length!==0){x+="&query="+encodeURIComponent(A)}else{if(z.length!==0){x+="&tag="+encodeURIComponent(z)}}x+="&site=&repo=true";if(y.reportFileName.indexOf(".zip")>0||y.reportTplName.indexOf(".xlsx")>0){x+="&async=true";var u=Alfresco.getArchiveAndDownloadInstance();u.mimeType=y.reportFileName.indexOf(".xlsx")>0?"-excel":"";u._resetGUI=function(){this.widgets.cancelOkButton.set("disabled",false);this._currentArchiveNodeURL="";a.setStyle(this.id+"-aggregate-progress-span","left","-300px");a.get(this.id+"-file-count-span").innerHTML="";a.get(this.id+"-aggregate-status-span").innerHTML=this.msg("status.label"+this.mimeType)};u.updateProgress=function(D){var C=D.done.replace(/,/g,"");var E=D.total.replace(/,/g,"");var B=E!=0?(C/E):0;var F=(-300+(B*300));a.setStyle(this.id+"-aggregate-progress-span","left",F+"px");a.get(this.id+"-file-count-span").innerHTML=this.msg("file.status"+this.mimeType,D.filesAdded,D.totalFiles)};u.showExport=function(B){this._resetGUI();this.widgets.escapeListener.enable();this.panel.setFirstLastFocusable();this.panel.show();this._currentArchiveName=B;Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.GET,url:x,responseContentType:"application/json",successCallback:{fn:this.archiveInitReqSuccess,scope:this},failureCallback:{fn:this.archiveInitReqFailure,scope:this}})};u.showExport(y.reportFileName)}else{window.location=x}},onBulkEditClick:function d(w,v){var u=Alfresco.constants.URL_PAGECONTEXT;u+="bulk-edit"+location.search;window.location=u},onWUsedClick:function e(w,v){var u=Alfresco.constants.URL_PAGECONTEXT;u+="wused"+location.search;window.location=u},_buildSearchParams:function b(z,y,v,x,u){var w=y?"":this.options.siteId;var A=YAHOO.lang.substitute("site={site}&term={term}&tag={tag}&maxResults={maxResults}&sort={sort}&query={query}&repo={repo}&metadataFields={metadataFields}&page={page}&pageSize={pageSize}&rootNode={rootNode}",{site:encodeURIComponent(w),repo:z.toString(),term:encodeURIComponent(v),tag:encodeURIComponent(x),sort:encodeURIComponent(u),query:encodeURIComponent(this.options.searchQuery),rootNode:encodeURIComponent(this.options.searchRootNode),metadataFields:encodeURIComponent(this.options.metadataFields),page:this.currentPage,pageSize:this.options.pageSize,maxResults:this.options.maxSearchResults+1});return A},_disableItems:function l(){var u=a.get(this.id+"-all-sites-link");if(u){t.removeListener(u,"click");u.style.color="#aaa"}u=a.get(this.id+"-repo-link");if(u){t.removeListener(u,"click");u.style.color="#aaa"}u=a.get(this.id+"-site-link");if(u){t.removeListener(u,"click");u.style.color="#aaa"}},_enableItems:function r(){var u=a.get(this.id+"-all-sites-link");if(u){t.addListener(u,"click",this.onAllSiteSearch,this,true);u.style.color=""}u=a.get(this.id+"-repo-link");if(u){t.addListener(u,"click",this.onRepositorySearch,this,true);u.style.color=""}u=a.get(this.id+"-site-link");if(u){t.addListener(u,"click",this.onSiteSearch,this,true);u.style.color=""}},getSelectedItems:function n(){var v=[],y=this.widgets.dataTable.getRecordSet(),w=0,z=y.getLength(),u;for(var x=w;x<=z;x++){u=y.getRecord(x);if(u!=null&&this.selectedItems[u.getData("nodeRef")]){v.push(u.getData())}}return v},selectItems:function o(B){var A=this.widgets.dataTable.getRecordSet(),y=s.query('input[type="checkbox"]',this.widgets.dataTable.getTbodyEl()),x=0,v=y.length,w,z,u;switch(B){case"selectAll":case"selectAllPages":u=function(C,D){return true};break;case"selectNone":u=function(C,D){return false};break;case"selectInvert":u=function(C,D){return !D};break;default:u=function(C,D){return D}}if(B=="selectAllPages"){this.allPages=true}else{this.allPages=false}for(z=0;z<v;z++){w=A.getRecord(z+x);this.selectedItems[w.getData("nodeRef")]=y[z].checked=u(w.getData("type"),y[z].checked)}f.fire("selectedItemsChanged")},onSelectedItemsChanged:function(){if(this.allPages){a.get(this.id+"-message").innerHTML='<span class="info">'+this.msg("message.edit.allPages",this.totalRecords)+"</span>";a.removeClass(this.id+"-message","hidden")}else{a.addClass(this.id+"-message","hidden")}var B=this.getSelectedItems(),E,F={},C,v=this.widgets.selectedItems.getMenu().getItems(),u,x,y,z,D,w;for(z=0,D=B.length;z<D;z++){E=B[z];C=E.permissions.userAccess;for(var A in C){if(C.hasOwnProperty(A)){F[A]=(F[A]===undefined?C[A]:F[A]&&C[A])}}}for(var A in v){if(v.hasOwnProperty(A)){u=v[A];y=false;w=true;if(u.element.firstChild){if(u.element.firstChild.rel&&u.element.firstChild.rel!==""){x=u.element.firstChild.rel.split(",");for(z=0,D=x.length;z<D;z++){if(x[z]!="allPages"){if((!F[x[z]])){y=true;break}}else{w=false}}}if(this.allPages&&(this.queryExecutionId==null||w)){y=true}u.cfg.setProperty("disabled",y)}}}this.widgets.selectedItems.set("disabled",(B.length===0))},onSelectedItems:function c(z,y,x){var v=y[0],w=y[1];var u=Alfresco.util.findEventClass(w);if(u&&(typeof this[u]=="function")){this[u].call(this,this.getSelectedItems())}t.preventDefault(v)},onItemSelect:function j(y,x,w){var u=x[0],v=x[1];this.selectItems(Alfresco.util.findEventClass(v));t.preventDefault(u)}});if(Alfresco.doclib&&Alfresco.doclib.Actions){YAHOO.lang.augmentProto(beCPG.custom.Search,Alfresco.doclib.Actions)}})();