(function(){var f=YAHOO.util.Dom,k=YAHOO.util.Event,c=YAHOO.Bubbling;Alfresco.AdvancedSearch=function(l){Alfresco.AdvancedSearch.superclass.constructor.call(this,"Alfresco.AdvancedSearch",l,["button","container"]);c.on("beforeFormRuntimeInit",this.onBeforeFormRuntimeInit,this);c.on("afterFormRuntimeInit",this.onAfterFormRuntimeInit,this);return this};YAHOO.extend(Alfresco.AdvancedSearch,Alfresco.component.Base,{options:{siteId:"",searchForms:[],savedQuery:"",searchScope:""},currentForm:null,onReady:function a(){var o=this,r=this.id+"-form-list",m=f.get(r);var l=this.options.searchForms[0];if(this.options.savedQuery.length!==0){var q=YAHOO.lang.JSON.parse(this.options.savedQuery);if(q.datatype){for(var p in this.options.searchForms){var n=this.options.searchForms[p];if(n.type===q.datatype){l=n;break}}}}if(f.get(this.id+"-adv-search-button")!=null){this.widgets.formPanel=Alfresco.util.createYUIButton(this,"adv-search-button",null,{label:this.msg("search.form.filter")+" "+Alfresco.constants.MENU_ARROW_SYMBOL,title:this.msg("search.form.filter"),type:"menu",menu:"adv-search-panel",menualignment:["tr","bl"],disabled:true})}this.widgets.searchButton1=Alfresco.util.createYUIButton(this,"search-button-1",this.onSearchClick);this.widgets.searchButton2=Alfresco.util.createYUIButton(this,"search-button-2",this.onSearchClick);this.widgets.formButton=Alfresco.util.createYUIButton(this,"selected-form-button",function(u,t){var v=this.options.searchForms[t[1].index];this.widgets.formButton.set("label",v.label+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.formButton.set("title",v.description);if(v.type==null){if(this.widgets.formPanel!=null){this.widgets.formPanel.set("disabled",true)}this.currentForm=null}else{this.renderFormTemplate(v)}},{label:l.label+" "+Alfresco.constants.MENU_ARROW_SYMBOL,title:l.description,type:"menu",menu:"selected-form-list"});if(l.type!=null){this.renderFormTemplate(l,true)}var s=f.get(this.id+"-search-text");this.widgets.enterListener=new YAHOO.util.KeyListener(s,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:o._searchEnterHandler,scope:this,correctScope:true},"keydown").enable();f.setStyle(this.id+"-body","visibility","visible")},renderFormTemplate:function b(m,t){this.currentForm=m;this.currentForm.repopulate=t;var q=this;var s=f.get(this.id+"-forms");var r=function(){for(var v=0,w=s.children;v<w.length;v++){if(!f.hasClass(w[v],"hidden")){f.addClass(w[v],"hidden");break}}if(q.widgets.formPanel!=null){q.widgets.formPanel.set("disabled",false)}f.removeClass(m.htmlid,"hidden");f.get(this.id+"-search-text").focus()};if(!m.htmlid){var u=this.id+"_"+s.children.length;var n=document.createElement("div");n.id=u;f.addClass(n,"hidden");f.addClass(n,"share-form");m.htmlid=u;var l=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind=type&itemId={itemId}&formId={formId}&mode=edit&showSubmitButton=false&showCancelButton=false",{itemId:m.type,formId:m.id});var p={htmlid:u};Alfresco.util.Ajax.request({url:l,dataObj:p,successCallback:{fn:function o(v){n.innerHTML=v.serverResponse.responseText;s.appendChild(n);r.call(this)},scope:this},failureMessage:"Could not load form component '"+l+"'.",scope:this,execScripts:true})}else{r.call(this)}},repopulateCurrentForm:function i(){if(this.options.savedQuery.length!==0){var v=YAHOO.lang.JSON.parse(this.options.savedQuery);var o=f.get(this.currentForm.runtime.formId);for(var q=0,p=o.elements.length;q<p;q++){var r=o.elements[q];var n=r.name;if(n!=undefined&&n!=="-"){var l=v[n];if(l!==undefined&&l!==""){if(r.type==="checkbox"||r.type==="radio"){r.checked=(l==="true")}else{if(n.match("-range$")=="-range"){var s=f.get(r.id+"-cntrl-min");if(s){s.value=l.substring(0,l.indexOf("|"));s=f.get(r.id+"-cntrl-max");s.value=l.substring(l.indexOf("|")+1,l.length);s=f.get(r.id);s.value=l}else{r.value=l}}else{if(n.indexOf("assoc_")!=0){r.value=l}}}var m=r.id.split("-")[0];var t=m+"-autocomplete";var u=f.get(t);if(u!=null){r.value=l;c.fire(m+"refreshContent",l,this)}if(r.type==="hidden"){var s=f.get(r.id+"-entry");if(s){switch(s.type){case"checkbox":s.checked=(l==="true");break;default:s.value=l;break}}}}}}c.fire("formContentsUpdated")}},onSearchClick:function h(o,n){var l="";if(this.currentForm!=null){var m=this.currentForm.runtime.getFormData();m.datatype=this.currentForm.type;l=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+this.options.searchPath,{site:(this.options.siteId.length!==0?("site/"+this.options.siteId+"/"):""),terms:encodeURIComponent(f.get(this.id+"-search-text").value),query:encodeURIComponent(YAHOO.lang.JSON.stringify(this.cleanFilterData(m))),scope:this.options.searchScope.toString(),repo:(this.options.searchScope.toString()=="repo")?"true":"false"})}else{l=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"{site}search?t={terms}&r={repo}",{site:(this.options.siteId.length!==0?("site/"+this.options.siteId+"/"):""),terms:encodeURIComponent(f.get(this.id+"-search-text").value),scope:this.options.searchScope.toString(),repo:(this.options.searchScope.toString()=="repo")?"true":"false"})}window.location.href=l},cleanFilterData:function e(n){var l={};if(n!=null){for(var m in n){if(n[m].length>0){l[m]=n[m]}}}return l},onBeforeFormRuntimeInit:function j(m,l){this.currentForm.runtime=l[1].runtime;this.currentForm.runtime.validations={};if(this.currentForm.repopulate){this.currentForm.repopulate=false;this.repopulateCurrentForm()}},onAfterFormRuntimeInit:function g(m,l){var o=this;this.currentForm.runtime=l[1].runtime;var n=(f.get(this.currentForm.runtime.formId));k.removeListener(n,"submit");n.setAttribute("onsubmit","return false;");n.onkeypress=function(p){if(p.keyCode==13){o._searchEnterHandler()}}},_searchEnterHandler:function d(m,l){this.onSearchClick(m,l)}})})();