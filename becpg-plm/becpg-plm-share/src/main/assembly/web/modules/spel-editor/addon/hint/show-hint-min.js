(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror"],a)}else{a(CodeMirror)}}})(function(e){var h="CodeMirror-hint";var g="CodeMirror-hint-active";e.showHint=function(o,p,q){if(!p){return o.showHint(q)}if(q&&q.async){p.async=true}var r={hint:p};if(q){for(var s in q){r[s]=q[s]}}return o.showHint(r)};e.defineExtension("showHint",function(p){p=m(this,this.getCursor("start"),p);var r=this.listSelections();if(r.length>1){return}if(this.somethingSelected()){if(!p.hint.supportsSelection){return}for(var q=0;q<r.length;q++){if(r[q].head.line!=r[q].anchor.line){return}}}if(this.state.completionActive){this.state.completionActive.close()}var o=this.state.completionActive=new b(this,p);if(!o.options.hint){return}e.signal(this,"startCompletion",this);o.update(true)});function b(o,q){this.cm=o;this.options=q;this.widget=null;this.debounce=0;this.tick=0;this.startPos=this.cm.getCursor("start");this.startLen=this.cm.getLine(this.startPos.line).length-this.cm.getSelection().length;var p=this;o.on("cursorActivity",this.activityFunc=function(){p.cursorActivity()})}var j=window.requestAnimationFrame||function(o){return setTimeout(o,1000/60)};var f=window.cancelAnimationFrame||clearTimeout;b.prototype={close:function(){if(!this.active()){return}this.cm.state.completionActive=null;this.tick=null;this.cm.off("cursorActivity",this.activityFunc);if(this.widget&&this.data){e.signal(this.data,"close")}if(this.widget){this.widget.close()}e.signal(this.cm,"endCompletion",this.cm)},active:function(){return this.cm.state.completionActive==this},pick:function(q,p){var o=q.list[p];if(o.hint){o.hint(this.cm,q,o)}else{this.cm.replaceRange(n(o),o.from||q.from,o.to||q.to,"complete")}e.signal(q,"pick",o);this.close()},cursorActivity:function(){if(this.debounce){f(this.debounce);this.debounce=0}var q=this.cm.getCursor(),o=this.cm.getLine(q.line);if(q.line!=this.startPos.line||o.length-q.ch!=this.startLen-this.startPos.ch||q.ch<this.startPos.ch||this.cm.somethingSelected()||(q.ch&&this.options.closeCharacters.test(o.charAt(q.ch-1)))){this.close()}else{var p=this;this.debounce=j(function(){p.update()});if(this.widget){this.widget.disable()}}},update:function(q){if(this.tick==null){return}if(!this.options.hint.async){this.finishUpdate(this.options.hint(this.cm,this.options),q)}else{var p=++this.tick,o=this;this.options.hint(this.cm,function(r){if(o.tick==p){o.finishUpdate(r,q)}},this.options)}},finishUpdate:function(p,q){if(this.data){e.signal(this.data,"update")}if(p&&this.data&&e.cmpPos(p.from,this.data.from)){p=null}this.data=p;var o=(this.widget&&this.widget.picked)||(q&&this.options.completeSingle);if(this.widget){this.widget.close()}if(p&&p.list.length){if(o&&p.list.length==1){this.pick(p,0)}else{this.widget=new l(this,p);e.signal(p,"shown")}}}};function m(o,t,q){var r=o.options.hintOptions;var p={};for(var s in c){p[s]=c[s]}if(r){for(var s in r){if(r[s]!==undefined){p[s]=r[s]}}}if(q){for(var s in q){if(q[s]!==undefined){p[s]=q[s]}}}if(p.hint.resolve){p.hint=p.hint.resolve(o,t)}return p}function n(o){if(typeof o=="string"){return o}else{return o.text}}function d(s,v){var p={Up:function(){v.moveFocus(-1)},Down:function(){v.moveFocus(1)},PageUp:function(){v.moveFocus(-v.menuSize()+1,true)},PageDown:function(){v.moveFocus(v.menuSize()-1,true)},Home:function(){v.setFocus(0)},End:function(){v.setFocus(v.length-1)},Enter:v.pick,Tab:v.pick,Esc:v.close};var u=s.options.customKeys;var r=u?{}:p;function q(w,y){var x;if(typeof y!="string"){x=function(z){return y(z,v)}}else{if(p.hasOwnProperty(y)){x=p[y]}else{x=y}}r[w]=x}if(u){for(var t in u){if(u.hasOwnProperty(t)){q(t,u[t])}}}var o=s.options.extraKeys;if(o){for(var t in o){if(o.hasOwnProperty(t)){q(t,o[t])}}}return r}function k(p,o){while(o&&o!=p){if(o.nodeName.toUpperCase()==="LI"&&o.parentNode==p){return o}o=o.parentNode}}function l(B,L){this.completion=B;this.data=L;this.picked=false;var s=this,x=B.cm;var I=this.hints=document.createElement("ul");I.className="CodeMirror-hints";this.selectedHint=L.selectedHint||0;var w=L.list;for(var K=0;K<w.length;++K){var r=I.appendChild(document.createElement("li")),q=w[K];var p=h+(K!=this.selectedHint?"":" "+g);if(q.className!=null){p=q.className+" "+p}r.className=p;if(q.render){q.render(r,L,q)}else{r.appendChild(document.createTextNode(q.displayText||n(q)))}r.hintId=K}var v=x.cursorCoords(B.options.alignWithWord?L.from:null);var t=v.left,F=v.bottom,D=true;I.style.left=t+"px";I.style.top=F+"px";var y=window.innerWidth||Math.max(document.body.offsetWidth,document.documentElement.offsetWidth);var J=window.innerHeight||Math.max(document.body.offsetHeight,document.documentElement.offsetHeight);(B.options.container||document.body).appendChild(I);var z=I.getBoundingClientRect(),A=z.bottom-J;if(A>0){var G=z.bottom-z.top,o=v.top-(v.bottom-z.top);if(o-G>0){I.style.top=(F=v.top-G)+"px";D=false}else{if(G>J){I.style.height=(J-5)+"px";I.style.top=(F=v.bottom-z.top)+"px";var u=x.getCursor();if(L.from.ch!=u.ch){v=x.cursorCoords(u);I.style.left=(t=v.left)+"px";z=I.getBoundingClientRect()}}}}var C=z.right-y;if(C>0){if(z.right-z.left>y){I.style.width=(y-5)+"px";C-=(z.right-z.left)-y}I.style.left=(t=v.left-C)+"px"}x.addKeyMap(this.keyMap=d(B,{moveFocus:function(N,M){s.changeActive(s.selectedHint+N,M)},setFocus:function(M){s.changeActive(M)},menuSize:function(){return s.screenAmount()},length:w.length,close:function(){B.close()},pick:function(){s.pick()},data:L}));if(B.options.closeOnUnfocus){var H;x.on("blur",this.onBlur=function(){H=setTimeout(function(){B.close()},100)});x.on("focus",this.onFocus=function(){clearTimeout(H)})}var E=x.getScrollInfo();x.on("scroll",this.onScroll=function(){var P=x.getScrollInfo(),O=x.getWrapperElement().getBoundingClientRect();var N=F+E.top-P.top;var M=N-(window.pageYOffset||(document.documentElement||document.body).scrollTop);if(!D){M+=I.offsetHeight}if(M<=O.top||M>=O.bottom){return B.close()}I.style.top=N+"px";I.style.left=(t+E.left-P.left)+"px"});e.on(I,"dblclick",function(N){var M=k(I,N.target||N.srcElement);if(M&&M.hintId!=null){s.changeActive(M.hintId);s.pick()}});e.on(I,"click",function(N){var M=k(I,N.target||N.srcElement);if(M&&M.hintId!=null){s.changeActive(M.hintId);if(B.options.completeOnSingleClick){s.pick()}}});e.on(I,"mousedown",function(){setTimeout(function(){x.focus()},20)});e.signal(L,"select",w[0],I.firstChild);return true}l.prototype={close:function(){if(this.completion.widget!=this){return}this.completion.widget=null;this.hints.parentNode.removeChild(this.hints);this.completion.cm.removeKeyMap(this.keyMap);var o=this.completion.cm;if(this.completion.options.closeOnUnfocus){o.off("blur",this.onBlur);o.off("focus",this.onFocus)}o.off("scroll",this.onScroll)},disable:function(){this.completion.cm.removeKeyMap(this.keyMap);var o=this;this.keyMap={Enter:function(){o.picked=true}};this.completion.cm.addKeyMap(this.keyMap)},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(o,q){if(o>=this.data.list.length){o=q?this.data.list.length-1:0}else{if(o<0){o=q?0:this.data.list.length-1}}if(this.selectedHint==o){return}var p=this.hints.childNodes[this.selectedHint];p.className=p.className.replace(" "+g,"");p=this.hints.childNodes[this.selectedHint=o];p.className+=" "+g;if(p.offsetTop<this.hints.scrollTop){this.hints.scrollTop=p.offsetTop-3}else{if(p.offsetTop+p.offsetHeight>this.hints.scrollTop+this.hints.clientHeight){this.hints.scrollTop=p.offsetTop+p.offsetHeight-this.hints.clientHeight+3}}e.signal(this.data,"select",this.data.list[this.selectedHint],p)},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}};function i(p,r){if(!p.somethingSelected()){return r}var o=[];for(var q=0;q<r.length;q++){if(r[q].supportsSelection){o.push(r[q])}}return o}function a(o,u){var s=o.getHelpers(u,"hint"),t;if(s.length){var r=false,p;for(var q=0;q<s.length;q++){if(s[q].async){r=true}}if(r){p=function(v,z,w){var y=i(v,s);function x(B,A){if(B==y.length){return z(null)}var C=y[B];if(C.async){C(v,function(D){if(D){z(D)}else{x(B+1)}},w)}else{var A=C(v,w);if(A){z(A)}else{x(B+1)}}}x(0)};p.async=true}else{p=function(v,w){var z=i(v,s);for(var x=0;x<z.length;x++){var y=z[x](v,w);if(y&&y.list.length){return y}}}}p.supportsSelection=true;return p}else{if(t=o.getHelper(o.getCursor(),"hintWords")){return function(v){return e.hint.fromList(v,{words:t})}}else{if(e.hint.anyword){return function(v,w){return e.hint.anyword(v,w)}}else{return function(){}}}}}e.registerHelper("hint","auto",{resolve:a});e.registerHelper("hint","fromList",function(u,x){var v=u.getCursor(),p=u.getTokenAt(v);var s=e.Pos(v.line,p.end);if(p.string&&/\w/.test(p.string[p.string.length-1])){var q=p.string,t=e.Pos(v.line,p.start)}else{var q="",t=s}var w=[];for(var r=0;r<x.words.length;r++){var o=x.words[r];if(o.slice(0,q.length)==q){w.push(o)}}if(w.length){return{list:w,from:t,to:s}}});e.commands.autocomplete=e.showHint;var c={hint:e.hint.auto,completeSingle:true,alignWithWord:true,closeCharacters:/[\s()\[\]{};:>,]/,closeOnUnfocus:true,completeOnSingleClick:true,container:null,customKeys:null,extraKeys:null};e.defineOption("hintOptions",null)});