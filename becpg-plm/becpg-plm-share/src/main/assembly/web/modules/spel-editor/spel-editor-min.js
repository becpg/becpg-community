(function(){var b=YAHOO.util.Dom,x=YAHOO.util.Event,n=YAHOO.util.KeyListener,f=YAHOO.util.Lang;var r=Alfresco.util.encodeHTML,u=Alfresco.util.hasEventInterest;beCPG.SpelEditor=function j(y,z){beCPG.SpelEditor.superclass.constructor.call(this,"beCPG.SpelEditor",y,["button","menu","container","resize","datasource","datatable"]);this.currentValueHtmlId=z;this.eventGroup=y;YAHOO.Bubbling.on("parentTypeChanged",this.onParentTypeChanged,this);YAHOO.Bubbling.on("formContainerDestroyed",this.onFormContainerDestroyed,this);YAHOO.Bubbling.on("refreshItemList",this.onRefreshItemList,this);this.editorId=y+"-editor";this.columns=[];this.selectedItems={};return this};YAHOO.extend(beCPG.SpelEditor,Alfresco.component.Base,{options:{selectedParentType:null,currentValue:"",currentItem:null,minSearchTermLength:1,maxSearchResults:100,disabled:false,mandatory:false,entityNodeRef:null,currentList:"compoList",dsr:Alfresco.constants.PROXY_URI+"becpg/autocomplete/speleditor"},columns:null,singleSelectedItem:null,selectedItems:null,onReady:function a(){this._createItemListControls();if(!this.options.disabled){this._createNavigationControls();var A=b.get(this.id+"-showEditorAction");if(A){var z=document.createElement("button");A.appendChild(z);this.widgets.showEditorButton=Alfresco.util.createYUIButton(this,null,this.onShowEditorClick,{label:this.msg("form.control.spel-editor.show"),disabled:true},z)}this.widgets.ok=Alfresco.util.createYUIButton(this,"ok",this.onOK);this.widgets.cancel=Alfresco.util.createYUIButton(this,"cancel",this.onCancel);b.get(this.id+"-ok-button").name="-";b.get(this.id+"-cancel-button").name="-";this.widgets.dialog=Alfresco.util.createYUIPanel(this.editorId,{width:"63em"});this.widgets.dialog.hideEvent.subscribe(this.onCancel,null,this);b.addClass(this.editorId,"spel-editor");var y=this;require(["cm/lib/codemirror","cm/addon/hint/show-hint","cm/addon/search/searchcursor","cm/addon/edit/matchbrackets","cm/mode/javascript/javascript"],function(B){if(typeof(y.widgets.brush)=="undefined"||y.widgets.brush==null){y.widgets.brush=new B(document.getElementById(y.id+"-currentValueDisplay"),{lineNumbers:true,lineWrapping:true,mode:"javascript",readOnly:true});y.widgets.brush.setSize("100%",100)}if(typeof(y.widgets.editor)=="undefined"||y.widgets.editor==null){y.widgets.editor=B.fromTextArea(document.getElementById(y.id+"-editor-textarea"),{lineNumbers:true,mode:"javascript",extraKeys:{"Ctrl-Space":"autocomplete"},lineWrapping:true,matchBrackets:true});B.commands.autocomplete=function(C){C.showHint({hint:B.hint.spel})};B.registerHelper("hint","spel",function(F,D){var G=F.getCursor(),E=F.getTokenAt(G);var H=E.start,C=G.ch;return{list:["entity","dataListItem","dataListItemEntity","variantData","#this","#root","$Value instanceof T($Type)",'$String matches "$Regexp"',"T($type)","$false ? $trueExp : $falseExp","$list.^[$property == $value]","$list.![$property]","@beCPG.sum($range,$formula)","@beCPG.avg($range,$formula)","@beCPG.sum($arrayOfDouble)","@beCPG.filter($range,$formula)","@beCPG.children($compoListDataItem)","@beCPG.findOne($nodeRef)",'@beCPG.propValue($nodeRef,"bcpg:productQty")',"@beCPG.copy($fromNodeRef,propQnames,listQNames)","isLiquid()","isRawMaterial()","isPackaging()","isPackagingKit()","isSemiFinished()","isLocalSemiFinished()"],from:B.Pos(G.line,H),to:B.Pos(G.line,C)}})}y._renderFormula(true)})}},destroy:function t(){try{YAHOO.Bubbling.unsubscribe("parentTypeChanged",this.onParentTypeChanged,this);YAHOO.Bubbling.unsubscribe("formContainerDestroyed",this.onFormContainerDestroyed,this);YAHOO.Bubbling.unsubscribe("refreshItemList",this.onRefreshItemList,this)}catch(y){}beCPG.SpelEditor.superclass.destroy.call(this)},onShowEditorClick:function v(z,A){if(!this.widgets.escapeListener){this.widgets.escapeListener=new n(this.editorId,{keys:n.KEY.ESCAPE},{fn:function y(B,C){this.onCancel();x.stopEvent(C[1])},scope:this,correctScope:true})}this.widgets.escapeListener.enable();this.widgets.editor.focus();this.widgets.dialog.show();this._createResizer();this._fireRefreshEvent();A.set("disabled",true);x.preventDefault(z)},onOK:function d(y,z){this.widgets.escapeListener.disable();this.widgets.dialog.hide();this.widgets.showEditorButton.set("disabled",false);if(y){x.preventDefault(y)}this.options.currentValue=this.widgets.editor.getValue();b.get(this.currentValueHtmlId).value=this.options.currentValue;YAHOO.Bubbling.fire("mandatoryControlValueUpdated",b.get(this.currentValueHtmlId));this._renderFormula(false)},onCancel:function e(y,z){this.widgets.escapeListener.disable();this.widgets.dialog.hide();this.widgets.showEditorButton.set("disabled",false);if(y){x.preventDefault(y)}},onSearch:function m(){var y=b.get(this.editorId+"-searchText").value;if(y.length<this.options.minSearchTermLength){y=null}YAHOO.Bubbling.fire("refreshItemList",{eventGroup:this,searchTerm:y})},onParentTypeChanged:function l(z,y){if(u(this,y)){var A=y[1];if(A&&A.item){this.widgets.itemTypeMenu.set("label",'<div><span class="item-icon"><img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/ajax_anim.gif" class="icon16" alt="'+this.msg("message.please-wait")+'"></span><span class="item-name">'+this._formatLabel(A.item.name)+"</span></div>");this.options.selectedParentType=A.item;this._fireRefreshEvent()}}},onFormContainerDestroyed:function w(z,y){if(this.widgets.dialog){this.widgets.dialog.destroy();delete this.widgets.dialog}if(this.widgets.resizer){this.widgets.resizer.destroy();delete this.widgets.resizer}if(this.widgets.editor){this.widgets.editor.toTextArea();delete this.widgets.editor}if(this.widgets.brush){delete this.widgets.brush}},_renderFormula:function g(B){var A=[],z=this,C=new RegExp("(workspace://SpacesStore/[a-z0-9A-Z-]*)","gi");A=this.options.currentValue.match(C);function y(F){var E=null,I,H;if(F!=null){E=F.json.data.items}z.widgets.brush.setValue(z.options.currentValue);z.widgets.editor.setValue(z.options.currentValue);if(E!=null){for(var G=0,D=E.length;G<D;G++){I=E[G];var K=z.widgets.brush.getSearchCursor(I.nodeRef);var J=z.widgets.editor.getSearchCursor(I.nodeRef);while(K.findNext()){H=document.createElement("span");H.innerHTML=r(I.name);H.className="spel-editor-nodeRef";z.widgets.brush.markText(K.from(),K.to(),{replacedWith:H})}while(J.findNext()){H=document.createElement("span");H.innerHTML=r(I.name);H.className="spel-editor-nodeRef";z.widgets.editor.markText(J.from(),J.to(),{replacedWith:H})}}}if(B){z._enableActions()}}if(A!=null&&A.length>0){Alfresco.util.Ajax.jsonRequest({url:Alfresco.constants.PROXY_URI+"api/forms/picker/items",method:"POST",dataObj:{items:A},successCallback:{fn:y,scope:this},failureCallback:{fn:function(D){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.spel-editor.failure")})},scope:this}})}else{y()}},_createNavigationControls:function q(){var E=this;this.widgets.itemTypeMenu=new YAHOO.widget.Button(this.editorId+"-itemType",{type:"menu",menu:this.editorId+"-itemTypeMenu",lazyloadmenu:false});b.get(this.editorId+"-itemType-button").name="-";this.widgets.itemTypeMenu.getMenu().subscribe("click",function(G,F){var H=F[1];if(H){YAHOO.Bubbling.fire("parentTypeChanged",{eventGroup:E,item:H.value})}});this.widgets.searchButton=new YAHOO.widget.Button(this.editorId+"-searchButton");this.widgets.searchButton.on("click",this.onSearch,this.widgets.searchButton,this);b.get(this.editorId+"-searchButton").name="-";var z=b.get(this.editorId+"-searchText");new YAHOO.util.KeyListener(z,{keys:13},{fn:E.onSearch,scope:this,correctScope:true},"keydown").enable();var B=[{name:"product",type:"fr.becpg.repo.product.data.ProductData",template:"{item1}"},{name:"costList",type:"bcpg:cost",subType:"fr.becpg.repo.product.data.productList.CostListDataItem",template:"cost['{item1}']?.{item2}"},{name:"nutList",type:"bcpg:nut",subType:"fr.becpg.repo.product.data.productList.NutListDataItem",template:"nut['{item1}']?.{item2}"},{name:"allergenList",type:"bcpg:allergen",subType:"fr.becpg.repo.product.data.productList.AllergenListDataItem",template:"allergen['{item1}']?.{item2}"},{name:"ingList",type:"bcpg:ing",subType:"fr.becpg.repo.product.data.productList.IngListDataItem",template:"ing['{item1}']?.{item2}"},{name:"organoList",type:"bcpg:organo",subType:"fr.becpg.repo.product.data.productList.OrganoListDataItem",template:"organo['{item1}']?.{item2}"},{name:"physicoChemList",type:"bcpg:physicoChem",subType:"fr.becpg.repo.product.data.productList.PhysicoChemListDataItem",template:"physico['{item1}']?.{item2}"},{name:"microbioList",type:"bcpg:microbio",subType:"fr.becpg.repo.product.data.productList.MicrobioListDataItem",template:"microbio['{item1}']?.{item2}"},{name:"compoList",type:"bcpg:rawMaterial,bcpg:finishedProduct,bcpg:localSemiFinishedProduct,bcpg:semiFinishedProduct",subType:"fr.becpg.repo.product.data.productList.CompoListDataItem",template:"compo['{item1}']?.{item2}"},{name:"processList",type:"bcpg:resourceProduct",subType:"fr.becpg.repo.product.data.productList.ProcessListDataItem",template:"process['{item1}']?.{item2}"},{name:"resourceParamList",type:"mpm:resourceParam",subType:"fr.becpg.repo.product.data.productList.ResourceParamListItem",template:"resParam['{item1}']?.{item2}"},{name:"packagingList",type:"bcpg:packagingMaterial,bcpg:packagingKit",subType:"fr.becpg.repo.product.data.productList.PackagingListDataItem",template:"pack['{item1}']?.{item2}"},{name:"variables",type:"bcpg:dynamicCharactList",template:"{currentList}Var['{name1}']"},{name:"labelClaimList",type:"bcpg:labelClaim",subType:"fr.becpg.repo.product.data.productList.LabelClaimListDataItem",template:"labelClaim['{item1}']?.{item2}"},{name:"ingLabelingList",type:"bcpg:labelingRuleList",subType:"fr.becpg.repo.product.data.productList.IngLabelingListDataItem",template:"labeling['{item1}']?.{item2}"}];var C,D,y;for(var A=0;A<B.length;A++){D=B[A];y="<span class='"+D.name+"'  >"+this._formatLabel(D.name)+"</span>";C=new YAHOO.widget.MenuItem(y,{value:D});this.widgets.itemTypeMenu.getMenu().addItem(C,0);if(A==0){this.options.selectedParentType=D}}this.widgets.itemTypeMenu.getMenu().render()},_createItemListControls:function s(){var y=this;if(this.options.disabled===false){this.widgets.dataSource=new YAHOO.util.DataSource(this.options.dsr,{responseType:YAHOO.util.XHRDataSource.TYPE_JSON,responseSchema:{resultsList:"result",fields:["value","name","cssClass","metadatas"],metaFields:{page:"page",pageSize:"pageSize",fullListSize:"fullListSize"}}});var z=[{key:"value",label:"Value",formatter:function(C,A,D,E){var B=A.getData();C.innerHTML="<span class='defaultIcon "+B.cssClass+"' >"+y._formatLabel(B.name)+"</span>"}}];this.widgets.dataTable1=new YAHOO.widget.DataTable(this.editorId+"-itemList1",z,this.widgets.dataSource,{MSG_EMPTY:this.msg("form.control.spel-editor.selected-items.empty"),initialLoad:false});this.widgets.dataTable2=new YAHOO.widget.DataTable(this.editorId+"-itemList2",z,this.widgets.dataSource,{MSG_EMPTY:this.msg("form.control.spel-editor.selected-items.empty"),initialLoad:false});this.widgets.dataTable1.doBeforeLoadData=function(A,B,C){if(y.options.selectedParentType){label="<span class='"+y.options.selectedParentType.name+"' style='padding-left: 20px;' >"+y._formatLabel(y.options.selectedParentType.name)+"</span>";y.widgets.itemTypeMenu.set("label",label)}return true};this.widgets.dataTable1.subscribe("rowClickEvent",function(C){var F=C.target,B=this.getRecord(F);var E=B.getData();y.options.currentItem=E;y.widgets.dataTable1.onEventSelectRow(C);if(y.options.selectedParentType.subType!=null){y.widgets.dataTable2.load({request:y._buildParamUrl(y.options.selectedParentType.subType)})}else{var G=f.substitute(y.options.selectedParentType.template,{name1:E.name,item1:E.value,currentList:y.options.currentList.replace("List","")});y.widgets.editor.replaceRange(G,y.widgets.editor.getCursor());var D=y.widgets.editor.getSearchCursor(y.options.currentItem.value);while(D.findNext()){var A=document.createElement("span");A.innerHTML=r(y.options.currentItem.name);y.widgets.editor.markText(D.from(),D.to(),{replacedWith:A})}y.widgets.editor.focus()}});this.widgets.dataTable2.subscribe("rowClickEvent",function(C){var F=C.target,B=this.getRecord(F);y.widgets.dataTable2.onEventSelectRow(C);var E=B.getData();var G=f.substitute(y.options.selectedParentType.template,{item1:y.options.currentItem.value,item2:E.value,currentList:y.options.currentList});y.widgets.editor.replaceRange(" "+G,y.widgets.editor.getCursor());var D=y.widgets.editor.getSearchCursor(y.options.currentItem.value);while(D.findNext()){var A=document.createElement("span");A.innerHTML=r(y.options.currentItem.name);y.widgets.editor.markText(D.from(),D.to(),{replacedWith:A})}y.widgets.editor.focus()})}},_buildParamUrl:function k(y,A){var z=YAHOO.util.Lang.substitute("?q={query}&page={page}&pageSize={pageSize}&className={className}&entityNodeRef={entityNodeRef}",{query:(!A||A.length<1)?"*":A,page:1,className:y,entityNodeRef:this.options.entityNodeRef,pageSize:this.options.maxSearchResults});return z},onRefreshItemList:function p(z,y){if(u(this,y)){this.widgets.dataTable2.deleteRows(0,this.widgets.dataTable2.getRecordSet().getLength());this.widgets.dataTable1.load({request:this._buildParamUrl(this.options.selectedParentType.type,y[1].searchTerm)})}},_fireRefreshEvent:function i(){var z=b.get(this.editorId+"-searchText");var y=z.value;if(y.length>=this.options.minSearchTermLength){YAHOO.Bubbling.fire("refreshItemList",{eventGroup:this,searchTerm:y})}else{YAHOO.Bubbling.fire("refreshItemList",{eventGroup:this})}},_formatLabel:function h(y){var z="form.control.spel-editor.item."+y;if(z.indexOf(" ")<0&&this.msg(z)!=z){return r(this.msg(z))}return r(y)},_createResizer:function c(){if(!this.widgets.resizer){var y=parseInt(b.get(this.editorId+"-body").offsetWidth,10)-2,z=0;this.columns[0]=b.get(this.editorId+"-left");this.columns[1]=b.get(this.editorId+"-right");this.widgets.resizer=new YAHOO.util.Resize(this.editorId+"-left",{handles:["r"],minWidth:200,maxWidth:(y-200)});z=this.widgets.resizer.get("height");this.widgets.resizer.on("resize",function(B){var A=B.width;b.setStyle(this.columns[0],"height","");b.setStyle(this.columns[1],"width",(y-A-8)+"px")},this,true);this.widgets.resizer.on("endResize",function(A){this.set("height",z)});this.widgets.resizer.fireEvent("resize",{ev:"resize",target:this.widgets.resizer,width:y/2})}},_enableActions:function o(){if(this.widgets.showEditorButton){this.widgets.showEditorButton.set("disabled",false)}}})})();